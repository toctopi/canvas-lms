define(["i18n!rubric_assessment","jquery","str/htmlEscape","jquery.instructure_forms","jqueryui/dialog","jquery.instructure_misc_helpers","jquery.instructure_misc_plugins","jquery.templateData","vendor/jquery.scrollTo"],function(a,b,c){return window.rubricAssessment={init:function(){var c=b("#rubric_criterion_comments_dialog");b(".rubric").delegate(".rating","click",function(a){b(this).parents(".criterion").find(".criterion_points").val(b(this).find(".points").text()).change()}).delegate(".long_description_link","click",function(c){c.preventDefault();if(!b(this).parents(".rubric").hasClass("editing")){var d=b(this).parents(".criterion").getTemplateData({textValues:["long_description","description"]}),e=b(this).parents(".criterion").hasClass("learning_outcome_criterion");b("#rubric_long_description_dialog").fillTemplateData({data:d,htmlValues:e?["long_description"]:[]}).find(".editing").hide().end().find(".displaying").show().end().dialog("close").dialog({autoOpen:!1,title:a.t("titles.criterion_long_description","Criterion Long Description"),width:400}).dialog("open")}}).delegate(".criterion .saved_custom_rating","change",function(){if(b(this).parents(".rubric").hasClass("assessing")){var a=b(this).val();a&&a.length>0&&b(this).parents(".custom_ratings_entry").find(".custom_rating_field").val(unescape(a))}}).delegate(".criterion_comments","click",function(d){d.preventDefault(),d.preventDefault();var e=b(this).parents(".criterion"),f=e.getTemplateData({textValues:["custom_rating"]}).custom_rating,g=b(this).closest("td").children(".editing").is(":visible"),h={criterion_comments:f,criterion_description:e.find(".description:first").text()};c.data("current_rating",e),c.fillTemplateData({data:h}),c.fillFormData(h),c.find(".editing").showIf(g),c.find(".displaying").showIf(!g),c.dialog("close").dialog({autoOpen:!1,title:a.t("titles.additional_comments","Additional Comments"),width:400}).dialog("open")}).find(".criterion_points").bind("keypress change blur",function(a){var c=b(a.target);if(c.parents(".rubric").hasClass("assessing")){var d=parseFloat(c.val(),10);isNaN(d)&&(d=null);var e=c.parents(".criterion");e.find(".rating.selected").removeClass("selected"),d||d===0?(e.find(".criterion_description").addClass("completed"),e.find(".rating").each(function(){var a=parseFloat(b(this).find(".points").text(),10);a==d&&b(this).addClass("selected")})):e.find(".criterion_description").removeClass("completed");var f=0;c.parents(".rubric").find(".criterion:visible:not(.ignore_criterion_for_scoring) .criterion_points").each(function(){var a=parseFloat(b(this).val(),10);isNaN(a)&&(a=0),f+=a}),c.parents(".rubric").find(".rubric_total").text(f)}}),b(".rubric_summary").delegate(".rating_comments_dialog_link","click",function(d){d.preventDefault();var e=b(this).parents(".criterion"),f=e.getTemplateData({textValues:["rating_custom"]}).rating_custom,g=e.find(".criterion_description:first").text().split(/\b\s+/)[0],h={criterion_comments:f,criterion_description:g+" description: "+e.find(".criterion_description .long_description:first").text()};c.data("current_rating",e),c.fillTemplateData({data:h}),c.fillFormData(h),c.find(".editing").hide(),c.find(".displaying").show(),c.dialog("close").dialog({autoOpen:!1,title:a.t("titles.additional_comments","Additional Comments"),width:400}).dialog("open")}),c.find(".save_button").click(function(a){var b=c.find("textarea.criterion_comments").val(),d=c.data("current_rating");d&&(d.find(".custom_rating").text(b),d.find(".criterion_comments").toggleClass("empty",!b)),c.dialog("close")}),c.find(".cancel_button").click(function(a){c.dialog("close")}),setInterval(rubricAssessment.sizeRatings,2500)},sizeRatings:function(){var a=b(".rubric .criterion:visible");if(a.length){var c=b.windowScrollTop();b(".rubric .criterion:visible").each(function(){var a=b(this),c=a.find(".ratings:visible");if(c.length){var d=c.find(".rating .container").css("height",""),e=Math.max(c.height(),a.find(".criterion_description .container").height());d.css("height",e-10+"px")}}),b("html,body").scrollTop(c)}},assessmentData:function(a){a=rubricAssessment.findRubric(a);var c={};return c["rubric_assessment[user_id]"]=ENV.RUBRIC_ASSESSMENT.assessment_user_id||a.find(".user_id").text(),c["rubric_assessment[assessment_type]"]=ENV.RUBRIC_ASSESSMENT.assessment_type||a.find(".assessment_type").text(),a.find(".criterion:not(.blank)").each(function(){var a=b(this).attr("id"),d="rubric_assessment["+a+"]";c[d+"[points]"]=b(this).find(".criterion_points").val(),b(this).find(".rating.selected")&&(c[d+"[description]"]=b(this).find(".rating.selected .description").text(),c[d+"[comments]"]=b(this).find(".custom_rating").text()),b(this).find(".custom_rating_field:visible").length>0&&(c[d+"[comments]"]=b(this).find(".custom_rating_field:visible").val(),c[d+"[save_comment]"]=b(this).find(".save_custom_rating").attr("checked")?"1":"0")}),c},findRubric:function(a){return a.hasClass("rubric")||($new_rubric=a.closest(".rubric"),$new_rubric.length===0&&($new_rubric=a.find(".rubric:first")),a=$new_rubric),a},updateRubricAssociation:function(c,d){var e=d.summary_data;if(e&&e.saved_comments)for(var f in e.saved_comments){var g=e.saved_comments[f],h=c.find("#criterion_"+f).find(".saved_custom_rating_holder").hide(),i=h.find(".saved_custom_rating");i.find(".comment").remove(),i.empty().append('<option value="">'+a.t("options.select","[ Select ]")+"</option>");for(var j in g)g[j]&&(i.append('<option value="'+escape(g[j])+'">'+b.truncateText(g[j],50)+"</option>"),h.show())}},populateRubric:function(a,d){a=rubricAssessment.findRubric(a);var e=a.attr("id").substring(7);a.find(".user_id").text(ENV.RUBRIC_ASSESSMENT.assessment_user_id||d.user_id).end().find(".assessment_type").text(ENV.RUBRIC_ASSESSMENT.assessment_type||d.assessment_type),a.find(".criterion_description").removeClass("completed").removeClass("original_completed").end().find(".rating").removeClass("selected").removeClass("original_selected").end().find(".custom_rating_field").val("").end().find(".custom_rating_comments").text("").end().find(".criterion_points").val("").change().end().find(".criterion_rating_points").text("").end().find(".custom_rating").text("").end().find(".save_custom_rating").attr("checked",!1),a.find(".criterion_comments").addClass("empty");if(d){var f=d,g=0;for(var h in f.data){var i=f.data[h],j=i.comments_enabled?i.comments:i.description;if(i.comments_enabled&&i.comments_html)var k=i.comments_html;else var k=c(j);var l=a.find("#criterion_"+i.criterion_id);i.id||l.find(".rating").each(function(){var a=parseFloat(b(this).find(".points").text(),10);a==i.points&&(i.id=b(this).find(".rating_id").text())}),l.find(".criterion_description").addClass("original_completed").end().find("#rating_"+i.id).addClass("original_selected").addClass("selected").end().find(".custom_rating_field").val(j).end().find(".custom_rating_comments").html(k).end().find(".criterion_points").val(i.points).change().end().find(".criterion_rating_points_holder").showIf(i.points||i.points===0).end().find(".criterion_rating_points").text(i.points).end().find(".custom_rating").text(j).end().find(".criterion_comments").toggleClass("empty",!j).end().find(".save_custom_rating").attr("checked",!1),j&&l.find(".criterion_comments").show(),i.points&&!i.ignore_for_scoring&&(g+=i.points)}a.find(".rubric_total").text(g)}},populateRubricSummary:function(a,b){a.find(".criterion_points").text("").end().find(".rating_custom").text("");if(b){var c=b,d=0;for(var e in c.data){var f=c.data[e];a.find("#criterion_"+f.criterion_id).find(".rating").hide().end().find(".rating.description").showIf(!a.hasClass("free_form")).text(f.description).end().find(".rating_"+f.id).show().end().find(".criterion_points").text(f.points).end().find(".ignore_for_scoring").showIf(f.ignore_for_scoring),f.comments_enabled&&f.comments&&a.find("#criterion_"+f.criterion_id).find(".rating_custom").show().text(f.comments),f.points&&!f.ignore_for_scoring&&(d+=f.points)}a.show().find(".rubric_total").text(d),a.closest(".edit").show()}else a.hide()}},b(rubricAssessment.init),rubricAssessment})