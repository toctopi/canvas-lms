require(["i18n!profile","jquery","jquery.ajaxJSON","jquery.instructure_forms","jqueryui/dialog","jquery.instructure_misc_helpers","jquery.instructure_misc_plugins","jquery.loadingImg","jquery.rails_flash_notifications","jquery.templateData","jqueryui/tabs"],function(a,b){b(document).ready(function(){b("#communication_channels").tabs(),b("#communication_channels").bind("tabsshow",function(a){if(b(this).css("display")!="none"){var c=b(this).data("selected.tabs");c==0?b("#register_email_address").find(":text:first").focus().select():b("#register_sms_number").find(":text:first").focus().select()}}),b(".channel_list tr").hover(function(){if(b(this).hasClass("unconfirmed")){var c=a.t("titles.contact_not_confirmed","This contact has not been confirmed.  Click the address for more details");b(this).closest(".email_channels").length>0&&(c=a.t("titles.email_not_confirmed","This email has not been confirmed.  Click the address for more details")),b(this).attr("title",c),b(this).find("a.path").parent().attr("title",c)}},function(){b(this).attr("title",""),b(this).find("a.path").parent().attr("title",b(this).find("a.path").text())}),b(".add_email_link,.add_contact_link").click(function(c){c.preventDefault();var d="email";b("#communication_channels").show().dialog("close").dialog({title:a.t("titles.register_communication","Register Communication"),width:430,resizable:!1,modal:!0,open:function(){b("#communication_channels").triggerHandler("tabsshow")}}).dialog("open"),b(this).hasClass("add_contact_link")?(b("#communication_channels").tabs("select","#register_sms_number"),d="sms"):b("#communication_channels").tabs("select","#register_email_address")}),b("#register_sms_number .user_selected").bind("change blur keyup focus",function(){var a=b(this).parents("#register_sms_number"),c=a.find(".sms_number").val().replace(/[^\d]/g,"");a.find(".should_be_10_digits").showIf(c&&c.length!=10);var d=a.find(".carrier").val();a.find(".sms_email").attr("disabled",d!="other");if(d=="other")return;d=d.replace("#",c),a.find(".sms_email").val(d)}),b("#register_sms_number,#register_email_address").formSubmit({beforeSubmit:function(c){var d=b(".email_channels"),c=b(this).getFormData({object_name:"communication_channel"});b(this).attr("id")=="register_sms_number"&&(d=b(".other_channels"));var e=b(this).getFormData({object_name:"communication_channel"}).address;b(this).data("email",e),d.find(".channel .path").each(function(){b(this).text()==e&&(e="")}),d.removeClass("single");var f=null;return e&&(f=d.find(".channel.blank").clone(!0).removeClass("blank"),f.find(".path").attr("title",a.t("titles.unconfirmed_click_to_confirm","Unconfirmed.  Click to confirm")),f.fillTemplateData({data:{path:e}}),d.find(".channel.blank").before(f.show())),e?(b("#communication_channels").dialog("close"),f.loadingImage({image_size:"small"}),f):!1},success:function(a,c){b("#communication_channels").dialog("close"),c.loadingImage("remove"),a.channel_id=a.id;var d="email_select";b(this).attr("id")=="register_sms_number"&&(d="sms_select");var e=b("#select_templates ."+d),f=b(document.createElement("option"));f.val(a.id).text(a.address),e.find("option:last").before(f),e.find("option.blank_option").remove(),b("."+d).each(function(){var c=b(this).val();c=="new"&&(c=a.id),b(this).after(e.clone(!0).val(c)).remove()}),c.fillTemplateData({data:a,id:"channel_"+a.id,hrefValues:["user_id","pseudonym_id","channel_id"]}),c.find(".path").triggerHandler("click")},error:function(a,b){b.loadingImage("remove"),b.remove()}}),b("a.email_address_taken_learn_more").live("click",function(a){a.preventDefault()}),b(".channel_list .channel .delete_channel_link").click(function(a){a.preventDefault(),b(this).parents(".channel").confirmDelete({url:b(this).attr("href"),success:function(a){var c=b(this).parents(".channel_list");b(this).remove(),c.toggleClass("single",c.find(".channel:visible").length<=1)}})}),b("#confirm_communication_channel .cancel_button").click(function(a){b("#confirm_communication_channel").dialog("close")}),b(".email_channels .channel .path,.other_channels .channel .path").click(function(c){c.preventDefault();var d=b(this).parents(".channel");if(d.hasClass("unconfirmed")){var e="email address",f=a.t("titles.confirm_email_address","Confirm Email Address");b(this).parents(".channel_list").hasClass("other_channels")&&(e="sms number",f=a.t("titles.confirm_sms_number","Confirm SMS Number"));var g=b("#confirm_communication_channel");d.parents(".email_channels").length>0&&(g=b("#confirm_email_channel"));var h=d.getTemplateData({textValues:["user_id","pseudonym_id","channel_id"]}),i=b(this).text();e=="sms number"&&(i=i.split("@")[0]),h.code="",g.fillTemplateData({data:{path:i,path_type:e,user_id:h.user_id,channel_id:h.channel_id}}),g.find(".status_message").css("visibility","hidden");var j=b(".re_send_confirmation_url").attr("href");j=b.replaceTags(j,"id",h.channel_id),j=b.replaceTags(j,"pseudonym_id",h.pseudonym_id),j=b.replaceTags(j,"user_id",h.user_id),g.find(".re_send_confirmation_link").attr("href",j).text(a.t("links.resend_confirmation","Re-Send Confirmation")),g.fillFormData(h),g.show().dialog("close").dialog({autoOpen:!1,title:f,width:350,open:function(){b(this).find(":text:first").focus().select()}}).dialog("open")}}),b("#confirm_communication_channel").formSubmit({formErrors:!1,processData:function(a){var c=b(this).find(".register_channel_link").attr("href");c=b.replaceTags(c,"id",a.channel_id),c=b.replaceTags(c,"code",a.code),b(this).attr("action",c)},beforeSubmit:function(c){b(this).find(".status_message").text(a.t("confirming_contact","Confirming...")).css("visibility","visible")},success:function(c){b(this).find(".status_message").css("visibility","hidden");var d=c.communication_channel.pseudonym_id;b("#channel_"+c.communication_channel.id).removeClass("unconfirmed"),b(".channel.pseudonym_"+d).removeClass("unconfirmed"),b("#confirm_communication_channel").dialog("close"),b.flashMessage(a.t("notices.contact_confirmed","Contact successfully confirmed!"))},error:function(c){b(this).find(".status_message").text(a.t("errors.confirmation_failed","Confirmation failed.  Please try again."))}}),b(".channel_list .channel .default_link").click(function(a){a.preventDefault();var c=b(this).parents(".channel").getTemplateData({textValues:["channel_id"]}).channel_id,d={default_email_id:c};b.ajaxJSON(b(this).attr("href"),"PUT",d,function(a){var c=a.user.communication_channel.id;b(".channel.default").removeClass("default"),b(".channel#channel_"+c).addClass("default"),b(".default_email.display_data").text(a.user.pseudonym.unique_id)})}),b(".dialog .re_send_confirmation_link").click(function(c){c.preventDefault();var d=b(this);d.text(a.t("links.resending_confirmation","Re-Sending...")),b.ajaxJSON(d.attr("href"),"POST",{},function(b){d.text(a.t("links.resent_confirmation","Done! Message may take a few minutes."))},function(b){d.text(a.t("links.resend_confirmation_failed","Request failed. Try again."))})}),b("#communication_channels .cancel_button").click(function(a){b("#communication_channels").dialog("close")}),b("#confirm_email_channel .cancel_button").click(function(){b("#confirm_email_channel").dialog("close")})})})