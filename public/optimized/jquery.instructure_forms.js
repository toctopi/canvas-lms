define(["INST","i18n!instructure","jquery","underscore","jquery.ajaxJSON","jquery.disableWhileLoading","jquery.google-analytics","jquery.instructure_date_and_time","jquery.instructure_misc_helpers","jquery.instructure_misc_plugins","jquery.rails_flash_notifications","tinymce.editor_box","vendor/jquery.scrollTo"],function(a,b,c,d){c.fn.formSubmit=function(b){return this.submit(function(e){var f=c(this);if(f.data("submitting"))return;f.data("trigger_event",e),f.hideErrors();var g=!1,h=f.validateForm(b);if(!h)return!1;var i=f.getFormData(b);if(b.processData&&c.isFunction(b.processData)){var j=null;try{j=b.processData.call(f,i)}catch(k){g=k}if(j===!1)return!1;j&&(i=j)}var l=f.data("method")||f.find("input[name='_method']").val()||f.attr("method"),m=f.attr("id"),n=f.attr("action"),o=null;if(c.isFunction(b.beforeSubmit)){o=null;try{o=b.beforeSubmit.call(f,i)}catch(k){g=k}if(o===!1)return!1}if(b.disableWhileLoading){var p=c.Deferred(),q={};f.disableWhileLoading(p),c.each(["success","error"],function(a,d){q[d]=b[d],b[d]=function(){p[d==="success"?"resolve":"reject"]();if(c.isFunction(q[d]))return q[d].apply(this,arguments)}})}var r=b.fileUpload;if(c.isFunction(b.fileUpload))try{r=b.fileUpload.call(f,i)}catch(k){g=k}r&&b.fileUploadOptions&&c.extend(b,b.fileUploadOptions),f.attr("action")&&(n=f.attr("action"));if(g&&!b.preventDegradeToFormSubmit){p&&p.reject(),a&&a.environment=="development"&&c.flashError("formSubmit error, trying to gracefully degrade. See console for details");return}e.preventDefault(),e.stopPropagation();if(b.noSubmit)c.isFunction(b.success)&&(p&&p.resolve(),b.success.call(f,i,o));else if(r&&b.preparedFileUpload&&b.context_code)c.ajaxJSONPreparedFiles.call(this,{handle_files:b.upload_only?b.success:b.handle_files,single_file:b.singleFile,context_code:c.isFunction(b.context_code)?b.context_code.call(f):b.context_code,asset_string:b.asset_string,intent:b.intent,folder_id:c.isFunction(b.folder_id)?b.folder_id.call(f):b.folder_id,file_elements:f.find("input[type='file']:visible"),url:b.upload_only?null:n,uploadDataUrl:b.uploadDataUrl,formData:i,formDataTarget:b.formDataTarget,success:b.success,error:b.error});else if(r&&c.handlesHTML5Files&&f.hasClass("handlingHTML5Files")){var s=c.extend({},i);f.find("input[type='file']").each(function(){var a=c(this),b=a.data("file_list");b&&b instanceof FileList&&(s[a.attr("name")]=b)}),c.toMultipartForm(s,function(a){c.sendFormAsBinary({url:n,body:a.body,content_type:a.content_type,form_data:a.form_data,method:l,success:function(a){b.success&&c.isFunction(b.success)&&b.success.call(f,a,o)},error:function(a,d){var e=f,g=!0;if(b.error&&c.isFunction(b.error)){a=a||{};var h=b.error.call(f,a.errors||a,o);h&&(e=h),g=!1}else g=!0;e.parents("html").get(0)==c("html").get(0)&&b.formErrors!==!1?e.formErrors(a,b):g&&c.ajaxJSON.unhandledXHRs.push(d)}})})}else if(r){var t=d.uniqueId(m+"_"),u=c("<div style='display: none;' id='box_"+t+"'><form id='form_"+t+"'></form><iframe id='frame_"+t+"' name='frame_"+t+"' src='about:blank' onload='$(\"#frame_"+t+'").triggerHandler("form_response_loaded");\'></iframe>').appendTo("body").find("#frame_"+t),v=c(this),w=l,x=v.attr("target"),y=v.attr("ENCTYPE"),z=new c.fakeXHR(0,""),A=f;v.attr({method:l,action:n,ENCTYPE:"multipart/form-data",encoding:"multipart/form-data",target:"frame_"+t}),b.onlyGivenParameters&&(v.find("input[name='_method']").remove(),v.find("input[name='authenticity_token']").remove()),c.ajaxJSON.storeRequest(z,n,l,i),u.bind("form_response_loaded",function(){var a=A,d=u[0],e,f;d.contentDocument?e=d.contentDocument:d.contentWindow?e=d.contentWindow.document:e=window.frames[t].document;var g="",h=null,f=null;try{if(e.location.href=="about:blank")return;g=c(e).text();var i=c.parseJSON(g);b.success&&c.isFunction(b.success)&&i&&!i.errors&&b.success.call(a,i,o)}catch(j){i={},f=j}if(f||i.errors){var k=a,l=!0;z.responseText=g;if(b.error&&c.isFunction(b.error)){var m=b.error.call(a,i.errors||g,o);m&&(k=m),l=!1}else c.fn.formSubmit.defaultAjaxErrorObject&&c.isFunction(c.fn.formSubmit.defaultAjaxErrorFunction)&&(l=!0);k.parents("html").get(0)==c("html").get(0)&&b.formErrors!==!1?k.formErrors(i.errrors||i,b):l&&c.ajaxJSON.unhandledXHRs.push(z),c.fn.defaultAjaxError.func.call(c.fn.defaultAjaxError.object,null,z,"0",f)}setTimeout(function(){a.attr({ENCTYPE:y,encoding:y,target:x}),c("#box_"+t).remove()},5e3)}),v.data("submitting",!0).submit().data("submitting",!1)}else c.ajaxJSON(n,l,i,function(a){c.isFunction(b.success)&&b.success.call(f,a,o)},function(a,d,e,g){a=a||{};var h=f,i=!0;if(c.isFunction(b.error)){var j=b.error.call(f,a.errors||a,o);j&&(h=j),i=!1}else i=!0;h.parents("html").get(0)==c("html").get(0)&&b.formErrors!==!1?h.formErrors(a,b):i&&c.ajaxJSON.unhandledXHRs.push(d)})}),this},c.handlesHTML5Files=!!(window.File&&window.FileReader&&window.FileList&&XMLHttpRequest),c.handlesHTML5Files&&c("input[type='file']").live("change",function(a){var b=this.files;b&&(c(this).data("file_list",b),c(this).parents("form").addClass("handlingHTML5Files"))}),c.ajaxFileUpload=function(a){a.data.authenticity_token||(a.data.authenticity_token=ENV.AUTHENTICITY_TOKEN),c.toMultipartForm(a.data,function(b){c.sendFormAsBinary({url:a.url,body:b.body,content_type:b.content_type,form_data:b.form_data,method:a.method,success:function(b){a.success&&c.isFunction(a.success)&&a.success.call(this,b)},progress:function(b){a.progress&&c.isFunction(a.progress)&&a.progress.call(this,b)},error:function(b,d){if(a.error&&c.isFunction(a.error)){b=b||{};var e=a.error.call(this,b.errors||b)}else c.ajaxJSON.unhandledXHRs.push(d)}},a.binary===!1)})},c.httpSuccess=function(a){try{return!a.status&&location.protocol=="file:"||a.status>=200&&a.status<300||a.status==304||jQuery.browser.safari&&a.status==undefined}catch(b){}return!1},c.sendFormAsBinary=function(a,b){var d=a.body,e=a.url,f=a.method,g=new XMLHttpRequest;g.upload&&(g.upload.addEventListener("progress",function(b){a.progress&&c.isFunction(a.progress)&&a.progress.call(this,b)},!1),g.upload.addEventListener("error",function(b){a.error&&c.isFunction(a.error)&&a.error.call(this,"uploading error",g,b)},!1),g.upload.addEventListener("abort",function(b){a.error&&c.isFunction(a.error)&&a.error.call(this,"aborted by the user",g,b)},!1),g.onreadystatechange=function(b){if(g.readyState==4){var d=null;try{d=c.parseJSON(g.responseText)}catch(e){}c.httpSuccess(g)?d&&!d.errors?a.success&&c.isFunction(a.success)&&a.success.call(this,d,g,b):a.error&&c.isFunction(a.error)&&a.error.call(this,d||g.responseText,g,b):a.error&&c.isFunction(a.error)&&a.error.call(this,d||g.responseText,g,b)}}),g.open(f,e),g.setRequestHeader("Accept","application/json, text/javascript, */*"),g.setRequestHeader("X-Requested-With","XMLHttpRequest"),a.form_data?g.send(a.form_data):(g.overrideMimeType(a.content_type||"multipart/form-data"),g.setRequestHeader("Content-Type",a.content_type||"multipart/form-data"),g.setRequestHeader("Content-Length",d.length),b?g.send(d):g.sendAsBinary?g.sendAsBinary(d):console.log("xhr.sendAsBinary not supported"))},c.fileData=function(a){return{name:a.name||a.fileName,size:a.size||a.fileSize,type:a.type,forced_type:a.type||"application/octet-stream"}},c.toMultipartForm=function(a,b){function e(a){return a.replace(/\"/g,"")}function f(){i.body=j.substring(0,j.length-2)+"--",b(i)}function g(){if(k.length===0){f();return}var a=k.shift(),b=a[0],i=a[1];window.FileList&&i instanceof FileList&&(i=i[0]);if(window.FileList&&i instanceof FileList){var l="-----BbC04y"+d.uniqueId(),m=[];j+='Content-Disposition: form-data; name="'+e(b)+"\r\n"+"Content-Type: multipart/mixed; boundary="+l+"\r\n\r\n";for(var n in i)m.push(i);function o(){j+="--"+l+"--\r\n"+"--"+h+"\r\n",g()}function p(){if(m.length===0){o();return}var a=m.shift(),b=c.fileData(a),d=new FileReader;d.onloadend=function(){j+="--"+l+"\r\n"+'Content-Disposition: file; filename="'+e(b.name)+'"\r\n'+"Content-Type: "+b.forced_type+"\r\n"+"Content-Transfer-Encoding: binary\r\n"+"\r\n"+d.result,p()},d.readAsBinaryString(a)}p()}else if(window.File&&i instanceof File){var q=c.fileData(i),r=new FileReader;r.onloadend=function(){j+='Content-Disposition: file; name="'+e(b)+'"; filename="'+q.name+'"\r\n'+"Content-Type: "+q.forced_type+"\r\n"+"Content-Transfer-Encoding: binary\r\n"+"\r\n"+r.result+"\r\n--"+h+"\r\n",g()},r.readAsBinaryString(i)}else i&&i.fake_file?(j+='Content-Disposition: file; name="'+e(b)+'"; filename="'+i.name+'"\r\n'+"Content-Type: "+i.content_type+"\r\n"+"Content-Transfer-Encoding: binary\r\n"+"\r\n"+i.content+"\r\n--"+h+"\r\n",g()):(j+='Content-Disposition: form-data; name="'+e(b)+'"\r\n'+"\r\n"+(i||"").toString()+"\r\n"+"--"+h+"\r\n",g())}var h="-----AaB03x"+d.uniqueId(),i={content_type:"multipart/form-data; boundary="+h},j="--"+h+"\r\n",k=[],l=!1;for(var m in a)k.push([m,a[m]]),a[m]&&a[m].fake_file&&(l=!0);if(window.FormData&&!l){var n=new FormData;for(var m in a){var o=a[m];window.FileList&&o instanceof FileList&&(o=o[0]);if(o instanceof Array)for(var p=0;p<o.length;p++)n.append(m,o[p]);else n.append(m,o)}i.form_data=n,b(i);return}g()},c.fakeXHR=function(a,b){this.status=a,this.responseText=b},c.fn.defaultAjaxError=function(b){c.fn.defaultAjaxError.object=this,c.fn.defaultAjaxError.func=function(d,e,f,g){var h=a.environment=="production",i=c.inArray(e,c.ajaxJSON.unhandledXHRs)!=-1,j=c.inArray(e,c.ajaxJSON.ignoredXHRs)!=-1;if((!h||i)&&!j){c.ajaxJSON.unhandledXHRs=c.grep(c.ajaxJSON.unhandledXHRs,function(a,b){return a!=e});var k=!1;i||(k=!0),b.call(this,d,e,f,g,k)}},this.ajaxError(c.fn.defaultAjaxError.func)},c.fn.fillFormData=function(a,b){if(this.length){a=a||[];var d=c.extend({},c.fn.fillFormData.defaults,b);d.object_name&&(a=c._addObjectName(a,d.object_name,!0)),this.find(":input").each(function(){var b=c(this),e=b.attr("name"),f=b.attr("type");if(e in a&&e){if(f!="hidden"||b.next("input:checkbox").attr("name")!=e)if(f!="checkbox"&&f!="radio"){var g=a[e];if(typeof g=="undefined"||g===null)g="";b.val(g.toString())}else b.val()==a[e]?b.attr("checked",!0):b.attr("checked",!1);b&&b.change&&d.call_change&&b.change()}})}return this},c.fn.fillFormData.defaults={object_name:null,call_change:!0},c.fn.getFormData=function(a){var a=c.extend({},c.fn.getFormData.defaults,a),b={},d=this;return d.find(":input").not(":button").each(function(){var e=c(this),f=e.attr("type");if((f=="radio"||f=="checkbox")&&!e.attr("checked"))return;var g=e.val();if(e.hasClass("suggestion_title")&&e.attr("title")==g)g="";else if(e.hasClass("datetime_field_enabled")){var h=e.parent().children(".datetime_suggest").text();h&&(g=h)}try{e.data("rich_text")&&(g=e.editorBox("get_code",!1))}catch(i){}var j=e.prop("name")||"",k=j.match(/\[\]$/);if(f=="hidden"&&!k&&d.find("[name='"+j+"']").filter("textarea,:radio:checked,:checkbox:checked,:text,:password,select,:hidden")[0]!=e[0])return;j&&j!==""&&(f=="checkbox"||typeof b[j]=="undefined"||k)&&(!a.values||c.inArray(j,a.values)!=-1)&&(k?(b[j]=b[j]||[],b[j].push(g)):b[j]=g);var l=j}),a.object_name&&(b=c._stripObjectName(b,a.object_name,!0)),b},c.fn.getFormData.defaults={object_name:null},c._addObjectName=function(a,b,c){if(!a)return a;var d={};a instanceof Array&&(d=[]);var e,f,g;for(var h in a)a instanceof Array?e=a[h]:e=h,g=e.indexOf("["),g<0?f=b+"["+e+"]":f=b+"["+e.substring(0,g)+"]"+e.substring(g),typeof e=="string"&&e.indexOf("=")===0&&(f=e.substring(1),e=f),a instanceof Array?(d.push(f),c&&d.push(e)):(d[f]=a[h],c&&(d[e]=a[h]));return d},c._stripObjectName=function(a,b,c){var d={},e;a instanceof Array&&(d=[]);for(var f in a){var g,h;a instanceof Array?g=a[f]:g=f;if(h=g.indexOf(b+"[")===0)e=g.replace(b+"[",""),closing=e.indexOf("]"),e=e.substring(0,closing)+e.substring(closing+1),a instanceof Array?d.push(e):d[e]=a[f];if(!h||c)a instanceof Array?d.push(a[f]):d[f]=a[f]}return d},c.fn.validateForm=function(a){if(this.length===0)return!1;var a=c.extend({},c.fn.validateForm.defaults,a),d=this,e={},f=a.data||d.getFormData(a);a.object_name&&(a.required=c._addObjectName(a.required,a.object_name),a.date_fields=c._addObjectName(a.date_fields,a.object_name),a.dates=c._addObjectName(a.dates,a.object_name),a.times=c._addObjectName(a.times,a.object_name),a.numbers=c._addObjectName(a.numbers,a.object_name),a.property_validations=c._addObjectName(a.property_validations,a.object_name)),a.required&&c.each(a.required,function(a,c){f[c]||(e[c]||(e[c]=[]),e[c].push(b.t("errors.field_is_required","This field is required")))}),a.date_fields&&c.each(a.date_fields,function(a,c){var f=d.find("input[name='"+c+"']").filter(".datetime_field_enabled");f.length&&f.parent().children(".datetime_suggest").hasClass("invalid_datetime")&&(e[c]||(e[c]=[]),e[c].push(b.t("errors.invalid_datetime","Invalid date/time value")))}),a.numbers&&c.each(a.numbers,function(a,c){var d=parseFloat(f[c]);isNaN(d)&&(e[c]||(e[c]=[]),e[c].push(b.t("errors.invalid_number","This should be a number.")))}),a.property_validations&&c.each(a.property_validations,function(a,g){if(c.isFunction(g)){var h=g.call(d,f[a],f);h&&(typeof h!="string"&&(h=b.t("errors.invalid_entry_for_field","Invalid entry: %{field}",{field:a})),e[a]||(e[a]=[]),e[a].push(h))}});var g=!1;for(var h in e){g=!0;break}return g?(d.formErrors(e,a),c.trackEvent("Form Errors",this.attr("id")||this.attr("class")||document.title,JSON.stringify(e)),!1):!0},c.fn.validateForm.defaults={object_name:null,required:null,dates:null,times:null},c.fn.formErrors=function(a,b){if(this.length===0)return;var d=this,e={},f=[];a&&a.errors&&(a=a.errors),typeof a=="string"&&(a={base:a}),c.each(a,function(a,b){if(typeof b=="string"){var g=[];g.push(b),b=g}else{if(typeof a=="number"&&b.length==2&&b[0]instanceof jQuery&&typeof b[1]=="string"){f.push(b);return}if(typeof a=="number"&&b.length==2&&typeof b[1]=="string")g=[],g.push(b[1]),a=b[0],b=g;else try{g=[];for(var h in b)typeof b[h]=="object"&&b[h].message?g.push(b[h].message.toString()):g.push(b[h].toString());b=g}catch(i){b=b.toString()}}d.find(":input[name='"+a+"'],:input[name*='["+a+"]']").length>0?c.each(b,function(b,c){e[a]?e[a]+="<br/>"+c:e[a]=c}):c.each(b,function(a,b){e.general?e.general+="<br/>"+b:e.general=b})});var g=!1,h=0,i=c(document).scrollTop(),j={};c.each(e,function(a,b){var c=d.find(":input[name='"+a+"'],:input[name*='["+a+"]']").filter(":first");if(!c||c.length===0||a=="general")c=d;c[0].tagName=="TEXTAREA"&&c.next(".mceEditor").length&&(c=c.next().find(".mceIframeContainer")),j[a]={object:c,message:b},g=!0;var e=c.errorBox(b).offset();e.top>h&&(h=e.top)});for(var k in f){var l=f[k][0],m=f[k][1];g=!0;var n=l.errorBox(m).offset();n.top>h&&(h=n.top)}return g&&(b&&b.onFormError&&b.onFormError.call(d,j),c("html,body").scrollTo({top:h,left:0})),this},c.fn.errorBox=function(a,b){if(this.length){var d=this,e=d.data("associated_error_box");e&&e.remove();var f=c("#error_box_template");f.length||(f=c("<div id='error_box_template' class='error_box errorBox' style=''><div class='error_text' style=''></div><img src='/images/error_bottom.png' class='error_bottom'/></div>").appendTo("body"));var g=f.clone(!0).attr("id","").css("zIndex",d.zIndex()+1).appendTo("body");g.find(".error_text").html(a);var h=d.offset(),i=g.outerHeight(),j=Math.round(d.outerWidth()/5);return d[0].tagName=="FORM"&&(j=Math.min(j,50)),g.hide().css({top:h.top-i+2,left:h.left+j}).fadeIn("fast"),d.data({associated_error_box:g,associated_error_object:d}).focus(function(){g.fadeOut("slow",function(){g.remove()})}),g.click(function(){c(this).fadeOut("fast",function(){c(this).remove()})}),c.fn.errorBox.errorBoxes.push(d),c.fn.errorBox.isBeingAdjusted||c.moveErrorBoxes(),b&&c("html,body").scrollTo(g),g}},c.fn.errorBox.errorBoxes=[],c.moveErrorBoxes=function(){var a=[],b=c.fn.errorBox.errorBoxes;for(var d in b){var e=b[d],f=e.data("associated_error_box");if(f.length&&f[0].parentNode){a.push(e);if(e.filter(":visible").length){var g=e.offset(),h=f.outerHeight(),i=Math.round(e.outerWidth()/5);e[0].tagName=="FORM"&&(i=Math.min(i,50)),f.css({top:g.top-h+2,left:g.left+i}).show()}else f.hide()}}c.fn.errorBox.errorBoxes=a,a.length?c.fn.errorBox.isBeingAdjusted=setTimeout(c.moveErrorBoxes,500):delete c.fn.errorBox.isBeingAdjusted},c.fn.hideErrors=function(a){if(this.length){var b=this.data("associated_error_box");b&&(b.remove(),this.data("associated_error_box",null)),this.find(":input").each(function(){var a=c(this),b=a.data("associated_error_box");b&&(b.remove(),a.data("associated_error_box",null))})}return this},c.fn.formSuggestion=function(){return this.each(function(){var a=c(this);a.focus(function(a){var b=c(this),d=b.attr("title");b.addClass("suggestionFocus");if(!d||d==="")return;b.val()==d&&b.select(),b.removeClass("form_text_hint")}).blur(function(a){var b=c(this),d=b.attr("title");b.removeClass("suggestionFocus");if(!d||d==="")return;b.val()===""&&b.val(d),b.val()==d&&b.addClass("form_text_hint")}).mouseup(!1).change(function(a){var b=c(this),d;!b.hasClass("suggestionFocus")&&(d=c(this).attr("title"))&&(b.removeClass("suggestionFocus"),b.val()===""&&b.val(d),b.toggleClass("form_text_hint",b.val()==d))}).addClass("suggestion_title");var b=a.attr("title"),d=a.val();b&&(d===""||d==b)&&a.addClass("form_text_hint").val(b)})},c.fn.formSuggestion.suggestions=[]})