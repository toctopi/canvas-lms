define(["i18n!mathquill","jquery"],function(a,b){function c(){}function d(){}function e(a,b,c){this.init(a,[b],[c||(a&&a.length>1?a.slice(1):a)])}function f(){}function g(a,c,d){if(!arguments.length)return;var e=this;e.parent=a,e.prev=c||0,e.next=d||0,e.jQinit(e.fold(b(),function(a,b){return b.jQ.add(a)}))}function h(a,c,d,e,f){function h(){t=P;var a=q.selection?"$"+q.selection.latex()+"$":"";s.val(a);if(a)if(s[0].select)s[0].select();else if(document.selection){var b=s[0].createTextRange();b.expand("textedit"),b.select()}}function j(a){return q.seek(b(a.target),a.pageX,a.pageY),(q.prev!==u.prev||q.parent!==u.parent)&&q.selectFrom(u),!1}function k(a){return delete a.target,j(a)}function l(c){u=P,q.blink=v,q.selection||(e?q.show():r.detach()),a.unbind("mousemove",j),b(document).unbind("mousemove",k).unbind("mouseup",l)}function m(){s.focus()}function n(){var a=s.val();a.slice(0,1)==="$"&&a.slice(-1)==="$"?a=a.slice(1,-1):a.match(/^\\/)||(a="\\text{"+a+"}"),q.writeLatex(a).show(),s.val("")}function o(){if(A)return;var a=s.val();if(a){s.val("");for(var b=0;b<a.length;b+=1)q.parent.textInput(a.charAt(b))}else(q.selection||t!==P)&&h()}var p=a.contents().detach();d||a.addClass("mathquill-rendered-math"),c.jQ=a.data(R,{block:c,revert:function(){a.empty().unbind(".mathquill").removeClass("mathquill-rendered-math mathquill-editable mathquill-textbox mathquill-editor").append(p)}});var q=c.cursor=new N(c);c.renderLatex(p.text());var r=c.textarea=b('<span class="textarea"><textarea></textarea></span>'),s=r.children();f&&i(c,a);var t;c.selectionChanged=function(){t===P&&(t=setTimeout(h)),X(a[0])},a.bind("selectstart.mathquill",function(a){a.target!==s[0]&&a.preventDefault(),a.stopPropagation()});var u,v=q.blink;a.bind("mousedown.mathquill",function(c){q.blink=b.noop,q.seek(b(c.target),c.pageX,c.pageY),u=new g(q.parent,q.prev,q.next),e||a.prepend(r),a.mousemove(j),b(document).mousemove(k).mouseup(l),c.stopPropagation()});if(!e){a.bind("cut paste",!1).bind("copy",h).prepend('<span class="selectable">$'+c.latex()+"$</span>"),s.blur(function(){q.clearSelection(),setTimeout(w)});function w(){r.detach()}return}a.prepend(r),a.addClass("mathquill-editable"),d&&a.addClass("mathquill-textbox"),s.focus(function(a){q.parent||q.appendTo(c),q.parent.jQ.addClass("hasCursor"),q.selection?(q.selection.jQ.removeClass("blur"),setTimeout(c.selectionChanged)):q.show(),a.stopPropagation()}).blur(function(a){q.hide().parent.blur(),q.selection&&q.selection.jQ.addClass("blur"),a.stopPropagation()}),a.bind("focus.mathquill blur.mathquill",function(a){s.trigger(a)}).bind("mousedown.mathquill",function(){setTimeout(m)}).bind("click.mathquill",m).blur(),a.bind("cut",function(a){h(),q.selection&&setTimeout(function(){q.deleteSelection(),q.redraw()}),a.stopPropagation()}).bind("copy",function(a){h(),A=!0,a.stopPropagation()}).bind("paste",function(a){A=!0,setTimeout(n),a.stopPropagation()});var x,y,z,A=!1;a.bind("keydown.mathquill",function(a){x=a,y=!0,q.parent.keydown(a)===!1&&a.preventDefault()}).bind("keypress.mathquill",function(a){if(y)y=!1;else{if(z!==a.which)return;q.parent.keydown(x)}z=a.which,t!==P&&clearTimeout(t),A=!1,setTimeout(o)})}function i(c,d){var e=[{name:a.t("tabs.basic","Basic"),example:"+",button_groups:[["subscript","supscript","frac","sqrt","nthroot","langle","binomial","vector","f","prime"],["+","-","pm","mp","cdot","=","times","div","ast"],["therefore","because"],["sum","prod","coprod","int"],["N","P","Z","Q","R","C","H"]]},{name:a.t("tabs.greek","Greek"),example:"&pi;",button_groups:[["alpha","beta","gamma","delta","epsilon","zeta","eta","theta","iota","kappa","lambda","mu","nu","xi","pi","rho","sigma","tau","upsilon","phi","chi","psi","omega"],["digamma","varepsilon","vartheta","varkappa","varpi","varrho","varsigma","varphi"],["Gamma","Delta","Theta","Lambda","Xi","Pi","Sigma","Upsilon","Phi","Psi","Omega"]]},{name:a.t("tabs.operators","Operators"),example:"&oplus;",button_groups:[["wedge","vee","cup","cap","diamond","bigtriangleup","ominus","uplus","otimes","oplus","bigtriangledown","sqcap","triangleleft","sqcup","triangleright","odot","bigcirc","dagger","ddagger","wr","amalg"]]},{name:a.t("tabs.relationships","Relationships"),example:"&le;",button_groups:[["<",">","equiv","cong","sim","notin","ne","propto","approx","le","ge","in","ni","notni","subset","supset","notsubset","notsupset","subseteq","supseteq","notsubseteq","notsupseteq","models","prec","succ","preceq","succeq","simeq","mid","ll","gg","parallel","bowtie","sqsubset","sqsupset","smile","sqsubseteq","sqsupseteq","doteq","frown","vdash","dashv","exists","varnothing"]]},{name:a.t("tabs.arrows","Arrows"),example:"&hArr;",button_groups:[["longleftarrow","longrightarrow","Longleftarrow","Longrightarrow","longleftrightarrow","updownarrow","Longleftrightarrow","Updownarrow","mapsto","nearrow","hookleftarrow","hookrightarrow","searrow","leftharpoonup","rightharpoonup","swarrow","leftharpoondown","rightharpoondown","nwarrow","downarrow","Downarrow","uparrow","Uparrow","rightarrow","Rightarrow","leftarrow","lArr","leftrightarrow","Leftrightarrow"]]},{name:a.t("tabs.delimiters","Delimiters"),example:"{",button_groups:[["lfloor","rfloor","lceil","rceil","slash","opencurlybrace","closecurlybrace"]]},{name:a.t("tabs.miscellaneous","Misc"),example:"&infin;",button_groups:[["forall","ldots","cdots","vdots","ddots","surd","triangle","ell","top","flat","natural","sharp","wp","bot","clubsuit","diamondsuit","heartsuit","spadesuit","caret","underscore","backslash","vert","perp","nabla","hbar","AA","circ","bullet","setminus","neg","dots","Re","Im","partial","infty","aleph","deg","angle"]]}],f={binomial:'<span style="font-size: 0.5em"><span class="paren" style="font-size: 2.087912087912088em; ">(</span><span class="array"><span><var>n</var></span><span><var>m</var></span></span><span class="paren" style="font-size: 2.087912087912088em; ">)</span></span>',frac:'<span style="font-size: 0.55em; vertical-align: middle" class="fraction"><span class="numerator"><var>n</var></span><span class="denominator"><var>m</var></span><span style="width:0"></span></span>',sqrt:'<span class="block"><span class="sqrt-prefix">&radic;</span><span class="sqrt-stem">&nbsp;</span></span>',nthroot:'<span style="font-size: 0.7em"><sup class="nthroot"><var>n</var></sup><span class="block"><span class="sqrt-prefix">&radic;</span><span class="sqrt-stem">&nbsp;</span></span></span>',supscript:'<sup style="font-size: 0.6em">sup</sup>',subscript:'<sub style="font-size: 0.6em; line-height: 3.5;">sub</sub>',vector:'<span class="array" style="vertical-align: middle; font-size: 0.4em; line-height: 0.9em"><span>1</span><span>2</span><span>3</span></span>'},g=[],h=[];b.each(e,function(a,c){g.push('<li><a href="#'+c.name+'_tab"><span class="mathquill-rendered-math">'+c.example+"</span>"+c.name+"</a></li>");var d=[];b.each(c.button_groups,function(a,c){b.each(c,function(a,b){var c=new V[b](P,b);d.push('<li><a class="mathquill-rendered-math" title="'+(b.match(/^[a-z]+$/i)?"\\"+b:b)+'">'+(f[b]?f[b]:'<span style="line-height: 1.5em">'+c.html_template.join("")+"</span>")+"</a></li>")}),d.push('<li class="mathquill-button-spacer"></li>')}),h.push('<div class="mathquill-tab-pane" id="'+c.name+'_tab"><ul>'+d.join("")+"</ul></div>")}),c.toolbar=b('<div class="mathquill-toolbar"><ul class="mathquill-tab-bar">'+g.join("")+'</ul><div class="mathquill-toolbar-panes">'+h.join("")+"</div></div>").prependTo(d),d.find(".mathquill-tab-bar li a").mouseenter(function(){d.find(".mathquill-tab-bar li").removeClass("mathquill-tab-selected"),d.find(".mathquill-tab-pane").removeClass("mathquill-tab-pane-selected"),b(this).parent().addClass("mathquill-tab-selected"),b(this.href.replace(/.*#/,"#")).addClass("mathquill-tab-pane-selected")}),d.find(".mathquill-tab-bar li:first-child a").mouseenter(),d.find("a.mathquill-rendered-math").mousedown(function(a){a.stopPropagation()}).click(function(){c.cursor.writeLatex(this.title,!0),d.focus()})}function j(){}function k(a){this.init("$"),this.firstChild.cursor=a,this.firstChild.textInput=function(b){if(this.skipTextInput)return;b!=="$"||a.parent!==this?a.write(b):this.isEmpty()?a.insertAfter(this.parent).backspace().insertNew(new H("\\$","$")).show():a.next?a.prev?a.write(b):a.insertBefore(this.parent):a.insertAfter(this.parent)}}function l(){}function m(a,b){return b.prototype=a.prototype,b}function n(a){var b=Array.prototype.slice.call(arguments,1);return m(a,function(){a.apply(this,Array.prototype.concat.apply(b,arguments))})}function o(a,b,c){this.init(a,[b],P,c)}function p(a,b,c,d){this.init(a,[b],[c],d)}function q(a){this.init("\\frac",P,P,a),this.jQ.append('<span style="display:inline-block;width:0">&nbsp;</span>')}function r(){q.apply(this,arguments)}function s(a){this.init("\\sqrt",P,P,a)}function t(a){s.call(this,a),this.jQ=this.firstChild.jQ.detach().add(this.jQ)}function u(a,b,c,d,e){this.init("\\left"+c,['<span class="block"><span class="paren">'+a+'</span><span class="block"></span><span class="paren">'+b+"</span></span>"],[a,b],e),this.end="\\right"+d}function v(a,b,c,d,e){u.apply(this,arguments)}function w(a,b,c){u.call(this,a,b,a,b,c)}function x(a,b,c){v.call(this,a,b,a,b,c)}function y(a){w.call(this,"|","|",a)}function z(a){a instanceof g?this.replacedText=a.remove().jQ.text():typeof a=="string"&&(this.replacedText=a),this.init()}function A(){}function B(a,b){function c(){z.apply(this,arguments)}return Q=c.prototype=new z,Q.cmd=a,Q.html_template=[b],c}function C(a){this.init("\\"),a&&(this.replacedFragment=a.detach(),this.isEmpty=function(){return!1})}function D(a){this.init("\\binom",P,P,a),this.jQ.wrapInner('<span class="array"></span>'),this.blockjQ=this.jQ.children(),this.bracketjQs=b('<span class="paren">(</span>').prependTo(this.jQ).add(b('<span class="paren">)</span>').appendTo(this.jQ))}function E(){D.apply(this,arguments)}function F(a){this.init("\\vector",P,P,a)}function G(a,b){e.call(this,a,"<var>"+(b||a)+"</var>")}function H(a,b){e.call(this,a,"<span>"+(b||a)+"</span>")}function I(a,b){e.call(this,a,'<span class="nonSymbola">'+(b||a)+"</span>")}function J(a,b,c){e.call(this,a,'<span class="binary-operator">'+b+"</span>",c)}function K(a,b){H.apply(this,arguments)}function L(a,b){e.call(this,a,"<big>"+b+"</big>")}function M(a,b){e.call(this,"\\"+b+" ","<span>"+b+"</span>")}function N(a){this.parent=this.root=a;var c=this.jQ=this._jQ=b('<span class="cursor">&zwj;</span>');this.blink=function(){c.toggleClass("blink")}}function O(a,b,c){g.apply(this,arguments)}var P,Q,R="[[mathquill internal data]]",S=Math.min,T=Math.max;Q=c.prototype,Q.prev=0,Q.next=0,Q.parent=0,Q.firstChild=0,Q.lastChild=0,Q.eachChild=function(a){for(var b=this.firstChild;b;b=b.next)if(a.call(this,b)===!1)break;return this},Q.foldChildren=function(a,b){return this.eachChild(function(c){a=b.call(this,a,c)}),a},Q.keydown=function(a){return this.parent.keydown(a)},Q.textInput=function(a){return this.parent.textInput(a)},Q=d.prototype=new c,Q.init=function(a,c,d,e){var f=this;a&&(f.cmd=a),c&&(f.html_template=c),d&&(f.text_template=d),f.jQ=b(f.html_template[0]).data(R,{cmd:f}),f.initBlocks(e)},Q.initBlocks=function(a){var c=this;if(c.html_template.length===1){c.firstChild=c.lastChild=c.jQ.data(R).block=a&&a.blockify()||new f,c.firstChild.parent=c,c.firstChild.jQ=c.jQ.append(c.firstChild.jQ);return}var d,e,g=c.html_template.length;this.firstChild=d=e=a&&a.blockify()||new f,d.parent=c,d.jQ=b(c.html_template[1]).data(R,{block:d}).append(d.jQ).appendTo(c.jQ),d.blur();for(var h=2;h<g;h+=1)d=new f,d.parent=c,d.prev=e,e.next=d,e=d,d.jQ=b(c.html_template[h]).data(R,{block:d}).appendTo(c.jQ),d.blur();c.lastChild=d},Q.latex=function(){return this.foldChildren(this.cmd,function(a,b){return a+"{"+(b.latex()||" ")+"}"})},Q.text_template=[""],Q.text=function(){var a=0;return this.foldChildren(this.text_template[a],function(b,c){a+=1;var d=c.text();return b&&this.text_template[a]==="("&&d[0]==="("&&d.slice(-1)===")"?b+d.slice(1,-1)+this.text_template[a]:b+c.text()+(this.text_template[a]||"")})},Q.insertAt=function(a){var b=this;b.parent=a.parent,b.next=a.next,b.prev=a.prev,a.prev?a.prev.next=b:a.parent.firstChild=b,a.next?a.next.prev=b:a.parent.lastChild=b,a.prev=b,b.jQ.insertBefore(a.jQ),b.respace(),b.next&&b.next.respace(),b.prev&&b.prev.respace(),b.placeCursor(a),a.redraw()},Q.respace=b.noop,Q.placeCursor=function(a){a.appendTo(this.foldChildren(this.firstChild,function(a,b){return a.isEmpty()?a:b}))},Q.isEmpty=function(){return this.foldChildren(!0,function(a,b){return a&&b.isEmpty()})},Q.remove=function(){var a=this,b=a.prev,c=a.next,d=a.parent;return b?b.next=c:d.firstChild=c,c?c.prev=b:d.lastChild=b,a.jQ.remove(),a},Q=e.prototype=new d,Q.initBlocks=b.noop,Q.latex=function(){return this.cmd},Q.text=function(){return this.text_template},Q.placeCursor=b.noop,Q.isEmpty=function(){return!0},Q=f.prototype=new c,Q.latex=function(){return this.foldChildren("",function(a,b){return a+b.latex()})},Q.text=function(){return this.firstChild===this.lastChild?this.firstChild.text():this.foldChildren("(",function(a,b){return a+b.text()})+")"},Q.isEmpty=function(){return this.firstChild===0&&this.lastChild===0},Q.focus=function(){return this.jQ.addClass("hasCursor"),this.isEmpty()&&this.jQ.removeClass("empty"),this},Q.blur=function(){return this.jQ.removeClass("hasCursor"),this.isEmpty()&&this.jQ.addClass("empty"),this},Q=g.prototype,Q.remove=d.prototype.remove,Q.jQinit=function(a){this.jQ=a},Q.each=function(a){for(var b=this.prev.next||this.parent.firstChild;b!==this.next;b=b.next)if(a.call(this,b)===!1)break;return this},Q.fold=function(a,b){return this.each(function(c){a=b.call(this,a,c)}),a},Q.latex=function(){return this.fold("",function(a,b){return a+b.latex()})},Q.blockify=function(){var a=this,b=a.prev,c=a.next,d=a.parent,e=new f,g=e.firstChild=b.next||d.firstChild,h=e.lastChild=c.prev||d.lastChild;return b?b.next=c:d.firstChild=c,c?c.prev=b:d.lastChild=b,g.prev=a.prev=0,h.next=a.next=0,a.parent=e,a.each(function(a){a.parent=e}),e.jQ=a.jQ,e},Q=j.prototype=new f,Q.latex=function(){return f.prototype.latex.call(this).replace(/(\\[a-z]+) (?![a-z])/ig,"$1")},Q.text=function(){return this.foldChildren("",function(a,b){return a+b.text()})},Q.renderLatex=function(a){this.jQ.children().slice(1).remove(),this.firstChild=this.lastChild=0,this.cursor.appendTo(this).writeLatex(a),this.blur()},Q.keydown=function(a){a.ctrlKey=a.ctrlKey||a.metaKey;switch(a.originalEvent&&a.originalEvent.keyIdentifier||a.which){case 8:case"Backspace":case"U+0008":if(a.ctrlKey)while(this.cursor.prev||this.cursor.selection)this.cursor.backspace();else this.cursor.backspace();break;case 27:case"Esc":case"U+001B":case 9:case"Tab":case"U+0009":if(a.ctrlKey)break;var b=this.cursor.parent;if(a.shiftKey){if(b===this.cursor.root)return this.skipTextInput=!0;b.prev?this.cursor.appendTo(b.prev):this.cursor.insertBefore(b.parent)}else{if(b===this.cursor.root)return this.skipTextInput=!0;b.next?this.cursor.prependTo(b.next):this.cursor.insertAfter(b.parent)}this.cursor.clearSelection();break;case 13:case"Enter":break;case 35:case"End":if(a.shiftKey)while(this.cursor.next||a.ctrlKey&&this.cursor.parent!==this)this.cursor.selectRight();else this.cursor.clearSelection().appendTo(a.ctrlKey?this:this.cursor.parent);break;case 36:case"Home":if(a.shiftKey)while(this.cursor.prev||a.ctrlKey&&this.cursor.parent!==this)this.cursor.selectLeft();else this.cursor.clearSelection().prependTo(a.ctrlKey?this:this.cursor.parent);break;case 37:case"Left":if(a.ctrlKey)break;a.shiftKey?this.cursor.selectLeft():this.cursor.moveLeft();break;case 38:case"Up":if(a.ctrlKey)break;if(a.shiftKey)if(this.cursor.prev)while(this.cursor.prev)this.cursor.selectLeft();else this.cursor.selectLeft();else this.cursor.parent.prev?this.cursor.clearSelection().appendTo(this.cursor.parent.prev):this.cursor.prev?this.cursor.clearSelection().prependTo(this.cursor.parent):this.cursor.parent!==this&&this.cursor.clearSelection().insertBefore(this.cursor.parent.parent);break;case 39:case"Right":if(a.ctrlKey)break;a.shiftKey?this.cursor.selectRight():this.cursor.moveRight();break;case 40:case"Down":if(a.ctrlKey)break;if(a.shiftKey)if(this.cursor.next)while(this.cursor.next)this.cursor.selectRight();else this.cursor.selectRight();else this.cursor.parent.next?this.cursor.clearSelection().prependTo(this.cursor.parent.next):this.cursor.next?this.cursor.clearSelection().appendTo(this.cursor.parent):this.cursor.parent!==this&&this.cursor.clearSelection().insertAfter(this.cursor.parent.parent);break;case 46:case"Del":case"U+007F":if(a.ctrlKey)while(this.cursor.next||this.cursor.selection)this.cursor.deleteForward();else this.cursor.deleteForward();break;case 65:case"A":case"U+0041":if(a.ctrlKey&&!a.shiftKey&&!a.altKey){if(this!==this.cursor.root)return this.parent.keydown(a);this.cursor.clearSelection().appendTo(this);while(this.cursor.prev)this.cursor.selectLeft();break};default:return this.skipTextInput=!1,!0}return this.skipTextInput=!0,!1},Q.textInput=function(a){this.skipTextInput||this.cursor.write(a)},Q=k.prototype=new d,Q.html_template=['<span class="mathquill-rendered-math"></span>'],Q.initBlocks=function(){this.firstChild=this.lastChild=this.jQ.data(R).block=new j,this.firstChild.parent=this,this.firstChild.jQ=this.jQ},Q.latex=function(){return"$"+this.firstChild.latex()+"$"},Q=l.prototype=new f,Q.renderLatex=function(a){var b=this,c=b.cursor;b.jQ.children().slice(1).remove(),b.firstChild=b.lastChild=0,c.show().appendTo(b),a=a.match(/(?:\\\$|[^$])+|\$(?:\\\$|[^$])*\$|\$(?:\\\$|[^$])*$/g)||"";for(var d=0;d<a.length;d+=1){var e=a[d];if(e[0]==="$"){e[-1+e.length]==="$"&&e[-2+e.length]!=="\\"?e=e.slice(1,-1):e=e.slice(1);var f=new k(c);c.insertNew(f),f.firstChild.renderLatex(e),c.show().insertAfter(f)}else for(var g=0;g<e.length;g+=1)this.cursor.insertNew(new H(e[g]))}},Q.keydown=j.prototype.keydown,Q.textInput=function(a){if(this.skipTextInput)return;this.cursor.deleteSelection(),a==="$"?this.cursor.insertNew(new k(this.cursor)):this.cursor.insertNew(new H(a))};var U={},V={},W,X=b.noop,Y=document.createElement("div"),Z=Y.style,$={transform:1,WebkitTransform:1,MozTransform:1,OTransform:1,msTransform:1},_;for(var ba in $)if(ba in Z){_=ba;break}_?W=function(a,b,c){a.css(_,"scale("+b+","+c+")")}:"filter"in Z?(X=function(a){a.className=a.className},W=function(a,c,d){function e(){a.css("marginRight",(1+a.width())*(c-1)/c+"px")}c/=1+(d-1)/2,a.addClass("matrixed").css({fontSize:d+"em",marginTop:"-.1em",filter:"progid:DXImageTransform.Microsoft.Matrix(M11="+c+",SizingMethod='auto expand')"}),e();var f=setInterval(e);b(window).load(function(){clearTimeout(f),e()})}):W=function(a,b,c){a.css("fontSize",c+"em")},m(d,o),V.mathrm=n(o,"\\mathrm",'<span class="roman font"></span>'),V.mathit=n(o,"\\mathit",'<i class="font"></i>'),V.mathbf=n(o,"\\mathbf",'<b class="font"></b>'),V.mathsf=n(o,"\\mathsf",'<span class="sans-serif font"></span>'),V.mathtt=n(o,"\\mathtt",'<span class="monospace font"></span>'),V.underline=n(o,"\\underline",'<span class="underline"></span>'),V.overline=V.bar=n(o,"\\overline",'<span class="overline"></span>'),Q=p.prototype=new d,Q.latex=function(){var a=this.firstChild.latex();return a.length===1?this.cmd+a:this.cmd+"{"+(a||" ")+"}"},Q.redraw=function(){this.prev&&this.prev.respace(),this.prev instanceof p||(this.respace(),this.next&&!(this.next instanceof p)&&this.next.respace())},Q.respace=function(){this.prev.cmd==="\\int "||this.prev instanceof p&&this.prev.cmd!=this.cmd&&this.prev.prev&&this.prev.prev.cmd==="\\int "?this.limit||(this.limit=!0,this.jQ.addClass("limit")):this.limit&&(this.limit=!1,this.jQ.removeClass("limit")),this.respaced=this.prev instanceof p&&this.prev.cmd!=this.cmd&&!this.prev.respaced;if(this.respaced){var a=+this.jQ.css("fontSize").slice(0,-2),b=this.prev.jQ.outerWidth();thisWidth=this.jQ.outerWidth(),this.jQ.css({left:(this.limit&&this.cmd==="_"?-0.25:0)-b/a+"em",marginRight:.1-S(thisWidth,b)/a+"em"})}else this.limit&&this.cmd==="_"?this.jQ.css({left:"-.25em",marginRight:""}):this.jQ.css({left:"",marginRight:""});return this.next instanceof p&&this.next.respace(),this},V.subscript=V._=m(p,function(a){p.call(this,"_","<sub></sub>","_",a)}),V.superscript=V.supscript=V["^"]=m(p,function(a){p.call(this,"^","<sup></sup>","**",a)}),Q=q.prototype=new d,Q.html_template=['<span class="fraction"></span>','<span class="numerator"></span>','<span class="denominator"></span>'],Q.text_template=["(","/",")"],V.frac=V.dfrac=V.cfrac=V.fraction=q,Q=r.prototype=new q,Q.placeCursor=function(a){if(this.firstChild.isEmpty()){var b=this.prev;while(b&&!(b instanceof J||b instanceof z||b instanceof L))b=b.prev;b instanceof L&&b.next instanceof p&&(b=b.next,b.next instanceof p&&b.next.cmd!=b.cmd&&(b=b.next));if(b!==this.prev){var c=(new g(this.parent,b,this)).blockify();c.jQ=this.firstChild.jQ.empty().removeClass("empty").append(c.jQ).data(R,{block:c}),c.next=this.lastChild,c.parent=this,this.firstChild=this.lastChild.prev=c}}a.appendTo(this.lastChild)},V.over=U["/"]=r,Q=s.prototype=new d,Q.html_template=['<span class="block"><span class="sqrt-prefix">&radic;</span></span>','<span class="sqrt-stem"></span>'],Q.text_template=["sqrt(",")"],Q.redraw=function(){var a=this.lastChild.jQ;W(a.prev(),1,a.innerHeight()/+a.css("fontSize").slice(0,-2)-.1)},Q.optional_arg_command="nthroot",V.sqrt=V["√"]=s,Q=t.prototype=new s,Q.html_template=['<span class="block"><span class="sqrt-prefix">&radic;</span></span>','<sup class="nthroot"></sup>','<span class="sqrt-stem"></span>'],Q.text_template=["sqrt[","](",")"],Q.latex=function(){return"\\sqrt["+this.firstChild.latex()+"]{"+this.lastChild.latex()+"}"},V.nthroot=t,Q=u.prototype=new d,Q.initBlocks=function(a){this.firstChild=this.lastChild=a&&a.blockify()||new f,this.firstChild.parent=this,this.firstChild.jQ=this.jQ.children(":eq(1)").data(R,{block:this.firstChild}).append(this.firstChild.jQ);var b=this.blockjQ=this.firstChild.jQ;this.bracketjQs=b.prev().add(b.next())},Q.latex=function(){return this.cmd+this.firstChild.latex()+this.end},Q.redraw=function(){var a=this.blockjQ.outerHeight()/+this.blockjQ.css("fontSize").slice(0,-2);W(this.bracketjQs,S(1+.2*(a-1),1.2),1.05*a)},V.lbrace=U["{"]=m(u,function(a){u.call(this,"{","}","\\{","\\}",a)}),V.langle=V.lang=m(u,function(a){u.call(this,"&lang;","&rang;","\\langle ","\\rangle ",a)}),Q=v.prototype=new u,Q.placeCursor=function(a){!this.next&&this.parent.parent&&this.parent.parent.end===this.end&&this.firstChild.isEmpty()?a.backspace().insertAfter(this.parent.parent):(this.firstChild.blur(),this.redraw())},V.rbrace=U["}"]=m(v,function(a){v.call(this,"{","}","\\{","\\}",a)}),V.rangle=V.rang=m(v,function(a){v.call(this,"&lang;","&rang;","\\langle ","\\rangle ",a)}),w.prototype=u.prototype,V.lparen=U["("]=m(w,function(a){w.call(this,"(",")",a)}),V.lbrack=V.lbracket=U["["]=m(w,function(a){w.call(this,"[","]",a)}),x.prototype=v.prototype,V.rparen=U[")"]=m(x,function(a){x.call(this,"(",")",a)}),V.rbrack=V.rbracket=U["]"]=m(x,function(a){x.call(this,"[","]",a)}),Q=y.prototype=new w,Q.placeCursor=function(a){!this.next&&this.parent.parent&&this.parent.parent.end===this.end&&this.firstChild.isEmpty()?a.backspace().insertAfter(this.parent.parent):a.appendTo(this.firstChild)},V.lpipe=V.rpipe=U["|"]=y,Q=z.prototype=new d,Q.cmd="\\text",Q.html_template=['<span class="text"></span>'],Q.text_template=['"','"'],Q.initBlocks=function(){this.firstChild=this.lastChild=this.jQ.data(R).block=new A,this.firstChild.parent=this,this.firstChild.jQ=this.jQ.append(this.firstChild.jQ)},Q.placeCursor=function(a){(this.cursor=a).appendTo(this.firstChild);if(this.replacedText)for(var b=0;b<this.replacedText.length;b+=1)this.write(this.replacedText.charAt(b))},Q.write=function(a){this.cursor.insertNew(new H(a))},Q.keydown=function(a){return!this.cursor.selection&&(a.which===8&&!this.cursor.prev||a.which===46&&!this.cursor.next)?(this.isEmpty()&&this.cursor.insertAfter(this),!1):this.parent.keydown(a)},Q.textInput=function(a){this.cursor.deleteSelection();if(a!=="$")this.write(a);else if(this.isEmpty())this.cursor.insertAfter(this).backspace().insertNew(new H("\\$","$"));else if(!this.cursor.next)this.cursor.insertAfter(this);else if(!this.cursor.prev)this.cursor.insertBefore(this);else{var b=new z(new g(this.firstChild,this.cursor.prev));b.placeCursor=function(a){this.prev=0,delete this.placeCursor,this.placeCursor(a)},b.firstChild.focus=function(){return this},this.cursor.insertAfter(this).insertNew(b),b.prev=this,this.cursor.insertBefore(b),delete b.firstChild.focus}},Q=A.prototype=new f,Q.blur=function(){this.jQ.removeClass("hasCursor");if(this.isEmpty()){var a=this.parent,b=a.cursor;b.parent===this?this.jQ.addClass("empty"):(b.hide(),a.remove(),b.next===a?b.next=a.next:b.prev===a&&(b.prev=a.prev),b.show().redraw())}return this},Q.focus=function(){f.prototype.focus.call(this);var a=this.parent;if(a.next.cmd===a.cmd){var b=this,c=a.cursor,d=a.next.firstChild;d.eachChild(function(a){a.parent=b,a.jQ.appendTo(b.jQ)}),this.lastChild?this.lastChild.next=d.firstChild:this.firstChild=d.firstChild,d.firstChild.prev=this.lastChild,this.lastChild=d.lastChild,d.parent.remove(),c.prev?c.insertAfter(c.prev):c.prependTo(this),c.redraw()}else if(a.prev.cmd===a.cmd){var c=a.cursor;c.prev?a.prev.firstChild.focus():c.appendTo(a.prev.firstChild)}return this},U.$=V.text=V.textnormal=V.textrm=V.textup=V.textmd=z,V.em=V.italic=V.italics=V.emph=V.textit=V.textsl=B("\\textit",'<i class="text"></i>'),V.strong=V.bold=V.textbf=B("\\textbf",'<b class="text"></b>'),V.sf=V.textsf=B("\\textsf",'<span class="sans-serif text"></span>'),V.tt=V.texttt=B("\\texttt",'<span class="monospace text"></span>'),V.textsc=B("\\textsc",'<span style="font-variant:small-caps" class="text"></span>'),V.uppercase=B("\\uppercase",'<span style="text-transform:uppercase" class="text"></span>'),V.lowercase=B("\\lowercase",'<span style="text-transform:lowercase" class="text"></span>'),Q=C.prototype=new d,Q.html_template=['<span class="latex-command-input">\\</span>'],Q.text_template=["\\"],Q.placeCursor=function(a){this.cursor=a.appendTo(this.firstChild),this.replacedFragment&&(this.jQ=this.jQ.add(this.replacedFragment.jQ.addClass("blur").bind("mousedown mousemove",function(a){return b(a.target=this.nextSibling).trigger(a),!1}).insertBefore(this.jQ)))},Q.latex=function(){return"\\"+this.firstChild.latex()+" "},Q.keydown=function(a){return a.which===9||a.which===13?(this.renderCommand(),!1):this.parent.keydown(a)},Q.textInput=function(a){if(a.match(/[a-z:]/i)){this.cursor.deleteSelection(),this.cursor.insertNew(new H(a));return}this.renderCommand();if(a===" "||a==="\\"&&this.firstChild.isEmpty())return;this.cursor.parent.textInput(a)},Q.renderCommand=function(){this.jQ=this.jQ.last(),this.remove(),this.next?this.cursor.insertBefore(this.next):this.cursor.appendTo(this.parent);var a=this.firstChild.latex();if(a)this.cursor.insertCmd(a,this.replacedFragment);else{var b=new H("\\backslash ","\\");this.cursor.insertNew(b),this.replacedFragment&&this.replacedFragment.remove()}},U["\\"]=C,Q=D.prototype=new d,Q.html_template=['<span class="block"></span>',"<span></span>","<span></span>"],Q.text_template=["choose(",",",")"],Q.redraw=u.prototype.redraw,V.binom=V.binomial=D,Q=E.prototype=new D,Q.placeCursor=r.prototype.placeCursor,V.choose=E,Q=F.prototype=new d,Q.html_template=['<span class="array"></span>',"<span></span>"],Q.latex=function(){return"\\begin{matrix}"+this.foldChildren([],function(a,b){return a.push(b.latex()),a}).join("\\\\")+"\\end{matrix}"},Q.text=function(){return"["+this.foldChildren([],function(a,b){return a.push(b.text()),a}).join()+"]"},Q.placeCursor=function(a){this.cursor=a.appendTo(this.firstChild)},Q.keydown=function(a){var c=this.cursor.parent;if(c.parent===this){if(a.which===13){var d=new f;return d.parent=this,d.jQ=b("<span></span>").data(R,{block:d}).insertAfter(c.jQ),c.next?c.next.prev=d:this.lastChild=d,d.next=c.next,c.next=d,d.prev=c,this.cursor.appendTo(d).redraw(),!1}if(a.which===9&&!a.shiftKey&&!c.next){if(c.isEmpty())return c.prev?(this.cursor.insertAfter(this),delete c.prev.next,this.lastChild=c.prev,c.jQ.remove(),this.cursor.redraw(),!1):this.parent.keydown(a);var d=new f;return d.parent=this,d.jQ=b("<span></span>").data(R,{block:d}).appendTo(this.jQ),this.lastChild=d,c.next=d,d.prev=c,this.cursor.appendTo(d).redraw(),!1}if(a.which===8){if(c.isEmpty())return c.prev?(this.cursor.appendTo(c.prev),c.prev.next=c.next):(this.cursor.insertBefore(this),this.firstChild=c.next),c.next?c.next.prev=c.prev:this.lastChild=c.prev,c.jQ.remove(),this.isEmpty()?this.cursor.deleteForward():this.cursor.redraw(),!1;if(!this.cursor.prev)return!1}}return this.parent.keydown(a)},V.vector=F,V.editable=m(k,function(){this.init("\\editable"),h(this.jQ,this.firstChild,!1,!0);var a;this.placeCursor=function(b){a=b.appendTo(this.firstChild)},this.firstChild.blur=function(){if(a.prev!==this.parent)return;delete this.blur,this.cursor.appendTo(this),f.prototype.blur.call(this)},this.latex=function(){return this.firstChild.latex()},this.text=function(){return this.firstChild.text()}}),V.f=n(e,"f",'<var class="florin">&fnof;</var><span style="display:inline-block;width:0">&nbsp;</span>'),Q=G.prototype=new e,Q.text=function(){var a=this.cmd;return this.prev&&!(this.prev instanceof G)&&!(this.prev instanceof J)&&(a="*"+a),this.next&&!(this.next instanceof J)&&this.next.cmd!=="^"&&(a+="*"),a},H.prototype=e.prototype,V[":"]=U[" "]=n(H,"\\:"," "),V.prime=U["'"]=n(H,"'","&prime;"),I.prototype=e.prototype,V["@"]=I,V["&"]=n(I,"\\&","&"),V["%"]=n(I,"\\%","%"),V.alpha=V.beta=V.gamma=V.delta=V.zeta=V.eta=V.theta=V.iota=V.kappa=V.mu=V.nu=V.xi=V.rho=V.sigma=V.tau=V.chi=V.psi=V.omega=m(e,function(a,b){G.call(this,"\\"+b+" ","&"+b+";")}),V.phi=n(G,"\\phi ","&#981;"),V.phiv=V.varphi=n(G,"\\varphi ","&phi;"),V.epsilon=n(G,"\\epsilon ","&#1013;"),V.epsiv=V.varepsilon=n(G,"\\varepsilon ","&epsilon;"),V.piv=V.varpi=n(G,"\\varpi ","&piv;"),V.sigmaf=V.sigmav=V.varsigma=n(G,"\\varsigma ","&sigmaf;"),V.thetav=V.vartheta=V.thetasym=n(G,"\\vartheta ","&thetasym;"),V.upsilon=V.upsi=n(G,"\\upsilon ","&upsilon;"),V.gammad=V.Gammad=V.digamma=n(G,"\\digamma ","&#989;"),V.kappav=V.varkappa=n(G,"\\varkappa ","&#1008;"),V.rhov=V.varrho=n(G,"\\varrho ","&#1009;"),V.pi=V["π"]=n(I,"\\pi ","&pi;"),V.lambda=n(I,"\\lambda ","&lambda;"),V.Upsilon=V.Upsi=V.upsih=V.Upsih=n(e,"\\Upsilon ",'<var style="font-family: serif">&upsih;</var>'),V.Gamma=V.Delta=V.Theta=V.Lambda=V.Xi=V.Pi=V.Sigma=V.Phi=V.Psi=V.Omega=V.forall=m(e,function(a,b){H.call(this,"\\"+b+" ","&"+b+";")}),J.prototype=new e,Q=K.prototype=new J,Q.respace=function(){return this.prev?this.prev instanceof J&&this.next&&!(this.next instanceof J)?this.jQ[0].className="unary-operator":this.jQ[0].className="binary-operator":this.jQ[0].className="",this},V["+"]=n(K,"+","+"),V["–"]=V["-"]=n(K,"-","&minus;"),V["±"]=V.pm=V.plusmn=V.plusminus=n(K,"\\pm ","&plusmn;"),V.mp=V.mnplus=V.minusplus=n(K,"\\mp ","&#8723;"),U["*"]=V.sdot=V.cdot=n(J,"\\cdot ","&middot;"),V["="]=n(J,"=","="),V["<"]=n(J,"<","&lt;"),V[">"]=n(J,">","&gt;"),V.notin=V.sim=V.cong=V.equiv=V.oplus=V.otimes=m(J,function(a,b){J.call(this,"\\"+b+" ","&"+b+";")}),V.times=m(J,function(a,b){J.call(this,"\\times ","&times;","[x]")}),V["÷"]=V.div=V.divide=V.divides=n(J,"\\div ","&divide;","[/]"),V["≠"]=V.ne=V.neq=n(J,"\\ne ","&ne;"),V.ast=V.star=V.loast=V.lowast=n(J,"\\ast ","&lowast;"),V.therefor=V.therefore=n(J,"\\therefore ","&there4;"),V.cuz=V.because=n(J,"\\because ","&#8757;"),V.prop=V.propto=n(J,"\\propto ","&prop;"),V["≈"]=V.asymp=V.approx=n(J,"\\approx ","&asymp;"),V.lt=n(J,"<","&lt;"),V.gt=n(J,">","&gt;"),V["≤"]=V.le=V.leq=n(J,"\\le ","&le;"),V["≥"]=V.ge=V.geq=n(J,"\\ge ","&ge;"),V.isin=V["in"]=n(J,"\\in ","&isin;"),V.ni=V.contains=n(J,"\\ni ","&ni;"),V.notni=V.niton=V.notcontains=V.doesnotcontain=n(J,"\\not\\ni ","&#8716;"),V.sub=V.subset=n(J,"\\subset ","&sub;"),V.sup=V.supset=V.superset=n(J,"\\supset ","&sup;"),V.nsub=V.notsub=V.nsubset=V.notsubset=n(J,"\\not\\subset ","&#8836;"),V.nsup=V.notsup=V.nsupset=V.notsupset=V.nsuperset=V.notsuperset=n(J,"\\not\\supset ","&#8837;"),V.sube=V.subeq=V.subsete=V.subseteq=n(J,"\\subseteq ","&sube;"),V.supe=V.supeq=V.supsete=V.supseteq=V.supersete=V.superseteq=n(J,"\\supseteq ","&supe;"),V.nsube=V.nsubeq=V.notsube=V.notsubeq=V.nsubsete=V.nsubseteq=V.notsubsete=V.notsubseteq=n(J,"\\not\\subseteq ","&#8840;"),V.nsupe=V.nsupeq=V.notsupe=V.notsupeq=V.nsupsete=V.nsupseteq=V.notsupsete=V.notsupseteq=V.nsupersete=V.nsuperseteq=V.notsupersete=V.notsuperseteq=n(J,"\\not\\supseteq ","&#8841;"),L.prototype=new e,V["∑"]=V.sum=V.summation=n(L,"\\sum ","&sum;"),V["∏"]=V.prod=V.product=n(L,"\\prod ","&prod;"),V.coprod=V.coproduct=n(L,"\\coprod ","&#8720;"),V["∫"]=V["int"]=V.integral=n(L,"\\int ","&int;"),V.N=V.naturals=V.Naturals=n(H,"\\mathbb{N}","&#8469;"),V.P=V.primes=V.Primes=V.projective=V.Projective=V.probability=V.Probability=n(H,"\\mathbb{P}","&#8473;"),V.Z=V.integers=V.Integers=n(H,"\\mathbb{Z}","&#8484;"),V.Q=V.rationals=V.Rationals=n(H,"\\mathbb{Q}","&#8474;"),V.R=V.reals=V.Reals=n(H,"\\mathbb{R}","&#8477;"),V.C=V.complex=V.Complex=V.complexes=V.Complexes=V.complexplane=V.Complexplane=V.ComplexPlane=n(H,"\\mathbb{C}","&#8450;"),V.H=V.Hamiltonian=V.quaternions=V.Quaternions=n(H,"\\mathbb{H}","&#8461;"),V.quad=V.emsp=n(H,"\\quad ","    "),V.qquad=n(H,"\\qquad ","        "),V.diamond=n(H,"\\diamond ","&#9671;"),V.bigtriangleup=n(H,"\\bigtriangleup ","&#9651;"),V.ominus=n(H,"\\ominus ","&#8854;"),V.uplus=n(H,"\\uplus ","&#8846;"),V.bigtriangledown=n(H,"\\bigtriangledown ","&#9661;"),V.sqcap=n(H,"\\sqcap ","&#8851;"),V.triangleleft=n(H,"\\triangleleft ","&#8882;"),V.sqcup=n(H,"\\sqcup ","&#8852;"),V.triangleright=n(H,"\\triangleright ","&#8883;"),V.odot=n(H,"\\odot ","&#8857;"),V.bigcirc=n(H,"\\bigcirc ","&#9711;"),V.dagger=n(H,"\\dagger ","&#0134;"),V.ddagger=n(H,"\\ddagger ","&#135;"),V.wr=n(H,"\\wr ","&#8768;"),V.amalg=n(H,"\\amalg ","&#8720;"),V.models=n(H,"\\models ","&#8872;"),V.prec=n(H,"\\prec ","&#8826;"),V.succ=n(H,"\\succ ","&#8827;"),V.preceq=n(H,"\\preceq ","&#8828;"),V.succeq=n(H,"\\succeq ","&#8829;"),V.simeq=n(H,"\\simeq ","&#8771;"),V.mid=n(H,"\\mid ","&#8739;"),V.ll=n(H,"\\ll ","&#8810;"),V.gg=n(H,"\\gg ","&#8811;"),V.parallel=n(H,"\\parallel ","&#8741;"),V.bowtie=n(H,"\\bowtie ","&#8904;"),V.sqsubset=n(H,"\\sqsubset ","&#8847;"),V.sqsupset=n(H,"\\sqsupset ","&#8848;"),V.smile=n(H,"\\smile ","&#8995;"),V.sqsubseteq=n(H,"\\sqsubseteq ","&#8849;"),V.sqsupseteq=n(H,"\\sqsupseteq ","&#8850;"),V.doteq=n(H,"\\doteq ","&#8784;"),V.frown=n(H,"\\frown ","&#8994;"),V.vdash=n(H,"\\vdash ","&#8870;"),V.dashv=n(H,"\\dashv ","&#8867;"),V.longleftarrow=n(H,"\\longleftarrow ","&#8592;"),V.longrightarrow=n(H,"\\longrightarrow ","&#8594;"),V.Longleftarrow=n(H,"\\Longleftarrow ","&#8656;"),V.Longrightarrow=n(H,"\\Longrightarrow ","&#8658;"),V.longleftrightarrow=n(H,"\\longleftrightarrow ","&#8596;"),V.updownarrow=n(H,"\\updownarrow ","&#8597;"),V.Longleftrightarrow=n(H,"\\Longleftrightarrow ","&#8660;"),V.Updownarrow=n(H,"\\Updownarrow ","&#8661;"),V.mapsto=n(H,"\\mapsto ","&#8614;"),V.nearrow=n(H,"\\nearrow ","&#8599;"),V.hookleftarrow=n(H,"\\hookleftarrow ","&#8617;"),V.hookrightarrow=n(H,"\\hookrightarrow ","&#8618;"),V.searrow=n(H,"\\searrow ","&#8600;"),V.leftharpoonup=n(H,"\\leftharpoonup ","&#8636;"),V.rightharpoonup=n(H,"\\rightharpoonup ","&#8640;"),V.swarrow=n(H,"\\swarrow ","&#8601;"),V.leftharpoondown=n(H,"\\leftharpoondown ","&#8637;"),V.rightharpoondown=n(H,"\\rightharpoondown ","&#8641;"),V.nwarrow=n(H,"\\nwarrow ","&#8598;"),V.ldots=n(H,"\\ldots ","&#8230;"),V.cdots=n(H,"\\cdots ","&#8943;"),V.vdots=n(H,"\\vdots ","&#8942;"),V.ddots=n(H,"\\ddots ","&#8944;"),V.surd=n(H,"\\surd ","&#8730;"),V.triangle=n(H,"\\triangle ","&#9653;"),V.ell=n(H,"\\ell ","&#8467;"),V.top=n(H,"\\top ","&#8868;"),V.flat=n(H,"\\flat ","&#9837;"),V.natural=n(H,"\\natural ","&#9838;"),V.sharp=n(H,"\\sharp ","&#9839;"),V.wp=n(H,"\\wp ","&#8472;"),V.bot=n(H,"\\bot ","&#8869;"),V.clubsuit=n(H,"\\clubsuit ","&#9827;"),V.diamondsuit=n(H,"\\diamondsuit ","&#9826;"),V.heartsuit=n(H,"\\heartsuit ","&#9825;"),V.spadesuit=n(H,"\\spadesuit ","&#9824;"),V.oint=n(H,"\\oint ","&#8750;"),V.bigcap=n(H,"\\bigcap ","&#8745;"),V.bigcup=n(H,"\\bigcup ","&#8746;"),V.bigsqcup=n(H,"\\bigsqcup ","&#8852;"),V.bigvee=n(H,"\\bigvee ","&#8744;"),V.bigwedge=n(H,"\\bigwedge ","&#8743;"),V.bigodot=n(H,"\\bigodot ","&#8857;"),V.bigotimes=n(H,"\\bigotimes ","&#8855;"),V.bigoplus=n(H,"\\bigoplus ","&#8853;"),V.biguplus=n(H,"\\biguplus ","&#8846;"),V.lfloor=n(H,"\\lfloor ","&#8970;"),V.rfloor=n(H,"\\rfloor ","&#8971;"),V.lceil=n(H,"\\lceil ","&#8968;"),V.rceil=n(H,"\\rceil ","&#8969;"),V.slash=n(H,"\\slash ","&#47;"),V.opencurlybrace=n(H,"\\opencurlybrace ","&#123;"),V.closecurlybrace=n(H,"\\closecurlybrace ","&#125;"),V.caret=n(H,"\\caret ","^"),V.underscore=n(H,"\\underscore ","_"),V.backslash=n(H,"\\backslash ","\\"),V.vert=n(H,"|"),V.perp=V.perpendicular=n(H,"\\perp ","&perp;"),V.nabla=V.del=n(H,"\\nabla ","&nabla;"),V.hbar=n(H,"\\hbar ","&#8463;"),V.AA=V.Angstrom=V.angstrom=n(H,"\\text\\AA ","&#8491;"),V.ring=V.circ=V.circle=n(H,"\\circ ","&#8728;"),V.bull=V.bullet=n(H,"\\bullet ","&bull;"),V.setminus=V.smallsetminus=n(H,"\\setminus ","&#8726;"),V.not=V["¬"]=V.neg=n(H,"\\neg ","&not;"),V["…"]=V.dots=V.ellip=V.hellip=V.ellipsis=V.hellipsis=n(H,"\\dots ","&hellip;"),V.converges=V.darr=V.dnarr=V.dnarrow=V.downarrow=n(H,"\\downarrow ","&darr;"),V.dArr=V.dnArr=V.dnArrow=V.Downarrow=n(H,"\\Downarrow ","&dArr;"),V.diverges=V.uarr=V.uparrow=n(H,"\\uparrow ","&uarr;"),V.uArr=V.Uparrow=n(H,"\\Uparrow ","&uArr;"),V.to=n(J,"\\to ","&rarr;"),V.rarr=V.rightarrow=n(H,"\\rightarrow ","&rarr;"),V.implies=n(J,"\\Rightarrow ","&rArr;"),V.rArr=V.Rightarrow=n(H,"\\Rightarrow ","&rArr;"),V.gets=n(J,"\\gets ","&larr;"),V.larr=V.leftarrow=n(H,"\\leftarrow ","&larr;"),V.impliedby=n(J,"\\Leftarrow ","&lArr;"),V.lArr=V.Leftarrow=n(H,"\\Leftarrow ","&lArr;"),V.harr=V.lrarr=V.leftrightarrow=n(H,"\\leftrightarrow ","&harr;"),V.iff=n(J,"\\Leftrightarrow ","&hArr;"),V.hArr=V.lrArr=V.Leftrightarrow=n(H,"\\Leftrightarrow ","&hArr;"),V.Re=V.Real=V.real=n(H,"\\Re ","&real;"),V.Im=V.imag=V.image=V.imagin=V.imaginary=V.Imaginary=n(H,"\\Im ","&image;"),V.part=V.partial=n(H,"\\partial ","&part;"),V.inf=V.infin=V.infty=V.infinity=n(H,"\\infty ","&infin;"),V.alef=V.alefsym=V.aleph=V.alephsym=n(H,"\\aleph ","&alefsym;"),V.xist=V.xists=V.exist=V.exists=n(H,"\\exists ","&exist;"),V.and=V.land=V.wedge=n(H,"\\wedge ","&and;"),V.or=V.lor=V.vee=n(H,"\\vee ","&or;"),V.o=V.O=V.empty=V.emptyset=V.oslash=V.Oslash=V.nothing=V.varnothing=n(J,"\\varnothing ","&empty;"),V.cup=V.union=n(H,"\\cup ","&cup;"),V.cap=V.intersect=V.intersection=n(H,"\\cap ","&cap;"),V.deg=V.degree=n(H,"^\\circ ","&deg;"),V.ang=V.angle=n(H,"\\angle ","&ang;"),Q=M.prototype=new e,Q.respace=function(){this.jQ[0].className=this.next instanceof p||this.next instanceof u?"":"non-italicized-function"},V.ln=V.lg=V.log=V.span=V.proj=V.det=V.dim=V.min=V.max=V.mod=V.lcm=V.gcd=V.gcf=V.hcf=V.lim=M,function(){var a=["sin","cos","tan","sec","cosec","csc","cotan","cot"];for(var b in a)V[a[b]]=V[a[b]+"h"]=V["a"+a[b]]=V["arc"+a[b]]=V["a"+a[b]+"h"]=V["arc"+a[b]+"h"]=M}(),Q=N.prototype,Q.prev=0,Q.next=0,Q.parent=0,Q.show=function(){return this.jQ=this._jQ.removeClass("blink"),"intervalId"in this?clearInterval(this.intervalId):(this.next?this.selection&&this.selection.prev===this.prev?this.jQ.insertBefore(this.selection.jQ):this.jQ.insertBefore(this.next.jQ.first()):this.jQ.appendTo(this.parent.jQ),this.parent.focus()),this.intervalId=setInterval(this.blink,500),this},Q.hide=function(){return"intervalId"in this&&clearInterval(this.intervalId),delete this.intervalId,this.jQ.detach(),this.jQ=b(),this},Q.redraw=function(){for(var a=this.parent;a;a=a.parent)a.redraw&&a.redraw()},Q.insertAt=function(a,b,c){var d=this.parent;this.parent=a,this.prev=b,this.next=c,d.blur()},Q.insertBefore=function(a){return this.insertAt(a.parent,a.prev,a),this.parent.jQ.addClass("hasCursor"),this.jQ.insertBefore(a.jQ.first()),this},Q.insertAfter=function(a){return this.insertAt(a.parent,a,a.next),this.parent.jQ.addClass("hasCursor"),this.jQ.insertAfter(a.jQ.last()),this},Q.prependTo=function(a){return this.insertAt(a,0,a.firstChild),a.textarea?this.jQ.insertAfter(a.textarea):this.jQ.prependTo(a.jQ),a.focus(),this},Q.appendTo=function(a){return this.insertAt(a,a.lastChild,0),this.jQ.appendTo(a.jQ),a.focus(),this},Q.hopLeft=function(){return this.jQ.insertBefore(this.prev.jQ.first()),this.next=this.prev,this.prev=this.prev.prev,this},Q.hopRight=function(){return this.jQ.insertAfter(this.next.jQ.last()),this.prev=this.next,this.next=this.next.next,this},Q.moveLeft=function(){return this.selection?this.insertBefore(this.selection.prev.next||this.parent.firstChild).clearSelection():this.prev?this.prev.lastChild?this.appendTo(this.prev.lastChild):this.hopLeft():this.parent.prev?this.appendTo(this.parent.prev):this.parent!==this.root&&this.insertBefore(this.parent.parent),this.show()},Q.moveRight=function(){return this.selection?this.insertAfter(this.selection.next.prev||this.parent.lastChild).clearSelection():this.next?this.next.firstChild?this.prependTo(this.next.firstChild):this.hopRight():this.parent.next?this.prependTo(this.parent.next):this.parent!==this.root&&this.insertAfter(this.parent.parent),this.show()},Q.seek=function(a,b,c){var d=this.clearSelection();if(a.hasClass("empty"))return d.prependTo(a.data(R).block),d;var e=a.data(R);if(e){if(e.cmd&&!e.block)return a.outerWidth()>2*(b-a.offset().left)?d.insertBefore(e.cmd):d.insertAfter(e.cmd),d}else a=a.parent(),e=a.data(R),e||(e={block:d.root});e.cmd?d.insertAfter(e.cmd):d.appendTo(e.block);var f=d.jQ.offset().left-b,g;do d.moveLeft(),g=f,f=d.jQ.offset().left-b;while(f>0&&(d.prev||d.parent!==d.root));return-f>g&&d.moveRight(),d},Q.resolveNonItalicizedFunctions=function(){var a=this.prev,b=a?a.latex().replace(/ $/,""):null,c=0,d={ln:1,lg:1,log:1,span:1,proj:1,det:1,dim:1,min:1,max:1,mod:1,lcm:1,gcd:1,gcf:1,hcf:1,lim:1,sin:1,sinh:1,asin:1,arcsin:1,asinh:1,arcsinh:1,cos:1,cosh:1,acos:1,arccos:1,acosh:1,arccosh:1,tan:1,tanh:1,atan:1,arctan:1,atanh:1,arctanh:1,sec:1,sech:1,asec:1,arcsec:1,asech:1,arcsech:1,cosec:1,cosech:1,acosec:1,arccosec:1,acosech:1,arccosech:1,csc:1,csch:1,acsc:1,arccsc:1,acsch:1,arccsch:1,cotan:1,cotanh:1,acotan:1,arccotan:1,acotanh:1,arccotanh:1,cot:1,coth:1,acot:1,arccot:1,acoth:1,arccoth:1},e="";while(a&&b){var f=b.match(/^[a-z]$/);if(!(f||e&&b[0]=="\\"&&d[b.substring(1)]&&d[(b+e).substring(1)]))return;c++,e=b.replace(/\\/,"")+e,a=a.prev,b=a?a.latex().replace(/ $/,""):null;if(!f||(!a||!b.match(/^[a-z]$/))&&d[e]){for(var g=0;g<c;g++)this.selectLeft();this.writeLatex("\\"+e);return}}},Q.writeLatex=function(a,b){return this.deleteSelection(),a=a&&a.match(/\\text\{([^}]|\\\})*\}|\\:|\\[a-z]*|[^\s]/ig)||0,function c(d){while(a.length){var e=a.shift();if(!e||e==="}"||e==="]")return;var f;if(e.slice(0,6)==="\\text{"){f=new z(e.slice(6,-1)),d.insertNew(f).insertAfter(f);continue}if(e==="\\left"||e==="\\right"){e=a.shift(),e==="\\"&&(e=a.shift()),d.insertCh(e),f=d.prev||d.parent.parent;if(d.prev)return;a.unshift("{")}else if(/^\\[a-z:]+$/i.test(e)){e=e.slice(1);var f=V[e];if(f)f=new f(P,e),a[0]==="["&&f.optional_arg_command&&(e=f.optional_arg_command,f=new V[e](P,e)),d.insertNew(f);else{f=new z(e),d.insertNew(f).insertAfter(f);continue}}else e.match(/[a-eg-zA-Z]/)?f=new G(e):(f=V[e])?f=new f:f=new H(e),d.insertNew(f);f.eachChild(function(b){d.appendTo(b);var e=a.shift();if(!e)return!1;e==="{"||e==="["?c(d):d.insertCh(e)}),b||d.insertAfter(f)}}(this),this.hide()},Q.write=function(a){var b=this.show().insertCh(a);return this.root.toolbar&&this.resolveNonItalicizedFunctions(),b},Q.insertCh=function(a){this.selection&&(this.prev=this.selection.prev,this.next=this.selection.next);var b;return a.match(/^[a-eg-zA-Z]$/)?b=new G(a):(b=U[a]||V[a])?b=new b(this.selection,a):b=new H(a),this.selection&&(b instanceof e&&this.selection.remove(),delete this.selection),this.insertNew(b)},Q.insertNew=function(a){return a.insertAt(this),this},Q.insertCmd=function(a,b){var c=V[a];return c?(c=new c(b,a),this.insertNew(c),c instanceof e&&b&&b.remove()):(c=new z(a),c.firstChild.focus=function(){return delete this.focus,this},this.insertNew(c).insertAfter(c),b&&b.remove()),this},Q.unwrapGramp=function(){var a=this.parent.parent,b=a.parent,c=a.prev,d=this;a.eachChild(function(d){if(d.isEmpty())return;d.eachChild(function(c){c.parent=b,c.jQ.insertBefore(a.jQ.first())}),d.firstChild.prev=c,c?c.next=d.firstChild:b.firstChild=d.firstChild,c=d.lastChild}),c.next=a.next,a.next?a.next.prev=c:b.lastChild=c;if(!this.next)if(this.prev)this.next=this.prev.next;else while(!this.next){this.parent=this.parent.next;if(this.parent)this.next=this.parent.firstChild;else{this.next=a.next,this.parent=b;break}}this.next?this.insertBefore(this.next):this.appendTo(b),a.jQ.remove(),a.prev&&a.prev.respace(),a.next&&a.next.respace()},Q.backspace=function(){if(!this.deleteSelection())if(this.prev)this.prev.isEmpty()?this.prev=this.prev.remove().prev:this.selectLeft();else if(this.parent!==this.root){if(this.parent.parent.isEmpty())return this.insertAfter(this.parent.parent).backspace();this.unwrapGramp()}return this.prev&&this.prev.respace(),this.next&&this.next.respace(),this.redraw(),this},Q.deleteForward=function(){if(!this.deleteSelection())if(this.next)this.next.isEmpty()?this.next=this.next.remove().next:this.selectRight();else if(this.parent!==this.root){if(this.parent.parent.isEmpty())return this.insertBefore(this.parent.parent).deleteForward();this.unwrapGramp()}return this.prev&&this.prev.respace(),this.next&&this.next.respace(),this.redraw(),this},Q.selectFrom=function(a){var b=this,c=a;d:for(;;){for(var e=this;e!==b.parent.parent;e=e.parent.parent)if(e.parent===c.parent){g=e,h=c;break d}for(var f=a;f!==c.parent.parent;f=f.parent.parent)if(b.parent===f.parent){g=b,h=f;break d}b.parent.parent&&(b=b.parent.parent),c.parent.parent&&(c=c.parent.parent)}var g,h,i;if(g.next!==h){for(var j=g;j;j=j.next)if(j===h.prev){i=!0;break}i||(i=h,h=g,g=i)}this.hide().selection=new O(g.parent,g.prev,h.next),this.insertAfter(h.next.prev||h.parent.lastChild),this.root.selectionChanged()},Q.selectLeft=function(){if(this.selection)if(this.selection.prev===this.prev)this.prev?(this.hopLeft().next.jQ.prependTo(this.selection.jQ),this.selection.prev=this.prev):this.parent!==this.root&&this.insertBefore(this.parent.parent).selection.levelUp();else{this.prev.jQ.insertAfter(this.selection.jQ),this.hopLeft().selection.next=this.next;if(this.selection.prev===this.prev){this.deleteSelection();return}}else{if(this.prev)this.hopLeft();else if(this.parent!==this.root)this.insertBefore(this.parent.parent);else return;this.hide().selection=new O(this.parent,this.prev,this.next.next)}this.root.selectionChanged()},Q.selectRight=function(){if(this.selection)if(this.selection.next===this.next)this.next?(this.hopRight().prev.jQ.appendTo(this.selection.jQ),this.selection.next=this.next):this.parent!==this.root&&this.insertAfter(this.parent.parent).selection.levelUp();else{this.next.jQ.insertBefore(this.selection.jQ),this.hopRight().selection.prev=this.prev;if(this.selection.next===this.next){this.deleteSelection();return}}else{if(this.next)this.hopRight();else if(this.parent!==this.root)this.insertAfter(this.parent.parent);else return;this.hide().selection=new O(this.parent,this.prev.prev,this.next)}this.root.selectionChanged()},Q.clearSelection=function(){return this.show().selection&&(this.selection.clear(),delete this.selection,this.root.selectionChanged()),this},Q.deleteSelection=function(){return this.show().selection?(this.prev=this.selection.prev,this.next=this.selection.next,this.selection.remove(),delete this.selection,this.root.selectionChanged(),!0):!1},Q=O.prototype=new g,Q.jQinit=function(a){this.jQ=a.wrapAll('<span class="selection"></span>').parent()},Q.levelUp=function(){return this.clear().jQinit(this.parent.parent.jQ),this.prev=this.parent.parent.prev,this.next=this.parent.parent.next,this.parent=this.parent.parent.parent,this},Q.clear=function(){return this.jQ.replaceWith(this.jQ.children()),this},Q.blockify=function(){return this.jQ.replaceWith(this.jQ=this.jQ.children()),g.prototype.blockify.call(this)},Q.detach=function(){var a=g.prototype.blockify.call(this);return this.blockify=function(){return this.jQ.replaceWith(a.jQ=this.jQ=this.jQ.children()),a},this},b.fn.mathquill=function(a,c){switch(a){case"redraw":return this.find(":not(:has(:first))").each(function(){var a=b(this).data(R);a&&(a.cmd||a.block)&&N.prototype.redraw.call(a.cmd||a.block)}),this;case"revert":return this.each(function(){var a=b(this).data(R);a&&a.revert&&a.revert()});case"latex":if(arguments.length>1)return this.each(function(){var a=b(this).data(R);a&&a.block&&a.block.renderLatex&&a.block.renderLatex(c)});var d=this.data(R);return d&&d.block&&d.block.latex();case"text":var d=this.data(R);return d&&d.block&&d.block.text();case"html":return this.html().replace(/ ?hasCursor|hasCursor /,"").replace(/ class=(""|(?= |>))/g,"").replace(/<span class="?cursor( blink)?"?><\/span>/i,"").replace(/<span class="?textarea"?><textarea><\/textarea><\/span>/i,"");case"write":if(arguments.length>1)return this.each(function(){var a=b(this).data(R),d=a&&a.block,e=d&&d.cursor;e&&e.writeLatex(c).parent.blur()});case"cmd":if(arguments.length>1)return this.each(function(){var a=b(this).data(R),d=a&&a.block,e=d&&d.cursor;e&&(e.show(),/^\\[a-z]+$/i.test(c)?(e.selection&&(e.prev=e.selection.prev,e.next=e.selection.next),e.insertCmd(c.slice(1),e.selection),delete e.selection):e.insertCh(c),e.hide().parent.blur())});default:var e=a==="textbox",f=a==="editor",g=f||e||a==="editable",i=e?l:j;return this.each(function(){h(b(this),new i,e,g,f)})}},b(function(){b(".mathquill-editable:not(.mathquill-rendered-math)").mathquill("editable"),b(".mathquill-editor").mathquill("editor"),b(".mathquill-textbox:not(.mathquill-rendered-math)").mathquill("textbox"),b(".mathquill-embedded-latex").mathquill()})})