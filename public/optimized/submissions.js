define(["i18n!submissions","jquery","jquery.ajaxJSON","jquery.instructure_date_and_time","jquery.instructure_misc_plugins","jquery.loadingImg","jquery.templateData","media_comments","vendor/jquery.scrollTo"],function(a,b){b("#content").addClass("padless");var c=1,d=function(c){if(c.submission){var d=[];d.push(c),c=d}for(var f in c){var g=c[f].submission,h=g.visible_submission_comments||g.submission_comments;if(g.user_id!=ENV.SUBMISSION.user_id)continue;for(var i in h){var j=h[i].submission_comment;if(b("#submission_comment_"+j.id).length>0)continue;var k=b("#comment_blank").clone(!0).removeAttr("id");j.posted_at=b.parseFromISO(j.created_at).datetime_formatted,j.anonymous&&(j.author_name=a.t("anonymous","Anonymous")),k.fillTemplateData({data:j,id:"submission_comment_"+j.id});if(j.media_comment_id)$media_comment_link=b("#comment_media_blank").clone(!0).removeAttr("id"),$media_comment_link.fillTemplateData({data:j}),k.find(".comment").empty().append($media_comment_link.show());else for(var f in j.attachments){var l=j.attachments[f].attachment,m=b("#comment_attachment_blank").clone(!0).removeAttr("id");l.comment_id=j.id,m.fillTemplateData({data:l,hrefValues:["comment_id","id"]}),k.find(".comment_attachments").append(m.show())}b(".comments .comment_list").append(k.show()).scrollTop(1e4)}b(".comments .comment_list .play_comment_link").mediaCommentThumbnail("small"),g&&(e(g),b(".submission_details").fillTemplateData({data:g}),b(".grading_comment").val(""),b("#add_comment_form .comment_attachments").empty())}b(".submission_header").loadingImage("remove")},e=function(a){b(".grading_box").val(a.grade!=undefined&&a.grade!==null?a.grade:""),b(".score").text(a.score!=undefined&&a.score!==null?a.score:""),b(".published_score").text(a.published_score!=undefined&&a.published_score!==null?a.published_score:"")};b(document).ready(function(){b(".comments .comment_list .play_comment_link").mediaCommentThumbnail("small"),b(window).bind("resize",function(){var a=b("#preview_frame"),c=a.offset().top,d=b(window).height()-c;a.height(d),b("#rubric_holder").css("maxHeight",d-50).css("overflow","auto").css("zIndex",5),b(".comments").height(d)}).triggerHandler("resize"),b(".comments_link").click(function(a){a.preventDefault(),b(".comments").slideToggle(function(){b(".comments .media_comment_content").empty(),b(".comments textarea:visible").focus().select()})}),b(".save_comment_button").click(function(a){b(document).triggerHandler("grading_change")}),b(".cancel_comment_button").click(function(a){b(".grading_comment").val(""),b(".comments_link").click()}),b(".grading_value").change(function(a){b(document).triggerHandler("grading_change")}),b(document).bind("grading_change",function(c){b(".submission_header").loadingImage();var e=b(".update_submission_url").attr("href"),f=b(".update_submission_url").attr("title"),g={"submission[assignment_id]":ENV.SUBMISSION.assignment_id,"submission[user_id]":ENV.SUBMISSION.user_id,"submission[group_comment]":b("#submission_group_comment").attr("checked")?"1":"0"};b(".grading_value:visible").length>0&&(g["submission[grade]"]=b(".grading_value").val());if(b("#media_media_recording:visible").length>0){var h=b("#media_media_recording").data("comment_id"),i=b("#media_media_recording").data("comment_type");g["submission[media_comment_type]"]=i||"video",g["submission[media_comment_id]"]=h}else b(".grading_comment").val()&&b(".grading_comment").val!=""&&(g["submission[comment]"]=b(".grading_comment").val()),!g["submission[comment]"]&&b("#add_comment_form input[type='file']").length>0&&(g["submission[comment]"]=g["submission[comment]"]||a.t("see_attached_files","See attached files"));if(!g["submission[comment]"]&&!g["submission[grade]"]&&!g["submission[media_comment_id]"])return;b("#add_comment_form input[type='file']").length>0?b.ajaxJSONFiles(e+".text",f,g,b("#add_comment_form input[type='file']"),d):b.ajaxJSON(e,f,g,d)}),b(".attach_comment_file_link").click(function(a){a.preventDefault();var d=b("#comment_attachment_input_blank").clone(!0).removeAttr("id");d.find("input").attr("name","attachments["+c++ +"][uploaded_data]"),b("#add_comment_form .comment_attachments").append(d.slideDown())}),b(".delete_comment_attachment_link").click(function(a){a.preventDefault(),b(this).parents(".comment_attachment_input").slideUp(function(){b(this).remove()})}),b(".save_rubric_button").click(function(){var a=b(this).parents("#rubric_holder").find(".rubric"),c=rubricAssessment.assessmentData(a),d=b(".update_rubric_assessment_url").attr("href"),f="POST";a.loadingImage(),b.ajaxJSON(d,f,c,function(c){a.loadingImage("remove");var d=c,f=!1;d.rubric_association&&(rubricAssessment.updateRubricAssociation(a,c.rubric_association),delete d.rubric_association);for(var g in rubricAssessments){var h=rubricAssessments[g].rubric_assessment;h&&d&&d.id==h.id&&(rubricAssessments[g].rubric_assessment=d,f=!0)}if(!f){rubricAssessments.push(c);var i=b(document.createElement("option"));i.val(d.id).text(d.assessor_name).attr("id","rubric_assessment_option_"+d.id),b("#rubric_assessments_select").prepend(i).val(d.id)}b("#rubric_assessment_option_"+d.id).text(d.assessor_name),b("#new_rubric_assessment_option").remove(),b("#rubric_assessments_list").show(),rubricAssessment.populateRubric(a,d),submission=d.artifact,submission&&e(submission),b("#rubric_holder").fadeOut()})}),b("#rubric_holder .rubric").css("width","auto").css("marginTop",0),b(".hide_rubric_link").click(function(a){a.preventDefault(),b("#rubric_holder").fadeOut()}),b(".assess_submission_link").click(function(a){a.preventDefault(),b("#rubric_assessments_select").change(),b("#rubric_holder").fadeIn()}),b("#rubric_assessments_select").change(function(){var a=b(this).val(),c=null;for(var d in rubricAssessments){var e=rubricAssessments[d].rubric_assessment;e.id==a&&(c=e)}rubricAssessment.populateRubric(b("#rubric_holder .rubric"),c);var f=!c||c.assessor_id==ENV.RUBRIC_ASSESSMENT.assessor_id;b("#rubric_holder .rubric").toggleClass("assessing",f&&ENV.RUBRIC_ASSESSMENT.assessor_id!=ENV.RUBRIC_ASSESSMENT.assessment_user_id),b("#rubric_holder .save_rubric_button").showIf(f)}).change(),b(".media_comment_link").click(function(a){a.preventDefault(),b("#add_comment_form").hide(),b("#media_media_recording").show(),$recording=b("#media_media_recording").find(".media_recording"),$recording.mediaComment("create","any",function(a,c){b("#media_media_recording").data("comment_id",a).data("comment_type",c),b(document).triggerHandler("grading_change"),b("#add_comment_form").show(),b("#media_media_recording").hide(),$recording.empty()},function(){b("#add_comment_form").show(),b("#media_media_recording").hide()})}),b("#media_recorder_container a").live("click",function(a){b("#add_comment_form").show(),b("#media_media_recording").hide()}),b(".comments .comment_list").delegate(".play_comment_link","click",function(a){a.preventDefault();var c=b(this).parents(".comment_media").getTemplateData({textValues:["media_comment_id"]}).media_comment_id;c&&b(this).parents(".comment_media").find(".media_comment_content").mediaComment("show",c,"audio")}).delegate("a.instructure_inline_media_comment","click",function(a){a.preventDefault(),a.stopPropagation()}),e(ENV.SUBMISSION.submission)}),b(document).fragmentChange(function(a,c){if(c=="#rubric")b(".assess_submission_link:visible:first").click();else if(c.match(/^#comment/)){var d=null;try{d=JSON.parse(c.substring(8))}catch(e){}d&&d.comment&&b(".grading_comment").val(d.comment),b(".grading_comment").focus().select()}}),INST.refreshGrades=function(){var a=b(".submission_data_url").attr("href");setTimeout(function(){b.ajaxJSON(a,"GET",{},d)},500)}})