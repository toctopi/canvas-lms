define(["i18n!gradebook","jquery","underscore","str/htmlEscape","vendor/slickgrid-googlecode/slick.grid","vendor/slickgrid-googlecode/slick.editors","jquery.instructure_forms","jquery.instructure_misc_helpers","jquery.templateData"],function(a,b,c,d,e){var f={init:function(){var c,f=b("#gradebook_grid"),g={columns:[{id:"student",name:a.t("student","Student"),field:"student",width:250,cssClass:"cell-title",editor:StudentNameEditor,validator:requiredFieldValidator,formatter:StudentNameFormatter}],options:{enableAddRow:!1,enableColumnReorder:!1,asyncEditorLoading:!0},data:[]};delete uploadedGradebook.missing_objects,delete uploadedGradebook.original_submissions,b.each(uploadedGradebook.assignments,function(){var a={id:this.id,name:d(this.title),field:this.id,width:200,editor:GradeCellEditor,formatter:simpleGradeCellFormatter,active:!0,original_id:this.original_id};g.columns.push(a),this.original_id?a.cssClass="active changed":a.cssClass="active new",a.setValueHandler=function(a,b,c){if(c[b.id])c[b.id].grade=a;else{var d={grade:a,assignment_id:b.id},e=c.submissions.push(d);c[b.id]=c.submissions[e-1]}}}),b.each(uploadedGradebook.students,function(){var a={student:this,id:this.id};b.each(this.submissions,function(){a[this.assignment_id]=this}),g.data.push(a),a.active=!0}),g.columns.length>1?(uploadedGradebook.unchanged_assignments&&b("#assignments_without_changes_alert").show(),b("#gradebook_grid_form").submit(function(a){b(this).find("input[name='json_data_to_submit']").val(JSON.stringify(uploadedGradebook))}).show(),b(window).resize(function(){f.height(b(window).height()-f.offset().top-50)}).triggerHandler("resize"),c=new e(f,g.data,g.columns,g.options),c.onColumnHeaderClick=function(a){}):b("#no_changes_detected").show()},handleThingsNeedingToBeResolved:function(){var e={},g={};b.each(["student","assignment"],function(a,c){var f=b("#"+c+"_resolution_template").remove(),g=f.find("select");e[c]=[],b.each(uploadedGradebook[c+"s"],function(){this.original_id||e[c].push(this)}),e[c].length&&(g.change(function(){b(this).next(".points_possible_section").css({opacity:0}),b(this).val()>0?(b("#"+c+"_resolution_template select option").removeAttr("disabled"),b("#"+c+"_resolution_template select").each(function(){b("#"+c+"_resolution_template select").not(this).find("option[value='"+b(this).val()+"']").attr("disabled",!0)})):b(this).val()==="new"&&b(this).next(".points_possible_section").css({opacity:1})}),b.each(uploadedGradebook.missing_objects[c+"s"],function(){b('<option value="'+this.id+'" >'+d(this.name||this.title)+"</option>").appendTo(g)}),b.each(e[c],function(a,d){f.clone(!0).fillTemplateData({iterator:d.id,data:{name:d.name,title:d.title,points_possible:d.points_possible}}).appendTo("#gradebook_importer_resolution_section ."+c+"_section table tbody").show().find("input.points_possible").change(function(){d.points_possible=b(this).val()})}),b("#gradebook_importer_resolution_section, #gradebook_importer_resolution_section ."+c+"_section").show())}),e.student.length||e.assignment.length?b("#gradebook_importer_resolution_section").submit(function(d){var e=!1;d.preventDefault(),b(this).find("select").each(function(){if(!b(this).val())return e=!0,b(this).errorBox(a.t("errors.select_an_option","Please select an option")),!1});if(e)return!1;b(this).find("select").each(function(){var a=b(this),d=a.attr("name").split("_"),e=d[0],f=d[1],g=a.val();switch(g){case"new":break;case"ignore":for(var h in uploadedGradebook[e+"s"])if(f==uploadedGradebook[e+"s"][h].id){uploadedGradebook[e+"s"].splice(h,1);break}break;default:var i=c.detect(uploadedGradebook[e+"s"],function(a){return f==a.id});i.id=i.original_id=g,e==="assignment"?b.each(uploadedGradebook.students,function(){var a=this,b=c.detect(a.submissions,function(a){return a.assignment_id==f});b.assignment_id=g;var d=c.detect(uploadedGradebook.original_submissions,function(b){return b.user_id==a.id&&b.assignment_id==g});d&&(b.original_grade=d.score)}):e==="student"&&b.each(i.submissions,function(){var a=this,b=c.detect(uploadedGradebook.original_submissions,function(b){return b.user_id==i.id&&b.assignment_id==a.assignment_id});b&&(a.original_grade=b.score)})}});var g=[];b.each(uploadedGradebook.assignments,function(a){uploadedGradebook.assignments[a].original_id&&c.all(uploadedGradebook.students,function(b){var c=b.submissions[a];return c.original_grade==c.grade||!c.original_grade&&!c.grade})&&g.push(a)}),c.each(g.reverse(),function(a){uploadedGradebook.assignments.splice(a,1),b.each(uploadedGradebook.students,function(){this.submissions.splice(a,1)})}),g.length!=0&&(uploadedGradebook.unchanged_assignments=!0),b(this).hide(),f.init()}):f.init()}};return f})