define(["i18n!calculator","jquery","calcCmd","str/htmlEscape","jquery.instructure_misc_helpers","jquery.instructure_misc_plugins","jqueryui/sortable"],function(a,b,c,d){var e=function(a){var c={};return c.formula_rows=a.find(".formula_row"),c.formula_rows.each(function(a){this.formula=b(this).find(".formula"),this.status=b(this).find(".status"),b(this).data("formula",b(this).find(".formula")),b(this).data("status",b(this).find(".status"))}),c.round=a.find(".round"),c.status=a.find(".status"),c.last_row_details=a.find(".last_row_details"),c};b.fn.superCalc=function(f,g){if(f=="recalculate")b(this).triggerHandler("calculate",g);else if(f=="clear")c.clearMemory();else if(f=="cache_finds")b(this).data("cached_finds",e(b(this).data("table")));else if(f=="clear_cached_finds")b(this).data("cached_finds",null);else{f=f||{},f.c1=!0;var h=b(this),i=b("<table class='formulas'><thead><tr><th>"+d(a.t("headings.formula","Formula"))+"</th><th>"+d(a.t("headings.result","Result"))+"</th><th>&nbsp;</th></tr></thead>"+"<tfoot>"+"<tr><td colspan='3' class='last_row_details' style='display: none;'>"+d(a.t("last_formula_row","the last formula row will be used to compute the final answer"))+"</td></tr>"+"<tr><td></td><td class='decimal_places'>"+a.t("how_many_decimal_places","%{number_selector} Decimal Places",{number_selector:b.raw("<select class='round'><option>0</option><option>1</option><option>2</option><option>3</option><option>4</option></select>")})+"</td></tr>"+"</tfoot>"+"<tbody></tbody>"+"</table>");b(this).data("table",i),h.before(i),i.find("tfoot tr:last td:first").append(h);var j=h.clone(!0).removeAttr("id");i.find("tfoot tr:last td:first").append(j);var k=b("<button type='button' class='save_formula_button'>"+d(a.t("buttons.save","Save"))+"</button>");i.find("tfoot tr:last td:first").append(k),h.hide();var l=b("<input type='text' readonly='true'/>");i.find("tfoot tr:last td:first").append(l.hide()),h.data("supercalc_options",f),h.data("supercalc_answer",l),i.delegate(".save_formula_button","click",function(){j.triggerHandler("keypress",!0)}),i.delegate(".delete_formula_row_link","click",function(a){a.preventDefault(),b(a.target).parents("tr").remove(),h.triggerHandler("calculate")}),i.find("tbody").sortable({items:".formula_row",update:function(){h.triggerHandler("calculate")}}),i.delegate(".round","change",function(){h.triggerHandler("calculate")}),h.bind("calculate",function(d,g){c.clearMemory();var j=b(this).data("cached_finds")||e(i);if(f.pre_process&&b.isFunction(f.pre_process)){var k=f.pre_process();for(var l in k){g||h.val(k[l]||"");try{c.compute(k[l])}catch(m){}}}j.formula_rows.each(function(){var a=this.formula.html();h.val(a);var b=null;try{b="= "+c.computeValue(a)}catch(d){b=d.toString()}if(b&&b.match(/=/))var e=parseFloat(b.substring(b.indexOf("=")+1),10),f=Math.pow(10,parseInt(j.round.val(),10)||0)||1,b="= "+Math.round(e*f)/f;this.status.attr("data-res",b),g||this.status.html(b)}),g||(j.formula_rows.length>1&&j.formula_rows.removeClass("last_row").filter(":last").addClass("last_row"),j.last_row_details.showIf(j.formula_rows.length>1),j.status.removeAttr("title").filter(":last").attr("title",a.t("sample_final_answer","This value is an example final answer for this question type")),h.val(""))}),j.bind("keypress",function(c,e){h.val(j.val());if(c.keyCode==13||e&&j.val()){c.preventDefault(),c.stopPropagation();var g=b("<tr class='formula_row'><td class='formula' title='"+d(a.t("drag_to_reorder","Drag to reorder"))+"'></td><td class='status'></td><td><a href='#' class='delete_formula_row_link no-hover'><img src='/images/delete_circle.png'/></a></td></tr>");g.find("td:first").text(h.val()),h.val(""),j.val(""),i.find("tbody").append(g),h.triggerHandler("calculate"),j.focus(),f&&f.formula_added&&b.isFunction(f.formula_added)&&f.formula_added.call(h)}})}}})