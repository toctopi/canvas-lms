define(["i18n!attendance","jquery","datagrid","str/htmlEscape","jquery.ajaxJSON","jquery.dropdownList","jquery.instructure_date_and_time","jquery.instructure_forms","jqueryui/dialog","jquery.instructure_misc_helpers","jquery.instructure_misc_plugins","jquery.keycodes","vendor/jquery.scrollTo","jqueryui/position"],function(a,b,c,d){var e={saveKeyIndex:0,toggleState:function(a,c,d){if(a.hasClass("false_submission"))return;var f=a.attr("id").split("_"),g=f[1],h=f[2];a.addClass("saving");var i="";c?c=="fail"?(a.removeClass("pass").addClass("fail"),i="fail"):c=="pass"?(a.removeClass("fail").addClass("pass"),i="pass"):(a.removeClass("fail").removeClass("pass"),i=""):a.hasClass("pass")?(a.removeClass("pass").addClass("fail"),i="fail"):a.hasClass("fail")?(a.removeClass("fail").removeClass("pass"),i=""):(a.removeClass("fail").addClass("pass"),i="pass");var j=e.saveKeyIndex++;return d||setTimeout(function(){if(a.data("save_key")==j){var c=b.replaceTags(b.replaceTags(b(".grade_submission_url").attr("href"),"user_id",g),"assignment_id",h),d={"submission[assignment_id]":h,"submission[user_id]":g,"submission[grade]":i};b.ajaxJSON(c,"POST",d,function(c){a.removeClass("saving");for(var d in c){var f=c[d].submission,g=b("#submission_"+f.user_id+"_"+f.assignment_id),h=e.toggleState(g,f.grade||"clear",!0);e.clearSavingState(g,h)}},function(b){a.removeClass("saving")})}},1e3),a.data("save_key",j),j},clearSavingState:function(a,b){a.data("save_key")==b&&(a.removeClass("saving"),a.data("save_key",null))},toggleColumnState:function(a,d){var f=c.cells["0,"+a].attr("id").split("_")[1],g={};for(var h=1;h<c.rows.length;h++){var i=e.toggleState(c.cells[h+","+a],d,!0);g[h]=i}var j=function(){for(var b=1;b<c.rows.length;b++){var d=g[b];e.clearSavingState(c.cells[b+","+a],g[b])}},k=b.replaceTags(b(".set_default_grade_url").attr("href"),"assignment_id",f),l=d;l!="pass"&&l!="fail"&&(l="");var m={"assignment[default_grade]":l,"assignment[overwrite_existing_grades]":"1"};b.ajaxJSON(k,"PUT",m,function(a){j()},function(a){j()})}},f;b(document).ready(function(){function g(){var c=b("#new_assignment_dialog .datetime_field").data("date");return c?a.t("default_attendance_title","Attendance %{date}",{date:a.l("#date.formats.default",c)}):""}var h=b(".blank_attendance:first"),i=b(".pass_attendance:first"),j=b(".fail_attendance:first"),k=0;f&&f(b("#new_assignment_dialog select.assignment_group_select")),b(".add_assignment_link").click(function(c){c.preventDefault(),b("#new_assignment_dialog :text:not(.points_possible)").each(function(){b(this).val("")}),b("#new_assignment_dialog").dialog("close").dialog({autoOpen:!1,title:a.t("titles.new_attendance_column","New Attendance Column")}).dialog("open")}),b("#new_assignment_dialog .cancel_button").click(function(a){b("#new_assignment_dialog").dialog("close")}),b("#add_assignment_form").formSubmit({beforeSubmit:function(c){b(this).find(".submit_button").text(a.t("status.adding_assignment","Adding Assignment...")),b(this).find("button").attr("disabled",!0)},success:function(c){b(this).find(".submit_button").text(a.t("status.added_assignment","Added Assignment")),b(this).find("button").attr("disabled",!1);var d=c.assignment;location.href="#assignment_"+d.id,location.reload()},error:function(c){b(this).formErrors(c),b(this).find(".submit_button").text(a.t("errors.could_not_add_assignment","Add Assignment Failed")),b(this).find("button").attr("disabled",!1)}}),b("#new_assignment_dialog .title").change(function(){var a=b(this).val();a&&a!=g()?b(this).attr("edited",!0):b(this).removeAttr("edited")}),b("#new_assignment_dialog .datetime_field").change(function(){var a=b("#new_assignment_dialog .title").val(),c=b("#new_assignment_dialog .title").attr("edited");if(!a||!c){var d=b(this).data("date");d&&b("#new_assignment_dialog .title").val(g())}}),b(".datetime_field").datetime_field(),b(".help_link").click(function(c){c.preventDefault(),b("#attendance_how_to_dialog").dialog("close").dialog({autoOpen:!1,width:400,title:a.t("titles.attendance_help","Attendance Help")}).dialog("open")}),b(".submission").addClass("loading");var l=function(a,c,d){b.ajaxJSON(a,"GET",{},function(a){for(var f in c)for(var g in d)b("#submission_"+d[g]+"_"+c[f]).removeClass("loading");for(var f in a)if(a[f]&&a[f].submission){var h=a[f].submission.grade,i=b("#submission_"+a[f].submission.user_id+"_"+a[f].submission.assignment_id);i.removeClass("loading"),h!="pass"&&h!="fail"&&(h="clear");var j=e.toggleState(i,h,!0);e.clearSavingState(i,j)}},function(){k<5&&(k++,l(a))})},m=Math.round(200/(b("#attendance .student").length||1)),n=[],o=b(".gradebook_url").attr("href");setTimeout(function(){var a=[];b("#attendance .assignment").each(function(){var c=(b(this).attr("id")||"").split("_").pop();a.push(c)}),b("#attendance .student").each(function(){var c=(b(this).attr("id")||"").split("_").pop();c&&n.push(c),n.length>m&&(l(o+"?init=1&submissions=1&user_ids="+n.join(",")+"&assignment_ids="+a.join(","),a,n),n=[])}),n.length>0&&l(o+"?init=1&submissions=1&user_ids="+n.join(",")+"&assignment_ids="+a.join(","),a,n)},500),b("#comment_link").click(function(a){a.preventDefault(),a.stopPropagation()}),b(".options_dropdown").click(function(a){a.preventDefault()}),b("#attendance").bind("entry_over",function(a,b){var c=b.cell.attr("id").split("_"),d=c[1],e=c[2]}).bind("entry_out",function(a,b){}).bind("entry_click",function(a,b){b.trueEvent.preventDefault(),c.focus(b.cell.row,b.cell.column)}).bind("entry_focus",function(b,f){if(f.cell.row==0){var g={};g['<span class="ui-icon ui-icon-pencil">&nbsp;</span> '+d(a.t("options.edit_assignment","Edit Assignment"))]=function(){location.href="/"},g['<span class="ui-icon ui-icon-check">&nbsp;</span> '+d(a.t("options.mark_all_as_present","Mark Everyone Present"))]=function(){e.toggleColumnState(f.cell.column,"pass")},g['<span class="ui-icon ui-icon-close">&nbsp;</span> '+d(a.t("options.mark_all_as_absent","Mark Everyone Absent"))]=function(){e.toggleColumnState(f.cell.column,"fail")},g['<span class="ui-icon ui-icon-minus">&nbsp;</span> '+d(a.t("options.clear_attendance_marks","Clear Attendance Marks"))]=function(){e.toggleColumnState(f.cell.column,"clear")},f.cell.find(".options_dropdown").dropdownList({options:g})}else e.toggleState(f.cell);c.blur()}).bind("entry_blur",function(a,b){}),b(document).keycodes("return p f del",function(a){if(c.currentFocus||!c.currentHover)return;if(b(a.target).closest(".ui-dialog").length>0)return;var d=c.currentHover;a.keyString=="return"?d.hasClass("submission")&&c.focus(d.row,d.column):a.keyString!="p"&&a.keyString!="f"&&a.keyString!="del"}),c.init(b("#attendance"),{borderSize:2,onViewable:function(){b("#attendance_loading_message").hide(),b(document).fragmentChange(function(a,d){d.length>1&&(d=d.substring(1)),d=d.replace(/\/|%2F/g,"_");if(d.indexOf("student")==0||d.indexOf("assignment")==0||d.indexOf("submission")==0){var e=b("#"+d),f=c.position(e),g=f.row,h=f.column;c.scrollTo(g,h),e.trigger("mouseover")}})},onReady:function(){}})})})