define(["i18n!quizzes.moderate","jquery","quiz_timing","jquery.ajaxJSON","jquery.instructure_date_and_time","jquery.instructure_forms","jqueryui/dialog","jquery.instructure_misc_helpers","jquery.instructure_misc_plugins","jquery.rails_flash_notifications","jquery.templateData","vendor/date"],function(a,b,c){window.moderation={updateTimes:function(){var d=new Date;moderation.studentsCurrentlyTakingQuiz=!!b("#students .student.in_progress"),b("#students .student.in_progress").each(function(){var e=b(this),f=e.data("timing")||{},g=e.attr("data-started-at"),h=e.attr("data-end-at");f.referenceDate||b.extend(f,c.setReferenceDate(g,h,d));if(!f.referenceDate)return;e.data("timing",f);var i=f.referenceDate.getTime()-d.getTime()-f.clientServerDiff;if(f.isDeadline&&i<0){e.find(".time").text(a.t("time_up","Time Up!"));return}e.data("minutes_left",i/6e4);var j=new Date(Math.abs(i)),k=j.getUTCFullYear()-1970,l=j.getUTCMonth();l+=12*k;var m=j.getUTCDate()-1,n=j.getUTCHours(),o=j.getUTCMinutes(),p=j.getUTCSeconds(),q=[];l&&q.push(l<10?"0"+l:l),m&&q.push(m<10?"0"+m:m),n&&q.push(n<10?"0"+n:n),q.push(o<10?"0"+o:o),q.push(p<10?"0"+p:p),e.find(".time").text(q.join(":"))})},updateSubmission:function(c,d){var e=b("#student_"+c.user_id);d&&(moderation.lastUpdatedAt=new Date(Math.max(Date.parse(c.updated_at),moderation.lastUpdatedAt)));var f="";if(c.workflow_state=="complete"||c.workflow_state=="pending_review")f=a.t("finished_in_duration","finished in %{duration}",{duration:c.finished_in_words});var g={attempt:c.attempt||"--",extra_time:c.extra_time,extra_attempts:c.extra_attempts,score:c.kept_score};c.attempts_left==-1?g.attempts_left="--":c.attempts_left&&(g.attempts_left=c.attempts_left),c.workflow_state!="untaken"&&(g.time=f),e.fillTemplateData({data:g}).toggleClass("extendable",c["extendable?"]).toggleClass("in_progress",c.workflow_state=="untaken").toggleClass("manually_unlocked",!!c.manually_unlocked).attr("data-started-at",c.started_at||"").attr("data-end-at",c.end_at||"").data("timing",null).find(".extra_time_allowed").showIf(c.extra_time).end().find(".unlocked").showIf(c.manually_unlocked)},lastUpdatedAt:"",studentsCurrentlyTakingQuiz:!1},b(document).ready(function(d){function e(a){j=a,a?k.attr("src",k.attr("src").replace("ajax-reload.gif","ajax-reload-animated.gif")):k.attr("src",k.attr("src").replace("ajax-reload-animated.gif","ajax-reload.gif"))}function f(c){if(j)return;e(!0);var d=moderation.lastUpdatedAt&&moderation.lastUpdatedAt.toISOString();b.ajaxJSON(b.replaceTags(i,"update",d),"GET",{},function(a){e(!1),c&&(a.length||moderation.studentsCurrentlyTakingQuiz?setTimeout(function(){f(!0)},6e4):setTimeout(function(){f(!0)},18e4));for(var b in a)moderation.updateSubmission(a[b],!0)},function(d){e(!1),h++,h>5?(b.flashMessage(a.t("errors.server_communication_failed","There was a problem communicating with the server.  The system will try again in five minutes, or you can reload the page")),h=0,c&&setTimeout(function(){f(!0)},3e5)):c&&setTimeout(function(){f(!0)},12e4)})}function g(){var a=b(".student_check:checked").length;b("#checked_count").text(a),b(".moderate_multiple_button").showIf(a)}c.initTimes(),setInterval(moderation.updateTimes,500);var h=0,i=b(".update_url").attr("href");moderation.lastUpdatedAt=Date.parse(b(".last_updated_at").text());var j=!1,k=b(".reload_link img");setTimeout(function(){f(!0)},1e3),b("#check_all").change(function(){b(".student_check").attr("checked",b(this).attr("checked")),g()}),b(".student_check").change(function(){b(this).attr("checked")||b("#check_all").attr("checked",!1),g()}),b(".moderate_multiple_button").live("click",function(c){var d=[],e={};b(".student_check:checked").each(function(){var a=b(this).parents(".student");d.push(b(this).attr("data-id"));var c={manually_unlocked:a.hasClass("manually_unlocked")?"1":"0",extra_attempts:parseInt(a.find(".extra_attempts").text(),10)||"",extra_time:parseInt(a.find(".extra_time").text(),10)||""};b.each(["manually_unlocked","extra_attempts","extra_time"],function(){e[this]==null?e[this]=c[this].toString():e[this]!=c[this].toString()&&(e[this]="")})}),b("#moderate_student_form").data("ids",d),b("#moderate_student_dialog h2").text(a.t("extensions_for_students",{one:"Extensions for 1 Student",other:"Extensions for %{count} Students"},{count:d.length})),b("#moderate_student_form").fillFormData(e),b("#moderate_student_dialog").dialog("close").dialog({auotOpen:!1,title:a.t("titles.student_extensions","Student Extensions"),width:400}).dialog("open")}),b(".moderate_student_link").live("click",function(c){c.preventDefault();var d=b(this).parents(".student"),e={manually_unlocked:d.hasClass("manually_unlocked")?"1":"0",extra_attempts:parseInt(d.find(".extra_attempts").text(),10)||"",extra_time:parseInt(d.find(".extra_time").text(),10)||""},f=d.find(".student_name").text();b("#moderate_student_form").fillFormData(e),b("#moderate_student_form").data("ids",[d.attr("data-user-id")]),b("#moderate_student_form").find("button").attr("disabled",!1),b("#moderate_student_dialog h2").text(a.t("extensions_for_student","Extensions for %{student}",{student:f})),b("#moderate_student_dialog").dialog("close").dialog({auotOpen:!1,title:a.t("titles.student_extensions","Student Extensions"),width:400}).dialog("open")}),b(".reload_link").click(function(a){a.preventDefault(),f()}),b("#moderate_student_form").submit(function(c){function d(){g>=e.length&&(h>0?e.length==1?f.find("button").attr("disabled",!1).filter(".save_button").text(a.t("buttons.save_failed","Save Failed, please try again")):f.find("button").attr("disabled",!1).filter(".save_button").text(a.t("buttons.save_failed_n_updates_lost","Save Failed, %{n} Students were not updated",{n:h})):(f.find("button").attr("disabled",!1).filter(".save_button").text(a.t("buttons.save","Save")),b("#moderate_student_dialog").dialog("close")))}c.preventDefault(),c.stopPropagation();var e=b(this).data("ids");if(e.length==0)return;var f=b(this);f.find("button").attr("disabled",!0).filter(".save_button").text(a.t("buttons.saving","Saving..."));var g=0,h=0,i=b(this).getFormData();for(var j in e){var k=e[j],l=b.replaceTags(b(".extension_url").attr("href"),"user_id",k);b.ajaxJSON(l,"POST",i,function(a){g++,moderation.updateSubmission(a),d()},function(a){g++,h++,d()})}}),b("#moderate_student_dialog").find(".cancel_button").click(function(){b("#moderate_student_dialog").dialog("close")}),b(".extend_time_link").live("click",function(c){c.preventDefault();var d=b(c.target).parents(".student"),e=b.parseFromISO(d.attr("data-end-at")).datetime_formatted,f=b.parseFromISO(d.attr("data-started-at")).datetime_formatted,g=b("#extend_time_dialog");g.data("row",d),g.fillTemplateData({data:{end_at:e,started_at:f}}),g.find("button").attr("disabled",!1),g.dialog("close").dialog({auto_open:!1,title:a.t("titles.extend_quiz_time","Extend Quiz Time"),width:400}).dialog("open")}),b("#extend_time_dialog").find(".cancel_button").click(function(){b("#extend_time_dialog").dialog("close")}).end().find(".save_button").click(function(){var c=b("#extend_time_dialog"),d=c.getFormData(),e={};d.time=parseInt(d.time,10)||0;if(d.time<=0)return;if(d.time_type=="extend_from_now"&&d.time<c.data("row").data("minutes_left")){var f=confirm(a.t("confirms.taking_time_away","That would be less time than the student currently has.  Continue anyway?"));if(!f)return}e[d.time_type]=d.time,c.find("button").attr("disabled",!0).filter(".save_button").text(a.t("buttons.extending_time","Extending Time..."));var g=b.replaceTags(b(".extension_url").attr("href"),"user_id",c.data("row").attr("data-user-id"));b.ajaxJSON(g,"POST",e,function(b){c.find("button").attr("disabled",!1).filter(".save_button").text(a.t("buttons.extend_time","Extend Time")),moderation.updateSubmission(b),c.dialog("close")},function(b){c.find("button").attr("disabled",!1).filter(".save_button").text(a.t("buttons.time_extension_failed","Extend Time Failed, please try again"))})})})})