define(["i18n!quizzes","jquery","calcCmd","str/htmlEscape","str/pluralize","wikiSidebar","compiled/editor/MultipleChoiceToggle","jquery.ajaxJSON","jquery.instructure_date_and_time","jquery.instructure_forms","jqueryui/dialog","jquery.instructure_misc_helpers","jquery.instructure_misc_plugins","jquery.keycodes","jquery.loadingImg","jquery.rails_flash_notifications","jquery.templateData","supercalc","compiled/tinymce","tinymce.editor_box","vendor/jquery.placeholder","vendor/jquery.scrollTo","jqueryui/sortable","jqueryui/tabs"],function(a,b,c,d,e,f,g){function i(c){var d=b(".question_holder:visible").length+1,e=b.extend({},h.defaultQuestionData,{question_name:a.t("default_quesiton_name","Question")},c),f=b("#question_template").clone(!0);f.attr("id","").find(".question").attr("id","question_new"),f.fillTemplateData({data:e,except:["answers"]}),f.find(".original_question_text").fillFormData(e),e.answers&&(e.answer_count=e.answers.length,c.answer_type=e.answer_type,e.anwer_type=h.answerTypeDetails(e.question_type));for(var g=0;g<e.answer_count;g++){var i=g==0?100:0,k={answer_weight:i};e.answers&&e.answers[g]&&b.extend(k,e.answers[g]),f.find(".answers").append(j(k))}return f.toggleClass("group",!!c&&!!c.quiz_group_id),f.show(),f}function j(c,d){c.answer_weight=c.weight||c.answer_weight,c.answer_misconception_id=c.misconception_id||c.answer_misconception_id,c.answer_comment=c.comments||c.answer_comment,c.answer_text=c.text||c.answer_text,c.answer_html=c.html||c.answer_html,c.answer_comment_html=c.comments_html||c.answer_comment_html,c.answer_match_left=c.left||c.answer_match_left,c.answer_match_left_html=c.left_html||c.answer_match_left_html,c.answer_match_right=c.right||c.answer_match_right,c.answer_exact=c.exact||c.answer_exact,c.answer_error_margin=c.answer_error_margin||c.margin,c.answer_range_start=c.start||c.answer_range_start,c.answer_range_end=c.end||c.answer_range_end;var e=b.extend({},h.defaultAnswerData,c),f=b("#answer_template").clone(!0).attr("id",""),g=e.answer_type;return g=="numerical_answer"&&(g="numerical_"+e.numerical_answer_type),f.addClass("answer_for_"+c.blank_id),f.find(".answer_type").hide().filter("."+g).show(),f.find("div.answer_text").showIf(!c.answer_html),f.find("div.answer_match_left").showIf(!c.answer_match_left_html),f.find("div.answer_match_left_html").showIf(c.answer_match_left_html),delete e.answer_type,e.answer_weight=parseFloat(e.answer_weight),isNaN(e.answer_weight)&&(e.answer_weight=0),f.fillFormData({answer_text:e.answer_text}),f.fillTemplateData({data:e,htmlValues:["answer_html","answer_match_left_html","answer_comment_html"]}),(!e.answer_comment||e.answer_comment==""||e.answer_comment==a.t("answer_comments","Answer comments"))&&f.find(".answer_comment_holder").hide(),e.answer_weight==100?f.addClass("correct_answer"):e.answer_weight>0?f.addClass("correct_answer"):e.answer_weight<0&&f.addClass("negative_answer"),f.show(),f}function k(a){var c=b.extend({},h.defaultAnswerData,a),d=b("#form_answer_template").clone(!0).attr("id","");return d.find(".answer_type").hide().filter("."+c.answer_type).show(),c.answer_weight=parseFloat(c.answer_weight),isNaN(c.answer_weight)&&(c.answer_weight=0),h.updateFormAnswer(d,c,!0),d.find("input[placeholder]").placeholder(),d.show(),d}function l(a){var c=b("#questions"),d={questions:[],points_possible:0},e=c.find(".question");return a&&(e=a),e.each(function(a){var c=b(this),e=c.getTemplateData({textValues:["question_name","question_points","question_type","answer_selection_type","assessment_question_id","correct_comments","incorrect_comments","neutral_comments","matching_answer_incorrect_matches","equation_combinations","equation_formulas"],htmlValues:["question_text","text_before_answers","text_after_answers","correct_comments_html","incorrect_comments_html","neutral_comments_html"]});e=b.extend(e,c.find(".original_question_text").getFormData()),e.assessment_question_bank_id=b(".question_bank_id").text()||"",e.text_before_answers&&(e.question_text=e.text_before_answers);var f=[];c.find(".matching_answer_incorrect_matches_list li").each(function(){f.push(b(this).text())}),e.matching_answer_incorrect_matches=f.join("\n");var g=b.extend({},d.defaultQuestionData,e);g.answers=[];var h={},i=!1;if(g.question_type=="multiple_dropdowns_question"||g.question_type=="fill_in_multiple_blanks_question")i=!0,c.find(".blank_id_select option").each(function(){h[b(this).text()]=!0});g.question_type!="calculated_question"?c.find(".answer").each(function(){var a=b(this);a.find(".answer_misconception_id").text(a.find(".answer_misconception_id").val());var c=a.getTemplateData({textValues:["answer_exact","answer_error_margin","answer_range_start","answer_range_end","answer_weight","answer_misconception_id","numerical_answer_type","blank_id","id","match_id","answer_text","answer_match_left","answer_match_right","answer_comment"],htmlValues:["answer_html","answer_match_left_html","answer_comment_html"]}),e=b.extend({},d.defaultAnswerData,c);if(i&&e.blank_id&&!h[e.blank_id])return;g.answers.push(e)}):(g.formulas=[],c.find(".formulas_holder .formulas_list > div").each(function(){g.formulas.push(b.trim(b(this).text()))}),g.variables=[],c.find(".variable_definitions_holder .variable_definitions tbody tr").each(function(){var a=b(this).getTemplateData({textValues:["name","min","max","scale"]});g.variables.push(a)}),g.answers=[],c.find(".equation_combinations tbody tr").each(function(){var a={};a.variables=[],b(this).find("td:not(.final_answer)").each(function(c){var d={};d.name=g.variables[c].name,d.value=parseFloat(b(this).text(),10)||0,a.variables.push(d)}),a.answer_text=parseFloat(b(this).find(".final_answer").text(),10)||0,g.answers.push(a)}),g.formula_decimal_places=parseInt(c.find(".formula_decimal_places").text(),10)||0,g.answer_tolerance=parseFloat(c.find(".answer_tolerance").text(),10)||0),g.position=a,g.question_points=parseFloat(g.question_points),isNaN(g.question_points)&&(g.question_points=0),d.points_possible+=g.question_points,d.questions.push(g)}),d}function m(a){var b={};for(var c in a)if(c.indexOf("questions[question_0]")==0){var d=c.replace("questions[question_0]","question");b[d]=a[c]}return b}function n(a){var b={},c=c||null;c&&(b["quiz[assignment_id]"]=c),b["quiz[title]"]=a.quiz_name;for(var d in a.questions){var e=a.questions[d],f="questions[question_"+d+"]";b[f+"[question_name]"]=e.question_name,b[f+"[assessment_question_id]"]=e.assessment_question_id,b[f+"[question_type]"]=e.question_type,b[f+"[points_possible]"]=e.question_points,b[f+"[correct_comments]"]=e.correct_comments,b[f+"[incorrect_comments]"]=e.incorrect_comments,b[f+"[neutral_comments]"]=e.neutral_comments,b[f+"[question_text]"]=e.question_text,b[f+"[position]"]=e.position,b[f+"[text_after_answers]"]=e.text_after_answers,b[f+"[matching_answer_incorrect_matches]"]=e.matching_answer_incorrect_matches;for(var g in e.formulas){var h=f+"[formulas][formula_"+g+"]";b[h]=e.formulas[g]}for(var g in e.variables){var h=f+"[variables][variable_"+g+"]";b[h+"[name]"]=e.variables[g].name,b[h+"[min]"]=e.variables[g].min,b[h+"[max]"]=e.variables[g].max,b[h+"[scale]"]=e.variables[g].scale}b[f+"[answer_tolerance]"]=e.answer_tolerance,b[f+"[formula_decimal_places]"]=e.formula_decimal_places;for(var g in e.answers){var i=e.answers[g],h=f+"[answers][answer_"+g+"]";b[h+"[answer_text]"]=i.answer_text,b[h+"[answer_html]"]=i.answer_html,b[h+"[answer_comments]"]=i.answer_comment,b[h+"[answer_comments_html]"]=i.answer_comment_html,b[h+"[answer_weight]"]=i.answer_weight,b[h+"[answer_misconception_id]"]=i.answer_misconception_id,b[h+"[answer_match_left]"]=i.answer_match_left,b[h+"[answer_match_left_html]"]=i.answer_match_left_html,b[h+"[answer_match_right]"]=i.answer_match_right,b[h+"[numerical_answer_type]"]=i.numerical_answer_type,b[h+"[answer_exact]"]=i.answer_exact,b[h+"[answer_error_margin]"]=i.answer_error_margin,b[h+"[answer_range_start]"]=i.answer_range_start,b[h+"[answer_range_end]"]=i.answer_range_end,b[h+"[blank_id]"]=i.blank_id,b[h+"[match_id]"]=i.match_id,b[h+"[id]"]=i.id;for(var j in i.variables){var k=h+"[variables][variable_"+j+"]";b[k+"[name]"]=i.variables[j].name,b[k+"[value]"]=i.variables[j].value}}}return b}function o(a,b,c){html=b[c+"_html"],html&&html.length>0&&(a.find("."+c+"_html").html(html).css("display","inline-block"),a.find("textarea").val(html),a.find("a,textarea").hide(),a.removeClass("empty"))}function q(c){if(!ENV.QUIZZES||!ENV.QUIZZES.QUIZ)return!1;var d=b("#questions .question_holder").not(".group").length;return b("#questions .group_top").find('input[name="quiz_group[pick_count]"]').each(function(){d+=parseInt(this.value)}),(c?d>p:d>=p)?(setTimeout(function(){alert(a.t("question_limit_reached","You have reached the maximum number of questions allowed for a quiz (%{count}/%{limit}).\n\nAs a workaround, consider spreading the material across multiple quizzes.",{count:d,limit:p}))}),!0):!1}var h=window.quiz={};h={uniqueLocalIDStore:{},init:function(){return this.$questions=b("#questions"),this.$showDetailsWrap=b("#show_question_details_wrap").hide(),this},checkShowDetails:function(){var a=this.$questions.find("div.display_question:not(.essay_question, .text_only_question)").length;this.$showDetailsWrap[a?"show":"hide"](200)},generateUniqueLocalID:function(a){var b="object";a.attr("class")&&(a.attr("class").indexOf(" ")!=-1?b=a.attr("class").split(" ")[0]:b=a.attr("class"));var c=Math.floor(Math.random()*99999),d=b+"_"+c;while(h.uniqueLocalIDStore[d])c=Math.floor(Math.random()*99999),d=b+"_"+c;return h.uniqueLocalIDStore[d]=!0,d},updateFormAnswer:function(c,d,e){var f=d.question_type,g=e?{}:c.getFormData(),i=b.extend({},h.defaultAnswerData,g,d);c.find(".answer_type").hide().filter("."+i.answer_type).show(),i.answer_weight=parseFloat(i.answer_weight),isNaN(i.answer_weight)&&(i.answer_weight=0),c.fillFormData(i,{call_change:!1}),c.find(".select_answer input").showIf(!i.answer_html),c.find(".matching_answer .answer_match_left").showIf(!i.answer_match_left_html),c.find(".matching_answer .answer_match_left_html").showIf(i.answer_match_left_html),(i.answer_comment||i.answer_comment_html)&&c.find(".answer_comments").removeClass("empty"),i.answer_selection_type=i.answer_selection_type||h.answerSelectionType(i.question_type);if(i.answer_selection_type=="any_answer")c.addClass("correct_answer");else if(i.answer_selection_type=="matching")c.removeClass("correct_answer");else if(i.answer_selection_type!="multiple_answer"){var j=c.parent().find(".answer");j.find(".answer").filter(".correct_answer").not(":first").removeClass("correct_answer"),j.filter(".correct_answer").length===0&&j.filter(":first").addClass("correct_answer"),j.find(".select_answer_link").attr("title",a.t("titles.click_to_set_as_correct","Click to set this answer as correct"))}else c.filter(".correct_answer").find(".select_answer_link").attr("title",a.t("titles.click_to_unset_as_correct","Click to unset this answer as correct")),c.filter(":not(.correct_answer)").find(".select_answer_link").attr("title",a.t("titles.click_to_set_as_correct","Click to set this answer as correct"));c.find(".numerical_answer_type").change();var k={answer_text:i.answer_text,id:i.id,match_id:i.match_id};k.comments_header=a.beforeLabel("comments_on_answer","Comments, if the user chooses this answer"),k.short_answer_header=a.beforeLabel("possible_answer","Possible Answer"),c.find(".comment_focus").attr("title",a.t("titles.click_to_enter_comments_on_answer","Click to enter comments for the student if they choose this answer")),f=="essay_question"?k.comments_header=a.beforeLabel("comments_on_question","Comments for this question"):f=="matching_question"?(k.answer_match_left_html=i.answer_match_left_html,k.comments_header=a.beforeLabel("comments_on_wrong_match","Comments if the user gets this match wrong"),c.find(".comment_focus").attr("title",a.t("titles.click_to_enter_comments_on_wrong_match","Click to enter comments for the student if they miss this match"))):f=="missing_word_question"?k.short_answer_header=a.beforeLabel("answer_text","Answer text"):f=="multiple_choice_question"?k.answer_html=i.answer_html:f=="multiple_answers_question"?(k.answer_html=i.answer_html,k.short_answer_header=a.beforeLabel("answer_text","Answer text")):f=="fill_in_multiple_blanks_question"?k.blank_id=i.blank_id:f=="multiple_dropdowns_question"&&(k.short_answer_header=a.t("answer_text","Answer text"),k.blank_id=i.blank_id),i.blank_id&&i.blank_id!="0"&&c.addClass("answer_for_"+i.blank_id),i.blank_index>=0&&c.addClass("answer_idx_"+i.blank_index),c.fillTemplateData({data:k,htmlValues:["answer_html","answer_match_left_html"]}),o(c,i,"answer_comment"),i.answer_weight>0?(c.addClass("correct_answer"),i.answer_selection_type=="multiple_answer"&&c.find(".select_answer_link").attr("title",a.t("titles.click_to_unset_as_correct","Click to unset this answer as correct"))):i.answer_weight<0&&c.addClass("negative_answer"),f=="matching_question"&&c.removeClass("correct_answer"),i.answer_misconception_id==""?c.find(".answer_misconception_id option[value='1']").attr("selected","selected"):c.find(".answer_misconception_id option[value="+i.answer_misconception_id+"]").attr("selected","selected"),d.answer_misconception_id=c.find(".answer_misconception_id option:selected").val();var l=c.find(".edit_html").data("editorToggle"),m=f==="multiple_choice_question"||f==="multiple_answers_question";l&&m?l.showAnswerText():l&&l.display()},questionContentCounter:0,showFormQuestion:function(a){return a.attr("id")||(a.show(),a.find(".question_content").attr("id","question_content_"+h.questionContentCounter++),a.find(".question_content").editorBox(),a.find(".text_after_answers").attr("id","text_after_answers_"+h.questionContentCounter++),a.find(".text_after_answers").editorBox(),a.hide()),a.show()},answerTypeDetails:function(a){var b,c,d="one";return a=="multiple_choice_question"?(b="select_answer",c="multiple_choice_question"):a=="true_false_question"?(b="select_answer",c="true_false_question"):a=="short_answer_question"?(b="short_answer",c="short_answer_question",d="all"):a=="fill_in_multiple_blanks_question"?(b="short_answer",c="fill_in_multiple_blanks_question",d="all"):a=="essay_question"?(b="comment",c="essay_question",d="none"):a=="matching_question"?(b="matching_answer",c="matching_question",d="all"):a=="missing_word_question"?(b="select_answer",c="missing_word_question"):a=="multiple_dropdowns_question"?(b="select_answer",c="multiple_dropdowns_question",d="multiple"):a=="numerical_question"?(b="numerical_answer",c="numerical_question",d="all"):a=="multiple_answers_question"?(b="select_answer",c="multiple_answers_question",d="multiple"):a=="calculated_question"&&(b="numerical_answer",c="question_question"),{question_type:c,answer_type:b,n_correct:d}},answerSelectionType:function(a){var b="single_answer";return a!="multiple_choice_question"&&a!="true_false_question"&&(a=="short_answer_question"?b="any_answer":a=="essay_question"?b="none":a=="matching_question"?b="matching":a!="missing_word_question"&&(a=="numerical_question"?b="any_answer":a=="calculated_question"?b="any_answer":a!="multiple_dropdowns_question"&&(a=="fill_in_multiple_blanks_question"?b="any_answer":a=="multiple_answers_question"?b="multiple_answer":a=="text_only_question"&&(b="none")))),b},addExistingQuestion:function(a){var c=b("#group_top_"+a.quiz_group_id),d=null;if(c.length>0){d=c.next();while(d.length>0&&!d.hasClass("group_bottom"))d=d.next();d.length==0&&(d=null)}b.extend(a,a.question_data);var e=i(a);b("#unpublished_changes_message").slideDown(),d?d.before(e):b("#questions").append(e),h.updateDisplayQuestion(e.find(".question:first"),a,!0)},updateDisplayQuestion:function(c,e,f){fillArgs={data:e,except:["answers"],htmlValues:[]},f?fillArgs.htmlValues.push("question_text"):fillArgs.except.push("question_text"),c.fillTemplateData(fillArgs),c.find(".original_question_text").fillFormData(e),c.find(".question_correct_comment").toggleClass("empty",!e.correct_comments&&!e.correct_comments_html),c.find(".question_incorrect_comment").toggleClass("empty",!e.incorrect_comments&&!e.incorrect_comments_html),c.find(".question_neutral_comment").toggleClass("empty",!e.neutral_comments&&!e.neutral_comments_html),c.find(".answers").empty(),c.find(".equation_combinations").empty(),c.find(".equation_combinations_holder_holder").css("display","none"),c.find(".multiple_answer_sets_holder").css("display","none"),c.find(".variable_definitions_holder").css("display","none").find("tbody").empty(),c.find(".formulas_holder").css("display","none").find(".formulas_list").empty(),c.find(".question_points").text(e.points_possible);var g=h.answerTypeDetails(e.question_type),i=g.answer_type,k=g.question_type,l=g.n_correct;c.attr("class","question display_question").addClass(k||"text_only_question"),e.question_type=="fill_in_multiple_blanks_question"?c.find(".multiple_answer_sets_holder").css("display",""):e.question_type=="multiple_dropdowns_question"&&c.find(".multiple_answer_sets_holder").css("display","");var m=b(document.createElement("select")).addClass("answer_select"),n=!1;if(e.question_type=="calculated_question"){b.each(e.variables,function(a,d){var e=b("<tr/>"),f=b("<td class='name'/>");f.text(d.name),e.append(f),f=b("<td class='min'/>"),f.text(d.min),e.append(f),f=b("<td class='max'/>"),f.text(d.max),e.append(f),f=b("<td class='scale'/>"),f.text(d.scale),e.append(f),c.find(".variable_definitions_holder").css("display",""),c.find(".variable_definitions tbody").append(e)}),b.each(e.formulas,function(a,d){var e=b("<div/>");e.text(d.formula),c.find(".formulas_holder").css("display","").find(".formulas_list").append(e)}),c.find(".formula_decimal_places").text(e.formula_decimal_places);if(e.answers.length>0){c.find(".equation_combinations").append(b("<thead/>")),c.find(".equation_combinations").append(b("<tbody/>"));var o=b("<tr/>");for(var p in e.answers[0].variables){var q=b("<th/>");q.text(e.answers[0].variables[p].name),o.append(q)}var q=b("<th/>");q.text(a.t("final_answer","Final Answer")),o.append(q),c.find(".equation_combinations_holder_holder").css("display",""),c.find(".equation_combinations thead").append(o).show(),b.each(e.answers,function(a,d){var f=b("<tr/>");for(var g in d.variables){var h=b("<td/>");h.text(d.variables[g].value),f.append(h)}var h=b("<td class='final_answer'/>"),i=d.answer;if(e.answerDecimalPoints||e.answer_tolerance){var j=parseFloat(e.answer_tolerance);j=j||Math.pow(.1,e.answerDecimalPoints),i=i+" <span style='font-size: 0.8em;'>+/-</span> "+j,c.find(".answer_tolerance").text(j)}h.html(i),f.append(h),c.find(".equation_combinations tbody").append(f)})}}else{var r=b(document.createElement("option"));r.val("").text(a.t("choose_option","[ Choose ]")),m.append(r),b.each(e.answers,function(a,d){d.answer_type=i,l=="all"?d.answer_weight=100:l=="one"&&n?d.answer_weight=0:l=="none"&&(d.answer_weight=0),d.answer_weight>0&&(n=!0);var e=j(d,f);c.find(".answers").append(e);var g=b(document.createElement("option"));g.val("option_"+a).text(d.answer_text),m.append(g)})}c.find(".blank_id_select").empty();if(e.question_type=="missing_word_question"){var s=c.find(".question_text");s.html("<span class='text_before_answers'>"+e.question_text+"</span> "),s.append(m),s.append(" <span class='text_after_answers'>"+e.text_after_answers+"</span>")}else if(e.question_type=="multiple_dropdowns_question"||e.question_type=="fill_in_multiple_blanks_question"){var t={};b.each(e.answers,function(a,b){t[b.blank_id]=!0}),c.find(".blank_id_select").empty();for(var p in t){var u=p;if(u&&t[p]){var r=b("<option/>");r.val(u).text(u),c.find(".blank_id_select").append(r)}}}c.find(".after_answers").empty();if(e.question_type=="matching_question"){var s=c.find(".after_answers"),v=[];if(e.matches&&e.answers){var w={};for(var p in e.answers)w[e.answers[p].match_id]=!0;for(var p in e.matches)w[e.matches[p].match_id]||v.push(e.matches[p].text)}else{var v=e.matching_answer_incorrect_matches||"";typeof v=="string"&&(v=v.split("\n"))}var x="";for(var y in v)v[y]&&(x=x+"<li>"+d(v[y])+"</li>");x&&s.append(a.beforeLabel("other_incorrect_matches","Other Incorrect Match Options")+"<ul class='matching_answer_incorrect_matches_list'>"+x+"</ul>")}c.find(".blank_id_select").change(),c.fillTemplateData({question_type:k,answer_selection_type:i}),c.show();var z=c.attr("id")=="question_new";z&&k!="text_only_question"&&(h.defaultQuestionData.question_type=k,h.defaultQuestionData.answer_count=Math.min(c.find(".answers .answer").length,4)),b("html,body").scrollTo({top:c.offset().top-10,left:0}),c.find(".question_points_holder").showIf(!c.closest(".question_holder").hasClass("group")&&e.question_type!="text_only_question"),c.find(".unsupported_question_type_message").remove(),h.updateDisplayComments(),e.id&&(c.fillTemplateData({data:{id:e.id},id:"question_"+e.id,hrefValues:["id"]}),c.find(".original_question_text").fillFormData(e),h.updateDisplayComments())},updateFormQuestion:function(c){var d=c.find(".question"),e=d.find(":input[name='question_type']").val(),f={};f.answer_type="select_answer",f.answer_selection_type=h.answerSelectionType(e),f.textValues=["answer_weight","answer_misconception_id","answer_text","answer_comment","blank_id","id","match_id"],f.htmlValues=["answer_html","answer_match_left_html","answer_comment_html"],f.question_type=e,d.find(".explanation").hide().filter("."+e+"_explanation").show(),d.attr("class","question").addClass("selectable"),d.find(".missing_word_after_answer").hide().end().find(".matching_answer_incorrect_matches_holder").hide().end().find(".question_comment").css("display","").end(),b("#questions").hasClass("survey_quiz")&&d.find(".question_comment").css("display","none").end().find(".question_neutral_comment").css("display",""),d.find(".question_header").text("Question:"),d.addClass(e),d.find(".question_points_holder").showIf(!d.closest(".question_holder").hasClass("group")&&e!="text_only_question"),d.find("textarea.comments").each(function(){b(this).val(b.trim(b(this).val())),b(this).val()?b(this).parents(".question_comment").removeClass("empty"):b(this).parents(".question_comment").addClass("empty")});var g={addable:!0};if(e!="multiple_choice_question")if(e=="true_false_question"){g.addable=!1;var i=d.find(".form_answers .answer");if(i.length<2)for(var j=0;j<2-i.length;j++){var l=k({answer_type:"fixed_answer",question_type:"true_false_question"});d.find(".form_answers").append(l)}else if(i.length>2)for(var j=2;j<i.length;j++)i.eq(j).remove();var m={question_type:"true_false_question",answer_type:"fixed_answer",answer_text:a.t("true","True")};h.updateFormAnswer(d.find(".answer:first"),m),m.answer_text=a.t("false","False"),h.updateFormAnswer(d.find(".answer:last"),m),f.answer_type="fixed_answer"}else e=="short_answer_question"?(d.removeClass("selectable"),f.answer_type="short_answer"):e=="essay_question"?(d.find(".answer").remove(),d.removeClass("selectable"),d.find(".answers_header").hide().end().find(".question_comment").css("display","none").end().find(".question_neutral_comment").css("display","").end(),g.addable=!1,f.answer_type="none",f.textValues=[],f.htmlValues=[]):e=="matching_question"?(d.removeClass("selectable"),c.find(".matching_answer_incorrect_matches_holder").show(),f.answer_type="matching_answer",f.textValues=["answer_match_left","answer_match_right","answer_comment"]):e=="missing_word_question"?(c.find(".missing_word_after_answer").show(),c.find(".question_header").text("Text to go before answers:"),f.answer_type="select_answer"):e=="numerical_question"?(d.removeClass("selectable"),f.answer_type="numerical_answer",f.textValues=["numerical_answer_type","answer_exact","answer_error_margin","answer_range_start","answer_range_end"],f.html_values=[]):e=="calculated_question"?(d.removeClass("selectable"),f.answer_type="numerical_answer",f.textValues=["answer_combinations"],f.html_values=[],d.formulaQuestion()):e=="multiple_dropdowns_question"?(f.answer_type="select_answer",d.multipleAnswerSetsQuestion()):e=="fill_in_multiple_blanks_question"?(f.answer_type="short_answer",d.multipleAnswerSetsQuestion()):e!="multiple_answers_question"&&e=="text_only_question"&&(g.addable=!1,d.find(".answer").remove(),d.removeClass("selectable"),d.find(".answers_header").hide().end().find(".question_comment").css("display","none"),d.find(".question_header").text(a.beforeLabel("message_text","Message Text")),c.find(":input[name='question_points']").val(0),f.answer_type="none",f.textValues=[],f.htmlValues=[]);d.find(".answer.hidden").remove(),c.find("input[name='answer_selection_type']").val(f.answer_selection_type).change(),c.find(".add_answer_link").showIf(g.addable);var i=d.find(".form_answers .answer");return i.length===0&&f.answer_type!="none"&&(d.find(".form_answers").append(k({answer_type:f.answer_type,question_type:e})),d.find(".form_answers").append(k({answer_type:f.answer_type,question_type:e})),i=d.find(".form_answers .answer")),f.answer_selection_type=="any_answer"?i.addClass("correct_answer"):f.answer_selection_type=="matching"?i.removeClass("correct_answer"):f.answer_selection_type!="multiple_answer"&&(i.filter(".correct_answer").not(":first").removeClass("correct_answer"),i.filter(".correct_answer").length===0&&i.filter(":first").addClass("correct_answer")),c.find(".answer").each(function(){var a=0;b(this).hasClass("correct_answer")&&(a=100),b(this).find(".answer_weight").text(a),h.updateFormAnswer(b(this),f)}),c.find(".answer_type").hide().filter("."+f.answer_type).show(),f},updateDisplayComments:function(){this.checkShowDetails(),b(".question_holder > .question > .question_comment").each(function(){var a=b.trim(b(this).find(".question_comment_text").html());b(this).css("display","").toggleClass("empty",!a)}),b(".question_holder .answer_comment_holder").each(function(){var a=b.trim(b(this).find(".answer_comment").html());b(this).css("display","").toggleClass("empty",!a)});var a=0;b("#questions .question_holder:not(.group) .question:not(#question_new)").each(function(){var c=parseFloat(b(this).find(".question_points:visible,.question_points.hidden").text());isNaN(c)&&(c=0),a+=c}),b("#questions .group_top:not(#group_top_new)").each(function(){var c=parseFloat(b(this).find(".question_points").text());isNaN(c)&&(c=0);var d=parseInt(b(this).find(".pick_count").text(),10);isNaN(d)&&(d=0),a+=c*d}),a=Math.round(a*100)/100,b("#quiz_options_form").find(".points_possible").text(a)},findContainerGroup:function(a){a=a.prev();while(a.length>0){if(a.hasClass("group_top"))return a;if(a.hasClass("group_bottom"))return null;a=a.prev()}return null},parseInput:function(a,b){if(a.val()=="")return;if(b=="int"){var c=parseInt(a.val(),10);isNaN(c)&&(c=0),a.val(c)}else if(b=="float"){var c=Math.round(parseFloat(a.val())*100)/100;isNaN(c)&&(c=0),a.val(c)}else if(b=="float_long"){var c=Math.round(parseFloat(a.val())*1e4)/1e4;isNaN(c)&&(c=0),a.val(c)}},defaultQuestionData:{question_type:"multiple_choice_question",question_text:"",question_points:1,question_name:a.t("default_question_name","Question"),answer_count:4},defaultAnswerData:{answer_type:"select_answer",answer_comment:"",answer_weight:0,answer_misconception_id:"",numerical_answer_type:"exact_answer",answer_exact:"",answer_error_margin:"",answer_range_start:"",answer_range_end:""}};var p=1e3;b(document).ready(function(){h.init().updateDisplayComments();var d=b("#quiz_options_form");b.scrollSidebar(),b(".datetime_field").datetime_field(),b("#questions").delegate(".group_top,.question,.answer_select","mouseover",function(a){b(this).addClass("hover")}).delegate(".group_top,.question,.answer_select","mouseout",function(a){b(this).removeClass("hover")}),b("#questions").delegate(".answer","mouseover",function(a){b("#questions .answer.hover").removeClass("hover"),b(this).addClass("hover")}),d.find("#extend_due_at").change(function(){b("#quiz_lock_after").showIf(b(this).attr("checked"))}).change(),d.find("#multiple_attempts_option").change(function(a){b("#multiple_attempts_suboptions").showIf(b(this).attr("checked"));var c=b("#multiple_attempts_suboptions #quiz_allowed_attempts");c.val()=="-1"&&c.val("1")}).triggerHandler("change"),d.find("#time_limit_option").change(function(){b(this).attr("checked")||b("#quiz_time_limit").val("")}).triggerHandler("change"),b("#limit_attempts_option").change(function(){var a=b("#quiz_allowed_attempts");if(b(this).attr("checked")){var c=parseInt(a.data("saved_value")||a.val()||"2",10);if(c==-1||isNaN(c))c=1;a.val(c)}else a.data("saved_value",b(this).val()),a.val("--")}).triggerHandler("change"),b("#protect_quiz").change(function(){var a=b(this).attr("checked");b(".protected_options").showIf(a).find(":checkbox").each(function(){a||b(this).attr("checked",!1).change()})}).triggerHandler("change"),b("#quiz_require_lockdown_browser").change(function(){b("#lockdown_browser_suboptions").showIf(b(this).attr("checked")),b("#quiz_require_lockdown_browser_for_results").attr("checked",!0).change()}),b("#lockdown_browser_suboptions").showIf(b("#quiz_require_lockdown_browser").attr("checked")),b("#ip_filter").change(function(){b("#ip_filter_suboptions").showIf(b(this).attr("checked")),b(this).attr("checked")||b("#quiz_ip_filter").val("")}).triggerHandler("change"),b("#ip_filters_dialog").delegate(".ip_filter","click",function(a){a.preventDefault();var c=b(this).getTemplateData({textValues:["filter"]}).filter;b("#protect_quiz").attr("checked",!0).triggerHandler("change"),b("#ip_filter").attr("checked",!0).triggerHandler("change"),b("#quiz_ip_filter").val(c),b("#ip_filters_dialog").dialog("close")}),b(".ip_filtering_link").click(function(c){c.preventDefault();var d=b("#ip_filters_dialog");d.dialog("close").dialog({autoOpen:!1,width:400,title:a.t("titles.ip_address_filtering","IP Address Filtering")}).dialog("open");if(!d.hasClass("loaded")){d.find(".searching_message").text(a.t("retrieving_filters","Retrieving Filters..."));var e=b("#quiz_urls .filters_url").attr("href");b.ajaxJSON(e,"GET",{},function(b){d.addClass("loaded");if(b.length){for(var c in b){var e=b[c],f=d.find(".ip_filter.blank:first").clone(!0).removeClass("blank");f.fillTemplateData({data:e}),d.find(".filters tbody").append(f.show())}d.find(".searching_message").hide().end().find(".filters").show()}else d.find(".searching_message").text(a.t("no_filters_found","No filters found"))},function(b){d.find(".searching_message").text(a.t("errors.retrieving_filters_failed","Retrieving Filters Failed"))})}}),b("#require_access_code").change(function(a){b("#access_code_suboptions").showIf(b(this).attr("checked")),b(this).attr("checked")||b("#quiz_access_code").val("")}).triggerHandler("change"),b("#never_hide_results").change(function(){b(".show_quiz_results_options").showIf(b(this).attr("checked")),b(this).attr("checked")||(b("#hide_results_only_after_last").attr("checked",!1),b("#quiz_show_correct_answers").attr("checked",!1))}).triggerHandler("change"),b("#multiple_attempts_option,#limit_attempts_option,#quiz_allowed_attempts").bind("change",function(){var a=b("#multiple_attempts_option").attr("checked")&&b("#limit_attempts_option").attr("checked"),c=parseInt(b("#quiz_allowed_attempts").val(),10);a&&c&&c>0?b("#hide_results_only_after_last_holder").show():(b("#hide_results_only_after_last").attr("checked",!1),b("#hide_results_only_after_last_holder").hide())}).triggerHandler("change"),d.find(".save_quiz_button").click(function(){d.data("activator","save")}),d.find(".publish_quiz_button").click(function(){d.data("activator","publish")}),d.formSubmit({object_name:"quiz",required:["title"],processData:function(a){b(this).attr("method","PUT"),b(this).data("submit_type")=="save_only"&&delete a.activate,a["quiz[description]"]=b("#quiz_description").editorBox("get_code");var c=1;if(a.multiple_attempts){c=parseInt(a.allowed_attempts,10);if(isNaN(c)||!a.limit_attempts)c=-1}return a.allowed_attempts=c,a["quiz[allowed_attempts]"]=c,a},beforeSubmit:function(c){b(this).find(".button.save_quiz_button").attr("disabled",!0),b(this).find(".button.publish_quiz_button").attr("disabled",!0),b(this).data("activator")=="publish"?b(this).find(".button.publish_quiz_button").text(a.t("buttons.publishing","Publishing...")):b(this).find(".button.save_quiz_button").text(a.t("buttons.saving","Saving..."))},success:function(c){var d=b(this);b(this).find(".button.save_quiz_button").attr("disabled",!1),b(this).find(".button.publish_quiz_button").attr("disabled",!1),b(this).data("activator")=="publish"?b(this).find(".button.publish_quiz_button").text(a.t("buttons.published","Published!")):b(this).find(".button.save_quiz_button").text(a.t("buttons.saved","Saved!")),setTimeout(function(){d.find(".button.save_quiz_button").text(a.t("buttons.save_settings","Save Settings"))},2500);if(c.quiz.assignment){var e=c.quiz.assignment;if(b("#assignment_option_"+e.id).length===0){if(e.assignment_group&&b("#assignment_group_optgroup_"+e.assignment_group_id).length===0){var f=e.assignment_group,g=b(document.createElement("optgroup"));g.attr("label",f.name).attr("id","assignment_group_optgroup_"+f.id)}var i=b("#assignment_group_optgroup_"+e.assignment_group_id),j=b(document.createElement("option"));j.attr("id","assignment_option_"+e.id).val(e.id).text(e.title),i.append(j)}}b(".show_rubric_link").showIf(c.quiz.assignment),b("#quiz_assignment_id").val(c.quiz.quiz_type||"practice_quiz").change(),b(this).data("submit_type")=="save_and_publish"?location.href=b(this).attr("action"):b.flashMessage(a.t("notices.quiz_data_saved","Quiz data saved")),h.updateDisplayComments()},error:function(a){b(this).formErrors(a),b(this).find(".button.save_quiz_button").attr("disabled",!1),b(this).find(".button.publish_quiz_button").attr("disabled",!1)}}),d.find(".save_quiz_button").click(function(a){a.preventDefault(),a.stopPropagation(),d.data("submit_type","save_only").submit()}).end().find(".publish_quiz_button").click(function(a){a.preventDefault(),a.stopPropagation(),d.data("submit_type","save_and_publish").submit()}),b("#show_question_details").change(function(a){b("#questions").toggleClass("brief",!b(this).attr("checked"))}).triggerHandler("change"),b(".start_over_link").click(function(b){b.preventDefault();var c=confirm(a.t("confirms.scrap_and_restart","Scrap this quiz and start from scratch?"));c&&(location.href=location.href+"?fresh=1")}),b("#quiz_assignment_id").change(function(c){var d=b("#quiz_options").getTemplateData({textValues:["assignment_id","title"]}),e=b("#quiz_assignment_id").val(),f=b("#quiz_title_input").val();if(e){var g=b("#quiz_assignment_id")[0];f=b(g.options[g.selectedIndex]).text()}else d.assignment_id&&(f=a.t("default_quiz_title","Quiz"));var h={"quiz[assignment_id]":e,"quiz[title]":f};b("#quiz_title").showIf(!0),b("#quiz_options_form .quiz_survey_setting").showIf(e&&e.match(/survey/)),b("#quiz_points_possible").showIf(e=="graded_survey"),b("#survey_instructions").showIf(e=="survey"||e=="graded_survey"),b("#quiz_assignment_group").showIf(e=="assignment"||e=="graded_survey"),b("#questions").toggleClass("survey_quiz",e=="survey"||e=="graded_survey"),b("#quiz_display_points_possible").showIf(e!="survey"&&e!="graded_survey"),b("#quiz_options_holder").toggleClass("survey_quiz",e=="survey"||e=="graded_survey");var i=b("#quiz_urls .update_quiz_url").attr("href");b("#quiz_title_input").val(f),b("#quiz_title_text").text(f)}).change(),b(".question_form :input").keycodes("esc",function(c){b(this).parents("form").find("input[value='"+a.t("#buttons.cancel","Cancel")+"']").click()}),b(document).delegate(".blank_id_select","change",function(){var a=b(this).val(),c=b(this)[0].selectedIndex;b(this).closest(".question").find(".answer").css("display","none"),a?(a!="0"&&b(this).closest(".question").find(".answer.answer_idx_"+c).filter(":not(.answer_for_"+a+")").each(function(){b(this).attr("class",b(this).attr("class").replace(/answer_for_[A-Za-z0-9]+/g,"")),b(this).addClass("answer_for_"+a)}),b(this).closest(".question").find(".answer.answer_for_"+a).css("display","")):(b(this).closest(".question").find(".answer").css("display",""),b(this).closest(".question").find(".answer.answer_idx_"+c).css("display",""))}),b(".blank_id_select").change(),b(document).delegate(".delete_question_link","click",function(c){c.preventDefault(),b(this).parents(".question_holder").confirmDelete({url:b(this).parents(".question_holder").find(".update_question_url").attr("href"),message:a.t("confirms.delete_question","Are you sure you want to delete this question?"),success:function(a){b(this).remove(),h.updateDisplayComments()}})}),b(document).delegate(".edit_question_link","click",function(c){c.preventDefault();var d=b(this).parents(".question"),e=d.getTemplateData({textValues:["question_type","correct_comments","incorrect_comments","neutral_comments","question_name","question_points","answer_selection_type","blank_id"],htmlValues:["question_text","correct_comments_html","incorrect_comments_html","neutral_comments_html"]});e.question_text=d.find("textarea[name='question_text']").val();var f=[];d.find(".matching_answer_incorrect_matches_list li").each(function(){f.push(b(this).text())}),e.matching_answer_incorrect_matches=f.join("\n"),e.question_points=parseFloat(e.question_points,10),isNaN(e.question_points)&&(e.question_points=0);var g=b("#question_form_template").clone(!0).attr("id",""),i=g.find(".question");g.fillFormData(e),o(g.find(".question_correct_comment"),e,"correct_comments"),o(g.find(".question_incorrect_comment"),e,"incorrect_comments"),o(g.find(".question_neutral_comment"),e,"neutral_comments"),i.addClass("selectable"),g.find(".answer_selection_type").change().show(),e.question_type!="missing_word_question"&&g.find("option.missing_word").remove();if(d.hasClass("missing_word_question")||e.question_type=="missing_word_question")e=d.getTemplateData({textValues:["text_before_answers","text_after_answers"]}),answer_data=d.find(".original_question_text").getFormData(),e.text_before_answers=answer_data.question_text,e.text_after_answers=answer_data.text_after_answers,e.question_text=e.text_before_answers,g.fillFormData(e);var j=h.updateFormQuestion(g);g.find(".form_answers").empty();if(j.question_type=="calculated_question"){var e=l(d).questions[0];g.find(".combinations_holder .combinations thead tr").empty();for(var m in e.variables){var n=b(g.find(".variables .variable."+e.variables[m].name));e.variables[m].name=="variable"&&(n=b(g.find(".variables .variable").get(m))),n&&n.length>0&&(n.find(".min").val(e.variables[m].min),n.find(".max").val(e.variables[m].max),n.find(".round").val(e.variables[m].scale));var p=b("<th/>");p.text(e.variables[m].name),g.find(".combinations_holder .combinations thead tr").append(p)}var p=b("<th class='final_answer'/>");p.text(a.t("final_answer","Final Answer")),g.find(".combinations_holder .combinations thead tr").append(p);for(var m in e.formulas)g.find(".supercalc").val(e.formulas[m]),g.find(".decimal_places .round").val(e.formula_decimal_places),g.find(".save_formula_button").click();e.answer_tolerance&&g.find(".combination_answer_tolerance").val(e.answer_tolerance),g.find(".combination_count").val(e.answers.length);for(var m in e.answers){var q=b("<tr/>");for(var r in e.answers[m].variables){var s=b("<td/>");s.text(e.answers[m].variables[r].value),q.append(s)}var t=e.answers[m].answer_text;e.answer_tolerance&&(t=t+" <span style='font-size: 0.8em;'>+/-</span> "+e.answer_tolerance);var s=b("<td class='final_answer'/>");s.html(t),q.append(s),g.find(".combinations tbody").append(q),g.find(".combinations_holder").show()}g.triggerHandler("settings_change",!1),i.triggerHandler("recompute_variables",!0)}else d.find(".answers .answer").each(function(){var a=b(this).getTemplateData({textValues:j.textValues,htmlValues:j.htmlValues});a.answer_type=j.answer_type,a.question_type=j.question_type;var c=k(a);g.find(".form_answers").append(c)});d.hasClass("essay_question")&&i.find(".comments_header").text(a.beforeLabel("comments_on_question","Comments for this question")),d.hide().after(g),h.showFormQuestion(g),g.attr("action",d.find(".update_question_url").attr("href")).attr("method","POST").find(".submit_button").text(a.t("buttons.update_question","Update Question")),g.find(":input:visible:first").focus().select(),b("html,body").scrollTo({top:g.offset().top-10,left:0}),setTimeout(function(){i.find(".question_content").triggerHandler("change"),i.addClass("ready")},100)}),b(".question_form :input[name='question_type']").change(function(){h.updateFormQuestion(b(this).parents(".question_form"))}),b("#question_form_template .cancel_link").click(function(a){a.preventDefault();var c=b(this).parents("form").prev(),d=c.attr("id")=="question_new";d||b(this).parents("form").remove(),c.show(),b("html,body").scrollTo({top:c.offset().top-10,left:0}),d&&(c.parent().remove(),h.updateDisplayComments()),h.updateDisplayComments()}),b(document).delegate("a.comment_focus","focus click",function(a){a.preventDefault(),b(this).parents(".question_comment,.answer_comments").removeClass("empty").find("textarea.comments").focus().select()}),b(document).delegate("textarea.comments","focus",function(){b(this).parents(".question_comment,.answer_comments").removeClass("empty")}).delegate("textarea.comments","blur",function(){b(this).val(b.trim(b(this).val())),b(this).val()==""&&b(this).parents(".question_comment,.answer_comments").addClass("empty")}),b(document).delegate(".numerical_answer_type","change",function(){var a=b(this).val(),c=b(this).parents(".numerical_answer");c.find(".numerical_answer_text").hide(),c.find("."+a).show()}).change(),b(document).delegate(".select_answer_link","click",function(c){c.preventDefault();var d=b(this).parents(".question");if(!d.hasClass("selectable"))return;d.find(":input[name='question_type']").val()!="multiple_answers_question"?(d.find(".answer:visible").removeClass("correct_answer"),b(this).parents(".answer").addClass("correct_answer")):(b(this).parents(".answer").toggleClass("correct_answer"),b(this).parents(".answer").hasClass("correct_answer")?b(this).attr("title",a.t("titles.click_to_unset_as_correct","Click to unset this answer as correct")):b(this).attr("title",a.t("titles.click_to_set_as_correct","Click to set this answer as correct"))),b(this).blur()}),b(".question_form :input").change(function(){if(b(this).parents(".answer").length>0){var a=b(this).parents(".answer");a.find(":input[name='"+b(this).attr("name")+"']").val(b(this).val())}}),b(".question_form select.answer_selection_type").change(function(){b(this).val()=="single_answer"?b(this).parents(".question").removeClass("multiple_answers"):b(this).parents(".question").addClass("multiple_answers")}).change(),b(".delete_answer_link").click(function(a){a.preventDefault(),b(this).parents(".answer").remove()}),b(".add_question_group_link").click(function(c){c.preventDefault();if(q())return;b(".question_form .submit_button:visible,.quiz_group_form .submit_button:visible").each(function(){b(this).parents("form").submit()});var d=b("#group_top_template").clone(!0).attr("id","group_top_new"),e=b("#group_bottom_template").clone(!0).attr("id","group_bottom_new");b("#questions").append(d.show()).append(e.show()),d.find(".edit_group_link").click(),d.find(".quiz_group_form").attr("action",b("#quiz_urls .add_group_url").attr("href")).attr("method","POST"),d.find(".submit_button").text(a.t("buttons.create_group","Create Group"))}),b(".add_question_link").click(function(c){c.preventDefault();if(q())return;b(".question_form:visible,.group_top.editing .quiz_group_form:visible").submit();var d=i();if(b(this).parents(".group_top").length>0){var e=b(this).parents(".group_top").next();while(e.length>0&&!e.hasClass("group_bottom"))e=e.next();e.before(d.addClass("group"))}else b("#questions").append(d);d.find(".edit_question_link:first").click();var f=d.parents(".question_holder").children("form");f.attr("action",b("#quiz_urls .add_question_url,#bank_urls .add_question_url").attr("href")).attr("method","POST").find(".submit_button").html(a.t("buttons.create_question","Create Question")),f.find("option.missing_word").remove(),d.find(".question_type").change(),b("html,body").scrollTo({top:d.offset().top-10,left:0}),d.find(":input:first").focus().select()}),h.$questions.delegate('.group_top input[name="quiz_group[pick_count]"]',{focus:function(){b(this).data("prev-value",this.value)},change:function(){q(!0)&&(this.value=b(this).data("prev-value"))}});var g=b("#find_bank_dialog");b(".find_bank_link").click(function(c){c.preventDefault();var d=g;d.data("form",b(this).closest(".quiz_group_form"));if(!d.hasClass("loaded")){d.data("banks",{}),d.find(".find_banks").hide(),d.find(".message").show().text(a.t("loading_question_banks","Loading Question Banks..."));var e=d.find(".find_question_banks_url").attr("href");b.ajaxJSON(e,"GET",{},function(a){d.find(".message").hide(),d.find(".find_banks").show(),d.addClass("loaded");for(idx in a){var c=a[idx].assessment_question_bank;c.title=b.truncateText(c.title);var e=d.find(".bank.blank:first").clone(!0).removeClass("blank");e.fillTemplateData({data:c,dataValues:["id","context_type","context_id"]}),d.find(".bank_list").append(e),e.data("bank_data",c),e.show()}},function(b){d.find(".message").text(a.t("errors.loading_banks_failed","Question Banks failed to load, please try again"))})}d.find(".bank.selected").removeClass("selected"),d.find(".submit_button").attr("disabled",!0),d.dialog("close").dialog({autoOpen:!1,title:a.t("titles.find_question_bank","Find Question Bank"),width:600,height:400}).dialog("open")}),g.delegate(".bank","click",function(){g.find(".bank.selected").removeClass("selected"),b(this).addClass("selected"),g.find(".submit_button").attr("disabled",!1)}).delegate(".submit_button","click",function(){var a=g.find(".bank.selected:first"),c=a.getTemplateData({textValues:["title"],dataValues:["id","context_id","context_type"]}),d=g.data("form");d.find(".bank_id").val(c.id),c.bank_name=c.title;var e=d.closest(".group_top").next(".assessment_question_bank");e.length==0&&(e=b("#group_top_template").next(".assessment_question_bank").clone(!0),d.closest(".group_top").after(e)),e.show().fillTemplateData({data:c}).data("bank_data",c),g.dialog("close")}).delegate(".cancel_button","click",function(){g.dialog("close")});var j=b("#find_question_dialog");b(".find_question_link").click(function(c){c.preventDefault();var d=j;if(!d.hasClass("loaded")){d.data("banks",{}),d.find(".side_tabs_table").hide(),d.find(".message").show().text(a.t("loading_question_banks","Loading Question Banks..."));var e=d.find(".find_question_banks_url").attr("href");b.ajaxJSON(e,"GET",{},function(a){d.find(".message").hide(),d.find(".side_tabs_table").show(),d.addClass("loaded");for(idx in a){var c=a[idx].assessment_question_bank;c.title=b.truncateText(c.title);var e=d.find(".bank.blank:first").clone(!0).removeClass("blank");e.fillTemplateData({data:c}),d.find(".bank_list").append(e),e.data("bank_data",c),e.show()}d.find(".bank:not(.blank):first").click()},function(b){d.find(".message").text(a.t("errors.loading_banks_failed","Question Banks failed to load, please try again"))})}d.data("add_source",""),d.dialog("close").dialog({autoOpen:!1,title:a.t("titles.find_quiz_question","Find Quiz Question"),open:function(){d.find(".selected_side_tab").length==0&&d.find(".bank:not(.blank):first").click()},width:600,height:400}).dialog("open")});var p=function(a){var c=[];j.find(".quiz_group_select").find("option.group").remove(),j.find(".quiz_group_select_holder").show(),b("#questions .group_top:visible").each(function(){var a={};a.id=b(this).attr("id").substring(10),a.name=b(this).getTemplateData({textValues:["name"]}).name;var c=b("<option/>");c.text(b.truncateText(a.name)),c.val(a.id),c.addClass("group"),j.find(".quiz_group_select option.bottom").before(c)}),a&&b("#quiz_group_select").val(a),b("#quiz_group_select").val()=="new"&&b("#quiz_group_select").val("none"),b("#quiz_group_select").change()};b("#quiz_group_select").change(function(){if(b(this).val()=="new"){var c=b("#add_question_group_dialog"),d=[];j.find(".question_list :checkbox:checked").each(function(){d.push(b(this).parents(".found_question").data("question_data").id)}),c.find(".questions_count").text(d.length),c.find("button").attr("disabled",!1).filter(".submit_button").text(a.t("buttons.create_group","Create Group")),c.dialog("close").dialog({width:400,autoOpen:!1}).dialog("open")}}),b("#add_question_group_dialog .submit_button").click(function(c){var d=b("#add_question_group_dialog");d.find("button").attr("disabled",!0).filter(".submit_button").text(a.t("buttons.creating_group","Creating Group..."));var e=d.getFormData(),f=d.find(".add_question_group_url").attr("href");b.ajaxJSON(f,"POST",e,function(c){d.find("button").attr("disabled",!1).filter(".submit_button").text(a.t("buttons.create_group","Create Group"));var e=b("#group_top_template").clone(!0).attr("id","group_top_new"),f=b("#group_bottom_template").clone(!0).attr("id","group_bottom_new");b("#questions").append(e.show()).append(f.show());var g=c.quiz_group;e.fillTemplateData({data:g,id:"group_top_"+g.id,hrefValues:["id"]}),e.fillFormData(c,{object_name:"quiz_group"}),b("#unpublished_changes_message").slideDown(),f.attr("id","group_bottom_"+g.id),h.updateDisplayComments(),p(c.quiz_group.id),d.dialog("close")},function(b){d.find("button").attr("disabled",!1).filter(".submit_button").text(a.t("errors.creating_group_failed","Create Group Failed, Please Try Again"))})}),b("#add_question_group_dialog .cancel_button").click(function(a){b("#add_question_group_dialog").dialog("close"),b("#quiz_group_select").val("none")});var r=function(a){var c=a.questions,d=j.find(".bank.selected_side_tab"),e=d.data("bank_data"),f=j.data("banks")[e.id];if(!d.hasClass("selected_side_tab"))return;var g={};b(".display_question:visible").each(function(){var a=parseInt(b(this).getTemplateData({textValues:["assessment_question_id"]}).assessment_question_id,10);a&&(g[a]=!0)}),j.find(".page_link").showIf(f.pages&&f.last_page&&f.pages>f.last_page),p();var h=b("<div/>");for(var i in c){var k=c[i].assessment_question;if(!g[k.id]||!0){h.html(k.question_data.question_text),k.question_text=b.truncateText(h.text(),75),k.question_name=k.question_data.question_name;var l=j.find(".found_question.blank").clone(!0).removeClass("blank");l.toggleClass("already_added",!!g[k.id]),l.fillTemplateData({data:k}),l.find(":checkbox").attr("id","find_bank_question_"+k.id),l.find("label").attr("for","find_bank_question_"+k.id),l.data("question_data",k),j.find(".question_list").append(l),l.show()}}};b("#find_question_dialog").delegate(".bank","click",function(c){c.preventDefault();var d=b(this).getTemplateData({textValues:["id"]}).id,e=j.data("banks")[d];j.find(".bank").removeClass("selected"),j.find(".selected_side_tab").removeClass("selected_side_tab"),b(this).addClass("selected_side_tab"),j.find(".page_link").data("page",0),e&&e.last_page&&j.find(".page_link").data("page",e.last_page),e?(j.find(".found_question:visible").remove(),r(e)):(j.find(".found_question:visible").remove(),j.find(".page_link").click(),j.find(".question_list_holder").hide(),j.find(".question_message").show().text(a.t("loading_questions","Loading Questions...")))}).delegate(".page_link","click",function(c){c.preventDefault();var d=b(this);if(d.hasClass("loading"))return;d.addClass("loading"),j.find(".page_link").text(a.t("loading_more_questions","loading more questions..."));var e=j.find(".bank.selected_side_tab"),f=e.data("bank_data"),g=j.find(".question_bank_questions_url").attr("href");g=b.replaceTags(g,"question_bank_id",f.id);var h=(j.find(".page_link").data("page")||0)+1;g+="&page="+h,b.ajaxJSON(g,"GET",{},function(b){d.removeClass("loading"),j.find(".page_link").data("page",h),j.find(".page_link").text(a.t("more_questions","more questions"));var c=b.questions,e=j.data("banks")||{},g=e[f.id]||{};g.pages=b.pages,g.questions=(g.questions||[]).concat(b.questions),g.last_page=h,e[f.id]=g,j.data("banks",e),j.find(".question_message").hide(),j.find(".question_list_holder").show(),r(b)},function(b){d.removeClass("loading"),j.find(".question_message").text(a.t("errors.loading_questions_failed","Questions failed to load, please try again")),j.find(".page_link").text(a.t("errors.loading_more_questions_failed","loading more questions failed"))})}).delegate(".select_all_link","click",function(a){a.preventDefault(),j.find(".question_list .found_question:not(.blank) :checkbox").attr("checked",!0)}).delegate(".clear_all_link","click",function(a){a.preventDefault(),j.find(".question_list .found_question:not(.blank) :checkbox").attr("checked",!1)}).delegate(".cancel_button","click",function(a){j.dialog("close")}).delegate(".group_button","click",function(c){var d=b("#add_found_questions_as_group_dialog"),e=[];j.find(".question_list :checkbox:checked").each(function(){e.push(b(this).parents(".found_question").data("question_data").id)}),d.find(".questions_count").text(e.length),d.dialog("close").dialog({autoOpen:!1,title:a.t("titles.add_questions_as_group","Add Questions as a Group")}).dialog("open")}).delegate(".submit_button","click",function(c){var d=[];j.find(".question_list :checkbox:checked").each(function(){d.push(b(this).parents(".found_question").data("question_data").id)});var e={};e.quiz_group_id=j.find(".quiz_group_select").val(),e.assessment_question_bank_id=j.find(".bank.selected_side_tab:first").data("bank_data").id,e.assessment_questions_ids=d.join(","),e.existing_questions="1";var f=j.find(".add_questions_url").attr("href");j.find("button").attr("disabled",!0).filter(".submit_button").text(a.t("buttons.adding_questions","Adding Questions...")),b.ajaxJSON(f,"POST",e,function(b){function d(){c++;var a=b.shift();a&&(h.addExistingQuestion(a.quiz_question),c>5?setTimeout(d,50):d())}j.find("button").attr("disabled",!1).filter(".submit_button").text(a.t("buttons.add_selected_questions","Add Selected Questions")),j.find(".selected_side_tab").removeClass("selected_side_tab");var c=0;setTimeout(d,10),j.dialog("close")},function(b){j.find("button").attr("disabled",!1).filter(".submit_button").text(a.t("errors.adding_questions_failed","Adding Questions Failed, please try again"))})}),b(".add_answer_link").bind("click",function(c,d){c.preventDefault();var e=b(this).parents(".question"),f=[],g=null,h=null,i="single_answer";if(e.hasClass("multiple_choice_question")){var f=[{comments:a.t("default_answer_comments","Response if the student chooses this answer")}];g="select_answer",h="multiple_choice_question"}else{if(e.hasClass("true_false_question"))return;if(e.hasClass("short_answer_question")){var f=[{comments:a.t("default_answer_comments","Response if the student chooses this answer")}];g="short_answer",h="short_answer_question",i="any_answer"}else if(e.hasClass("essay_question")){var f=[{comments:a.t("default_response_to_essay","Response to show student after they submit an answer")}];g="comment",h="essay_question"}else if(e.hasClass("matching_question")){var f=[{comments:a.t("default_comments_on_wrong_match","Response if the user misses this match")}];g="matching_answer",h="matching_question",i="matching"}else if(e.hasClass("missing_word_question")){var f=[{comments:a.t("default_answer_comments","Response if the student chooses this answer")}];g="short_answer",h="missing_word_question"}else if(e.hasClass("numerical_question")){var f=[{numerical_answer_type:"exact_answer",answer_exact:"#",answer_error_margin:"#",comments:a.t("default_answer_comments_on_match","Response if the student matches this answer")}];g="numerical_answer",h="numerical_question",i="any_answer"}else if(e.hasClass("multiple_answers_question")){var f=[{comments:a.t("default_answer_comments","Response if the student chooses this answer")}];g="select_answer",h="multiple_answers_question",i="multiple_answers"}else if(e.hasClass("multiple_dropdowns_question")){var f=[{comments:a.t("default_answer_comments","Response if the student chooses this answer")}];g="select_answer",h="multiple_dropdowns_question"}else if(e.hasClass("fill_in_multiple_blanks_question")){var f=[{comments:a.t("default_answer_comments","Response if the student chooses this answer")}];g="short_answer",h="fill_in_multiple_blanks_question",i="any_answer"}}for(var j=0;j<f.length;j++){var l=f[j];l.answer_type=g,l.question_type=h,l.blank_id=e.find(".blank_id_select").val(),l.blank_index=e.find(".blank_id_select")[0].selectedIndex,$answer=k(l),i=="any_answer"?$answer.addClass("correct_answer"):i=="matching"&&$answer.removeClass("correct_answer"),e.find(".form_answers").append($answer.show()),d||(b("html,body").scrollTo($answer),$answer.find(":text:visible:first").focus().select())}}),b(document).delegate(".answer_comment_holder","click",function(a){b(this).find(".answer_comment").slideToggle()}),b("#question_form_template").submit(function(c){c.preventDefault(),c.stopPropagation();var d=b(this).prev(),e=b(this),f=e.find(".answer"),g=b(this).find(".question"),i=[],j=g.getFormData({values:["question_type","question_name","question_points","correct_comments","incorrect_comments","neutral_comments","question_text","answer_selection_type","text_after_answers","matching_answer_incorrect_matches"]});e.find(".edit_html_done").trigger("click"),j.assessment_question_bank_id=b(".question_bank_id").text()||"";var k=null;if(j.question_type=="calculated_question")e.find(".combinations_holder .combinations tbody tr").length===0&&(k=a.t("errors.no_possible_solution","Please generate at least one possible solution"));else if(f.length===0||f.filter(".correct_answer").length===0)f.length===0&&j.question_type!="essay_question"&&j.question_type!="text_only_question"?k=a.t("errors.no_answer","Please add at least one answer"):f.filter(".correct_answer").length===0&&(j.question_type=="multiple_choice_question"||j.question_type=="true_false_question"||j.question_tyep=="missing_word_question")&&(k=a.t("errors.no_correct_answer","Please choose a correct answer"));var o=b("#quiz_assignment_id").length==0||!b("#quiz_assignment_id").val().match(/survey/i);if(o&&k){e.find(".answers_header").errorBox(k,!0);return}var p=b.extend({},j);p.points_possible=parseFloat(p.question_points),p.answers=[],d.find(".blank_id_select").empty();var q={},r=!1;if(p.question_type=="multiple_dropdowns_question"||p.question_type=="fill_in_multiple_blanks_question")r=!0,g.find(".blank_id_select option").each(function(){q[b(this).text()]=!0});g.find(".blank_id_select option").each(function(){d.find(".blank_id_select").append(b(this).clone())});var f=g.find(".answer").each(function(c){var d=b(this);d.show();var e=d.getFormData();e.blank_id=d.find(".blank_id").text(),e.answer_text=d.find("input[name='answer_text']:visible").val(),e.answer_html=d.find(".answer_html").html(),e.answer_misconception_id=d.find("select option:selected").val(),j.question_type=="true_false_question"&&(e.answer_text=c==0?a.t("true","True"):a.t("false","False")),d.hasClass("correct_answer")?e.answer_weight=100:e.answer_weight=0;if(r&&e.blank_id&&!q[e.blank_id])return;p.answers.push(e)});if(g.hasClass("calculated_question")){p.answers=[],p.variables=[];var s={};g.find(".variables .variable").each(function(a){var c={};c.scale="0",c.name=b(this).find(".name").text(),c.scale=parseFloat(b(this).find(".round").val(),10)||0,c.min=parseFloat(b(this).find(".min").val(),10)||0,c.max=parseFloat(b(this).find(".max").val(),10)||0,s[c.name]=a,p.variables.push(c)}),p.formulas=[],g.find(".formulas .formula").each(function(){var a={};a.formula=b.trim(b(this).text()),p.formulas.push(a)}),p.formula_decimal_places=parseInt(g.find(".decimal_places .round").val(),10)||0,p.answer_tolerance=parseFloat(g.find(".combination_answer_tolerance").val(),10)||0,p.answerDecimalPoints=parseFloat(g.find(".combination_error_margin").val(),10)||0;var t=g.find(".combinations thead th");g.find(".combinations tbody tr").each(function(){var a={};a.variables=[],a.answer=parseFloat(b(this).find("td.final_answer").text(),10)||0,b(this).find("td:not(.final_answer)").each(function(c){var d={};d.name=b.trim(t.eq(c).text()),d.value=parseFloat(b(this).text(),10)||0,a.variables.push(d)}),a.variables=a.variables.sort(function(a,b){return s[a.name]-s[b.name]}),p.answers.push(a)})}d.find(".answers").each(function(){b(this).find(".answer").each(function(a){b(this).find(".answer_misconception_id").text(p.answers[a].answer_misconception_id)})}),h.updateDisplayQuestion(d,p);var u=h.answerTypeDetails(p.question_type),v=u.answer_type,w=u.question_type,x=u.n_correct;e.remove(),b("html,body").scrollTo({top:d.offset().top-10,left:0});var y=b("#quiz_urls .add_question_url,#bank_urls .add_question_url").attr("href"),z="POST",A=d.attr("id")=="question_new";A||(y=d.find(".update_question_url").attr("href"),z="PUT");var j=l(d),B=n(j),j=m(B);if(d.parent(".question_holder").hasClass("group")){var C=h.findContainerGroup(d.parent(".question_holder"));C&&(j["question[quiz_group_id]"]=C.attr("id").substring(10))}b("#assessment_question_bank_id").length>0&&(j["assessment_question[assessment_question_bank_id]"]=b("#assessment_question_bank_id").text()),d.loadingImage(),h.updateDisplayComments(),b.ajaxJSON(y,z,j,function(a){d.loadingImage("remove");var c=a.quiz_question||a.assessment_question,e=b.extend({},c,c.question_data);e.assessment_question_id=e.assessment_question_id||c.assessment_question_id||c.id,h.updateDisplayQuestion(d,e,!0),b("#unpublished_changes_message").slideDown()},function(a){d.formErrors(a)})}),b("#sort_questions").sortable({revert:!1,update:function(a,c){var d=b(this).sortable("toArray");for(var e in d){var f=d[e];f&&f!="sort_question_blank"&&b("#"+f.substring(5)).appendTo(b("#questions"))}}}),b(document).delegate("input.float_value","keydown",function(a){a.keyCode>57&&a.keyCode<91&&a.preventDefault()}).delegate("input.float_value","change blur focus",function(a){h.parseInput(b(this),b(this).hasClass("long")?"float_long":"float")}),b("#questions").delegate(".question_teaser_link","click",function(c){function f(a){var c=b("#question_template").clone().removeAttr("id"),e=a,f=b.extend({},e,e.question_data);d.after(c),d.remove(),c.show(),c.find(".question_points").text(f.points_possible),h.updateDisplayQuestion(c.find(".display_question"),f,!0),d.hasClass("to_edit")&&c.find(".edit_question_link").click()}c.preventDefault();var d=b(this).parents(".question_teaser"),e=d.data("question");e?f(e):(d.find(".teaser.question_text").text(a.t("loading_question","Loading Question...")),b.ajaxJSON(d.find(".update_question_url").attr("href"),"GET",{},function(a){f(a.quiz_question)},function(){d.find(".teaser.question_text").text(a.t("errors.loading_question_failed","Loading Question Failed..."))}))}).delegate(".teaser.question_text","click",function(a){a.preventDefault(),b(this).parents(".question_teaser").find(".question_teaser_link").click()}).delegate(".edit_teaser_link","click",function(a){a.preventDefault(),b(this).parents(".question_teaser").addClass("to_edit"),b(this).parents(".question_teaser").find(".question_teaser_link").click()}),b(".keep_editing_link").click(function(a){a.preventDefault(),b(".question_generated,.question_preview").hide(),b(".question_editing").show(),b("html,body").scrollTo(b("#questions"))}),b(".quiz_group_form").formSubmit({object_name:"quiz_group",beforeSubmit:function(a){var c=b(this),d=c.parents(".group_top");d.fillTemplateData({data:a}).removeClass("editing"),c.loadingImage()},success:function(a){var c=b(this),d=c.parents(".group_top"),f=a.quiz_group;c.loadingImage("remove");var d=c.parents(".group_top");d.removeClass("editing"),d.fillTemplateData({data:f,id:"group_top_"+f.id,hrefValues:["id"]}),d.toggleClass("question_bank_top",!!f.assessment_question_bank_id);var g=d.next(".assessment_question_bank");if(!f.assessment_question_bank_id)g.remove();else if(g.data("bank_data")){var i=g.data("bank_data");i.bank_id=i.id,i.context_type_string=e(b.underscore(i.context_type)),d.next(".assessment_question_bank").fillTemplateData({data:i,hrefValues:["bank_id","context_type_string","context_id"]}).find(".bank_name").hide().filter(".bank_name_link").show()}d.fillFormData(a,{object_name:"quiz_group"});var j=d.next();while(j.length>0&&!j.hasClass("group_bottom"))j=j.next();b("#unpublished_changes_message").slideDown(),j.attr("id","group_bottom_"+f.id),h.updateDisplayComments()},error:function(a){var c=b(this),d=c.parents(".group_top");d.addClass("editing"),c.loadingImage("remove"),c.formErrors(a)}}),b("#questions").sortable({handle:".move_icon",helper:function(a,b){return b.clone().removeClass("group")},items:".group_top,.group_bottom,.question_holder",tolerance:"pointer",start:function(a,b){b.placeholder.css("visibility","visible");if(b.item.hasClass("group_top")){b.helper.addClass("dragging");var c=b.item,d=[];while(c.length>0&&!c.hasClass("group_bottom"))c=c.next(),c.hasClass("ui-sortable-placeholder")||(d.push(c),c.hide());b.item.data("take_with",d),b.placeholder.show()}else h.findContainerGroup(b.placeholder)?b.placeholder.addClass("group"):b.placeholder.removeClass("group"),b.placeholder.append("<div class='question_placeholder' style='height: "+(b.helper.height()-10)+"px;'>&nbsp;</div>")},change:function(a,c){var d=h.findContainerGroup(c.placeholder);c.item.hasClass("group_top")?d&&(d.before(c.placeholder),b("html,body").scrollTo(c.placeholder)):(d?d.attr("id")=="group_top_new"?(d.before(c.placeholder),b("html,body").scrollTo(c.placeholder)):d.hasClass("question_bank_top")?d.before(c.placeholder).addClass("group"):c.placeholder.addClass("group"):c.placeholder.removeClass("group"),c.placeholder.height(c.helper.height()).find(".question_placeholder").height(c.helper.height()-10))},stop:function(a,c){if(c.item.hasClass("group_top")){var d=c.item.data("take_with");if(d){var e=c.item;for(var f in d){var g=d[f];e.after(g.show()),e=g}}}else if(h.findContainerGroup(c.item)){c.item.addClass("group");var e=c.item.prev();while(e.length>0&&!e.hasClass("group_top"))e=e.prev();e.find(".expand_link").click()}else c.item.removeClass("group");var i=b("#quiz_urls .reorder_questions_url, #bank_urls .reorder_questions_url").attr("href"),j={},k=b("#questions"),l=[];if(h.findContainerGroup(c.item)){k=h.findContainerGroup(c.item),$list=[],i=k.find(".reorder_group_questions_url").attr("href");var e=k.next();while(e.length>0&&!e.hasClass("group_bottom"))l.push(e),e=e.next()}else k.children(".question_holder:not(.group),.group_top").each(function(){l.push(b(this))});k.loadingImage();var m=[],n=b("#questions.question_bank").length>0;b.each(l,function(a,b){if(n){var c=b.find(".assessment_question_id").text();m.push(c)}else if(b.hasClass("question_holder")){var d=b.find(".question"),e=d.attr("id"),c=e?e.substring(9):d.find(".id").text();m.push("question_"+c)}else{var c="group_"+b.attr("id").substring(10);m.push(c)}});var j={order:m.join(",")};b.ajaxJSON(i,"POST",j,function(a){k.loadingImage("remove")})}}),b(document).delegate(".edit_group_link","click",function(c){if(b(this).closest(".group_top").length==0)return;c.preventDefault();var d=b(this).parents(".group_top"),e=d.getTemplateData({textValues:["name","pick_count","question_points"]});d.fillFormData(e,{object_name:"quiz_group"}),d.addClass("editing"),d.find(":text:visible:first").focus().select(),d.find(".quiz_group_form").attr("action",d.find(".update_group_url").attr("href")).attr("method","PUT"),d.find(".submit_button").text(a.t("buttons.update_group","Update Group"))}).delegate(".delete_group_link","click",function(a){if(b(this).closest(".group_top").length==0)return;a.preventDefault();var c=b(this).parents(".group_top"),d=b("nothing").add(c),e=c.next();while(e.length>0&&!e.hasClass("group_bottom"))d=d.add(e),e=e.next();d=d.add(e),c.confirmDelete({url:c.find(".update_group_url").attr("href"),confirmed:function(){d.dim()},success:function(){d.fadeOut(function(){b(this).remove(),h.updateDisplayComments()})}})}).delegate(".group_edit.cancel_button","click",function(a){if(b(this).closest(".group_top").length==0)return;var c=b(this).parents(".group_top");c.removeClass("editing");if(c.attr("id")=="group_top_new"){var d=c.next();while(d.length>0&&!d.hasClass("group_bottom")){var e=d;d.removeClass("group"),d=d.next(),e.hasClass("assessment_question_bank")&&e.remove()}d.remove(),c.remove()}h.updateDisplayComments()}).delegate(".collapse_link","click",function(a){if(b(this).closest(".group_top").length==0)return;a.preventDefault(),b(this).parents(".group_top").find(".collapse_link").addClass("hidden").end().find(".expand_link").removeClass("hidden");var c=b(this).parents(".group_top").next();while(c.length>0&&c.hasClass("question_holder"))c.hide(),c=c.next()}).delegate(".expand_link","click",function(a){if(b(this).closest(".group_top").length==0)return;a.preventDefault(),b(this).parents(".group_top").find(".collapse_link").removeClass("hidden").end().find(".expand_link").addClass("hidden");var c=b(this).parents(".group_top").next();while(c.length>0&&c.hasClass("question_holder"))c.show(),c=c.next()}),f&&(f.init(),f.attachToEditor(b("#quiz_description"))),b("#quiz_description").editorBox(),b(".toggle_description_views_link").click(function(a){a.preventDefault(),b("#quiz_description").editorBox("toggle")}),b(".toggle_question_content_views_link").click(function(a){a.preventDefault(),b(this).parents(".question_form").find(".question_content").editorBox("toggle")}),b(".toggle_text_after_answers_link").click(function(a){a.preventDefault(),b(this).parents(".question_form").find(".text_after_answers").editorBox("toggle")}),b(document).bind("editor_box_focus",function(a,b){f.attachToEditor(b)}),b(".quiz_options_link,.link_to_content_link").click(function(a){a.preventDefault(),b("#quiz_content_links,#quiz_options_holder").toggle(),b("#quiz_content_links:visible").length>0?f&&f.show():f&&f.hide()}),b("#calc_helper_methods").change(function(){var a=b(this).val();b("#calc_helper_method_description").text(c.functionDescription(a));var d="<pre>"+c.functionExamples(a).join("</pre><pre>")+"</pre>";b("#calc_helper_method_examples").html(d)}),b("#equations_dialog_tabs").tabs()}),b.fn.multipleAnswerSetsQuestion=function(){var c=b(this),d=c.find(".question_content"),e=c.find(".blank_id_select"),f=c.find(".question_type");if(c.data("multiple_sets_question_bindings"))return;c.data("multiple_sets_question_bindings",!0),d.bind("keypress",function(a){setTimeout(function(){b(a.target).triggerHandler("change")},50)}),d.bind("change",function(){var c=f.val();if(c!="multiple_dropdowns_question"&&c!="fill_in_multiple_blanks_question")return;var d=b(this).editorBox("get_code"),g=d.match(/\[[A-Za-z][A-Za-z0-9]*\]/g);e.find("option.shown_when_no_other_options_available").remove(),e.find("option").addClass("to_be_removed");var h={};if(g)for(var i=0;i<g.length;i++)if(g[i]){var j=g[i].substring(1,g[i].length-1);if(!h[j]){var k=e.find("option").eq(i);k.length||(k=b("<option/>").appendTo(e)),k.removeClass("to_be_removed").addClass(j).val(j).text(j),h[j]=!0}}e.find("option:not(.shown_when_no_other_options_available)").length||e.append("<option class='shown_when_no_other_options_available' value='0'>"+a.t("enter_answer_variable_above","[ Enter Answer Variables Above ]")+"</option>"),e.find("option.to_be_removed").remove(),e.change()}).change(),e.change(function(){var a=f.val();if(a!="multiple_dropdowns_question"&&a!="fill_in_multiple_blanks_question")return;c.find(".form_answers .answer").hide().addClass("hidden"),e.find("option").each(function(a){var d=b(this);c.find(".form_answers .answer_for_"+b(this).val()).each(function(){b(this).attr("class",b(this).attr("class").replace(/answer_idx_\d+/g,""))}).addClass("answer_idx_"+a)});if(e.val()!=="0"){var d=e.val(),g=e[0].selectedIndex;g>=0&&c.find(".form_answers .answer").each(function(){var a=b(this);if(!a.attr("class").match(/answer_idx_/))if(a.attr("class").match(/answer_for_/)){var c=null,d=a.attr("class").match(/answer_for_[^\s]+/);d&&d[0]&&(d=d[0].substring(11)),e.find("option").each(function(a){b(this).text()==d&&(c=a)}),c===null&&(c=g),a.addClass("answer_idx_"+c)}else a.addClass("answer_idx_"+g)}),e.find("option").each(function(a){var d=b(this).text();c.find(".form_answers .answer.answer_idx_"+a).find(".blank_id").each(function(){b(this).text(d)})});var h=c.find(".form_answers .answer.answer_idx_"+g).show().removeClass("hidden");if(!h.length&&d&&d!=="0"){for(var i=0;i<2;i++)c.find(".add_answer_link").triggerHandler("click",!0);h=c.find(".form_answers .answer.answer_idx_"+g).show().removeClass("hidden")}h.filter(".correct_answer").length||h.filter(":first").addClass("correct_answer"),h.each(function(){b(this).find(".blank_id").text(d)})}}).change()},b.fn.formulaQuestion=function(){var d=b(this);if(d.data("formula_question_bindings"))return;d.data("formula_question_bindings",!0),d.find(".supercalc").superCalc({pre_process:function(){var a=[];return d.find(".variables .variable").each(function(){var c={name:b(this).attr("data-name"),value:b(this).attr("data-value")};a.push(c.name+" = "+c.value)}),a},formula_added:function(){d.triggerHandler("settings_change",!0)}}),d.find(".compute_combinations").click(function(){var c=b(this);c.text(a.t("buttons.generating","Generating...")).attr("disabled",!0);var e=d.find(".question_type").val();if(e!="calculated_question")return;var f=d.find(".combinations");f.find("thead tr").empty(),d.find(".variables .variable").each(function(){var a=b("<th/>");a.text(b(this).find(".name").text()),f.find("thead tr").append(a)});var g=b("<th/>");g.text(a.t("final_answer","Final Answer")),g.addClass("final_answer"),f.find("thead tr").append(g),f.find("tbody").empty();var h=parseInt(d.find(".combination_count").val(),10)||10;h<0?h=10:h>maxCombinations&&(h=maxCombinations),d.find(".combination_count").val(h);var i=0,j={},k=0,l=function(){d.find(".supercalc").superCalc("clear_cached_finds"),c.text("Generate").attr("disabled",!1),i==0?alert(a.t("alerts.no_valid_combinations","The system could not generate any valid combinations for the parameters given")):i<h&&alert(a.t("alerts.only_n_valid_combinations",{one:"The system could only generate 1 valid combination for the parameters given",other:"The system could only generate %{count} valid combinations for the parameters given"},{count:i})),d.triggerHandler("settings_change",!1)},m=0,n=0,o=d.find(".formulas .formula_row:last .status"),p=d.find(".variables .variable"),q=f.find("tbody");d.find(".supercalc").superCalc("cache_finds");var r=parseFloat(d.find(".combination_answer_tolerance").val(),10),s=function(){c.text(a.t("buttons.generating_combinations_progress","Generating... (%{done}/%{total})",{done:i,total:h}));var e=document.createDocumentFragment();for(var f=0;f<5&&i<h&&n<25;f++){p.each(function(){b(this).find(".variable_setting:first").trigger("change",{cache:!0})}),d.find(".supercalc").superCalc("recalculate",!0);var g=o.attr("data-res"),k=[];p.each(function(){k.push(b(this).attr("data-value"))});var t=parseFloat(g.substring(1),10);if(!j[k]||!0){if(g.match(/^=/)&&g!="= NaN"&&g!="= Infinity"&&t){var u=b("<tr/>");p.each(function(){var a=b("<td/>");a.html(b(this).attr("data-value")),u.append(a)});var v=b("<td/>");v.addClass("final_answer");var w=b.trim(g.substring(1)),x=r;x&&(w+=" <span style='font-size: 0.8em;'>+/-</span> "+x),v.html(w),u.append(v),i++,n=0,e.appendChild(u[0])}else n++;j[k]=!0}else n++}q[0].appendChild(e),c.text(a.t("buttons.generating_combinations_progress","Generating... (%{done}/%{total})",{done:i,total:h}));if(m<h&&i<h&&n<25)m++,setTimeout(function(){s()},500);else{l();return}};setTimeout(s,100)}),d.find(".recompute_variables").click(function(){var a=d.find(".question_type").val();if(a!="calculated_question")return;d.triggerHandler("recompute_variables",!0)}),d.bind("recompute_variables",function(a,c){d.find(".variables .variable").each(function(){b(this).find(".variable_setting:first").trigger("change",c?null:{recompute:!0})})}),d.bind("settings_change",function(a,b){var c=d.find(".question_type").val();if(c!="calculated_question")return;var e=d.find(".variables tbody tr.variable").length>0,f=d.find(".formulas .formula").length>0;d.find(".combinations_option").attr("disabled",!e||!f),d.find(".variables_specified").showIf(e),d.find(".formulas_specified").showIf(f),d.hasClass("ready")&&b&&d.find(".combinations_holder .combinations tbody tr").remove(),d.find(".combinations_holder").showIf(d.find(".combinations tbody tr").length>0)}),d.find(".variables").delegate(".variable_setting","change",function(a,c){var e=d.find(".question_type").val();if(e!="calculated_question")return;var f=b(a.target).parents(".variable"),g=f.data("cached_data");if(!g||!c||!c.cache)g=f.getFormData(),g.min=parseFloat(g.min)||0,g.max=Math.max(g.min,parseFloat(g.max)||0),g.round=parseInt(g.round,10)||0,g.range=g.max-g.min,g.rounder=Math.pow(10,g.round)||1;c&&c.cache&&f.data("cached_data",g);var h=Math.random()*g.range+g.min;h=Math.round(h*g.rounder)/g.rounder,f.attr("data-value",h),(!c||c.template)&&f.find(".value").html(h);if(!c||c.recompute)d.find(".supercalc").superCalc("recalculate"),d.triggerHandler("settings_change",!0)}),d.find(".help_with_equations_link").click(function(d){d.preventDefault(),b("#calc_helper_methods").empty();var e=c.functionList();for(var f in e){var g=e[f][0],h=b("<option/>");h.val(g).text(g),b("#calc_helper_methods").append(h)}b("#calc_helper_methods").change(),b("#help_with_equations_dialog").dialog("close").dialog({autoOpen:!1,title:a.t("titles.help_with_formulas","Help with Quiz Question Formulas"),width:500}).dialog("open")}),d.find(".combinations_option").attr("disabled",!0),d.find(".question_content").bind("keypress",function(a){setTimeout(function(){b(a.target).triggerHandler("change")},50)}),d.find(".question_content").bind("change",function(a){var c=b(this).editorBox("get_code"),e=c.match(/\[[A-Za-z][A-Za-z0-9]*\]/g);d.find(".variables").find("tr.variable").addClass("to_be_removed"),d.find(".variables").showIf(e&&e.length>0);var f={};if(e)for(var g=0;g<e.length;g++)if(e[g]){var h=e[g].substring(1,e[g].length-1);if(!f[h]){var i=d.find(".variables tr.variable").eq(g);i.length===0&&(i=b("<tr class='variable'><td class='name'></td><td><input type='text' name='min' class='min variable_setting' style='width: 30px;' value='1'/></td><td><input type='text' name='max' class='max variable_setting' style='width: 30px;' value='10'/></td><td><select name='round' class='round variable_setting'><option>0</option><option>1</option><option>2</option><option>3</option></td><td class='value'></td></tr>"),d.find(".variables tbody").append(i),i.find(".variable_setting:first").triggerHandler("change")),i.removeClass("to_be_removed"),i.addClass(h),i.attr("data-name",h),i.find("td.name").text(h),f[h]=!0}}d.find(".variables").find("tr.to_be_removed").remove(),d.find(".supercalc").superCalc("recalculate",!0),d.triggerHandler("settings_change",!1)}).change()},b("#questions").delegate(".edit_html","click",function(a){a.preventDefault();var c=b(this),d=c.data("editorToggle");d||(d=new g(c),c.data("editorToggle",d)),d.toggle()})})