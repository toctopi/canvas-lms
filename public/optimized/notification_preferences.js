require(["i18n!profile","jquery","jquery.ajaxJSON","jquery.instructure_forms","jquery.instructure_misc_plugins","jquery.loadingImg","jquery.rails_flash_notifications","jquery.templateData"],function(a,b){b(document).ready(function(){b(".notification_preferences .frequency").click(function(a){a.preventDefault(),b(this).hasClass("selected")||(b(this).parents("tr").find(".frequency").removeClass("selected").removeClass("selected_pending"),b(this).addClass("selected_pending"))}),b(".notification_preferences .add_notification_link").click(function(a){a.preventDefault();var c=b(this).parents("tr").prev(),d=c.clone(!0);d.find(".delete_preference_link").show(),d.find(".frequency.selected").removeClass("selected").addClass("selected_pending"),c.after(d);var c=d.prev(".preference");while(c.length>0)c.find(".delete_preference_link").show(),c=c.prev(".preference");d.find(".contact_type_select").change()}),b(".delete_preference_link").bind("click",function(a,c){a.preventDefault();var d=b(this).parents(".preference");while(d.prev(".preference").length>0)d=d.prev(".preference");var e=1,f=d;while(f.next(".preference").length>0)f=f.next(".preference"),e++;var g=c?0:"normal";b(this).parents(".preference").fadeOut(g,function(){if(e<3){d.find(".delete_preference_link").hide();while(d.next(".preference").length>0)d=d.next(".preference"),d.find(".delete_preference_link").hide()}b(this).remove()})}),b(".sms_select").change(function(a){b(this).val()=="new"&&b(".add_contact_link").click()}),b(".email_select").change(function(a){b(this).val()=="new"&&b(".add_email_link").click()}),b(".contact_type_select").change(function(a){var c=b(this).parents("tr.preference"),d=b(this).val();if(c.find(".contact_select").hasClass(d))return;var e=b("#select_templates ."+d).clone(!0);e[0].selectedIndex=0,c.find(".contact_select").after(e).remove(),c.find(".at").showIf(d=="email_select"||d=="sms_select")}).each(function(){b(this).change()}),b(".save_preferences_button").click(function(c){c.preventDefault();var d=b(this);b(".notification_preferences").loadingImage();var e=b(".notification_preferences").getFormData();b(".notification_preferences tr.preference").each(function(){var a=b(this).getTemplateData({textValues:["category_slug","channel_id"]}),c="immediately";a.channel_id=b(this).getFormData().channel_id;var d=b(this).find(".frequency.selected,.frequency.selected_pending");d.hasClass("never")?c="never":d.hasClass("daily")?c="daily":d.hasClass("weekly")&&(c="weekly"),a.category_slug&&a.channel_id&&(e["category_"+a.category_slug+"[channel_"+a.channel_id+"]"]=c)});var f=b("#contact_urls .update_communication_url").filter(":last").attr("href");d.text(a.t("communication.buttons.saving_preferences","Saving Preferences...")).attr("disabled",!0),b.ajaxJSON(f,"POST",e,function(c){d.text(a.t("communication.buttons.saved_preferences","Saved Preferences!")).attr("disabled",!1),setTimeout(function(){d.text(a.t("communication.buttons.save_preferences","Save Preferences"))},2500),b.flashMessage(a.t("communication.notices.communication_preferences_updated","Communication Preferences updated")),b(".notification_preferences").loadingImage("remove"),b("tr.preference .frequency.selected_pending").removeClass("selected_pending").addClass("selected");var e={};b("tr.preference").each(function(){var a=b(this).getTemplateData({textValues:["category_slug"]}).category_slug;e[a]&&b(this).find(".delete_preference_link").triggerHandler("click",!0),e[a]=!0}),e={};for(var f in c){var g=c[f].notification_policy;e[g.notification_id]&&b(".add_notification_"+g.notification_id).click(),e[g.notification_id]=!0;var h=b(".preference_"+g.notification_id+":last"),i="email_select";b(".channel_option_"+g.communication_channel_id).parents("select").hasClass("sms_select")?i="sms_select":b(".channel_option_"+g.communication_channel_id).parents("select").hasClass("facebook_select")?i="facebook_select":b(".channel_option_"+g.communication_channel_id).parents("select").hasClass("twitter_select")&&(i="twitter_select"),h.find(".contact_type_select").val(i).change(),h.find(".contact_select").val(g.communication_channel_id),h.find(".frequency."+g.frequency).click()}b("tr.preference .frequency.selected_pending").removeClass("selected_pending").addClass("selected")},function(c){d.text(a.t("communication.buttons.problem_saving_preferences","Problem Saving Preferences")).attr("disabled",!1),b(".notification_preferences").loadingImage("remove"),b.flashError(a.t("communication.errors.saving_preferences_failed","Oops! Something broke.  Try saving again"))})}),b(".sms_select, .email_select").change(function(){b(this).parents("tr.preference").length>0&&b(this).parents("tr.preference td.frequency.selected").removeClass("selected").addClass("selected_pending")})})})