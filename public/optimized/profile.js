define(["INST","i18n!profile","jquery","compiled/util/BackoffPoller","jquery.ajaxJSON","jquery.instructure_date_and_time","jquery.instructure_forms","jqueryui/dialog","jquery.instructure_misc_plugins","jquery.loadingImg","jquery.templateData","jqueryui/sortable"],function(a,b,c,d){var e=c(".profile_table"),f=c("#update_profile_form"),g=c("#default_email_id"),h="/api/v1/users/self/avatars",i=new d(h,function(a){var b={},d=c("img.pending"),e,f,g,h=0;for(var i=0,j=a.length;i<j;i++)e=a[i],e.pending||(b[e.token]=e.url);return d.each(function(){f=c(this),g=b[f.data("token")],g!=null&&(f.removeClass("pending"),f.attr("src",g),h++)}),h===d.length?"stop":h>0?"reset":"continue"});c(".edit_profile_link").click(function(a){return e.addClass("editing").find(".edit_data_row").show().end().find(":text:first").focus().select(),!1}),e.find(".cancel_button").click(function(a){return e.removeClass("editing").find(".change_password_row,.edit_data_row,.more_options_row").hide().end().find("#change_password_checkbox").attr("checked",!1),!1}),e.find("#change_password_checkbox").click(function(){a.browser.ie&&c(this).triggerHandler("change")}).change(function(a){a.preventDefault(),c(this).attr("checked")?(c(this).addClass("showing"),e.find(".change_password_row").show().find(":password:first").focus().select()):e.find(".change_password_row").hide().find(":password").val("")}).attr("checked",!1).change(),f.attr("method","PUT").formSubmit({required:f.find("#user_name").length?["name"]:[],object_name:"user",property_validations:{"=default_email_id":function(a,d){if(c("#default_email_id").length&&(!a||a=="new"))return b.t("please_select_an_option","Please select an option")}},beforeSubmit:function(a){f.loadingImage()},success:function(a){var b=a.user,d={short_name:b.short_name,full_name:b.name,sortable_name:b.sortable_name,time_zone:b.time_zone,locale:c("#user_locale option[value='"+b.locale+"']").text()};if(d.locale!=f.find(".locale").text()){location.reload();return}f.loadingImage("remove");if(g.length>0){var e=g.find("option:selected").text();c(".default_email.display_data").text(e)}c(".channel").removeClass("default"),c("#channel_"+b.communication_channel.id).addClass("default"),f.fillTemplateData({data:d}).find(".cancel_button").click()},error:function(a){f.loadingImage("remove").formErrors(a.errors||a),c(".edit_profile_link").click()}}).find(".more_options_link").click(function(){return f.find(".more_options_link_row").hide(),f.find(".more_options_row").show(),!1}),c("#default_email_id").change(function(){c(this).val()=="new"&&c(".add_email_link:first").click()}),c("#unregistered_services li.service").click(function(a){a.preventDefault(),c("#"+c(this).attr("id")+"_dialog").dialog("close").dialog({width:350,autoOpen:!1}).dialog("open")}),c(".create_user_service_form").formSubmit({object_name:"user_service",beforeSubmit:function(a){c(this).loadingImage()},success:function(a){c(this).loadingImage("remove").parents(".content").dialog("close"),document.location.reload()},error:function(a){c(this).loadingImage("remove").errorBox(b.t("errors.registration_failed","Registration failed. Check the user name and password, and try again."))}}),c("#unregistered_services li.service .content form .cancel_button").click(function(a){c(this).parents(".content").dialog("close")}),c("#registered_services li.service .delete_service_link").click(function(a){a.preventDefault(),c(this).parents("li.service").confirmDelete({message:b.t("confirms.unregister_service","Are you sure you want to unregister this service?"),url:c(this).attr("href"),success:function(a){c(this).slideUp(function(){c("#unregistered_services").find("#unregistered_"+c(this).attr("id")).slideDown()})}})}),c(".service").hover(function(){c(this).addClass("service-hover")},function(){c(this).removeClass("service-hover")}),c("#show_user_services").change(function(){c.ajaxJSON(c("#update_profile_form").attr("action"),"PUT",{"user[show_user_services]":c(this).prop("checked")},function(a){},function(a){})}),c(".delete_pseudonym_link").click(function(a){a.preventDefault(),c(this).parents(".pseudonym").confirmDelete({url:c(this).attr("href"),message:b.t("confirms.delete_login","Are you sure you want to delete this login?")})}),c(".datetime_field").datetime_field(),c(".expires_field").bind("change keyup",function(){c(this).closest("td").find(".hint").showIf(!c(this).val())}),c(".delete_key_link").click(function(a){a.preventDefault(),c(this).closest(".access_token").confirmDelete({url:c(this).attr("rel"),message:b.t("confirms.delete_access_key","Are you sure you want to delete this access key?"),success:function(){c(this).remove(),c(".access_token:visible").length||c("#no_approved_integrations,#access_tokens_holder").toggle()}})}),c("#add_access_token_dialog .cancel_button").click(function(){c("#add_access_token_dialog").dialog("close")}),c("#access_token_form").formSubmit({object_name:"access_token",required:["purpose"],beforeSubmit:function(){c(this).find("button").attr("disabled",!0).filter(".submit_button").text(b.t("buttons.generating_token","Generating Token..."))},success:function(a){c(this).find("button").attr("disabled",!1).filter(".submit_button").text(b.t("buttons.generate_token","Generate Token")),c("#add_access_token_dialog").dialog("close"),c("#no_approved_integrations").hide(),c("#access_tokens_holder").show();var d=c(".access_token.blank:first").clone(!0).removeClass("blank");a.created=c.parseFromISO(a.created_at).datetime_formatted||"--",a.expires=c.parseFromISO(a.expires_at).datetime_formatted||b.t("token_never_expires","never"),a.used="--",d.fillTemplateData({data:a,hrefValues:["id"]}),d.data("token",a),c("#access_tokens > tbody").append(d.show()),d.find(".show_token_link").click()},error:function(){c(this).find("button").attr("disabled",!1).filter(".submit_button").text(b.t("errors.generating_token_failed","Generating Token Failed"))}}),c("#token_details_dialog .regenerate_token").click(function(){var a=confirm(b.t("confirms.regenerate_token","Are you sure you want to regenerate this token?  Anything using this token will have to be updated."));if(!a)return;var d=c("#token_details_dialog"),e=d.data("token"),f=d.data("token_url"),g=c(this);g.text(b.t("buttons.regenerating_token","Regenerating token...")).attr("disabled",!0),c.ajaxJSON(f,"PUT",{"access_token[regenerate]":"1"},function(a){a.created=c.parseFromISO(a.created_at).datetime_formatted||"--",a.expires=c.parseFromISO(a.expires_at).datetime_formatted||b.t("token_never_expires","never"),a.used=c.parseFromISO(a.last_used_at).datetime_formatted||"--",a.visible_token=a.visible_token||"protected",d.fillTemplateData({data:a}).find(".full_token_warning").showIf(a.visible_token.length>10),e.data("token",a),g.text(b.t("buttons.regenerate_token","Regenerate Token")).attr("disabled",!1)},function(){g.text(b.t("errors.regenerating_token_failed","Regenerating Token Failed")).attr("disabled",!1)})}),c(".show_token_link").click(function(a){function d(a){e.fillTemplateData({data:a}),e.data("token_url",f),e.find(".refresh_token").showIf(a.visible_token&&a.visible_token!=="protected").find(".regenerate_token").text(b.t("buttons.regenerate_token","Regenerate Token")).attr("disabled",!1),e.find(".loading_message,.error_loading_message").hide().end().find(".results").show().end().find(".full_token_warning").showIf(a.visible_token.length>10)}a.preventDefault();var e=c("#token_details_dialog"),f=c(this).attr("rel");e.dialog("close").dialog({autoOpen:!1,width:600}).dialog("open");var g=c(this).parents(".access_token");e.data("token",g),e.find(".loading_message").show().end().find(".results,.error_loading_message").hide();var h=g.data("token");h?d(h):c.ajaxJSON(f,"GET",{},function(a){a.created=c.parseFromISO(a.created_at).datetime_formatted||"--",a.expires=c.parseFromISO(a.expires_at).datetime_formatted||b.t("token_never_expires","never"),a.used=c.parseFromISO(a.last_used_at).datetime_formatted||"--",a.visible_token=a.visible_token||"protected",g.data("token",a),d(a)},function(){e.find(".error_loading_message").show().end().find(".results,.loading_message").hide()})}),c(".add_access_token_link").click(function(a){a.preventDefault(),c("#access_token_form").find("button").attr("disabled",!1).filter(".submit_button").text(b.t("buttons.generate_token","Generate Token")),c("#add_access_token_dialog").find(":input").val("").end().dialog({width:500})}),c(document).fragmentChange(function(a,b){var d=b.substring(1);d.match(/^register/)&&(d=d.substring(9)),c("#unregistered_service_"+d+":visible").length>0&&c("#unregistered_service_"+d+":visible").click()}).fragmentChange(),c("#profile_pic_dialog .add_pic_link").click(function(a){a.preventDefault(),c("#add_pic_form").slideToggle()}),c("#profile_pic_dialog").delegate("img","click",function(){c(this).hasClass("pending")||(c("#profile_pic_dialog .img.selected").removeClass("selected"),c(this).parent().addClass("selected"),c("#profile_pic_dialog .select_button").attr("disabled",!1))}),c("#add_pic_form").formSubmit({fileUpload:!0,beforeSubmit:function(){c(this).find("button").attr("disabled",!0).text(b.t("buttons.adding_file","Adding File..."));var a=c("<span class='img'><img/></span>"),d=a.find("img");return d.attr("src","/images/ajax-loader.gif"),d.addClass("pending"),c("#profile_pic_dialog .profile_pic_list div").before(a),a},success:function(a,d){var e=a.attachment,f=a.avatar,g=c("#add_pic_form");c(this).find("button").prop("disabled",!1).text(b.t("buttons.add_file","Add File")),g.slideToggle();if(d){var h=d.find("img");h.data("type","attachment").data("token",a.avatar.token).attr("alt",e.display_name),h[0].onerror=function(){h.attr("src","/images/dotted_pic.png")},i.start().then(function(){h.click()})}},error:function(a,d){c(this).find("button").attr("disabled",!1).text(b.t("errors.adding_file_failed","Adding File Failed")),d&&d.remove()}}),c("#profile_pic_dialog .cancel_button").click(function(){c("#profile_pic_dialog").dialog("close")}),c("#profile_pic_dialog .select_button").click(function(){var a="/api/v1/users/self",d=c("#profile_pic_dialog"),e=d.find("button"),f=c("#profile_pic_dialog .profile_pic_list .img.selected img"),g={"user[avatar][token]":f.data("token")};e.prop("disabled",!0).filter(".select_button").text(b.t("buttons.selecting_image","Selecting Image..."));if(f.length===0)return;c.ajaxJSON(a,"PUT",g,function(a){var f=c(".profile_pic_link img"),g=c("#profile_pic_dialog .img.selected img").attr("src");e.prop("disabled",!1).filter(".select_button").text(b.t("buttons.select_image","Select Image")),a.avatar_url==="/images/no_pic.gif"&&(a.avatar_url="/images/dotted_pic.png"),f.attr("src",g),d.dialog("close")},function(a){e.prop("disabled",!1).filter(".select_button").text(b.t("errors.selecting_image_failed","Selecting image failed, please try again"))})}),c(".profile_pic_link").click(function(a){a.preventDefault();var d=c("#profile_pic_dialog");d.find(".img.selected").removeClass("selected"),d.find(".select_button").prop("disabled",!0);if(c(this).hasClass("locked")){alert(b.t("alerts.profile_picture_locked","Your profile picture has been locked by an administrator, and cannot be changed."));return}d.hasClass("loaded")||(d.find(".profile_pic_list h3").text(b.t("headers.loading_images","Loading Images...")),c.ajaxJSON(h,"GET",{},function(a){if(a&&a.length>0){d.addClass("loaded"),d.find(".profile_pic_list h3").remove();var e=!1;for(var f in a){var g=a[f],h=c("<span />",{"class":"img"}),j=c("<img />").appendTo(h);g.pending?(j.addClass("pending").attr("src","/images/ajax-loader.gif").data("token",g.token),e=!0):j.attr("src",g.url).data("token",g.token),j.data("token",g.token).attr("alt",g.display_name||g.type).attr("title",g.display_name||g.type).attr("data-type",g.type),j[0].onerror=function(){h.remove()},d.find(".profile_pic_list div").before(h)}e&&i.start()}else d.find(".profile_pic_list h3").text(b.t("errors.loading_images_failed","Loading Images Failed, please try again"))},function(a){d.find(".profile_pic_list h3").text(b.t("errors.loading_images_failed","Loading Images Failed, please try again"))})),c("#profile_pic_dialog").dialog("close").dialog({autoOpen:!1,title:b.t("titles.select_profile_pic","Select Profile Pic"),width:500,height:300}).dialog("open")});var j=function(){var a=c(".profile_pic_link img")[0];a&&(a.complete?a.width<5&&(a.src="/images/dotted_pic.png"):setTimeout(j,500))};setTimeout(j,500)})