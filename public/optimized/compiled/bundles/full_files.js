define("translations/files",["i18nObj","jquery"],function(a,b){b.extend(!0,a,{translations:{es:{errors:{failed:"Falló"},files:{alts:{collaboration:"Colaboración",file:"Archivo",folder_locked:"Carpeta Bloqueada",locked_file:"Archivo Bloqueado"},buttons:{add_collaboration:"Agregue la Colaboración",update_collaboration:"Actualizar la Colaboración",update_file:"Actualice el Archivo"},descriptions:{collaborations:"Colaboraciones son una forma para usar herramientas en línea como Google Docs y Etherpad para trabajar colaborativamente en tareas como trabajos en grupo y toma de notas. Esta es una carpeta especial que muestra cualquier colaboración que ha creado para poder tener un lugar para seguir y crear estas colaboraciones",collaborations2:"Para saber más acerca de un tipo en particular de colaboración, haga click en &quot;Nueva Colaboración&quot; y luego escoja el tipo de la lista desplegable."},errors:{extracting:"Hubieron errors extrayendo el archivo zip. Intente de nuevo.",failed:"Falló",failed_uploading:"La Carga Falló: %{error_info} ",loading_file:"Error Cargando los Contenidos de Archivo. Intente de nuevo.",server_returned_invalid_status:"El servidor dejó de reporter un estátus válido",server_unresponsive:"El servidor dejó de responder a las solicitudes de estatus",unexpected_response:"no se obtuvo una respuesta esperada",update_file_failed:"Actualización del Archivo Falló, intente de nuevo",uploading:"Error de Carga"},links:{add_files:"Agregar Archivos"},messages:{access_denied:"No puede leer el contenido de este folder.",done_uploading:"Carga completa",error_count:{one:"1 Error",other:"%{count} Errores"},extraction_complete:"¡Extracción completa! Actualización la Estructura del Archivo...",finalizing:"Finalizando",folder_empty:"Nada en esta Carpeta",loading_files:"Cargando los archivos...",no_collaborations:"No hay colaboraciones que mostrar",no_files_selected:"Ningún archivo válido fue seleccionado",queue:"En Fila ",queued:"En Fila",updating_file:"Actualizando el Archivo...",upload_complete:"Carga completa",uploading:"Cargando ",uploading_files:{one:"Cargando 1 Archivo...",other:"Cargando %{count} Archivos..."},uploading_with_speed:"Cargando (%{speed}KB/s) "},prompts:{delete_file:"¿Está seguro de que quiere borrar este archivo?",delete_folder:"¿Está seguro de que quiere borrar esta carpeta y todos sus componentes?",duplicate_filenames:"Los archivos con los siguientes nombres ya existen en esta carpeta. ¿Desea reemplazarlos, o renombrarlos con nombres únicos?",extract_zip:"Este archivo es un archivo comprimido zip. ¿Desea extraer sus contenidos en esta carpeta?"},titles:{add_collaboration:"Agregar una Nueva Colaboración",click_and_drag:"Hacer click y arrastrar para mover la carpeta a otra carpeta",drag_to_move:"Arrastrar para mover a una carpeta diferente",edit_collaboration:"Editar la Colaboración",extracting:"Extrayendo Archivos a la Carpeta",file_uplaods_queue:"Lista de Cargas de Archivos",lock_file:"Bloquear el Archivo",lock_folder:"Bloquear la Carpeta"},warnings:{file_uploaded_without_response:"El archive puede haberse cargado, pero el servidor no ha respondido. Recargue la página para confirmar."}}}}})}),define("uploadify",["jquery"],function(a){a.extend(a.fn,{uploadify:function(b){a(this).each(function(){var c=a.extend({id:a(this).attr("id"),uploader:"uploadify.swf",script:"uploadify.php",expressInstall:null,folder:"",height:30,width:120,cancelImg:"cancel.png",wmode:"opaque",scriptAccess:"sameDomain",fileDataName:"Filedata",method:"POST",queueSizeLimit:999,simUploadLimit:1,queueID:!1,displayData:"percentage",removeCompleted:!0,onInit:function(){},onSelect:function(){},onSelectOnce:function(){},onQueueFull:function(){},onCheck:function(){},onCancel:function(){},onClearQueue:function(){},onError:function(){},onProgress:function(){},onComplete:function(){},onAllComplete:function(){}},b);a(this).data("settings",c);var d=location.pathname;d=d.split("/"),d.pop(),d=d.join("/")+"/";var e={};e.uploadifyID=c.id,e.pagepath=d,c.buttonImg&&(e.buttonImg=escape(c.buttonImg)),c.buttonText&&(e.buttonText=escape(c.buttonText)),c.rollover&&(e.rollover=!0),e.script=c.script,e.folder=escape(c.folder);if(c.scriptData){var f="";for(var g in c.scriptData)f+="&"+g+"="+c.scriptData[g];e.scriptData=escape(f.substr(1))}e.width=c.width,e.height=c.height,e.wmode=c.wmode,e.method=c.method,e.queueSizeLimit=c.queueSizeLimit,e.simUploadLimit=c.simUploadLimit,c.hideButton&&(e.hideButton=!0),c.fileDesc&&(e.fileDesc=c.fileDesc),c.fileExt&&(e.fileExt=c.fileExt),c.multi&&(e.multi=!0),c.auto&&(e.auto=!0),c.sizeLimit&&(e.sizeLimit=c.sizeLimit),c.checkScript&&(e.checkScript=c.checkScript),c.fileDataName&&(e.fileDataName=c.fileDataName),c.queueID&&(e.queueID=c.queueID),c.onInit()!==!1&&(a(this).css("display","none"),a(this).after('<div id="'+a(this).attr("id")+'Uploader"></div>'),swfobject.embedSWF(c.uploader,c.id+"Uploader",c.width,c.height,"9.0.24",c.expressInstall,e,{quality:"high",wmode:c.wmode,allowScriptAccess:c.scriptAccess},{},function(a){typeof c.onSWFReady=="function"&&a.success&&c.onSWFReady()}),c.queueID==0?a("#"+a(this).attr("id")+"Uploader").after('<div id="'+a(this).attr("id")+'Queue" class="uploadifyQueue"></div>'):a("#"+c.queueID).addClass("uploadifyQueue")),typeof c.onOpen=="function"&&a(this).bind("uploadifyOpen",c.onOpen),a(this).bind("uploadifySelect",{action:c.onSelect,queueID:c.queueID},function(b,d,e){if(b.data.action(b,d,e)!==!1){var f=Math.round(e.size/1024*100)*.01,g="KB";f>1e3&&(f=Math.round(f*.001*100)*.01,g="MB");var h=f.toString().split(".");h.length>1?f=h[0]+"."+h[1].substr(0,2):f=h[0],e.name.length>20?fileName=e.name.substr(0,20)+"...":fileName=e.name,queue="#"+a(this).attr("id")+"Queue",b.data.queueID&&(queue="#"+b.data.queueID),a(queue).append('<div id="'+a(this).attr("id")+d+'" class="uploadifyQueueItem">\t\t\t\t\t\t\t\t<div class="cancel">\t\t\t\t\t\t\t\t\t<a href="javascript:jQuery(\'#'+a(this).attr("id")+"').uploadifyCancel('"+d+'\')"><img src="'+c.cancelImg+'" border="0" /></a>\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t<span class="fileName">'+fileName+" ("+f+g+')</span><span class="percentage"></span>\t\t\t\t\t\t\t\t<div class="uploadifyProgress">\t\t\t\t\t\t\t\t\t<div id="'+a(this).attr("id")+d+'ProgressBar" class="uploadifyProgressBar"><!--Progress Bar--></div>\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t</div>')}}),a(this).bind("uploadifySelectOnce",{action:c.onSelectOnce},function(b,d){b.data.action(b,d),c.auto&&(c.checkScript?a(this).uploadifyUpload(null,!1):a(this).uploadifyUpload(null,!0))}),a(this).bind("uploadifyQueueFull",{action:c.onQueueFull},function(a,b){a.data.action(a,b)!==!1&&alert("The queue is full.  The max size is "+b+".")}),a(this).bind("uploadifyCheckExist",{action:c.onCheck},function(b,c,e,f,g){var h=new Object;h=e,h.folder=f.substr(0,1)=="/"?f:d+f;if(g)for(var i in e)var j=i;a.post(c,h,function(c){for(var d in c)if(b.data.action(b,c,d)!==!1){var e=confirm("Do you want to replace the file "+c[d]+"?");e||document.getElementById(a(b.target).attr("id")+"Uploader").cancelFileUpload(d,!0,!0)}g?document.getElementById(a(b.target).attr("id")+"Uploader").startFileUpload(j,!0):document.getElementById(a(b.target).attr("id")+"Uploader").startFileUpload(null,!0)},"json")}),a(this).bind("uploadifyCancel",{action:c.onCancel},function(b,c,d,e,f,g){if(b.data.action(b,c,d,e,g)!==!1&&f){var h=g==1?0:250;a("#"+a(this).attr("id")+c).fadeOut(h,function(){a(this).remove()})}}),a(this).bind("uploadifyClearQueue",{action:c.onClearQueue},function(b,d){var e=c.queueID?c.queueID:a(this).attr("id")+"Queue";d&&a("#"+e).find(".uploadifyQueueItem").remove(),b.data.action(b,d)!==!1&&a("#"+e).find(".uploadifyQueueItem").each(function(){var b=a(".uploadifyQueueItem").index(this);a(this).delay(b*100).fadeOut(250,function(){a(this).remove()})})});var h=[];a(this).bind("uploadifyError",{action:c.onError},function(b,c,d,e){if(b.data.action(b,c,d,e)!==!1){var f=new Array(c,d,e);h.push(f),a("#"+a(this).attr("id")+c).find(".percentage").text(" - "+e.type+" Error"),a("#"+a(this).attr("id")+c).find(".uploadifyProgress").hide(),a("#"+a(this).attr("id")+c).addClass("uploadifyError")}}),typeof c.onUpload=="function"&&a(this).bind("uploadifyUpload",c.onUpload),a(this).bind("uploadifyProgress",{action:c.onProgress,toDisplay:c.displayData},function(b,c,d,e){b.data.action(b,c,d,e)!==!1&&(a("#"+a(this).attr("id")+c+"ProgressBar").animate({width:e.percentage+"%"},250,function(){e.percentage==100&&a(this).closest(".uploadifyProgress").fadeOut(250,function(){a(this).remove()})}),b.data.toDisplay=="percentage"&&(displayData=" - "+e.percentage+"%"),b.data.toDisplay=="speed"&&(displayData=" - "+e.speed+"KB/s"),b.data.toDisplay==null&&(displayData=" "),a("#"+a(this).attr("id")+c).find(".percentage").text(displayData))}),a(this).bind("uploadifyComplete",{action:c.onComplete},function(b,d,e,f,g){b.data.action(b,d,e,unescape(f),g)!==!1&&(a("#"+a(this).attr("id")+d).find(".percentage").text(" - Completed"),c.removeCompleted&&a("#"+a(b.target).attr("id")+d).fadeOut(250,function(){a(this).remove()}),a("#"+a(b.target).attr("id")+d).addClass("completed"))}),typeof c.onAllComplete=="function"&&a(this).bind("uploadifyAllComplete",{action:c.onAllComplete},function(a,b){a.data.action(a,b)!==!1&&(h=[])})})},uploadifySettings:function(b,c,d){var e=!1;a(this).each(function(){if(b=="scriptData"&&c!=null){if(d)var f=c;else var f=a.extend(a(this).data("settings").scriptData,c);var g="";for(var h in f)g+="&"+h+"="+f[h];c=escape(g.substr(1))}e=document.getElementById(a(this).attr("id")+"Uploader").updateSettings(b,c)});if(c==null&&b=="scriptData"){var f=unescape(e).split("&"),g=new Object;for(var h=0;h<f.length;h++){var i=f[h].split("=");g[i[0]]=i[1]}e=g}return e},uploadifyUpload:function(b,c){a(this).each(function(){c||(c=!1),document.getElementById(a(this).attr("id")+"Uploader").startFileUpload(b,c)})},uploadifyCancel:function(b){a(this).each(function(){document.getElementById(a(this).attr("id")+"Uploader").cancelFileUpload(b,!0,!0,!1)})},uploadifyClearQueue:function(){a(this).each(function(){document.getElementById(a(this).attr("id")+"Uploader").clearFileUploadQueue(!1)})}})}),define("full_files",["INST","i18n!files","jquery","str/htmlEscape","jqueryui/draggable","jquery.ajaxJSON","jquery.doc_previews","jquery.inst_tree","jquery.instructure_date_and_time","jquery.instructure_forms","jqueryui/dialog","jquery.instructure_misc_helpers","jquery.instructure_misc_plugins","jquery.keycodes","jquery.loadingImg","jquery.scrollToVisible","jquery.templateData","media_comments","vendor/jquery.scrollTo","jqueryui/droppable","jqueryui/progressbar","jqueryui/sortable","vendor/scribd.view"],function(a,b,c,d){var e={},f=[];(function(){var h=c("#files_content"),i=c("#swfupload_holder"),j=c("#add_file_link"),k=c("#files_structure"),l=c("#files_structure_list");c.extend(e,{canManageAContext:!1,init:function(){h=c("#files_content"),i=c("#swfupload_holder"),j=c("#add_file_link"),k=c("#files_structure"),l=c("#files_structure_list"),h.prepend(i),e.clearDataCache.cacheIndex=0;for(var a in contexts){var m={context:contexts[a],context_name:contexts[a].name,context_string:contexts[a].asset_string};if(contexts[a].asset_string){var n=contexts[a].asset_string.replace(/_\d+$/,"");m[n]=contexts[a]}f.push([m,{}])}for(var a in f)if(f[a]){var o=f[a][0],n=null,p=null,q=null;for(var r in o)o[r]&&r!="context_string"&&r!="context_name"&&r!="context"&&(n=r,p=o[r].name,q=o[r]);f[a][0].context_string=n+"_"+o[n].id,f[a][0].context_name=p,f[a][0].context=q,q&&q.permissions&&q.permissions.manage_files&&(e.canManageAContext=!0)}h.append(c("#drag_n_drop_panel")),h.append(c("#content_templates .content_panel").hide()),c.handlesHTML5Files&&h.bind("dragenter dragover",function(a){a.preventDefault(),a.stopPropagation();var b=e.currentItemData();if(!b||b.mime_class!="folder")return;c(this).addClass("file_drag"),c("#drag_n_drop_panel").css("top",h.scrollTop())}).bind("dragleave dragout",function(a){c(this).closest(".drag_panel").length||c(this).removeClass("file_drag")}).bind("drop",function(a){var f=a.originalEvent.dataTransfer;if(f){var h=e.currentItemData();a.preventDefault(),a.stopPropagation(),c(this).removeClass("file_drag");if(!h||h.mime_class!="folder")return;var i=[],j=f.files;for(var k=0;k<j.length;k++)j[k]&&j[k].size>0&&i.push(j[k]);if(i.length===0){alert(b.t("messages.no_files_selected","No valid files were selected"));return}var l=!1;i.length==1&&i[0].type.match(/application\/(x-)?zip/)&&(l=confirm(b.t("prompts.extract_zip","This file is a zip file.  Do you want to extract its contents into this folder?")));if(l){var m=i[0];h.context_string;var n=c("."+h.context_string+"_zip_import_url").attr("href"),o={folder_id:h.id,zip_file:i[0],format:"json"},p=null,q=c("<div/>");q.append("Uploading and extracting <b>"+d(m.name)+"</b><br/>to "+d(h.name)+"..."),q.append("<div class='progress'/>");var r=q.find(".progress");r.css("margin","10px"),r.progressbar(),q.dialog("close").dialog({autoOpen:!1,title:b.t("titles.extracting","Extracting Files into Folder"),close:function(){q.data("closed",!0),setTimeout(function(){q.detach()},500)}}).dialog("open");var s=function(a){q.text(b.t("errors.extracting","There were errors extracting the zip file.  Please try again."));var d=c("<ul/>");for(var e in a){var f=a[e],g=c("<li/>");g.text(f),d.append(g)}q.append(d)},t=function(a){var d=c("#file_context_links ."+h.context_string+"_zip_import_status_url").attr("href");d=c.replaceTags(d,"id",a),c.ajaxJSON(d,"GET",{},function(c){var d=c.zip_file_import;if(q.data("closed"))return;d&&d.data&&d.data.errors?s(d.data.errors):d&&d.workflow_state=="imported"?(r.progressbar("value",100),q.append(b.t("messages.extraction_complete","Extraction complete!  Updating...")),e.refreshContext(h.context_string,function(){q.dialog("close")})):d?d&&d.workflow_state=="failed"?s([]):(t.errorCount=0,setTimeout(function(){t(a)},2e3),r.progressbar("value",(d.progress||0)*100)):(t.blankCount=t.blankCount||0,t.blankCount++,t.blankCount>30?s([b.t("errors.server_returned_invalid_status","The server stopped returning a valid status")]):setTimeout(function(){t(a)},2e3))},function(c){t.errorCount=t.errorCount||0,t.errorCount++,t.errorCount>5?s([b.t("errors.server_unresponsive","The server stopped responding to status requests")]):setTimeout(function(){t(a)},2e3)})};c.ajaxFileUpload({url:n,data:o,method:"POST",success:function(a){zip_import_id=a.zip_file_import.id,t(zip_import_id)},error:function(a){q.text(b.t("errors.uploading_zip","There were errors uploading the zip file."))}})}else{var h=e.currentItemData(),u=[];for(k in i)u.push(i[k].name);e.preflight(h.id,h.context_string,u,function(a){for(k in i)i[k].duplicate_handling=a},function(){for(var a in i)g.queueAjaxUpload(i[a])},function(){})}return!1}})},preflight:function(a,e,f,g,h,i){var j={folder_id:a,context_code:e,filenames:f};c.ajaxJSON("/files/preflight","GET",j,function(a){if(a.duplicates&&a.duplicates.length>0){var e=c("#duplicate_filename_dialog");e.find(".duplicate_filename_prompt").text(b.t("prompts.duplicate_filenames","Files with the following names already exist in this folder. Do you want to replace them, or rename the new files with unique names?"));var f="";for(idx in a.duplicates)f+="<span class='duplicate_filename'>"+d(a.duplicates[idx])+"</span>";e.find(".duplicate_filenames").html(f),e.dialog("close").dialog({autoOpen:!1,title:"",width:500}).dialog("open"),e.find("button").unbind("click"),e.find(".cancel_button").click(function(){i(),e.dialog("close")}),e.find(".rename_button").click(function(){g("rename"),h(),e.dialog("close")}),e.find(".overwrite_button").click(function(){g("overwrite"),h(),e.dialog("close")})}else h()},function(a){i()})},context_page_view_ids:{},updatePageView:function(a){return},viewFile:function(a,b){var d=c("#file_context_links ."+a+"_inline_view_attachment_url").attr("href");d=c.replaceTags(d,"id",b),c.ajaxJSON(d,"POST",{},function(){},function(){})},selectFolder:function(a){if(!e.selectFolder.forceRefresh&&(a.hasClass("active-node")||a.hasClass("active-leaf")))return;e.selectFolder.forceRefresh=!1;var b=a;while(b.parent("ul").parent("li").length>0)b=b.parent("ul").parent("li"),e.expandFolder(b);a.children(".text:visible:first").click(),k.find("li.node.active-node,li.leaf.active-leaf").length===0&&k.find("li.node:visible:first").children(".text:visible:first").click();if(!e.currentItemData()){setTimeout(function(){e.selectFolder(a)},250);return}!e.currentItemData().includes_files&&e.currentItemData().full_name&&e.getFilesForFolder(e.currentItemData())},deleteAttachmentIds:function(a){for(var b in a){var d=a[b],f=c("#files_structure .file_"+d);f.prev("li.separator").remove(),f.remove(),e.refreshView(),e.updateQuota()}},gettingFiles:{},getFilesForFolder:function(a,b){var d=a.context_string+"_"+a.id;if(e.gettingFiles[d])return;var f=k.find("li.folder_"+a.id);if(f.hasClass("folder_locked")&&(!a.context||!a.context.permissions||!a.context.permissions.manage_files))return;if(a.false_folder){e.refreshContext(a.context_string,function(){e.getFilesForFolder(a,b)});return}e.gettingFiles[d]=!0;var g=c.replaceTags(c("#file_context_links ."+a.context_string+"_folder_url").attr("href"),"id",a.id);c.ajaxJSON(g,"GET",{},function(f){e.gettingFiles[d]=!1;var g=f.actual_folder.folder;g.includes_files=!0,e.updateFolder(a.context_string,{folder:g,already_in_place:!0},!1);for(var i in f.files){var l=f.files[i].attachment;l&&e.updateFile(a.context_string,{attachment:l,definitely_new:!0},!1)}k.find(".folder_"+g.id).triggerHandler("files_load");var m=h.find(".message.no_content:visible").length>0;if(b!==!1||m)b&&c.isFunction(b)?b(f):e.refreshView();j.triggerHandler("show")},function(a){e.gettingFiles[d]=!1})},expandFolder:function(a){l[0]&&l[0].ExpandNode&&l[0].ExpandNode(c("#files_structure_list"),a)},collapseFolder:function(a){l[0]&&l[0].CollapseNode&&l[0].CollapseNode(c("#files_structure_list"),a)},fullPath:function(a){var b=[],c=e.itemData(a);b.unshift(c.name.replace(/\//g,"//"));while(a.parent("ul").parent("li").length>0)a=a.parent("ul").parent("li"),c=e.itemData(a),b.unshift(c.name.replace(/\//g,"//"));return b.join("/")},selectNodeFromPath:function(a){var b=e.nodeFromPath(a);e.selectFolder(b);var c=function(){b.unbind("files_load",c),b.hasClass("active-node")&&e.selectNodeFromPath(a)};b.bind("files_load",c),k.find(".node.active-node,.leaf.active-leaf").length===0&&e.selectFolder(k.find(".node:visible:first"))},nodeFromPath:function(a){try{if(k.find("#files_structure_list > li."+a).length>0)return k.find("#files_structure_list > li."+a)}catch(b){}var d=a.replace(/\/\//g,"\\").split("/"),e=k,f=!0;for(var g in d){var h=d[g].replace(/\\\\/g,"/"),i=!1;f&&e.children("ul").children("li").each(function(){if(c(this).children(".text.name").text()==h)return e=c(this),i=!0,!1}),f=i}return e},draggable_helper:function(a,b){if(c(this).hasClass("folder_item"))b=c(this);else{var d=b.width();return b.clone().css("backgroundColor","#eeeeee").css("height",50).css("borderWidth",1).css("borderStyle","solid").css("borderColor","#ccc").css("width",d-50)}var e=b.clone().attr("id","file_drag");e.find(".header .sub_header").remove(),e.find(".header").append("<div class='sub_header'/>"),e.find(".header .sub_header").html("&nbsp;"),e.addClass("file_drag"),e.find(".links").remove(),e.css("width",100);var f=c("<ul/>");return f.addClass("files_content"),f.append(e),f.addClass("true-draggable"),f.css("width",200),f.css("height",50),c("#content").append(f),f},updateQuota:function(){if(!c("#quota").length)return;var a=c(".quota_url").attr("href");c.ajaxJSON(a,"GET",{},function(a){c("#quota").text(a.quota),c("#quota_used").text(a.quota_used)},function(){})}}),c.extend(e,{draggable_options:{handle:".draggable.item_icon",distance:5,helper:e.draggable_helper,start:function(a,b){h.addClass("dragging")},stop:function(){setTimeout(function(){h.removeClass("dragging")},500)}},droppable_options:{accept:".file,.folder",hoverClass:"drop_target",tolerance:"pointer",drop:function(a,b){if(!c(b.helper).hasClass("true-draggable"))return;var d=c(b.draggable),f=e.itemData(d),g=c(this),h=e.itemData(c(this).parent(".folder"));h=h||e.itemData(c(this)),k.loadingImage();if(d.hasClass("file"))if(c(b.helper).hasClass("copy_drag")){var i=c("#file_context_links ."+h.context_string+"_attachments_url").attr("href"),j={"attachment[source_attachment_id]":f.id,"attachment[folder_id]":h.id};c.ajaxJSON(i,"POST",j,function(a){k.loadingImage("remove"),e.updateFile(h.context_string,a,!1),e.selectFolder(g),e.refreshView()},function(a){k.loadingImage("remove")})}else{var i=c("#file_context_links ."+h.context_string+"_attachment_url").attr("href");i=c.replaceTags(i,"id",f.id),c.ajaxJSON(i,"PUT",{"attachment[folder_id]":h.id},function(a){k.loadingImage("remove"),e.updateFile(h.context_string,a,!1),e.selectFolder(g),e.refreshView()},function(a){k.loadingImage("remove")})}else if(c(b.helper).hasClass("copy_drag")){var i=c("#file_context_links ."+h.context_string+"_folders_url").attr("href"),j={"folder[source_folder_id]":f.id,"folder[parent_folder_id]":h.id};c.ajaxJSON(i,"POST",j,function(a){k.loadingImage("remove"),e.refreshContext(h.root_context_string)},function(a){k.loadingImage("remove")})}else{var i=c("#file_context_links ."+h.context_string+"_folder_url").attr("href");i=c.replaceTags(i,"id",f.id),c.ajaxJSON(i,"PUT",{"folder[parent_folder_id]":h.id},function(a){k.loadingImage("remove"),e.refreshContext(f.root_context_string)},function(a){k.loadingImage("remove")})}},over:function(a,b){c(b.helper).hasClass("true-draggable")||c(this).removeClass("drop_target");var f=e.itemData(c(b.draggable)),g=e.itemData(c(this).parent(".folder"));g=g||e.itemData(c(this)),c(b.helper).find(".header .sub_header").text("move to "+g.name),f&&g&&f.context_string!=g.context_string&&(c(b.helper).addClass("copy_drag"),c(b.helper).find(".header .sub_header").html("<strong>copy</strong> to "+d(g.name)))},out:function(a,b){c(b.helper).removeClass("copy_drag"),c(b.helper).find(".header .sub_header").html("&nbsp;")}},breadcrumb:function(){var a=location.hash.substring(1).replace(/\/\//g,"\\").split("/"),b=c("<div/>"),d=[];for(var e=0;e<a.length-1;e++){var f=c("<a/>");d.push(a[e].replace(/\\\\/g,"/")),f.attr("href","#"+d.join("/")),f.text(a[e]),b.append(f)}return b},refreshContext:function(a,b){e.refreshContext.refreshing=e.refreshContext.refreshing||{};if(e.refreshContext.refreshing[a])return;e.refreshContext.refreshing[a]=!0;var d=c("#file_context_links ."+a+"_attachments_url").attr("href");c.ajaxJSON(d,"GET",{},function(d){e.clearDataCache(),e.refreshContext.refreshing[a]=!1;var g=k.scrollTop(),h=null;for(var i in f){var j=f[i][0];if(j.context_string==a){h=j.context_name,f[i][0].context.includes_files=!0;for(var m in d.folders)for(var n in f[i][1].folders)f[i][1].folders[n].id==d.folders[m].id&&(d.folders[m].includes_files=f[i][1].folders[n].includes_files);d.files=d.files||[];for(var m in f[i][1].files)d.files.push(f[i][1].files[m]);f[i][1]=d}}var o=c("#files_structure > ul > li.context."+a).filter(":first");o.length===0&&(o=null);var p=[],q=!1;if(o){q=o.hasClass("open");var r=o.find("li.node.open");r.each(function(){p.push(e.itemData(c(this)).id)})}var s=null;for(var i in d.contexts)for(var m in d.contexts[i])s||(s=m,h=d.contexts[i][m].name);var t=null;!d.folders&&d[0]&&d[0][1]&&d[0][1].folders&&(d.folders=d[0][1].folders);for(var i in d.folders)!t&&d.folders[i].folder&&d.folders[i].folder.parent_folder_id===null&&(t=d.folders[i].folder);var u=o;if(!u||u.length===0)u=k.find(".folder_blank").clone(!0).removeClass("folder_blank");u.children(".name").text(h),u.children(".id").text(t.id),u.addClass("context folder folder_"+t.id+" "+a),u.find("li").addClass("to_be_removed");var v=u.children("ul"),w=function(a,b){for(var c in d.folders)if(b.id&&d.folders[c].folder.parent_folder_id==b.id){var e=a.children("ul").children(".folder_"+d.folders[c].folder.id);e.length===0&&(e=k.find(".folder_blank").clone(!0).removeClass("folder_blank"),e.addClass("folder folder_"+d.folders[c].folder.id),e.children(".id").text(d.folders[c].folder.id),e.children(".name").text(d.folders[c].folder.name)),e.removeClass("to_be_removed"),w(e,d.folders[c].folder),e.parents("body").length===0&&a.children("ul").append(e.show())}};for(var i in d.folders)if(d.folders[i].folder.parent_folder_id==t.id){var x=v.find(".folder_"+d.folders[i].folder.id);x.length===0&&(x=k.find(".folder_blank").clone(!0).removeClass("folder_blank"),x.addClass("folder folder_"+d.folders[i].folder.id),x.children(".name").text(d.folders[i].folder.name),x.children(".id").text(d.folders[i].folder.id)),x.removeClass("to_be_removed"),w(x,d.folders[i].folder),x.parents("body").length===0&&v.append(x.show())}if(d.collaborations&&!a.match(/^user_/)){var y=k.find(".folder_blank").clone(!0).removeClass("folder_blank");y.addClass("collaborations"),y.fillTemplateData({data:{name:"collaborations"}});for(var i in d.collaborations){var z=d.collaborations[i].collaboration||d.collaborations[i].google_docs_collaboration||d.collaborations[i].etherpad_collaboration,A=c(".collaboration_"+z.id);A.length===0&&(A=k.find(".file_blank").clone(!0).removeClass("file_blank"),A.addClass("collaboration_"+d.collaborations[i].collaboration.id),A.addClass("collaboration "+d.collaborations[i].collaboration.collaboration_type),A.fillTemplateData({data:{name:d.collaborations[i].collaboration.title,id:d.collaborations[i].collaboration.id}})),A.removeClass("to_be_removed"),A.parents("body").length===0&&y.children("ul").append(A.show())}v.append(y.show())}var B={};for(var i in d.groups)B[(d.groups[i].group||d.groups[i].course_assigned_group).category]=!0;for(var i in B){var C=k.find(".folder_blank").clone(!0).removeClass("folder_blank");C.fillTemplateData({data:{name:i}}),C.addClass("groups");for(var m in d.groups){var D=d.groups[m].group||d.groups[m].course_assigned_group;if(D.category==i){var E=null;for(var n in d.folders)!E&&!d.folders[n].folder.parent_folder_id===null&&(E=d.folders[n].folder);if(E){var F=C.children("ul").children(".group_"+D.id);F.length===0&&(F=k.find(".folder_blank").clone(!0).removeClass("folder_blank"),F.addClass("group context folder folder_"+E.id),F.addClass("group_"+D.id),F.fillTemplateData({data:{name:D.name,id:E.id}})),F.removeClass("to_be_removed"),w(F,E),F.parents("body").length===0&&C.children("ul").append(F.show())}}}v.append(C.show())}var G=!1;u.find(".to_be_removed").remove(),k.find("#files_structure_list > .folder").each(function(){var b=e.itemData(c(this));b&&b.root_context_string==a&&(c(this)[0]!=u[0]&&(c(this).after(u.show()),c(this).remove()),G=!0)}),G||k.find("#files_structure_list").append(u.show()),u.children(".text").droppable(e.droppable_options),u.find(".folder > .text").droppable(e.droppable_options);for(var i in p)e.expandFolder(u.find(".folder_"+p[i]));q&&e.expandFolder(u),k.scrollTop(g),l.instTree.InitInstTree(l),k.find("li.node.active-node,li.leaf.active-leaf").filter(":first").children(".name").click(),b&&c.isFunction(b)&&b()},function(){e.refreshContext.refreshing[a]=!1})},refreshContentListeners:function(){var a=e.currentContext();a&&a.permissions&&a.permissions.manage_files?(h.find(".folder.draggable_droppable").droppable(e.droppable_options),h.sortable("enable"),h.sortable("refresh")):h.sortable("disable").removeClass("ui-state-disabled"),e.canManageAContext&&(h.find(".folder.draggable_droppable").draggable(e.draggable_options),h.find(".file").draggable(e.draggable_options))},nodeClumpSize:25,addScrollCatcher:function(){var a=function(){var a=h.scrollTop(),b=!1,c=0;h.find(".catcher").remove();var d=h.find(".folder_item:visible:last"),f=d.data("node");if(f){f=f.next();var g=!1;while(f.length>0)f.hasClass("separator")||(c++,c>e.nodeClumpSize?g=!0:e.addContentItem(f)),f=f.next();e.refreshContentListeners(),g&&e.addScrollCatcher()}h.scrollTop(a)},b=c("<li class='catcher'>&nbsp;</li>");e.watchingScroll||(h.bind("scroll",function(b){var c=h.find(".catcher:visible:first");if(c.length>0){var d=c.offset().top,e=h.offset().top+h.height();d<e&&a()}}),e.watchingScroll=!0),h.append(b)},addContentItem:function(a,d){var f=e.itemData(a);if(!f||!f.id)return;var g=!1;if(a.hasClass("node")){var i=h.find(".folder_"+f.id);if(i.length===0){g=!0,i=c("#content_templates .folder:first").clone(!0),d&&i.hide(),i.fillTemplateData({data:f}),i.data("parent_node",a.parent().parent());var j=c.replaceTags(c("."+f.context_string+"_folder_url").attr("href"),"id",f.id);i.find(".rename_item_link,.delete_item_link,.folder_url").attr("href",j),i.addClass("folder_"+f.id),i.find(".item_icon.draggable").attr("title",b.t("titles.click_and_drag","Click and drag to move folder to another folder")),i.data("node",a)}i.toggleClass("editable_folder_item",!a.hasClass("context")&&!!(f.context&&f.context.permissions&&f.context.permissions.manage_files||f.permissions&&f.permissions.update)),i.removeClass("to_be_removed"),i.find(".item_icon").toggleClass("draggable",i.hasClass("editable_folder_item")),i.find(".item_icon").attr("alt","Folder").attr("src",c("#content_blank_icon").attr("src")),f&&f.currently_locked&&i.find(".item_icon").attr("alt",b.t("alts.folder_locked","Locked Folder")).attr("src",c("#content_locked_icon").attr("src")),i.find(".lock_item_link").showIf(!f.currently_locked),i.find(".unlock_item_link").showIf(f.currently_locked),i.toggleClass("folder_locked",!!f&&!!f.currently_locked),i.toggleClass("draggable_droppable",a.hasClass("folder")&&!a.hasClass("context")),g&&h.append(i)}else if(a.hasClass("collaboration")){var i=h.find(".collaboration_"+f.id);if(i.length===0){g=!0,i=c("#content_templates .collaboration:first").clone(!0),d&&i.hide(),i.fillTemplateData({data:f}),i.data("parent_node",a.parent().parent()),i.data("node",a);var k=c.replaceTags(c("."+f.context_string+"_collaboration_url").attr("href"),"id",f.id);i.find(".collaboration_url").attr("href",k),i.addClass("collaboration_"+f.id),i.addClass(f.collaboration_type)}i.toggleClass("editable_folder_item",!!f.permissions&&!!f.permissions.update),i.removeClass("to_be_removed"),i.find(".item_icon").attr("alt",b.t("alts.collaboration","Collaboration")).attr("src",c("#content_blank_icon").attr("src")),g&&h.append(i)}else{var i=h.find(".file_"+f.id);if(i.length===0){g=!0,i=c("#content_templates .file:first").clone(!0),d&&i.hide();var l=c.replaceTags(c("#file_context_links ."+f.context_string+"_attachment_url").attr("href"),"id",f.id),m=c.replaceTags(c("#file_context_links ."+f.context_string+"_download_attachment_url").attr("href"),"id",f.id);i.fillTemplateData({data:f}).data({parent_node:a.parent().parent(),node:a}).addClass(f.mime_class+" file_"+f.id),i.find(".attachment_url").attr("href",l),i.find(".download_url").attr("href",m),i.find(".item_icon.draggable").attr("title","Click and drag to move file to another folder")}i.toggleClass("editable_folder_item",!!(f.context&&f.context.permissions&&f.context.permissions.manage_files||f.permissions&&f.permissions.update)).removeClass("to_be_removed").find(".item_icon").attr({alt:b.t("alts.file","File"),src:c("#content_blank_icon").attr("src")}),f&&f.currently_locked&&i.find(".item_icon").attr({alt:b.t("alts.locked_file","Locked File"),src:c("#content_locked_icon").attr("src")}),i.find(".lock_item_link").showIf(!f.currently_locked),i.find(".unlock_item_link").showIf(f.currently_locked),i.find(".preview_item_link").showIf(f.scribd_doc||f.content_type.match(/image/)||f.content_type.match(/(video|audio)/)&&f.media_entry_id),i.find(".edit_item_content_link_holder").showIf(i.hasClass("editable_folder_item")&&f.context_type!="User"&&(i.hasClass("text")||i.hasClass("html")||i.hasClass("code"))),i.find(".item_icon").toggleClass("draggable",i.hasClass("editable_folder_item")),g&&h.append(i)}return g},reorderContent:function(a,b){var d=[],f=[];for(var g=0;g<b.length;g++)b[g].attachment?d.push(b[g]):b[g].folder&&f.push(b[g]);k.find(".folder_"+a).each(function(){var a=c(this),b=[],d=[];a.children("ul").children("li").each(function(){c(this).hasClass("file")?d.push(c(this)):b.push(c(this))}),d=d.sort(function(a,b){var c=e.itemData(a),d=e.itemData(b);return c.position-d.position});for(var f in d)a.children("ul").append(d[f].prev(".separator")),a.children("ul").append(d[f]);b=b.sort(function(a,b){var c=e.itemData(a)||{},d=e.itemData(b)||{};return(d.position||0)-(c.position||0)});for(var f in b)d[f]&&(a.children("ul").prepend(d[f].prev(".separator")),a.children("ul").prepend(d[f]))}),e.refreshView()},updateCollaboration:function(a,b,d){var g=c.underscore(b.collaboration.context_type)+"_"+b.collaboration.context_id;for(var h in f)if(f[h]&&(f[h][0].context_string==a||f[h][0].context_string==g)){var i=!1;for(var j in f[h][1].collaborations){var m=f[h][1].collaborations[j].collaboration;m.id==b.collaboration.id&&(f[h][1].collaborations[j]=b,k.find(".collaboration_"+m.id).each(function(){var a=e.itemData(c(this).parent("ul").parent("li"));c(this).fillTemplateData({data:{name:b.collaboration.title}}),b.collaboration.title&&c(this).find(".name").attr("title",b.collaboration.title)}),i=!0)}if(!i){var m=b.collaboration;f[h][1].collaborations.push(b);var n=k.find(".file_blank").clone(!0).removeClass("file_blank");n.removeClass("file"),n.addClass("collaboration collaboration_"+m.id+" "+m.collaboration_type),m.name=m.title,n.fillTemplateData({data:m}),m.title&&n.find(".name").attr("title",m.title),k.find("."+a+" .collaborations").children("ul").prepend(n.show())}}d!==!1&&(e.refreshView(b.attachment),l.instTree.InitInstTree(l))},updateFile:function(a,b,d){e.clearDataCache();var g=c.underscore(b.attachment.context_type)+"_"+b.attachment.context_id;for(var h in f)if(f[h]&&(f[h][0].context_string==a||f[h][0].context_string==g)){var i=!1,j=!1;if(!b.definitely_new)for(var m in f[h][1].files){var n=f[h][1].files[m].attachment;n.id==b.attachment.id&&(f[h][1].files[m]=b,k.find(".file_"+n.id).each(function(){var a=e.itemData(c(this).parent("ul").parent("li"));a.id==b.attachment.folder_id?(c(this).fillTemplateData({data:{name:b.attachment.display_name}}),b.attachment.display_name&&c(this).find(".name").attr("title",b.attachment.display_name)):j=!0}),i=!0,j&&k.find(".file_"+n.id).remove())}if(!i||j){var o=b.attachment;i||(b.definitely_new=!1,f[h][1].files.push(b));var p=k.find(".file_blank").clone(!0).removeClass("file_blank");p.addClass("file_"+o.id),p.addClass(o.mime_class),o.name=o.display_name,p.fillTemplateData({data:o}),o.name&&p.find(".name").attr("title",o.name),k.find(".folder_"+o.folder_id).children("ul").append(p.show())}}d!==!1&&(e.refreshView(b.attachment),l.instTree.InitInstTree(l))},updateFolder:function(a,b,d){e.clearDataCache();var g=c.underscore(b.folder.context_type)+"_"+b.folder.context_id,h=b.already_in_place;b.already_in_place=null;for(var i in f)if(f[i]&&(f[i][0].context_string==a||f[i][0].context_string==g)){var j=!1,l=!1;for(var m in f[i][1].folders){var n=f[i][1].folders[m].folder;n.id==b.folder.id&&(n.includes_files&&(b.folder.includes_files=n.includes_files),f[i][1].folders[m]=b,k.find(".folder_"+n.id).each(function(){var a=e.itemData(c(this).parent("ul").parent("li"));a=a||{parent_folder_id:null};if(a.id==b.folder.parent_folder_id){c(this).hasClass("context")||c(this).children(".name").text(b.folder.name).attr("title",b.folder.name);if(!h){c(this).prev("li.separator").remove();var d=c(this).parent("ul").parent("li"),f=null,g=c(this);d.children("ul").children("li:not(.separator)").each(function(){var b=e.itemData(c(this)).position;if(c(this)[0]!=g[0]&&(!c(this).hasClass("folder")||b>=a.position))return f=c(this),!1}),f?(f.before(c(this).show()),f.before("<li class='separator'/>")):(d.children("ul").append("<li class='separator'/>"),d.children("ul").append(c(this).show()))}}else l=!0}),j=!0,l&&k.find(".folder_"+n.id).remove())}if(!j||l)e.foldersStillLoading=e.foldersStillLoading||{},e.foldersStillLoading[b.folder.id]=b,e.refreshContext(a),a!=g&&e.refreshContext(g)}d!==!1&&e.refreshView(b.folder)},refreshView:function(a){k.find("li.node.active-node,li.leaf.active-leaf").filter(":first").children(".text:visible:first").click(),a&&a.id&&(h.find(".file_"+a.id).mouseover(),h.find(".folder_"+a.id).mouseover()),j.triggerHandler("show")},currentItemData:function(){return e.itemData(k.find("li.node.active-node,#files_structure li.leaf.active-leaf"))},currentContext:function(){var a=e.currentItemData().context_string;for(var b in f)if(f[b][0].context_string==a)return f[b][0].context;return null},clearDataCache:function(){e.clearDataCache.cacheIndex++},itemData:function(a){var b=a.data("item_data");if(b&&b.cacheIndex==e.clearDataCache.cacheIndex)return b;var b=e.uncachedItemData(a);return b&&(b.cacheIndex=e.clearDataCache.cacheIndex,a.data("item_data",b)),b},uncachedItemData:function(a){if(a.closest("#files_content").length>0)return e.itemData(a.data("node"));var b=a.getTemplateData({textValues:["id"]}).id;for(var d in f){var g=f[d],h=null;if(a.hasClass("file")){var i=g[1].files;for(var j in i){var k=i[j].attachment;if(k.id==b)return k.context_string=c.underscore(k.context_type)+"_"+k.context_id,k.root_context_string=g[0].context_string,k.context=g[0].context,k.name=k.display_name,k}}else if(a.hasClass("collaborations")){if(a.parents("li.context:last").hasClass(g[0].context_string))return res=a.getTemplateData({textValues:["name"]}),res.context_string=g[0].context_string,res.context=g[0].context,res}else if(a.hasClass("groups")){if(a.parents("li.context:last").hasClass(g[0].context_string))return res=a.getTemplateData({textValues:["name"]}),res.context_string=g[0].context_string,res.context=g[0].context,res}else if(a.hasClass("collaboration")){var l=g[1].collaborations;for(var j in l){var m=l[j].collaboration;if(m.id==b)return m.context_string=c.underscore(m.context_type)+"_"+m.context_id,m.root_context_string=g[0].context_string,m.name=m.title,m}}else if(a.hasClass("folder")){var n=g[1].folders;for(var j in n){var o=n[j].folder;if(o.id==b)return o.context_string=c.underscore(o.context_type)+"_"+o.context_id,o.root_context_string=g[0].context_string,a.hasClass("context")&&(o.name=a.getTemplateData({textValues:["name"]}).name),o.context=g[0].context,o}}else if(a.hasClass("group")){var p=g[1].groups;for(var j in p){var q=p[j].group||p[j].course_assigned_group;q.context_string=c.underscore(q.context_type)+"_"+q.context_id,q.root_context_string=g[0].context_string;if(q.id==b)return q}}}if(a.hasClass("folder")){var g=null;for(var d in f)a.closest(".context").hasClass(f[d][0].context_string)&&(g=f[d]);for(var d in e.foldersStillLoading)if(e.foldersStillLoading[d].folder.id==b){var o=e.foldersStillLoading[d].folder;return o.name=a.getTemplateData({textValues:["name"]}).name,o.context_string=g[0].context_string,o.context=g[0].context,o}if(g){var o={};return o.name=a.getTemplateData({textValues:["name"]}).name,o.id=b,o.context_string=g[0].context_string,o.permissions={read_contents:!0},o.context=g[0].context,o.false_folder=!0,o}}return null}}),c(document).ready(function(){e.init(),setInterval(function(){j.triggerHandler("show")},1e3),c(".folder_item").live("mousedown",function(a){a.preventDefault()}),c(".folder_item.ui-draggable").live("mouseover",function(){c(this).find(".item_icon").attr("title",b.t("titles.drag_to_move","Drag to move to a different folder"))}),i.hover(function(a){j.css("text-decoration","underline")},function(a){j.css("text-decoration","none")}),j.bind("show",function(){var a=j.width(),b=j.height(),c=j.offset(),d=h.offset();c.left=c.left-d.left,c.top=c.top-d.top,i.css({width:a+5,height:b+5,top:c.top-5,left:c.left-5})}),c("#file_uploads_dialog_link").click(function(a){a.preventDefault(),c("#file_uploads").dialog("close").dialog({autoOpen:!1,title:b.t("titles.file_uplaods_queue","File Uploads Queue")}).dialog("open")}),setTimeout(function(){k.find(".folder > .text").droppable(e.droppable_options),h.sortable({distance:5,cancel:".draggable.item_icon",items:"li.file,li.folder",axis:"y",hoverClass:"lameness",containment:"parent",start:function(a,b){h.addClass("dragging")},stop:function(a,b){setTimeout(function(){h.removeClass("dragging")},500)},helper:e.draggable_helper,update:function(a,b){var d=e.itemData(c(b.item)),f=[],g=[],i=h.find(".file:first"),j=h.find(".folder_item"),k=j.index(i);h.find(".folder").each(function(){j.index(c(this))>k&&i.before(c(this));var a=e.itemData(c(this)).id;f.push(a)}),h.find(".file").each(function(){var a=e.itemData(c(this)).id;g.push(a)}),h.loadingImage();var l={order:g.join(","),folder_id:d.folder_id||d.parent_folder_id,folder_order:f.join(",")},m=c("#file_context_links ."+d.context_string+"_reorder_attachments_url").attr("href");c.ajaxJSON(m,"POST",l,function(a){h.loadingImage("remove");for(var b in a)a[b].attachment?e.updateFile(d.context_string,a[b],!1):a[b].folder&&e.updateFolder(d.context_string,a[b],!1);e.reorderContent(d.folder_id,a),e.refreshView(d)},function(){h.loadingImage("remove")})}}),c("#files_structure_list > li").hide(),l.instTree({autoclose:!1,multi:!1,dragdrop:!1,onExpand:function(a){if(a.hasClass("folder")){var b=e.itemData(a);b&&!b.includes_files&&e.getFilesForFolder(b,!1)}},onCollapse:function(a){a.find(".node.active-node,.leaf.active-leaf").length>0&&a.find(".text:visible:first").click()},onClick:function(d,f){h.find(".content_panel").addClass("to_be_hidden"),h.find(".folder_item").addClass("to_be_removed"),h.find(".catcher").addClass("to_be_removed"),h.find(".file_preview").remove(),h.find(".message").remove();var g=function(){h.find(".content_panel.to_be_hidden").hide(),h.find(".catcher.to_be_removed").remove(),h.find(".folder_item.to_be_removed").remove()},i=e.itemData(f),k=encodeURIComponent(e.fullPath(f));location.hash!="#"+k&&location.replace("#"+k),!i.includes_files&&i.full_name&&e.getFilesForFolder(i),i.context_string&&(a&&(a.interaction_context=i.context_string),e.updatePageView(i.context_string));if(f.hasClass("node")){var l=c.replaceTags(c("."+i.context_string+"_folder_url").attr("href"),"id",i.id),m=!1,n=c("<li class='message'>"+b.t("messages.folder_empty","Nothing in this Folder")+"</li>");if(f.hasClass("folder"))if(!i||!i.permissions||!i.permissions.read_contents)h.find(".content_panel:last").after("<li class='message'>"+b.t("messages.access_denied","You cannot read the contents of this folder.")+"</li>"),m=!0;else{var o=c("#folder_panel");o.find(".rename_item_link,.delete_item_link,.folder_url").attr("href",l),o.find(".breadcrumb").empty().append(e.breadcrumb()),o.toggleClass("editable_content_panel",!!(i.context&&i.context.permissions&&i.context.permissions.manage_files||i.permissions&&i.permissions.update)).toggleClass("addable_content_panel",!!(i.context&&i.context.permissions&&i.context.permissions.manage_files||i.permissions&&i.permissions.update)).toggleClass("downloadable_content_panel",!o.hasClass("editable_content_panel")&&!o.hasClass("addable_content_panel")&&!!i.permissions&&!!i.permissions.read_contents),o.removeClass("to_be_hidden"),o.find(".download_zip,.upload_zip").hide(),(f.hasClass("context")||!(i&&i.permissions&&i.permissions.update))&&o.removeClass("editable_content_panel");var p=c.replaceTags(c("."+i.context_string+"_folder_url").attr("href")+"/download","id",i.id);c(".download_zip_link").attr("href",p),c(".upload_zip_link").attr("href",c("."+i.context_string+"_import_url").attr("href")+"?return_to="+encodeURIComponent(location.href)+"&folder_id="+i.id),i.unlock_at_string=c.parseFromISO(i.unlock_at).datetime_formatted,i.lock_at_string=c.parseFromISO(i.lock_at).datetime_formatted,o.find(".lock_after").showIf(i.lock_at),o.find(".lock_until").showIf(i.unlock_at),o.find(".currently_locked_box").showIf(i.currently_locked),o.find(".lock_item_link").showIf(i.parent_folder_id&&!i.currently_locked),o.find(".unlock_item_link").showIf(i.parent_folder_id&&i.currently_locked),o.find(".download_zip").showIf(i.permissions&&i.permissions.read_contents),o.find(".upload_zip").showIf(i.context&&i.context.permissions&&i.context.permissions.manage_files),o.find(".edit_link").showIf(i.context&&i.context.permissions&&i.context.permissions.manage_files),o.fillTemplateData({data:i}),o.data("node",f),o.show(),j.triggerHandler("show")}else if(f.hasClass("collaborations")){var o=c("#collaborations_panel"),q=i.context;o.find(".header .name").text(q.name),o.find(".breadcrumb").empty().append(e.breadcrumb());var r=c("."+i.context_string+"_collaborations_url").attr("href");o.find(".collaborations_link").attr("href",r),o.find(".add_collaboration_link").attr("href",r),o.find(".view_collaborations").showIf(q&&q.permissions&&q.permissions.manage_grades),o.removeClass("to_be_hidden"),o.toggleClass("addable_content_panel",!!(i.context&&i.context.permissions&&i.context.permissions.create_collaborations)),o.data("node",f),o.show()}else if(f.hasClass("groups")){var o=c("#groups_panel"),q=i.context,s=c("."+i.context_string+"_groups_url").attr("href");o.find(".category_name").text(i.name),o.find(".context_name").text(q.name),o.find(".breadcrumb").empty().append(e.breadcrumb()),o.find(".groups_link").attr("href",s),o.removeClass("to_be_hidden"),q&&q.permissions&&q.permissions.read_roster&&o.toggleClass("addable_content_panel",!0),o.show()}if(!m){var t=0,u=f.children("ul").children("li.node,li.leaf").length;g.already_cleared=!0,setTimeout(function(){var a=!1;f.children("ul").children("li.node,li.leaf").each(function(){t++,t<e.nodeClumpSize&&(newItem=e.addContentItem(c(this),!0),newItem&&(a=!0))}),h.find("li.folder_item").show(),u>=e.nodeClumpSize&&e.addScrollCatcher(),a&&e.refreshContentListeners();if(f.children("ul").children("li.node,li.leaf").length===0||f.hasClass("folder")&&!i.includes_files){f.hasClass("folder")&&!i.includes_files&&(n.addClass("no_content"),n.text(b.t("messages.loading_files","Loading Files...")),e.getFilesForFolder(i,function(a){a.files.length>0?e.refreshView():h.find(".message.no_content").remove()}));if(h.find(".message.no_content").length===0){if(f.hasClass("collaborations")){var d="";i.context.permissions.create_collaborations&&(d="<p>"+b.t("descriptions.collaborations2","To find out more about a particular type of collaboration, click &quot;New collaboration&quot; and then choose that type in the dropdown list.")+"</p>"),n.html(['<div class="ui-state-highlight" style="padding:1em;">',"<p>",b.t("descriptions.collaborations","Collaborations are a way for you to use web-based tools like Google Docs and EtherPad to work collaboratively on tasks like group papers or note-taking.  This is a special folder that shows you any collaborations you have created so you have an easy place to keep track of and create those collaborations"),"</p>",d,"</div>","<p>",b.t("messages.no_collaborations","There are no collaborations to show"),"</p>"].join("").replace("Google Docs",'<a href="http://docs.google.com">Google Docs</a>').replace("EtherPad",'<a href="http://www.etherpad.org">EtherPad</a>'))}h.append(n)}}g()},10)}}else if(f.hasClass("file")){var o=c("#file_panel"),v=null;i.unlock_at_string=c.parseFromISO(i.unlock_at).datetime_formatted,i.lock_at_string=c.parseFromISO(i.lock_at).datetime_formatted,o.find(".lock_after").showIf(i.lock_at),o.find(".lock_until").showIf(i.unlock_at),o.find(".currently_locked_box").showIf(i.currently_locked),o.find(".lock_item_link").showIf(!i.currently_locked),o.find(".unlock_item_link").showIf(i.currently_locked),o.removeClass("to_be_hidden"),o.fillTemplateData({data:i});var w=c.replaceTags(c("#file_context_links ."+i.context_string+"_attachment_url").attr("href"),"id",i.id),x=c.replaceTags(c("#file_context_links ."+i.context_string+"_download_attachment_url").attr("href"),"id",i.id);o.find(".breadcrumb").empty().append(e.breadcrumb()),o.find(".attachment_url").attr("href",w).end().find(".download_item_link").attr("href",x),o.removeClass("editable_content_panel"),i&&i.permissions&&i.permissions.update&&o.addClass("editable_content_panel"),o.removeClass("panel_locked");if(!i||!i.permissions||!i.permissions.download)o.addClass("panel_locked");else if(i&&i.permissions&&i.permissions.download&&c.isPreviewable(i.content_type))v=c("#content_templates .file_scribd_preview").clone(!0),v.append("<div id='doc_preview_holder'/>");else if(i&&i.content_type.match(/image/)){v=c("#content_templates .file_image_preview").clone(!0);var y=c.replaceTags(c("#file_context_links ."+i.context_string+"_preview_attachment_url").attr("href"),"id",i.id);v.find("a").attr("href",x),v.find("img").attr("src",c(".preview_loading_image").attr("src")).attr("src",y||"").attr("title",i.display_name)}else if(i&&i.content_type.match(/(video|audio)/)&&i.media_entry_id){v=c("#content_templates .file_media_preview").clone(!0),v.fillTemplateData({data:i});var z=i.content_type.match(/video/)?"video":"audio";v.find(".media_preview").mediaComment("show_inline","maybe",z,x),v.find("a").attr("href",x)}else v=c("#content_templates .file_no_preview").clone(!0),v.fillTemplateData({data:i}),v.find("a").attr("href",x);o.data("node",f),o.show(),v&&(v.addClass("file_preview"),h.append(v),i.permissions&&i.permissions.download&&c.isPreviewable(i.content_type)&&(c("#doc_preview_holder").loadDocPreview({mimeType:i.content_type,attachment_id:i.id,height:"100%",scribd_doc_id:i.scribd_doc&&i.scribd_doc.attributes&&i.scribd_doc.attributes.doc_id,scribd_access_key:i.scribd_doc&&i.scribd_doc.attributes&&i.scribd_doc.attributes.access_key}),e.viewFile(i.context_string,i.id))),c(window).triggerHandler("resize")}else if(f.hasClass("collaboration")){var o=c("#collaboration_panel");o.find(".header .name").text(i.name),o.removeClass("to_be_hidden");var A={name:i.name,updated_at:c.parseFromISO(i.updated_at).datetime_formatted,collaborator_count:(i.collaborator_ids||"").split(",").length,description:i.description,collaborator_ids:i.collaborator_ids};o.find(".breadcrumb").empty().append(e.breadcrumb());var B=c("."+i.context_string+"_collaboration_url").attr("href");B=c.replaceTags(B,"id",i.id),o.find(".collaborations_link").attr("href",B),o.find(".edit_collaboration_link").attr("href",B),o.find(".delete_collaboration_link").attr("href",B),o.find(".view_item_link").attr("href",B),o.data("node",f);var C=c("#collaboration_sub_panel");C.find(".subcontent").fillTemplateData({data:A}),C.removeClass("to_be_hidden"),C.find(".subcontent .collaboration_icon").hide(),C.find(".subcontent .google_docs_icon").showIf(i.collaboration_type=="google_docs"),C.find(".subcontent .etherpad_icon").showIf(i.collaboration_type=="etherpad"),C.find(".view_item_link").attr("href",B),C.find(".collaborators").empty();var D=(A.collaborator_ids||"").split(",");for(var E in D){var F=D[E],G=c("."+i.context_string+"_user_list:first .collaborator_"+F).clone(!0);G.find(":checkbox").remove(),C.find(".collaborators").append(G)}h.find(".content_panel:last").after(C),o.show(),o.removeClass("editable_content_panel"),i&&i.permissions&&i.permissions.update&&o.addClass("editable_content_panel")}g.already_cleared||g()}}),c("#files_structure_list > li.context").show(),c("#files_structure_list .context").length==1&&e.expandFolder(c("#files_structure_list .context"))},500),c(window).bind("resize",function(){var a=k.offset().top,b=c(window).height()-a,d=142,e=c("#section-tabs").height();k.height(Math.max(e,b-d)),h.height(Math.max(e,b-d));var f=h.height(),g=c("#file_panel").outerHeight();c("#doc_preview_holder").height(f-g)}),c(".folder_item .edit_collaboration_link, #collaboration_panel .edit_collaboration_link").click(function(a){a.preventDefault(),a.stopPropagation(),c("#edit_collaboration_form").attr("action",c(this).attr("href")),c("#edit_collaboration_form").attr("method","PUT"),c("#edit_collaboration_form .submit_button").text(b.t("buttons.update_collaboration","Update Collaboration")),c("#edit_collaboration_form .add_collaboration").hide();if(h.find(".add_form:visible").length>0)return;h.children(".message").remove();var d=e.itemData(c(this).parents(".folder_item,#collaboration_panel")),f=d.context_string;c("#edit_collaboration_dialog").data("context_string",f);var g=c("."+f+"_user_list:first").clone(!0),i=(d.collaborator_ids||"").split(",");c("#edit_collaboration_form").fillFormData(d,{object_name:"collaboration"}),g.find(".collaborator input").each(function(){c(this).attr("id",c(this).attr("class"));var a=c(this).parent("li.collaborator").getTemplateData({textValues:["user_id"]}).user_id;c.inArray(a,i)!=-1&&c(this).attr("checked",!0)}),c("#edit_collaboration_dialog .collaborator_list").empty().append(g),c("#edit_collaboration_dialog").dialog("close").dialog({autoOpen:!1,title:b.t("titles.edit_collaboration","Edit Collaboration"),width:500}).dialog("open")}),c("#collaborations_panel .add_collaboration_link").click(function(a){a.preventDefault(),c("#edit_collaboration_form").attr("action",c(this).attr("href")),c("#edit_collaboration_form").attr("method","POST"),c("#edit_collaboration_form .submit_button").text(b.t("buttons.add_collaboration","Add Collaboration")),c("#edit_collaboration_form .add_collaboration").show(),c("#collaboration_collaboration_type").triggerHandler("change");if(h.find(".add_form:visible").length>0)return;h.children(".message").remove();var d=e.itemData(c("#collaborations_panel").data("node"));d.title="",d.description="",c("#edit_collaboration_form").fillFormData(d,{object_name:"collaboration"});var f=d.context_string;c("#edit_collaboration_dialog").data("context_string",f);var g=c("."+f+"_user_list:first").clone(!0);g.find(".collaborator input").each(function(){c(this).attr("id",c(this).attr("class"))}),c("#edit_collaboration_dialog .collaborator_list").empty().append(g),c("#edit_collaboration_dialog").dialog("close").dialog({autoOpen:!1,title:b.t("titles.add_collaboration","Add New Collaboration"),width:500}).dialog("open")}),c("#folder_panel .download_zip").click(function(b){b.preventDefault(),a.downloadFolderFiles(c(this).find(".download_zip_link").attr("href"))}),c("#edit_collaboration_dialog").find(".select_all_link,.deselect_all_link").click(function(a){a.preventDefault();var b=c(this);c("#edit_collaboration_dialog .collaborator_list :checkbox").each(function(){c(this).attr("checked",b.hasClass("select_all_link"))})}),c("#edit_collaboration_dialog .cancel_button").click(function(){c("#edit_collaboration_dialog").dialog("close")}),c("#edit_collaboration_form").formSubmit({beforeSubmit:function(a){c(this).loadingImage()},success:function(a){var b=c("#edit_collaboration_dialog").data("context_string");c("#edit_collaboration_dialog").dialog("close"),e.updateCollaboration(b,a),c(this).loadingImage("remove")},error:function(a){c(this).loadingImage("remove"),c(this).formErrors(a)}}),c("#collaboration_collaboration_type").change(function(){c("#edit_collaboration_dialog .collaboration_description").hide(),c("#edit_collaboration_dialog #"+c(this).val()+"_description").show(),c("#edit_collaboration_dialog .collaborate_data").show(),c("#edit_collaboration_dialog .collaboration_authorization").hide(),c(this).val()=="google_docs"&&c("#edit_collaboration_dialog #collaborate_authorize_google_docs").length>0&&(c("#edit_collaboration_dialog .collaborate_data").hide(),c("#edit_collaboration_dialog #collaborate_authorize_google_docs").show())}).triggerHandler("change"),c(".folder_item .edit_item_content_link").click(function(a){a.preventDefault(),a.stopPropagation();var d=c(this).parents(".folder_item,#file_panel,#folder_panel"),f=e.itemData(d),g=d.find(".download_url").attr("href"),h=d.find(".name:first").text(),i=c("#edit_content_dialog");i.data("update_url",d.find(".rename_item_link").attr("href")).data("content_type",f.content_type||"").data("filename",f.filename||"file_to_update"),i.find(".display_name").text(h),i.find(".loading_message").text("Loading File Contents...").show().end().find(".content").hide(),i.dialog("close").dialog({autoOpen:!1,width:600,height:410}).dialog("open"),c.ajax({dataType:"json",error:function(){i.find(".loading_message").text(b.t("errors.loading_file","Error Loading File Contents.  Please try again."))},success:function(a){var b=a.body;i.find("textarea").val(b),i.find(".loading_message").hide().end().find(".content").show(),i.find(".textarea").focus()},url:g.replace(/\/download/,"/contents")})}),c("#edit_content_dialog .cancel_button").click(function(){c("#edit_content_dialog").dialog("close")}),c("#edit_content_dialog .save_button").click(function(){var a=c("#edit_content_dialog");a.find("button").attr("disabled",!1).filter(".save_button").text(b.t("buttons.update_file","Update File")),a.find("button").attr("disabled",!0).filter(".save_button").text(b.t("messages.updating_file","Updating File..."));var d=e.currentItemData().context_string;c.ajaxFileUpload({url:a.data("update_url"),method:"PUT",binary:!1,data:{"attachment[uploaded_data]":{fake_file:!0,name:a.data("filename"),content_type:a.data("content_type"),content:a.find("textarea").val()}},success:function(c){a.find("button").attr("disabled",!1).filter(".save_button").text(b.t("buttons.update_file","Update File")),e.updateFile(d,c),a.dialog("close")},error:function(){a.find("button").attr("disabled",!1).filter(".save_button").text(b.t("errors.update_file_failed","Updating File Failed, please try again"))}})}),c(".folder_item .preview_item_link").click(function(a){a.preventDefault(),a.stopPropagation(),e.selectFolder(c(this).parents(".folder_item").data("node"))}),c(".folder_item .rename_item_link,#file_panel .rename_item_link,#folder_panel .rename_item_link").click(function(a){a.preventDefault(),a.stopPropagation();var b=c(this).parents(".folder_item,#file_panel,#folder_panel"),d=b.getTemplateData({textValues:["name"]}).name;b.find(".name").hide().after(c("#rename_entry_field")),c("#rename_entry_field").val(d).focus().select(),c(this).blur()}),c("#rename_entry_field").bind("blur",function(a,b){var d=c(this).parents(".folder_item,#file_panel,#folder_panel");if(d.length===0)return;var f=d.getTemplateData({textValues:["name"]}).name,g=c(this).val();if(b!==!1&&g!=""&&f!=g){d.find(".name").text(g);var h=e.itemData(d.data("node")),i=h.root_context_string;if(d.hasClass("folder")||d.attr("id")=="folder_panel"){var j=c.replaceTags(c("#file_context_links ."+i+"_folder_url").attr("href"),"id",h.id);c.ajaxJSON(j,"PUT",{"folder[name]":g},function(a){e.updateFolder(i,{folder:a.folder,already_in_place:!0})},function(){})}else{var j=c.replaceTags(c("#file_context_links ."+i+"_attachment_url").attr("href"),"id",h.id);c.ajaxJSON(j,"PUT",{"attachment[display_name]":g},function(a){e.updateFile(i,a)},function(){})}}d.find(".name").show(),c(this).val("").appendTo(c("#file_context_links")),c(this).triggerHandler("blur",!1)}),c("#rename_entry_field").keycodes("return esc",function(a){c(this).triggerHandler("blur",a.keyString=="return")}),c(".folder_item .delete_item_link,#folder_panel .delete_item_link,#file_panel .delete_item_link").click(function(a){a.preventDefault(),a.stopPropagation();var d=e.itemData(c(this).parents(".folder_item"));d=d||e.itemData(c(this).parents("#folder_panel,#file_panel").data("node"));var f=c(this).parents(".folder_item").hasClass("file")?"file":"folder";c(this).parents(".folder_item").hasClass("collaboration")&&(f="collaboration"),c(this).parents(".folder_item").confirmDelete({message:c(this).parents(".folder_item").hasClass("folder")||c(this).hasClass("folder_url")?b.t("prompts.delete_folder","Are you sure you want to delete this folder and all of its contents?"):b.t("prompts.delete_file","Are you sure you want to delete this file?"),url:c(this).attr("href"),success:function(){k.find(".file_"+d.id+",.folder_"+d.id).filter(".active-node,.active-leaf").length>0&&e.selectFolder(k.find(".file_"+d.id+",.folder_"+d.id).filter(".active-node,.active-leaf").parent("ul").parent("li")),k.find(".file_"+d.id).prev("li.separator").remove(),k.find(".file_"+d.id).remove(),k.find(".folder_"+d.id).prev("li.separator").remove(),k.find(".folder_"+d.id).remove(),k.find(".collaboration_"+d.id).prev("li.separator").remove(),k.find(".collaboration_"+d.id).remove(),e.refreshView(),e.updateQuota(),c(this).slideUp(function(){c(this).remove()})}})}),c(".folder_item:not(.add_item)").click(function(a){var b=c(this);a.preventDefault();if(h.filter(".dragging").length>0)return;if(c(this).find("#rename_entry_field").length>0)return;a.stopPropagation(),b.data("parent_node")&&e.expandFolder(b.data("parent_node")),setTimeout(function(){if(b.hasClass("folder")){e.expandFolder(b.data("node"));var a=function(){e.refreshView(),c(this).unbind("files_load",a)};b.data("node").bind("files_load",a),b.data("node").children(".text").click()}else b.hasClass("collaboration")?b.data("node").children(".text").click():(b.find(".name").focus(),location.href=b.find(".download_url").attr("href"))},50)}),c(".folder_item").hover(function(a,b){c(".folder_item_hover").removeClass("folder_item_hover"),c(this).addClass("folder_item_hover")},function(){}),c("#folder_panel .add_file_link").click(function(a){a.preventDefault();if(h.find(".add_form:visible").length>0)return;var b=c("#add_file_form").clone(!0).removeAttr("id");h.children(".message").remove(),h.append(b),h.scrollToVisible(b);var d=e.currentItemData();b.fillFormData({folder_id:d.id},{object_name:"attachment"}),b.find("form").attr("action",c("#file_context_links ."+d.context_string+"_attachments_url").attr("href")+".text"),b.mouseover(),b.find(":text:first").focus().select()}),c("#folder_panel .add_folder_link").click(function(a){a.preventDefault();if(h.find(".add_form:visible").length>0)return;var b=c("#add_folder_form").clone(!0).removeAttr("id");h.children(".message").remove(),h.find("#folder_panel.addable_content_panel").after(b),h.scrollToVisible(b);var d=e.currentItemData();b.fillFormData({parent_folder_id:d.id},{object_name:"folder"}),b.find("form").attr("action",c("#file_context_links ."+d.context_string+"_folders_url").attr("href")),b.mouseover(),b.find(":text:first").focus().select()}),c("#add_folder_form :text").keycodes("esc",function(a){a.keyString=="esc"&&c(this).trigger("blur",!0)}),c("#add_folder_form :text").bind("blur",function(a,b){b?c(this).parents("li").remove():c.trim(c(this).val())&&c(this).parents("form").trigger("submit")}),c("#add_folder_form .add_folder_form").formSubmit({beforeSubmit:function(a){if(c(this).hasClass("submitting"))return!1;c(this).addClass("submitting"),c(this).find(".name").show().text(a["folder[name]"]),c(this).find(":text").hide(),c(this).data("root_context_string",e.currentItemData().root_context_string)},success:function(a){c(this).removeClass("submitting");for(var b in f)f[b][0].context_string==c(this).data("root_context_string")&&f[b][1].folders.push(a);var d=a.folder,g=k.find(".folder_blank").clone(!0).removeClass("folder_blank");g.addClass("folder folder_"+d.id),g.fillTemplateData({data:{name:d.name,id:d.id}});var h=k.find(".folder_"+d.parent_folder_id);h.children("ul").append("<li class='separator'/>"),h.children("ul").append(g.show()),e.updateFolder(c(this).data("root_context_string"),a),c(this).parents("li").remove(),g.find("span").droppable(e.droppable_options),e.refreshView(d)},error:function(a){c(this).removeClass("submitting"),c(this).formErrors(a)}}),c("#add_file_form .add_file_form").formSubmit({fileUpload:!0,beforeSubmit:function(a){c(this).data("context_string",e.currentItemData().context_string),c(this).find(".loading_message").slideDown()},success:function(a){c(this).parents("li").remove(),e.updateFile(c(this).data("context_string"),a),e.updateQuota()},error:function(a){c(this).find(".loading_message").slideUp(),c(this).formErrors(a)}}),c("#add_file_form .cancel_button").click(function(){c(this).parents("li").remove()}),c(".folder_item .lock_item_link,#file_panel .lock_item_link,#folder_panel .lock_item_link").click(function(a){a.preventDefault(),a.stopPropagation();var d="attachment",f=c("#lock_attachment_form"),g=c(this).parents(".folder_item,#file_panel,#folder_panel"),h=e.itemData(g)||e.itemData(g.data("node")),i=c(this).attr("href");if(g.hasClass("folder")||c(this).parents("#folder_panel").length>0)d="folder",f=c("#lock_folder_form");f.attr("action",i),f.data("context_string",h.context_string),c("#lock_item_dialog form").hide(),f.show(),h.lock_at=c.parseFromISO(h.last_lock_at).datetime_formatted,h.unlock_at=c.parseFromISO(h.last_unlock_at).datetime_formatted,h.locked=!h.lock_at&&!h.unlock_at?"1":"0",c("#lock_item_dialog").fillTemplateData({data:{name:h.name}}),f.fillFormData(h,{object_name:d}),f.find("#folder_just_hide,#attachment_just_hide").attr("checked",!1).change(),f.find(".item_type").text(d),c("#lock_item_dialog").dialog("close").dialog({autoOpen:!0,modal:!0,width:350,title:d=="folder"?b.t("titles.lock_folder","Lock Folder"):b.t("titles.lock_file","Lock File")}).dialog("open")}),c("#folder_just_hide,#attachment_just_hide").change(function(){c(this).parents("form").find(".full_lock").showIf(!c(this).attr("checked")),c(this).parents("form").find(".lock_checkbox").change()}).change(),c("#lock_item_dialog .cancel_button").click(function(){c("#lock_item_dialog").dialog("close")}),c("#lock_item_dialog .lock_checkbox").change(function(){c(this).parents("table").find(".lock_range").showIf(!c(this).attr("checked"))}).change(),c("#lock_attachment_form").formSubmit({processData:function(a){return a},beforeSubmit:function(a){c(this).loadingImage()},success:function(a){c(this).loadingImage("remove"),c("#lock_item_dialog").dialog("close"),e.updateFile(c(this).data("context_string"),a)}}),c("#lock_folder_form").formSubmit({processData:function(a){return a},beforeSubmit:function(a){c(this).loadingImage()},success:function(a){c(this).loadingImage("remove"),c("#lock_item_dialog").dialog("close"),e.updateFolder(c(this).data("context_string"),{folder:a.folder,already_in_place:!0})}}),c(".folder_item .unlock_item_link,#file_panel .unlock_item_link,#folder_panel .unlock_item_link").click(function(a){a.preventDefault(),a.stopPropagation();var b="attachment",d=c("#lock_attachment_form"),f=c(this).parents(".folder_item,#file_panel,#folder_panel"),g=e.itemData(f)||e.itemData(f.data("node")),h=c(this).attr("href");if(f.hasClass("folder")||c(this).parents("#folder_panel").length>0)b="folder",d=c("#lock_folder_form"),h=f.find(".folder_url").attr("href");f.loadingImage();var i={};i["["+b+"][locked]"]="",i["["+b+"][hidden]"]="",i["["+b+"][lock_at]"]="",i["["+b+"][unlock_at]"]="",f.loadingImage(),c.ajaxJSON(h,"PUT",i,function(a){f.loadingImage("remove"),b=="attachment"?e.updateFile(g.context_string,a):e.updateFolder(g.context_string,{folder:a.folder,already_in_place:!0})},function(a){f.loadingImage("remove")})});if(location.hash===""||location.hash=="#"){var d=c("#files_structure_list .context:first .name:first").text();location.href="#"+encodeURIComponent(d)}c(document).fragmentChange(function(a,b){setTimeout(function(){e.selectNodeFromPath(b.substring(1)),k.scrollToVisible(c("li.active-node,li.active-leaf").find("span.name").filter(":first"))},100)}).fragmentChange(),setTimeout(function(){c(window).triggerHandler("resize"),c("#file_swf").uploadify({fileDataName:"file",uploader:"/flash/uploadify/uploadify.swf",buttonText:"testing",folder:"no_idea",script:"s3_url",scriptAccess:"always",multi:!0,auto:!1,sizeLimit:10737418240,simUploadLimit:1,buttonText:"",hideButton:!0,wmode:"transparent",width:60,height:22,cancelImg:"/images/blank.png",onInit:function(){j.text(b.t("links.add_files","Add Files")).triggerHandler("show")},onSelect:g.swfFileQueue,onSelectOnce:g.swfFileQueueOnce,onCancel:g.swfCancel,onClearQueue:g.swfQueueClear,onError:g.swfFileError,onOpen:g.swfFileOpen,onProgress:g.swfFileProgress,onComplete:g.swfFileComplete,onAllComplete:g.swfQueueComplete})},1e3)})})();var g={ajaxUploadCount:0,swfUploadCount:0,queuedAjaxUploads:[],currentlyUploading:!1,status_status:"hidden",status_request:"hidden",showStatus:function(){g.status_request="shown",g.status_status=="hidden"&&(g.status_status="showing",c("#file_uploads_progress").slideDown(null,null,function(){setTimeout(function(){g.status_status="shown",g.status_request=="hidden"&&g.hideStatus()},3e3)}))},hideStatus:function(){g.status_request="hidden",g.status_status=="shown"&&(g.status_status="hiding",c("#file_uploads_progress").slideUp(null,null,function(){g.status_status="hidden",g.status_request=="shown"&&g.showStatus()}))},queueAjaxUpload:function(a,b){g.ajaxUploadCount=g.queuedAjaxUploads.length;var c={file:a,folder_id:b,name:a.name},d=g.initFile(c);d.data("folder",e.currentItemData()),d.find(".status").text("Queued"),g.queuedAjaxUploads.push(c),g.updateUploadCount(),g.uploadAjaxFiles()},uploadAjaxFiles:function(a){if(g.currentlyUploading&&!a)return;var d=g.queuedAjaxUploads.shift();if(!d)g.currentlyUploading=!1,g.ajaxUploadCount=0,g.updateUploadCount();else{g.currentlyUploading=!0;var f=g.initFile(d);f.find(".status").text("Uploading"),f.find(".progress_bar").progressbar("value",10);var h=f.data("folder"),i=d.file;c.ajaxFileUpload({url:c("."+h.context_string+"_attachments_url").attr("href"),data:{"attachment[uploaded_data]":i,"attachment[display_name]":i.name,"attachment[folder_id]":h.id,duplicate_handling:d.file.duplicate_handling},method:"POST",success:function(a){setTimeout(function(){g.uploadAjaxFiles(!0)},500);var d=a.attachment,h=c.underscore(d.context_type)+"_"+d.context_id;f.find(".cancel_upload_link").hide().end().find(".status").text(b.t("messages.done_uploading","Done uploading")),f.addClass("done"),setTimeout(function(){f.slideUp(function(){f.remove()})},5e3),a.deleted_attachment_ids&&e.deleteAttachmentIds(a.deleted_attachment_ids),e.updateFile(d.context_code,a)},error:function(a){setTimeout(function(){g.uploadAjaxFiles(!0)},500),f.find(".status").text(b.t("#errors.failed","Failed")).end().find(".cancel_upload_link").hide()}})}},updateUploadCount:function(){g.ajaxUploadCount=g.queuedAjaxUploads.length,g.currentlyUploading&&g.ajaxUploadCount++;var a=g.swfFiles.length+g.ajaxUploadCount,d=c("#file_uploads .file_upload.errored:visible").length;if(a===0&&d==0){g.hideStatus();var e=c("#file_upload_blank").clone(!0).removeAttr("id").addClass("finished_message").empty();e.text("Finished uploading all files"),c("#file_uploads .file_upload:visible:first").hasClass("finished_message")||(c("#file_uploads").prepend(e),e.slideDown("fast")),e.addClass("finished_message"),e.click(function(){c(this).slideUp(function(){c(this).remove()})}),setTimeout(function(){e.slideUp(function(){e.remove()})},5e3)}else c("#file_uploads_dialog_link").text(b.t("messages.uploading_files",{one:"Uploading 1 File...",other:"Uploading %{count} Files..."},{count:a})),a===0&&c("#file_uploads_dialog_link").text(b.t("messages.error_count",{one:"1 Error",other:"%{count} Errors"},{count:d})),g.showStatus()},fileDialogComplete:function(a,b){try{b>0&&this.startUpload()}catch(c){this.debug(c)}},fileQueued:function(a){var c=g.initFile(a);c.data("folder",e.currentItemData()),c.find(".status").text(b.t("messages.queue","Queued")),g.updateSwfUploadCount(this.getStats().files_queued)},fileQueueError:function(a,c,d){var e=g.initFile(a);e.find(".status").text(b.t("errors.failed","Failed")).end().find(".cancel_upload_link").hide(),e.append(d)},swfPreQueued:[],swfQueuedAndPendingFiles:[],swfFiles:[],swfFileQueueOnce:function(a,b){var d=g.swfPreQueued;g.swfPreQueued=[];var f=e.currentItemData(),h=[];for(idx in d)h.push(d[idx].name);e.preflight(f.id,f.context_string,h,function(a){for(idx in d)d[idx].duplicate_handling=a},function(){for(idx in d){var b=d[idx];g.swfFileQueueReal(a,b.id,b)}},function(){for(idx in d)c("#file_swf").uploadifyCancel(d[idx].id)})},swfFileQueue:function(a,b,c){c.id=b,g.swfPreQueued.push(c)},swfFileQueueReal:function(a,d,f){f.id=d;var h=g.initFile(f);h.data("folder",e.currentItemData()),h.find(".status").text(b.t("messages.queued","Queued")),g.swfFiles.push(f);var i=h.data("folder"),j={"attachment[folder_id]":i.id,"attachment[filename]":f.name,"attachment[context_code]":i.context_string,no_redirect:!0,"attachment[duplicate_handling]":f.duplicate_handling};c("#file_swf").uploadifySettings("folder",""+i.id),g.updateUploadCount(),c.ajaxJSON("/files/pending","POST",j,function(a){f.upload_url=a.proxied_upload_url||a.upload_url,a.upload_params.key=encodeURIComponent(a.upload_params.key),a.upload_params.Signature=encodeURIComponent(a.upload_params.Signature),f.upload_params=a.upload_params,h.data("success_url",a.success_url),h.hasClass("done")||(g.swfQueuedAndPendingFiles.push(f),g.swfUploadNext()),g.updateUploadCount()},function(a){c("#file_swf").uploadifyCancel(d),h.find(".cancel_upload_link").hide().end().find(".status").text("Upload Failed")})},swfUploadNext:function(){g.swfQueuedAndPendingFiles.length>0&&(file=g.swfQueuedAndPendingFiles.shift(),file&&(c("#file_swf").uploadifySettings("script",file.upload_url),c("#file_swf").uploadifySettings("scriptData",file.upload_params),c("#file_swf").uploadifyUpload(file.id))),g.updateUploadCount()},swfCancel:function(a,d,e,f){e.id=d;var h=g.initFile(e);return c("#file_uploads_dialog_link").text(b.t("errors.uploading","Uploading Error")),h.addClass("done"),!h.hasClass("errored")&&!h.hasClass("error_cancelled")&&(h.find(".cancel_upload_link").hide().end().find(".status").text("Canceled"),g.swfFiles=c.grep(g.swfFiles,function(a){return a.id!=e.id})),g.swfUploadNext(),!1},swfQueueClear:function(a,b){},swfFileError:function(a,d,e,f,h){h=typeof h!="undefined"?h:!0,e.id=d;var i=g.initFile(e);return setTimeout(function(){i.addClass("error_cancelled"),h&&c("#file_swf").uploadifyCancel(d)},50),g.swfFiles=c.grep(g.swfFiles,function(a){return a.id!=e.id}),c("#file_uploads_dialog_link").text(b.t("errors.uploading","Uploading Error")),g.showStatus(),i.find(".cancel_upload_link").hide().end().find(".status").text(b.t("errors.failed_uploading","Failed uploading: %{error_info}",{error_info:f.info})),i.addClass("done").addClass("errored"),g.swfUploadNext(),!1},swfFileOpen:function(a,d,e){e.id=d;var f=g.initFile(e);e.upload_url&&c("#file_swf").uploadifySettings("script",e.upload_url),e.upload_params&&c("#file_swf").uploadifySettings("scriptData",e.upload_params),g.swfQueuedAndPendingFiles=c.grep(g.swfQueuedAndPendingFiles,function(a){return a.id!=e.id}),f.find(".progress_bar").progressbar("value",1),f.find(".status").text(b.t("messages.uploading","Uploading"))},swfFileProgress:function(a,c,d,e){d.id=c;var f=g.initFile(d);f.find(".status").text(b.t("messages.uploading_with_speed","Uploading (%{speed}KB/s)",{speed:parseInt(e.speed,10)})),f.find(".cancel_upload_link").showIf(e.percentage<100),f.find(".progress_bar").progressbar("value",e.percentage)},swfFileComplete:function(a,d,f,h,i){f.id=d;var j=g.initFile(f);if(h.indexOf("<PostResponse>")>=0){j.find(".status").text(b.t("messages.finalizing","Finalizing"));var k=function(){g.swfFileError({},f.id,f,{type:"server",info:b.t("errors.unexpected_response","didn't get back expected response")})};c.ajaxJSON(j.data("success_url"),"GET",{},function(a){a&&a.attachment?(g.swfFileComplete({},f.id,f,JSON.stringify(a),{}),a.deleted_attachment_ids&&e.deleteAttachmentIds(a.deleted_attachment_ids)):k()},k);return}g.swfFiles=c.grep(g.swfFiles,function(a){return a.id!=f.id}),j.find(".status").text(b.t("messages.upload_complete","Done uploading")),j.find(".cancel_upload_link").remove(),j.find(".progress_bar").progressbar("value",100),j.addClass("done");var l=j.data("folder").context_string;setTimeout(function(){j.slideUp(function(){j.remove()})},5e3);if(h)try{var i=c.parseJSON(h);"errors"in i&&!jQuery.isEmptyObject(i.errors)?g.swfFileError(a,d,f,{type:"server",info:JSON.stringify(i.errors)},!1):(i.swf=!0,setTimeout(function(){i.deleted_attachment_ids&&e.deleteAttachmentIds(i.deleted_attachment_ids),e.updateFile(l,i)},500))}catch(m){g.swfFileError(a,d,f,{type:"JS",info:m.toString()},!1)}else j.find(".status").text(b.t("warnings.file_uploaded_without_response","File may have uploaded, but the server failed to respond.  Reload the page to confirm."));g.swfUploadNext()},swfQueueComplete:function(a,b){g.updateUploadCount()},initFile:function(a){a.id||(a.id="tmp_"+Math.round(Math.random()*9999));var b=c("#file_upload_"+a.id);return b.length===0&&(b=c("#file_upload_blank").clone(!0).attr("id","file_upload_"+a.id),c("#file_uploads").append(b),b.find(".progress_bar").progressbar(),b.click(function(a){c(this).find(".cancel_upload_link:visible").length===0&&c(this).hasClass("done")&&(a.preventDefault(),c(this).slideUp(function(){c(this).remove(),g.updateUploadCount()}))}),b.find(".cancel_upload_link").click(function(b){b.preventDefault();var d=(c(this).parents(".file_upload").attr("id")||"").substring(12);c("#file_swf").uploadifyCancel(a.id)})),b.find(".file_name").text(a.name),b.slideDown("fast"),b},attempt:0,file_details:{}}}),function(){require(["full_files","uploadify"])}.call(this),define("compiled/bundles/full_files",function(){})