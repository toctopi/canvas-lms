(function(){var a=function(a,b){return function(){return a.apply(b,arguments)}};define(["jquery","jquery.ajaxJSON","jquery.instructure_misc_helpers","jquery.disableWhileLoading","compiled/jquery/scrollIntoView"],function(b){return function(){function c(c,d,e){var f=this;this.input=c,this.url=d,this.options=e!=null?e:{},this.close=a(this.close,this),this.stack=[],this.fetchListAjaxRequests=[],this.queryCache={},this.$container=b("<div />").addClass("autocomplete_menu"),this.options.showToggles&&this.$container.addClass("with-toggles"),this.$menu=b("<div />").append(this.$list=this.newList()),this.$container.append(b("<div />").append(this.$menu)),this.$container.css("top",0).css("left",0),this.mode="input",b("body").append(this.$container),this.reposition=function(){var a;return a=f.input.bottomOffset(),f.$container.css("top",a.top),f.$container.css("left",a.left)},b(window).resize(this.reposition),this.close()}return c.prototype.abortRunningRequests=function(){var a,b,c,d;d=this.fetchListAjaxRequests;for(b=0,c=d.length;b<c;b++)a=d[b],a.abort();return this.fetchListAjaxRequests=[]},c.prototype.browse=function(a){if(!this.uiLocked)return this.input.val(""),this.close(),this.fetchList({data:a}),!0},c.prototype.newList=function(){var a,c=this;return a=b('<div class="list"><ul class="heading"></ul><ul></ul></div>'),a.find("ul").mousemove(function(a){var d;if(c.uiLocked)return;return d=b(a.target).closest("li"),d.hasClass("selectable")||(d=null),c.select(d)}).mousedown(function(a){return setTimeout(function(){return c.input.focus()},0)}).click(function(a){var d;if(c.uiLocked)return;return d=b(a.target).closest("li"),d.hasClass("selectable")||(d=null),c.select(d),c.selection&&(b(a.target).closest("a.expand").length?c.selectionExpanded()?c.collapse():c.expandSelection():c.selectionToggleable()&&b(a.target).closest("a.toggle").length?c.toggleSelection():c.selectionExpanded()?c.collapse():c.selectionExpandable()?c.expandSelection():(c.toggleSelection(!0),c.clear(),c.close())),c.input.focus()}),a.body=a.find("ul").last(),a},c.prototype.captureKeyDown=function(a){var b,c;if(this.uiLocked)return!0;switch((b=(c=a.originalEvent)!=null?c.keyIdentifier:void 0)!=null?b:a.which){case"Backspace":case"U+0008":case 8:if(this.input.val()==="")return this.listExpanded()?this.collapse():this.$menu.is(":visible")?this.close():this.input.removeLastToken(),!0;break;case"Tab":case"U+0009":case 9:this.selection&&(this.selectionToggleable()||!this.selectionExpandable())&&this.toggleSelection(!0),this.clear(),this.close();if(this.selection)return!0;break;case"Enter":case 13:if(this.selectionExpanded())return this.collapse(),!0;if(this.selectionExpandable()&&!this.selectionToggleable())return this.expandSelection(),!0;return this.selection&&(this.toggleSelection(!0),this.clear()),this.close(),!0;case"Shift":case 16:return!1;case"Esc":case"U+001B":case 27:return this.$menu.is(":visible")?(this.close(),!0):!1;case"U+0020":case 32:if(this.selectionToggleable()&&this.mode==="menu")return this.toggleSelection(),!0;break;case"Left":case 37:if(this.listExpanded()&&this.input.caret()===0)return this.selectionExpanded()||this.input.val()===""?this.collapse():this.select(this.$list.find("li").first()),!0;break;case"Up":case 38:return this.selectPrev(),!0;case"Right":case 39:if(this.input.caret()===this.input.val().length&&this.expandSelection())return!0;break;case"Down":case 40:return this.selectNext(),!0;case"U+002B":case 187:case 107:if(this.selectionToggleable()&&this.mode==="menu")return this.toggleSelection(!0),!0;break;case"U+002D":case 189:case 109:if(this.selectionToggleable()&&this.mode==="menu")return this.toggleSelection(!1),!0}return this.mode="input",this.fetchList(),!1},c.prototype.fetchList=function(a,c){var d=this;return a==null&&(a={}),this.uiLocked=c!=null?c:!1,clearTimeout(this.timeout),this.timeout=setTimeout(function(){var c,e,f;c=d.preparePost((f=a.data)!=null?f:{}),e=JSON.stringify(c);if(c.search===""&&!d.listExpanded()&&!a.data){d.uiLocked=!1,d.close();return}if(e===d.lastAppliedQuery){d.uiLocked=!1;return}if(d.queryCache[e]){d.lastAppliedQuery=e,d.lastSearch=c.search,d.abortRunningRequests(),d.renderList(d.queryCache[e],a,c);return}return d.fetchListAjaxRequests.push(d.load(b.ajaxJSON(d.url,"POST",b.extend({},c),function(b){var f;d.queryCache[e]=b;if(JSON.stringify(d.preparePost((f=a.data)!=null?f:{}))!==e)return d.uiLocked=!1;d.lastAppliedQuery=e,d.lastSearch=c.search;if(d.$menu.is(":visible"))return d.renderList(b,a,c)},function(a){return d.uiLocked=!1})))},100)},c.prototype.addByUserId=function(a,c){var d,e=this;return d=function(a){var b;e.close(),b=a[0];if(b)return e.input.addToken({value:b.id,text:b.name,data:b})},this.load(b.ajaxJSON(this.url,"POST",{user_id:a,from_conversation_id:c},d,this.close))},c.prototype.open=function(){return this.$container.show(),this.reposition()},c.prototype.close=function(){var a,b,c,d,e,f,g,h,i;this.uiLocked=!1,this.$container.hide(),delete this.lastAppliedQuery,h=this.stack;for(c=f=0,g=h.length;f<g;c=++f)i=h[c],b=i[0],a=i[1],d=i[2],e=i[3],this.$list.remove(),this.$list=a.css("height","auto");return this.$list.find("ul").html(""),this.stack=[],this.$menu.css("left",0),this.select(null),this.input.selectorClosed()},c.prototype.clear=function(){return this.input.val("")},c.prototype.blur=function(){return this.close()},c.prototype.listExpanded=function(){return this.stack.length?!0:!1},c.prototype.selectionExpanded=function(){var a,b;return(a=(b=this.selection)!=null?b.hasClass("expanded"):void 0)!=null?a:!1},c.prototype.selectionExpandable=function(){var a,b;return(a=(b=this.selection)!=null?b.hasClass("expandable"):void 0)!=null?a:!1},c.prototype.selectionToggleable=function(a){var b;return a==null&&(a=this.selection),((b=a!=null?a.hasClass("toggleable"):void 0)!=null?b:!1)&&!this.selectionExpanded()},c.prototype.expandSelection=function(){return!this.selectionExpandable()||!!this.selectionExpanded()?!1:(this.stack.push([this.selection,this.$list,this.lastAppliedQuery,this.lastSearch]),this.clear(),this.$menu.css("width",(this.stack.length+1)*100+"%"),this.fetchList({expand:!0},!0))},c.prototype.collapse=function(){var a,b,c,d=this;return this.listExpanded()?(c=this.stack.pop(),b=c[0],a=c[1],this.lastAppliedQuery=c[2],this.lastSearch=c[3],this.uiLocked=!0,a.css("height","auto"),this.$menu.animate({left:"+="+this.$menu.parent().css("width")},"fast",function(){return d.input.val(d.lastSearch),d.$list.remove(),d.$list=a,d.select(b),d.uiLocked=!1})):!1},c.prototype.toggleSelection=function(a,b,c){var d,e;b==null&&(b=this.selection),c==null&&(c=!1);if(a==null&&!this.selectionToggleable(b))return!1;d=b.data("id"),a==null&&(a=!b.hasClass("on")),a?(this.selectionToggleable(b)&&!c&&b.addClass("on"),this.input.addToken({value:d,text:(e=b.data("text"))!=null?e:b.text(),noClear:!0,data:b.data("user_data")})):(c||b.removeClass("on"),this.input.removeToken({value:d}));if(!c)return this.updateSelectAll(b)},c.prototype.updateSelectAll=function(a,c){var d,e,f,g,h,i,j=this;c==null&&(c=0),i=a.data("user_data").selectAll,d=c?this.stack[this.stack.length-c][1]:this.$list,h=d.selectAll;if(!h)return;e=d.body.find("li.toggleable").not(h),i?h.hasClass("on")?e.addClass("on").each(function(a,c){return j.toggleSelection(!1,b(c),!0)}):e.removeClass("on").each(function(a,c){return j.toggleSelection(!1,b(c),!0)}):(f=e.filter(".on"),f.length<e.length&&h.hasClass("on")?(h.removeClass("on"),this.toggleSelection(!1,h,!0),f.each(function(a,c){return j.toggleSelection(!0,b(c),!0)})):f.length===e.length&&!h.hasClass("on")&&(h.addClass("on"),this.toggleSelection(!0,h,!0),f.each(function(a,c){return j.toggleSelection(!1,b(c),!0)})));if(c<this.stack.length){c++,g=this.stack[this.stack.length-c][0];if(this.selectionToggleable(g))return h.hasClass("on")?g.addClass("on"):g.removeClass("on"),this.updateSelectAll(g,c)}},c.prototype.select=function(a,b){var c,d;b==null&&(b=!1);if((a!=null?a[0]:void 0)===((c=this.selection)!=null?c[0]:void 0))return;(d=this.selection)!=null&&d.removeClass("active"),this.selection=(a!=null?a.length:void 0)?(a.addClass("active"),a.scrollIntoView({ignore:{border:!0}}),a):null;if(!b)return this.mode=a?"menu":"input"},c.prototype.selectNext=function(a){var b;a==null&&(a=!1),this.select(this.selection?this.selection.next().length?this.selection.next():this.selection.parent("ul").next().length?this.selection.parent("ul").next().find("li").first():null:this.$list.find("li:first"),a);if((b=this.selection)!=null?b.hasClass("message"):void 0)return this.selectNext(a)},c.prototype.selectPrev=function(){var a,b;this.select(this.selection?((a=this.selection)!=null?a.prev().length:void 0)?this.selection.prev():this.selection.parent("ul").prev().length?this.selection.parent("ul").prev().find("li").last():null:this.$list.find("li:last"));if((b=this.selection)!=null?b.hasClass("message"):void 0)return this.selectPrev()},c.prototype.populateRow=function(a,b,c){c==null&&(c={}),this.options.populator?this.options.populator(this,a,b,c):(a.data("id",b.text),a.text(b.text)),c.first&&a.addClass("first");if(c.last)return a.addClass("last")},c.prototype.load=function(a){return this.$menu.is(":visible")||(this.open(),this.$list.find("ul").last().append(b('<li class="message first last"></li>'))),this.$list.disableWhileLoading(a),a},c.prototype.renderList=function(a,c,d){var e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w=this;c==null&&(c={}),d==null&&(d={}),this.open(),c.expand?h=this.newList():h=this.$list,h.selectAll=null,this.selection=null,j=h.find("ul"),j.html(""),f=j.first(),e=j.last();if(a.length){n=this.stack.length?this.stack[this.stack.length-1][0]:null,l=this.stack.length?function(){var a,b,c,d;c=this.stack,d=[];for(a=0,b=c.length;a<b;a++)k=c[a],d.push(k[0].data("id"));return d}.call(this):[],a.prepared||(typeof (p=this.options).preparer=="function"&&p.preparer(d,a,n),a.prepared=!0);for(m=r=0,s=a.length;r<s;m=++r)o=a[m],g=b("<li />").addClass("selectable"),this.populateRow(g,o,{level:this.stack.length,first:m===0,last:m===a.length-1,parent:n,ancestors:l}),o.selectAll&&(h.selectAll=g),g.hasClass("toggleable")&&this.input.hasToken(g.data("id"))&&g.addClass("on"),e.append(g);(((t=h.selectAll)!=null?typeof t.hasClass=="function"?t.hasClass("on"):void 0:void 0)||this.stack.length&&(typeof (q=this.stack[this.stack.length-1][0]).hasClass=="function"?q.hasClass("on"):void 0))&&h.body.find("li.toggleable").addClass("on")}else i=b('<li class="message first last"></li>'),i.text((u=(v=this.options.messages)!=null?v.noResults:void 0)!=null?u:""),e.append(i);return this.listExpanded()?(g=this.stack[this.stack.length-1][0].clone(),g.addClass("expanded").removeClass("active first last"),f.append(g).show()):f.hide(),c.expand?(h.insertAfter(this.$list),this.$menu.animate({left:"-="+this.$menu.parent().css("width")},"fast",function(){return w.$list.animate({height:"1px"},"fast",function(){return w.uiLocked=!1}),w.$list=h,w.selectNext(!0)})):(c.loading||this.selectNext(!0),this.uiLocked=!1)},c.prototype.preparePost=function(a){var c,d,e;return c=b.extend({},(e=this.options.baseData)!=null?e:{},a,{search:this.input.val().replace(/^\s+|\s+$/g,"")}),c.exclude=this.input.baseExclude.concat(this.stack.length?[]:this.input.tokenValues()),this.listExpanded()&&(c.context=this.stack[this.stack.length-1][0].data("id")),c.per_page==null&&(c.per_page=typeof (d=this.options).limiter=="function"?d.limiter({level:this.stack.length}):void 0),c},c}()})}).call(this)