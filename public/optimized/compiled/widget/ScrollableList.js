(function(){define(["compiled/util/ScrollableListDataSource","compiled/util/shortcut","compiled/jquery/scrollIntoView","jquery.disableWhileLoading"],function(a,b){return function(){function c(b,c){var d,e,f,g=this;this.$scroller=b,c==null&&(c={}),this.$scroller.css("overflow","auto"),this.ds=new a(this,c),this.$scroller.scroll(function(a){return g.scroll(a)}),this.$list=this.$scroller.find("ul").eq(0),this.$list.length||(this.$list=$("<ul>").appendTo(this.$scroller)),this.$list.addClass("scrollable-list"),this.itemTemplate=(d=c.itemTemplate)!=null?d:function(a){return"<li>"+a+"</li>"},this.elementHeight=(e=c.elementHeight)!=null?e:this.inferElementHeight(),this.fetchBuffer=(f=c.fetchBuffer)!=null?f:20,this.firstLoad=!0,c.noAutoLoad||this.load(),this.clicked&&this.$list.delegate(".scrollable-list > li","click",this.clicked)}return b(c,"ds","addItem","updateItems","removeItem"),c.prototype.item=function(a){return this.ds.items[this.positionFor(a)]},c.prototype.$item=function(a){var b;b=this.$itemAt(this.positionFor(a));if(b.length)return b},c.prototype.$itemAt=function(a){return this.$items().eq(a)},c.prototype.$items=function(){return this.$list.find("> li").not(".scrollable-list-item-deleting,.scrollable-list-item-moving")},c.prototype.addedItem=function(a,b){var c;return this.prepareItems(b-1),c=$(this.itemTemplate(a)),b===0?c.prependTo(this.$list):c.insertAfter(this.$itemAt(b-1)),this.setCount(this.ds.itemIds.length),typeof this.added=="function"?this.added(a,c):void 0},c.prototype.updateItem=function(a){return this.updateItems([a])},c.prototype.updatedItem=function(a,b,c){var d,e,f,g=this;return this.prepareItems(c-1),this.$itemAt(b).replaceWith(this.itemTemplate(a)),e=this.$items(),d=e.eq(b),b!==c&&(f=d.clone(),d.addClass("scrollable-list-item-moving").animate({opacity:"toggle",height:"toggle"},200,function(){return d.remove()}),c===0?f.prependTo(this.$list):f.insertAfter(e.eq(c-1)),f.animate({opacity:"toggle",height:"toggle"},0).animate({opacity:"toggle",height:"toggle"},200,function(){return f.scrollIntoView()})),typeof this.updated=="function"?this.updated(a,f!=null?f:d):void 0},c.prototype.removedItem=function(a,b){var c,d=this;return c=this.$itemAt(b),c.addClass("scrollable-list-item-deleting").fadeOut("fast",function(){return c.remove(),d.setCount(d.ds.itemIds.length),d.fetchVisible()}),typeof this.removed=="function"?this.removed(a,c):void 0},c.prototype.replaceItems=function(a,b,c){var d,e,f;this.setCount(c),this.prepareItems(a-1),d=this.$items().slice(a,a+b.length),f=[],d.length<b.length&&(f=b.slice(d.length),b=b.slice(0,d.length)),$(function(){var a,c,d;d=[];for(a=0,c=b.length;a<c;a++)e=b[a],d.push(this.itemTemplate(e));return d}.call(this).join("")).insertBefore(d.eq(0)),d.remove();if(f.length)return this.$list.append(function(){var a,b,c;c=[];for(a=0,b=f.length;a<b;a++)e=f[a],c.push(this.itemTemplate(e));return c}.call(this).join(""))},c.prototype.fetchVisible=function(){var a,b;return this.ds.itemIds?(b=Math.floor(this.$scroller.scrollTop()/this.elementHeight),a=Math.floor((this.$scroller.scrollTop()+this.$scroller.height()-1)/this.elementHeight)+this.fetchBuffer,a>=this.numItems&&(a=Math.max(this.numItems,1)-1),b=Math.max(0,b-this.fetchBuffer),this.prepareItems(a),this.ds.fetchRange(b,a)):[]},c.prototype.prepareItems=function(a){var b,c;c=a-this.$items().length;if(c>0)return this.$list.append(function(){var a,d;d=[];for(b=a=0;0>c?a>=c:a<=c;b=0>c?--a:++a)d.push("<li class='scrollable-list-item-loading' />");return d}().join(""))},c.prototype.scroll=function(){var a=this;return this.scrollCb&&clearTimeout(this.scrollCb),this.scrollCb=setTimeout(function(){return delete a.scrollCb,a.fetchVisible()},50)},c.prototype.inferElementHeight=function(){var a,b;return a=$(this.itemTemplate({})).appendTo(this.$list),b=a.height(),a.remove(),b},c.prototype.positionFor=function(a){return this.ds.itemMap[a]},c.prototype.loadItem=function(a){var b,c,d=this;return a!=null&&(c=this.positionFor(a))!=null&&(this.prepareItems(c),this.$item(a).scrollIntoView({toTop:this.firstLoad})),b=this.fetchVisible(),b.length||(b=[{}]),$.when.apply($,b).done(function(){var b,e,f;return c!=null&&(f=[d.ds.items[c],d.$item(a)],e=f[0],b=f[1]),typeof d.loaded=="function"?d.loaded(a,e,b):void 0})},c.prototype.load=function(a){var b,c,d,e=this;return a==null&&(a={}),d=a.sortKey&&a.sortKey!==this.ds.sortKey,c=a.params&&JSON.stringify(a.params)!==JSON.stringify(this.ds.params),d||c||!this.ds.initialized?(this.fetchThrough=0,this.$list.empty(),this.$list.css("min-height","0px"),b=this.ds.load(a,function(b){return e.setCount(b),e.loadItem(a.loadId),typeof a.cb=="function"&&a.cb(),e.firstLoad=!1}),this.$scroller.disableWhileLoading(b)):(this.loadItem(a.loadId),this.firstLoad=!1)},c.prototype.setCount=function(a){var b;this.numItems=a,this.$list.css("min-height",this.elementHeight*this.numItems+"px"),b=this.$items();if(b.length>this.numItems)return b.slice(this.numItems).remove()},c}()})}).call(this)