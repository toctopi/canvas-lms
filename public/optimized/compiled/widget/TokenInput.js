(function(){var a=[].indexOf||function(a){for(var b=0,c=this.length;b<c;b++)if(b in this&&this[b]===a)return b;return-1};define(["jquery","compiled/widget/TokenSelector","jquery.instructure_misc_plugins"],function(b,c){var d;return d=function(){function d(a,d){var e,f,g=this;this.$node=a,this.options=d,this.$node.data("token_input",this),this.$fakeInput=b("<div />").css("font-family",this.$node.css("font-family")).insertAfter(this.$node).addClass("token_input").click(function(){return g.$input.focus()}),this.nodeName=this.$node.attr("name"),this.$node.removeAttr("name").hide().change(function(){return g.$tokens.html(""),typeof g.change=="function"?g.change(g.tokenValues()):void 0}),this.added=this.options.added,this.$placeholder=b("<span />"),this.$placeholder.text(this.options.placeholder),this.options.placeholder&&this.$placeholder.appendTo(this.$fakeInput),this.$scroller=b("<div />").appendTo(this.$fakeInput),this.$tokens=b("<ul />").appendTo(this.$scroller),this.$tokens.click(function(a){var c,d;if(d=b(a.target).closest("li")){c=b(a.target).closest("a");if(c.length)return d.remove(),typeof g.change=="function"?g.change(g.tokenValues()):void 0}}),this.$tokens.maxTokenWidth=function(){var a;return parseInt(g.$tokens.css("width").replace("px",""))-((a=g.options.tokenWrapBuffer)!=null?a:150)+"px"},this.$tokens.resizeTokens=function(a){return a.find("div.ellipsis").css("max-width",g.$tokens.maxTokenWidth())},b(window).resize(function(){return g.$tokens.resizeTokens(g.$tokens)}),this.$input=b("<input />").appendTo(this.$scroller).css("width","20px").css("font-size",this.$fakeInput.css("font-size")).autoGrowInput({comfortZone:20}).focus(function(){return g.$placeholder.hide(),g.active=!0,g.$fakeInput.addClass("active")}).blur(function(){return g.active=!1,setTimeout(function(){var a;if(!g.active)return g.$fakeInput.removeClass("active"),g.$placeholder.showIf(g.val()===""&&!g.$tokens.find("li").length),(a=g.selector)!=null?typeof a.blur=="function"?a.blur():void 0:void 0},50)}).keydown(function(a){return g.inputKeyDown(a)}).keyup(function(a){return g.inputKeyUp(a)});if(this.options.selector){e=(f=this.options.selector.type)!=null?f:c,delete this.options.selector.type;if(this.browser=this.options.selector.browser)delete this.options.selector.browser,b('<a class="browser">browse</a>').click(function(){if(g.selector.browse(g.browser.data))return g.$fakeInput.addClass("browse")}).prependTo(this.$fakeInput),this.$fakeInput.addClass("browsable");this.selector=new e(this,this.$node.data("finder_url"),this.options.selector)}this.baseExclude=[],this.resize()}return d.name="TokenInput",d.prototype.resize=function(){return this.$fakeInput.css("width",this.$node.css("width"))},d.prototype.addToken=function(a){var c,d,e,f,g,h,i,j,k;return i=(j=a!=null?a.value:void 0)!=null?j:this.val(),f="token_"+i,e=this.$tokens.find("#"+f),g=e.length===0,g&&(e=b("<li />"),h=(k=a!=null?a.text:void 0)!=null?k:this.val(),e.attr("id",f),d=b("<div />").addClass("ellipsis"),d.attr("title",h),d.text(h),e.append(d),c=b("<a />"),e.append(c),e.append(b("<input />").attr("type","hidden").attr("name",this.nodeName+"[]").val(i)),this.$tokens.resizeTokens(e),this.$tokens.append(e)),(a!=null?!a.noClear:!void 0)&&this.val(""),this.$placeholder.hide(),a&&typeof this.added=="function"&&this.added(a.data,e,g),typeof this.change=="function"&&this.change(this.tokenValues()),this.reposition()},d.prototype.hasToken=function(a){var b;return this.$tokens.find("#token_"+((b=a!=null?a.value:void 0)!=null?b:a)).length>0},d.prototype.removeToken=function(a){var b,c;return b="token_"+((c=a!=null?a.value:void 0)!=null?c:a),this.$tokens.find("#"+b).remove(),typeof this.change=="function"&&this.change(this.tokenValues()),this.reposition()},d.prototype.removeLastToken=function(a){return this.$tokens.find("li").last().remove(),typeof this.change=="function"&&this.change(this.tokenValues()),this.reposition()},d.prototype.reposition=function(){var a;return(a=this.selector)!=null&&a.reposition(),this.$scroller.scrollTop(this.$scroller.prop("scrollHeight"))},d.prototype.inputKeyDown=function(b){var c,d,e;this.keyUpAction=!1;if(this.selector){if((c=this.selector)!=null?c.captureKeyDown(b):void 0)return b.preventDefault(),!1;this.$fakeInput.removeClass("browse")}else if((d=(e=b.which,a.call(this.delimiters,e)>=0))!=null?d:[])return this.keyUpAction=this.addToken,b.preventDefault(),!1;return!0},d.prototype.tokenPairs=function(){var a,c,d,e,f,g;f=this.$tokens.find("li"),g=[];for(d=0,e=f.length;d<e;d++)c=f[d],a=b(c),g.push([a.find("input").val(),a.find("div").attr("title")]);return g},d.prototype.tokenValues=function(){var a,b,c,d,e;d=this.$tokens.find("input"),e=[];for(b=0,c=d.length;b<c;b++)a=d[b],e.push(a.value);return e},d.prototype.inputKeyUp=function(a){return this.reposition(),typeof this.keyUpAction=="function"?this.keyUpAction():void 0},d.prototype.bottomOffset=function(){var a;return a=this.$fakeInput.offset(),a.top+=this.$fakeInput.height()+2,a},d.prototype.focus=function(){return this.$input.focus()},d.prototype.val=function(a){if(a==null)return this.$input.val();if(a!==this.$input.val())return this.$input.val(a).change(),this.reposition()},d.prototype.caret=function(){var a,b,c,d;return this.$input[0].selectionStart!=null?(c=this.$input[0].selectionStart,a=this.$input[0].selectionEnd):(d=this.val(),b=document.selection.createRange().duplicate(),b.moveEnd("character",d.length),c=b.text===""?d.length:d.lastIndexOf(b.text),b=document.selection.createRange().duplicate(),b.moveStart("character",-d.length),a=b.text.length),c===a?c:-1},d.prototype.selectorClosed=function(){return this.$fakeInput.removeClass("browse")},d}(),b.fn.tokenInput=function(a){return this.each(function(){return new d(b(this),b.extend(!0,{},a))})}})}).call(this)