(function(){define(["jquery","compiled/util/objectCollection","jst/courseList/wrapper","jst/courseList/content","jquery.ajaxJSON"],function(a,b,c,d){var e;return e=function(){function e(b,c,d){this.options=a.extend({},this.options,d),this.appendTarget=a(this.options.appendTarget),this.element=a(b),this.targetList=this.element.find("> ul"),this.wrapper=a(this.options.wrapper({})),this.sourceList=this.wrapper.find("> ul"),this.contentTemplate=this.options.content,this.ghost=a("<ul/>").addClass("customListGhost"),this.requests={add:{},remove:{}},this.doc=a(document.body),this.attach(),this.setItems(c),this.options.autoOpen&&this.open()}return e.name="CustomList",e.prototype.options={animationDuration:200,model:"Course",dataAttribute:"id",wrapper:c,content:d,url:"/favorites",appendTarget:"body",resetCount:12,onToggle:!1},e.prototype.open=function(){var a=this;return this.wrapper.appendTo(this.appendTarget).show(),setTimeout(function(){var b;return a.element.addClass("customListEditing"),typeof (b=a.options).onToggle=="function"?b.onToggle(!0):void 0},1)},e.prototype.close=function(){var a,b=this;this.wrapper.hide(0,function(){return b.teardown()}),this.element.removeClass("customListEditing"),typeof (a=this.options).onToggle=="function"&&a.onToggle(!1);if(this.pinned.length===0)return this.resetList()},e.prototype.attach=function(){return this.element.delegate(".customListOpen","click",a.proxy(this,"open")),this.wrapper.delegate(".customListClose","click",a.proxy(this,"close")),this.wrapper.delegate(".customListRestore","click",a.proxy(this,"reset")),this.wrapper.delegate("a","click.customListTeardown",function(a){return a.preventDefault()}),this.wrapper.delegate(".customListItem","click.customListTeardown",a.proxy(this,"sourceClickHandler"))},e.prototype.teardown=function(){return this.wrapper.detach()},e.prototype.add=function(a,b){var c,d,e,f;return e=this.items.findBy("id",a),c=b.clone().hide(),e.element=c,b.addClass("on"),this.pinned.push(e),this.pinned.sortBy("shortName"),d=this.pinned.indexOf(e)+1,f=this.targetList.find("li:nth-child("+d+")"),f.length!==0?c.insertBefore(f):c.appendTo(this.targetList),c.slideDown(this.options.animationDuration),this.animateGhost(b,c),this.onAdd(e)},e.prototype.animateGhost=function(a,b){var c,d,e,f=this;return d=a.offset(),e=b.offset(),c=a.clone(),d.position="absolute",this.ghost.append(c),this.ghost.appendTo(this.doc).css(d).animate(e,this.options.animationDuration,function(){return f.ghost.detach().empty()})},e.prototype.remove=function(a,b){var c=this;return b.removeClass("on"),this.animating=!0,this.onRemove(a),a.element.slideUp(this.options.animationDuration,function(){return a.element.remove(),c.pinned.eraseBy("id",a.id),c.animating=!1})},e.prototype.abortAll=function(){var a,b,c,d,e;c=this.requests.add;for(a in c)b=c[a],b.abort();d=this.requests.remove,e=[];for(a in d)b=d[a],e.push(b.abort());return e},e.prototype.reset=function(){var b,c=this;return this.abortAll(),b=function(){return delete c.requests.reset},this.requests.reset=a.ajaxJSON(this.options.url+"/"+this.options.model,"DELETE",{},b,b),this.resetList()},e.prototype.resetList=function(){var a,b;return a=this.items.slice(0,this.options.resetCount),b=this.contentTemplate({items:a}),this.targetList.empty().html(b),this.setPinned()},e.prototype.onAdd=function(b){var c,d,e,f,g=this;if(this.requests.remove[b.id]){this.requests.remove[b.id].abort();return}return f=function(){var a;return a=[].slice.call(arguments),a.unshift(b.id),g.addSuccess.apply(g,a)},d=function(){var a;return a=[].slice.call(arguments),a.unshift(b.id),g.addError.apply(g,a)},c={favorite:{context_type:this.options.model,context_id:b.id}},e=a.ajaxJSON(this.options.url,"POST",c,f,d),this.requests.add[b.id]=e},e.prototype.onRemove=function(b){var c,d,e,f,g=this;if(this.requests.add[b.id]){this.requests.add[b.id].abort();return}return e=function(){var a;return a=[].slice.call(arguments),a.unshift(b.id),g.removeSuccess.apply(g,a)},c=function(){var a;return a=[].slice.call(arguments),a.unshift(b.id),g.removeError.apply(g,a)},f=this.options.url+"/"+b.id,d=a.ajaxJSON(f,"DELETE",{context_type:this.options.model},e,c),this.requests.remove[b.id]=d},e.prototype.addSuccess=function(a){return delete this.requests.add[a]},e.prototype.addError=function(a){return delete this.requests.add[a]},e.prototype.removeSuccess=function(a){return delete this.requests.remove[a]},e.prototype.removeError=function(a){return delete this.requests.remove[a]},e.prototype.setItems=function(a){var c;return this.items=b(a),this.items.sortBy("shortName"),c=this.contentTemplate({items:this.items}),this.sourceList.html(c),this.setPinned()},e.prototype.setPinned=function(){var c,d,e,f,g,h,i=this;this.pinned=b([]),this.element.find("> ul > li").each(function(b,c){var d,e;c=a(c),d=c.data("id"),e=i.items.findBy("id",d);if(!e)return;return e.element=c,i.pinned.push(e)}),this.wrapper.find("ul > li").removeClass("on"),g=this.pinned,h=[];for(e=0,f=g.length;e<f;e++)c=g[e],d=this.wrapper.find("ul > li[data-id="+c.id+"]"),h.push(d.addClass("on"));return h},e.prototype.sourceClickHandler=function(b){return this.checkElement(a(b.currentTarget))},e.prototype.checkElement=function(a){var b,c;if(this.animating||this.requests.reset)return;return b=a.data("id"),c=this.pinned.findBy("id",b),c?this.remove(c,a):this.add(b,a)},e}()})}).call(this)