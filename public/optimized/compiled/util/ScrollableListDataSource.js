(function(){var a=[].slice;define(["jquery","jquery.ajaxJSON"],function(b){return function(){function c(a,b){var c,d,e,f,g,h,i,j,k;this.list=a,this.pageOffset=(c=b.pageOffset)!=null?c:1,this.perPage=(d=b.perPage)!=null?d:25,this.pageKey=(e=b.pageKey)!=null?e:"page",this.perPageKey=(f=b.perPageKey)!=null?f:"per_page",this.itemIdsKey=(g=b.itemIdsKey)!=null?g:"item_ids",this.itemsKey=(h=b.itemsKey)!=null?h:"items",this.sortKey=(i=b.sortKey)!=null?i:"id",this.sortDir=(j=b.sortDir)!=null?j:"asc",this.params=(k=b.params)!=null?k:{},this.baseUrl=b.baseUrl,this.model=b.model}return c.prototype.load=function(a,b){return this.initialized=!0,a.sortKey!=null&&(this.sortKey=a.sortKey),a.params!=null&&(this.params=a.params),this.itemIds=null,this.items=[],this.pages=[],this.resetRequests(),this.fetchPage(0,b)},c.prototype.addItem=function(a){return this._addItem(this.modelize(a)),this.recompute()},c.prototype.updateItems=function(a){var b,c,d,e;a=this.modelize(a),b=a.length<=1;for(d=0,e=a.length;d<e;d++)c=a[d],c.get("visible")?this.itemMap[c.id]!=null?this._updateItem(c,b):this._addItem(c,b):this._removeItem(c,b);return this.recompute(!b)},c.prototype.removeItem=function(a){return this._removeItem(this.modelize(a)),this.recompute()},c.prototype.modelize=function(a){var b,c,d,e,f,g=this;c=function(a){return a=new g.model(a),a.list=g.list,a};if(a.length){f=[];for(d=0,e=a.length;d<e;d++)b=a[d],f.push(c(b));return f}return c(a)},c.prototype.positionOrReload=function(a,b){var c;return c=this.positionFor(a,b),c!=null&&!this.deferredPositionChecks?c:(this.deferredPositionChecks==null&&(this.deferredPositionChecks=[]),this.deferredPositionChecks.push(a.id),null)},c.prototype.positionFor=function(a,b){var c,d,e,f,g,h=this;c=this.sortDir==="asc"?function(a,b){return a.get(h.sortKey)<b.get(h.sortKey)}:function(a,b){return a.get(h.sortKey)>b.get(h.sortKey)};for(d=f=0,g=this.items.length-1;0>g?f>g:f<g;d=0>g?--f:++f)if(this.items[d]){e=b===d&&a.id===this.items[d].id&&a.get(this.sortKey)===this.items[d].get(this.sortKey);if(e||c(a,this.items[d]))return d>1&&!this.items[d-1]?null:d}if(this.items.length===this.itemIds.length||this.itemIds.length===0)return this.itemIds.length},c.prototype.refreshList=function(){var a,b,c,d,e;e=[];for(b=c=0,d=this.pages.length;0>d?c>d:c<d;b=0>d?--c:++c){if(this.pages[b]!=="loaded")continue;a=b*this.perPage,e.push(this.list.replaceItems(a,this.items.slice(a,Math.min(a+this.perPage,this.itemIds.length)),this.itemIds.length))}return e},c.prototype.fetchRange=function(a,b){var c,d,e,f;b==null&&(b=a);if(!this.itemIds)return[];e=Math.floor(a/this.perPage),c=Math.floor(b/this.perPage),c=Math.min(c,Math.floor(this.itemIds.length/this.perPage));for(d=f=e;e>c?f>=c:f<=c;d=e>c?--f:++f)this.pages[d]||this.fetchPage(d);return this.requests},c.prototype.fetchPage=function(a,c){var d,e,f=this;return d=b.extend({},this.params),d[this.perPageKey]=this.perPage,d[this.pageKey]=a+this.pageOffset,this.pages[a]="loading",(e=this.requests[a])!=null&&e.abort(),this.requests[a]=b.ajaxJSON(this.baseUrl,"GET",d,function(b){var d,e;return delete f.requests[a],e=f.modelize(b[f.itemsKey]),d=b[f.itemIdsKey],f.fetchedPage(a,d,e),typeof c=="function"?c(d.length):void 0})},c.prototype.fetchedPage=function(b,c,d){var e,f,g,h,i;return f=b*this.perPage,e=d.length,c.length<(b+1)*this.perPage&&(e=((h=[])!=null?h:this.itemIds).length-f),this.setItemIds(c,b),(g=this.items)[f]==null&&(g[f]=null),(i=this.items).splice.apply(i,[f,e].concat(a.call(d))),this.pages[b]="loaded",this.list.replaceItems(f,d,this.itemIds.length)},c.prototype.resetRequests=function(){var a,b,c,d;if(this.requests){d=this.requests;for(b=0,c=d.length;b<c;b++)a=d[b],a!=null&&a.abort()}return this.requests=[]},c.prototype.setItemIds=function(a,b){var c;c=this.itemIds==null;if(!c&&this.itemIds.toString()===a.toString())return;this.itemIds=a,this.resetItemMap();if(!c)return this.refetchPages(b)},c.prototype.resetItemMap=function(){var a,b,c,d;this.itemMap={},d=[];for(a=b=0,c=this.itemIds.length;0>c?b>c:b<c;a=0>c?--b:++b)d.push(this.itemMap[this.itemIds[a]]=a);return d},c.prototype.recompute=function(a){var b,c,d,e=this;a==null&&(a=!1);if(this.deferredPositionChecks)return this.fetchPage(0,function(){var b,c,d,f;f=e.deferredPositionChecks;for(c=0,d=f.length;c<d;c++)b=f[c],e.fetchRange(e.itemMap[b]);delete e.deferredPositionChecks;if(a)return e.refreshList()});for(b=c=0,d=this.pages.length;0>d?c>d:c<d;b=0>d?--c:++c)this.pages[b]==="loaded"&&this.checkPage(b);if(a)return this.refreshList()},c.prototype.refetchPages=function(a){var b,c,d,e,f;f=[];for(b=c=0,d=this.pages.length;0>d?c>d:c<d;b=0>d?--c:++c)this.pages[b]==="loaded"&&b!==a&&(b*this.perPage<this.itemIds.length?f.push(this.fetchPage(b)):((e=this.requests[b])!=null&&e.abort(),f.push(delete this.pages[b])));return f},c.prototype.checkPage=function(a){var b,c,d,e;c=a*this.perPage;for(b=d=c,e=Math.min(c+this.perPage,this.itemIds.length);c>e?d>e:d<e;b=c>e?--d:++d)if(!this.items[b])return this.fetchPage(a)},c.prototype._addItem=function(a,b,c){var d;b==null&&(b=!0),c==null&&(c=null),d=c!=null?c:this.positionOrReload(a);if(d==null)return;return this.itemIds.splice(d,0,a.id),this.items.splice(d,0,a),b&&this.list.addedItem(a,d),this.resetItemMap()},c.prototype._updateItem=function(a,b,c){var d,e;b==null&&(b=!0),c==null&&(c=null),d=this.itemMap[a.id],e=c!=null?c:this.positionOrReload(a,d),a=this.items[d].set(a.toJSON());if(e==null)return;return e!==d&&this._moveItem(a,d,e),b&&this.list.updatedItem(a,d,e),this.resetItemMap()},c.prototype._moveItem=function(a,b,c){return c>b&&c--,this._removeItem(a,!1,b),this._addItem(a,!1,c)},c.prototype._removeItem=function(a,b,c){b==null&&(b=!0),c==null&&(c=null),c==null&&(c=this.itemMap[a.id]);if(c==null)return;return this.itemIds.splice(c,1),this.items.length>=c&&this.items.splice(c,1),b&&this.list.removedItem(a,c),this.resetItemMap()},c}()})}).call(this)