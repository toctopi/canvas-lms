(function(){var a=function(a,b){return function(){return a.apply(b,arguments)}},b={}.hasOwnProperty,c=function(a,c){function e(){this.constructor=a}for(var d in c)b.call(c,d)&&(a[d]=c[d]);return e.prototype=c.prototype,a.prototype=new e,a.__super__=c.prototype,a};define(["i18n!jobs","jquery","vendor/slickgrid","jquery.ajaxJSON","jqueryui/dialog"],function(b,d,e){var f,g,h;return f=function(){function b(b,c,e){this.options=b,this.type_name=c,this.grid_name=e,this.change_flavor=a(this.change_flavor,this),this.refresh=a(this.refresh,this),this.setTimer=a(this.setTimer,this),this.data=this.options.data,this.$element=d(this.grid_name),this.options.refresh_rate&&this.setTimer(),this.query=""}return b.name="FlavorGrid",b.prototype.setTimer=function(){var a=this;return setTimeout(function(){return a.refresh(a.setTimer)},this.options.refresh_rate)},b.prototype.refresh=function(a){var b=this;return this.$element.queue(function(){return d.ajaxJSON(b.options.url,"GET",{flavor:b.options.flavor,q:b.query},function(c){var d,e,f,g,h,i,j,k;b.data.length=0,b.loading={},i=c[b.type_name];for(f=0,h=i.length;f<h;f++)e=i[f],b.data.push(e);if(c.total&&c.total>b.data.length)for(d=g=j=b.data.length,k=c.total;j>k?g>k:g<k;d=j>k?--g:++g)b.data.push({});return b.grid.invalidate(),typeof a=="function"&&a(),typeof b.updated=="function"&&b.updated(),b.$element.dequeue()})})},b.prototype.change_flavor=function(a){return this.options.flavor=a,this.grid.setSelectedRows([]),this.refresh()},b.prototype.grid_options=function(){return{rowHeight:20}},b.prototype.init=function(){return this.columns=this.build_columns(),this.loading={},this.grid=new e.Grid(this.grid_name,this.data,this.columns,this.grid_options()),this},b}(),window.Jobs=function(f){function g(b,c,d){c==null&&(c="jobs"),d==null&&(d="#jobs-grid"),this.id_formatter=a(this.id_formatter,this),this.load=a(this.load,this),this.attempts_formatter=a(this.attempts_formatter,this),b.max_attempts&&(g.max_attempts=b.max_attempts),g.__super__.constructor.call(this,b,c,d),b.starting_query&&(this.query=b.starting_query)}return c(g,f),g.name="Jobs",g.prototype.search=function(a){return this.query=a,this.refresh()},g.prototype.attempts_formatter=function(a,b,c){var d,e,f;return this.data[a].id?(e=this.data[a].max_attempts||g.max_attempts,c===0?d="":c<e?d="has-failed-attempts":c===this.options.on_hold_attempt_count?(d="on-hold",c="hold"):d="has-failed-max-attempts",f=c==="hold"?"":"/ "+e,"<span class='"+d+"'>"+c+f+"</span>"):""},g.prototype.load=function(a){var b=this;return this.$element.queue(function(){a-=a%b.options.limit;if(b.loading[a]){b.$element.dequeue();return}return b.loading[a]=!0,d.ajaxJSON(b.options.url,"GET",{flavor:b.options.flavor,q:b.query,offset:a},function(c){var d;return[].splice.apply(b.data,[a,a+c[b.type_name].length-a].concat(d=c[b.type_name])),d,b.grid.invalidate(),b.$element.dequeue()})})},g.prototype.id_formatter=function(a,b,c){return this.data[a].id?this.data[a].id:(this.load(a),"<span class='unloaded-id'>-</span>")},g.prototype.build_columns=function(){return[{id:"id",name:b.t("columns.id","id"),field:"id",width:75,formatter:this.id_formatter},{id:"tag",name:b.t("columns.tag","tag"),field:"tag",width:200},{id:"attempts",name:b.t("columns.attempt","attempt"),field:"attempts",width:60,formatter:this.attempts_formatter},{id:"priority",name:b.t("columns.priority","priority"),field:"priority",width:70},{id:"strand",name:b.t("columns.strand","strand"),field:"strand",width:100},{id:"run_at",name:b.t("columns.run_at","run at"),field:"run_at",width:165}]},g.prototype.init=function(){var a=this;return g.__super__.init.call(this),this.grid.setSelectionModel(new e.RowSelectionModel),this.grid.onSelectedRowsChanged.subscribe(function(){var b,c,e;return e=a.grid.getSelectedRows(),c=(e!=null?e.length:void 0)===1?e[0]:-1,b=a.data[e[0]]||{},d("#show-job .show-field").each(function(a,c){var e;return e=c.id.replace("job-",""),d(c).text(b[e]||"")}),d("#job-id-link").attr("href","/jobs?id="+b.id+"&flavor="+a.options.flavor)}),this.data.length===1&&this.type_name==="jobs"&&(this.grid.setSelectedRows([0]),this.grid.onSelectedRowsChanged.notify()),this},g.prototype.selectAll=function(){var a,b,c;return this.grid.setSelectedRows(function(){c=[];for(var a=0,b=this.data.length;0>b?a>b:a<b;0>b?a--:a++)c.push(a);return c}.apply(this)),this.grid.onSelectedRowsChanged.notify()},g.prototype.onSelected=function(a){var c,e,f,g;f={flavor:this.options.flavor,q:this.query,update_action:a};if(this.grid.getSelectedRows().length<1){alert("No jobs are selected");return}c=this.grid.getSelectedRows().length>1&&this.grid.getSelectedRows().length===this.data.length;if(c){e=function(){switch(a){case"hold":return b.t("confirm.hold_all","Are you sure you want to hold *all* jobs of this type and matching this query?");case"unhold":return b.t("confirm.unhold_all","Are you sure you want to unhold *all* jobs of this type and matching this query?");case"destroy":return b.t("confirm.destroy_all","Are you sure you want to destroy *all* jobs of this type and matching this query?")}}();if(!confirm(e))return}return c||(f.job_ids=function(){var a,b,c,d;c=this.grid.getSelectedRows(),d=[];for(a=0,b=c.length;a<b;a++)g=c[a],d.push(this.data[g].id);return d}.call(this)),d.ajaxJSON(this.options.batch_update_url,"POST",f,this.refresh),this.grid.setSelectedRows([])},g.prototype.updated=function(){return d("#jobs-total").text(this.data.length)},g}(f),h=function(a){function d(a){d.__super__.constructor.call(this,a,"running","#running-grid")}return c(d,a),d.name="Workers",d.prototype.build_columns=function(){var a;return a=[{id:"worker",name:b.t("columns.worker","worker"),field:"locked_by",width:175}].concat(d.__super__.build_columns.call(this)),a.pop(),a},d.prototype.updated=function(){},d}(Jobs),g=function(a){function e(a){e.__super__.constructor.call(this,a,"tags","#tags-grid")}return c(e,a),e.name="Tags",e.prototype.build_columns=function(){return[{id:"tag",name:b.t("columns.tag","tag"),field:"tag",width:200},{id:"count",name:b.t("columns.count","count"),field:"count",width:50}]},e.prototype.grid_options=function(){return d.extend(e.__super__.grid_options.call(this),{enableCellNavigation:!1})},e}(f),d.extend(window,{Jobs:Jobs,Workers:h,Tags:g}),d(document).ready(function(){var a;return d("#tags-flavor").change(function(){return window.tags.change_flavor(d(this).val())}),d("#jobs-flavor").change(function(){return window.jobs.change_flavor(d(this).val())}),d("#jobs-refresh").click(function(){return window.jobs.refresh()}),a=d("#jobs-search")[0].onsearch===void 0?"change":"search",d("#jobs-search").bind(a,function(){return window.jobs.search(d(this).val())}),d("#select-all-jobs").click(function(){return window.jobs.selectAll()}),d("#hold-jobs").click(function(){return window.jobs.onSelected("hold")}),d("#un-hold-jobs").click(function(){return window.jobs.onSelected("unhold")}),d("#delete-jobs").click(function(){return window.jobs.onSelected("destroy")}),d("#job-handler-show").click(function(){return d("#job-handler-wrapper").clone().dialog({title:b.t("titles.job_handler","Job Handler"),width:900,height:700,modal:!0}),!1}),d("#job-last_error-show").click(function(){return d("#job-last_error-wrapper").clone().dialog({title:b.t("titles.last_error","Last Error"),width:900,height:700,modal:!0}),!1})}),{Jobs:Jobs,Workers:h,Tags:g}})}).call(this)