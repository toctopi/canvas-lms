(function(){var a=function(a,b){return function(){return a.apply(b,arguments)}},b={}.hasOwnProperty,c=function(a,c){function e(){this.constructor=a}for(var d in c)b.call(c,d)&&(a[d]=c[d]);return e.prototype=c.prototype,a.prototype=new e,a.__super__=c.prototype,a};define(["i18n!discussions","Backbone","underscore","compiled/discussions/Topic","compiled/discussions/EntriesView","compiled/discussions/EntryView","jst/discussions/_reply_form","compiled/discussions/Reply","compiled/widget/assignmentRubricDialog","compiled/util/wikiSidebarWithMultipleEditors","jquery.instructure_misc_helpers"],function(b,d,e,f,g,h,i,j,k){var l;return l=function(d){function e(){return this.onUnreadChange=a(this.onUnreadChange,this),this.initEntries=a(this.initEntries,this),e.__super__.constructor.apply(this,arguments)}return c(e,d),e.name="TopicView",e.prototype.events={"click #discussion_topic .discussion-reply-form [data-event]":"handleEvent","change .view_switcher":"switchView","click .add_root_reply":"addRootReply"},e.prototype.initialize=function(){return this.$el=$("#main"),this.model.set("id",ENV.DISCUSSION.TOPIC.ID),this.model.cid="main",this.model.set("canAttach",ENV.DISCUSSION.PERMISSIONS.CAN_ATTACH),this.render(),ENV.DISCUSSION.INITIAL_POST_REQUIRED||this.initEntries(),this.initViewSwitcher(),$(document.body).is(".with-right-side")&&$.scrollSidebar(),k.initTriggers(),this.disableNextUnread(),this.$el.toggleClass("side_comment_discussion",!ENV.DISCUSSION.THREADED)},e.prototype.cacheElements=function(){return this.$addRootReply=this.$(".add_root_reply")},e.prototype.initEntries=function(){var a=this;return this.discussion?!1:(this.discussion=new g({model:new f}),this.collection=this.discussion.collection,this.discussion.model.bind("change:unread_entries",this.onUnreadChange),this.discussion.model.bind("fetchSuccess",function(){var b;return b=a.discussion.model.get("unread_entries"),a.setNextUnread(b),a.cacheElements()}),this.trigger("initEntries",this))},e.prototype.onUnreadChange=function(a,c){return this.model.set("unreadCount",c.length),this.model.set("unreadText",b.t("unread_count_tooltip",{zero:"No unread replies",one:"1 unread reply",other:"%{count} unread replies"},{count:c.length})),this.setNextUnread(c)},e.prototype.setNextUnread=function(a){var b,c,d;if(a.length===0){this.disableNextUnread();return}return d=this.discussion.$(".can_be_marked_as_read.unread:first"),c=d.parent(),b=c.attr("id"),this.$("#jump_to_next_unread").removeClass("disabled").attr("href","#"+b)},e.prototype.disableNextUnread=function(){return this.$("#jump_to_next_unread").addClass("disabled").removeAttr("href")},e.prototype.addReply=function(a){var b=this;return a.preventDefault(),this.reply==null&&(this.reply=new j(this,{topLevel:!0,added:this.initEntries}),this.reply.on("edit",function(){var a;return(a=b.$addRootReply)!=null?a.hide():void 0}),this.reply.on("hide",function(){var a;return(a=b.$addRootReply)!=null?a.show():void 0})),this.model.set("notification",""),this.reply.edit()},e.prototype.addReplyAttachment=h.prototype.addReplyAttachment,e.prototype.removeReplyAttachment=h.prototype.removeReplyAttachment,e.prototype.handleEvent=function(a){var b,c;return b=$(a.currentTarget),c=b.data("event"),typeof this[c]=="function"?this[c](a,b):void 0},e.prototype.render=function(){var a;return ENV.DISCUSSION.PERMISSIONS.CAN_REPLY&&(a=i(this.model.toJSON()),this.$(".entry_content:first").append(a)),e.__super__.render.apply(this,arguments)},e.prototype.initViewSwitcher=function(){return this.$(".view_switcher").show().selectmenu({icons:[{find:".collapsed-view"},{find:".unread-view"},{find:".expanded-view"}]})},e.prototype.switchView=function(a){var b,c;return b=$(a.currentTarget),c=b.val(),this[c+"View"]()},e.prototype.collapsedView=function(){var a,b,c,d;c=h.instances,d=[];for(a in c)b=c[a],d.push(b.model.set("collapsedView",!0));return d},e.prototype.expandedView=function(){var a,b,c,d;c=h.instances,d=[];for(a in c)b=c[a],d.push(b.model.set("collapsedView",!1));return d},e.prototype.unreadView=function(){var a,b,c,d,e;d=h.instances,e=[];for(b in d)c=d[b],a=c.model.get("read_state")==="read",e.push(c.model.set("collapsedView",a));return e},e.prototype.addRootReply=function(a){var b,c;return b=this.$(a.currentTarget),c=$("#discussion_topic .discussion-reply-form"),this.addReply(a),$("html, body").animate({scrollTop:c.offset().top-100})},e}(d.View)})}).call(this)