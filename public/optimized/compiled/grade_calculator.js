(function(){define(["INST","jquery"],function(a,b){var c;return c=function(){function a(){}return a.name="GradeCalculator",a.calculate=function(a,c,d){var e,f=this;return e={},e.group_sums=b.map(c,function(b){return{group:b,current:f.create_group_sum(b,a,!0),"final":f.create_group_sum(b,a,!1)}}),e.current=this.calculate_total(e.group_sums,!0,d),e["final"]=this.calculate_total(e.group_sums,!1,d),e},a.create_group_sum=function(a,c,d){var e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E;l={submissions:[],score:0,possible:0,submission_count:0},y=a.assignments;for(m=0,q=y.length;m<q;m++){e=y[m],f={score:0,possible:0,percent:0,drop:!1,submitted:!1},k=null;for(n=0,r=c.length;n<r;n++){j=c[n];if(j.assignment_id!==e.id)continue;k=j;break}k==null&&(k={score:null}),k.assignment_group_id=a.id,k.points_possible==null&&(k.points_possible=e.points_possible),f.submission=k,l.submissions.push(f);if(!d||k.score!=null&&k.score!=="")f.score=this.parse(k.score),f.possible=this.parse(e.points_possible),f.percent=this.parse(f.score/f.possible),f.submitted=k.score!=null&&k.score!=="",f.submitted&&(l.submission_count+=1)}l.submissions.sort(function(a,b){return a.percent-b.percent}),i=b.extend({drop_lowest:0,drop_highest:0,never_drop:[]},a.rules),g=0,z=["low","high"];for(o=0,s=z.length;o<s;o++){h=z[o],A=l.submissions;for(p=0,t=A.length;p<t;p++)f=A[p],!f.drop&&i["drop_"+h+"est"]>0&&b.inArray(f.assignment_id,i.never_drop)===-1&&f.possible>0&&f.submitted&&(f.drop=!0,(B=f.submission)!=null&&(B.drop=!0),i["drop_"+h+"est"]-=1,g+=1)}g>0&&g===l.submission_count&&(l.submissions[l.submissions.length-1].drop=!1,(C=l.submissions[l.submissions.length-1].submission)!=null&&(C.drop=!1),g-=1),l.submission_count-=g,D=l.submissions;for(w=0,u=D.length;w<u;w++)j=D[w],j.drop||(l.score+=j.score);E=l.submissions;for(x=0,v=E.length;x<v;x++)j=E[x],j.drop||(l.possible+=j.possible);return l},a.calculate_total=function(a,b,c){var d,e,f,g,h,i,j,k,l;e=b?"current":"final";if(c==="percent"){h=0,g=0,j=0;for(k=0,l=a.length;k<l;k++){d=a[k];if(d.group.group_weight>0)d[e].submission_count>0&&d[e].possible>0&&(i=d[e].score/d[e].possible,h+=d.group.group_weight*i,g+=d.group.group_weight),j+=d.group.group_weight;else continue}return b&&g<100&&(f=j<100?j:100,h=h*f/g),{score:h,possible:100}}return{score:this.sum(function(){var b,c,f;f=[];for(b=0,c=a.length;b<c;b++)d=a[b],f.push(d[e].score);return f}()),possible:this.sum(function(){var b,c,f;f=[];for(b=0,c=a.length;b<c;b++)d=a[b],f.push(d[e].possible);return f}())}},a.sum=function(a){var b,c,d,e;b=0;for(d=0,e=a.length;d<e;d++)c=a[d],b+=c;return b},a.parse=function(a){var b;return b=parseFloat(a),b&&isFinite(b)?b:0},a.letter_grade=function(a,c){var d,e;return c<0&&(c=0),e=b.grep(a,function(b,d){return c>=b[1]*100||d===a.length-1}),d=e[0],d[0]},a}(),window.INST.GradeCalculator=c})}).call(this)