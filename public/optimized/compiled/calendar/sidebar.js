(function(){var a=function(a,b){return function(){return a.apply(b,arguments)}},b=[].indexOf||function(a){for(var b=0,c=this.length;b<c;b++)if(b in this&&this[b]===a)return b;return-1};define(["jquery","compiled/userSettings","jst/calendar/contextList","jst/calendar/undatedEvents","compiled/calendar/commonEventFactory","compiled/calendar/EditEventDetailsDialog","compiled/calendar/EventDataSource","compiled/jquery.kylemenu","jquery.instructure_misc_helpers","vendor/jquery.ba-tinypubsub"],function(c,d,e,f,g,h,i){var j,k;return j=function(){function e(b,e,f){var g,h;this.$holder=f,this.restoreList=a(this.restoreList,this),this.saveAndClear=a(this.saveAndClear,this),h=function(){try{return c.parseJSON(c.decodeFromHex(location.hash.substring(1)))||{}}catch(a){return{}}}(),h.show&&(this.contexts=h.show.split(",")),this.contexts||(this.contexts=e),this.contexts||(this.contexts=d.get("checked_calendar_codes")),this.contexts||(this.contexts=function(){var a,c,d,e;d=b.slice(0,10),e=[];for(a=0,c=d.length;a<c;a++)g=d[a],e.push(g.asset_string);return e}()),this.notify(),c.subscribe("Calendar/saveVisibleContextListAndClear",this.saveAndClear),c.subscribe("Calendar/restoreVisibleContextList",this.restoreList)}return e.name="VisibleContextManager",e.prototype.saveAndClear=function(){if(!this.savedContexts)return this.savedContexts=this.contexts,this.contexts=[],this.notify()},e.prototype.restoreList=function(){if(this.savedContexts)return this.contexts=this.savedContexts,this.savedContexts=null,this.notify()},e.prototype.toggle=function(a){var b;return b=c.inArray(a,this.contexts),b<0?(this.contexts.push(a),this.contexts.length>10&&this.contexts.shift):this.contexts.splice(b,1),this.notify()},e.prototype.notify=function(){var a=this;return c.publish("Calendar/visibleContextListChanged",[this.contexts]),this.$holder.find(".context_list_context").each(function(d,e){var f,g,h;return f=c(e),g=(h=f.data("context"),b.call(a.contexts,h)>=0),f.toggleClass("checked",g).toggleClass("not-checked",!g)})},e}(),k=function(a,b,d){var f,i,k,l,m;for(l=0,m=a.length;l<m;l++)i=a[l],i.can_create_stuff=i.can_create_calendar_events||i.can_create_assignments;return f=c("#context-list-holder"),f.html(e({contexts:a})),k=new j(a,b,f),f.find(".settings").kyleMenu({buttonOpts:{icons:{primary:"ui-icon-cog-with-droparrow",secondary:null}}}),f.delegate(".context_list_context","click",function(a){if(!c(a.target).closest(".settings, .actions").length)return k.toggle(c(this).data("context"))}),f.delegate(".context_list_context",{"mouseenter mouseleave":function(a){var b;return b=a.type!=="mouseleave"||!!c(this).find(".ui-menu:visible").length,c(this).toggleClass("hovering",b)},"popupopen popupclose":function(a){var b;return b=a.type==="popupopen",c(this).toggleClass("hovering",b).find(".settings").toggleClass("ui-state-active",b)}}),f.delegate(".actions a","click",function(){var b,d,e;d=c(this).parents("li[data-context]").data("context"),b=c(this).data("action");if(b==="add_event"||b==="add_assignment"){e=g(null,a),(new h(e)).show(),c('select[class="context_id"]').val(d).triggerHandler("change");if(b==="add_assignment")return c('a[href="#edit_assignment_form"]').click()}})}})}).call(this)