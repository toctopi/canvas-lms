(function(){var a=function(a,b){return function(){return a.apply(b,arguments)}};define(["i18n!calendar","jquery","compiled/util/hsvToRgb","jst/calendar/calendarApp","compiled/calendar/EventDataSource","compiled/calendar/commonEventFactory","compiled/calendar/ShowEventDetailsDialog","compiled/calendar/EditEventDetailsDialog","compiled/calendar/Scheduler","vendor/fullcalendar","jquery.instructure_misc_helpers","jquery.instructure_misc_plugins","vendor/jquery.ba-tinypubsub","jqueryui/button"],function(b,c,d,e,f,g,h,i,j){var k;return k=function(){function m(d,f,g,h,i){var k,l,m,n,o,p,q,r,s=this;this.contexts=f,this.manageContexts=g,this.dataSource=h,this.options=i,this.dataFromDocumentHash=a(this.dataFromDocumentHash,this),this.loadView=a(this.loadView,this),this.refetchEvents=a(this.refetchEvents,this),this.ajaxEnded=a(this.ajaxEnded,this),this.ajaxStarted=a(this.ajaxStarted,this),this.visibleContextListChanged=a(this.visibleContextListChanged,this),this.eventSaveFailed=a(this.eventSaveFailed,this),this.eventSaved=a(this.eventSaved,this),this.eventSaving=a(this.eventSaving,this),this.eventDeleted=a(this.eventDeleted,this),this.eventDeleting=a(this.eventDeleting,this),this.reloadClick=a(this.reloadClick,this),this.fragmentChange=a(this.fragmentChange,this),this.drop=a(this.drop,this),this.viewDisplay=a(this.viewDisplay,this),this.eventResize=a(this.eventResize,this),this.dayClick=a(this.dayClick,this),this.eventClick=a(this.eventClick,this),this.eventDrop=a(this.eventDrop,this),this.eventAfterRender=a(this.eventAfterRender,this),this.eventRender=a(this.eventRender,this),this.getEvents=a(this.getEvents,this),this.contextCodes=function(){var a,b,c;c=[];for(a=0,b=f.length;a<b;a++)k=f[a],c.push(k.asset_string);return c}(),this.visibleContextList=[],this.displayAppointmentEvents=null,this.activateEvent=(q=this.options)!=null?q.activateEvent:void 0,this.activeAjax=0,c.subscribe({"CommonEvent/eventDeleting":this.eventDeleting,"CommonEvent/eventDeleted":this.eventDeleted,"CommonEvent/eventSaving":this.eventSaving,"CommonEvent/eventSaved":this.eventSaved,"CommonEvent/eventSaveError":this.eventSaveFailed,"Calendar/visibleContextListChanged":this.visibleContextListChanged,"EventDataSource/ajaxStarted":this.ajaxStarted,"EventDataSource/ajaxEnded":this.ajaxEnded,"Calendar/refetchEvents":this.refetchEvents}),p='\'<span class="agenda-col-wrapper">\n  <span class="day-num">\'d\'</span>\n  <span class="day-and-month">\n    <span class="day-name">\'dddd\'</span><br />\n    <span class="month-name">\'MMM\'</span>\n  </span>\n</span>\'',n={header:{left:"prev,today,next",center:"title",right:""},editable:!0,columnFormat:{month:"dddd",week:p},allDayDefault:!1,buttonText:{today:b.t("today","Today")},defaultEventMinutes:60,weekMode:"variable",slotMinutes:30,firstHour:7,droppable:!0,dropAccept:".undated_event",ignoreTimezone:!0,lazyFetching:!1,events:this.getEvents,eventRender:this.eventRender,eventAfterRender:this.eventAfterRender,eventDrop:this.eventDrop,eventClick:this.eventClick,eventResize:this.eventResize,dayClick:this.dayClick,titleFormat:{week:"MMM d[ yyyy]{ '&ndash;'[ MMM] d, yyyy}"},viewDisplay:this.viewDisplay,drop:this.drop},l=this.dataFromDocumentHash(),!l.view_start&&((r=this.options)!=null?r.viewStart:void 0)&&(l.view_start=this.options.viewStart,location.hash=c.encodeToHex(JSON.stringify(l))),l.view_start&&(m=c.fullCalendar.parseISO8601(l.view_start),m&&(n.year=m.getFullYear(),n.month=m.getMonth(),n.date=m.getDate())),this.el=c(d).html(e());if(l.view_name==="month"||l.view_name==="agendaWeek")o=l.view_name==="agendaWeek"?"week":"month",c("#"+o).click(),n.defaultView=l.view_name;l.show&&l.show!==""&&(this.visibleContextList=l.show.split(",")),this.calendar=this.el.find("div.calendar").fullCalendar(n),c(document).fragmentChange(this.fragmentChange),this.el.find("#calendar_views").buttonset().find("input").change(function(a){return s.loadView(c(a.target).attr("id"))}),this.$refresh_calendar_link=this.el.find("#refresh_calendar_link").click(this.reloadClick),this.colorizeContexts(),this.scheduler=new j(".scheduler-wrapper",this),c("html").addClass("calendar-loaded"),this.dataSource.getAppointmentGroups(!1,function(a){var b,c,d,e;c=0;for(d=0,e=a.length;d<e;d++)b=a[d],b.requiring_action&&(c+=1);return s.el.find("#calendar-header .counter-badge").toggle(c>0).text(c)}),window.setTimeout(function(){if(l.view_name==="scheduler"){c("#scheduler").click();if(l.appointment_group_id)return s.scheduler.viewCalendarForGroupId(l.appointment_group_id)}})}var f,k,l;return m.name="Calendar",m.prototype.getEvents=function(a,b,d){var e,f=this;return e=function(a){var b,c,d,e,g,h,i;c={};if(a.length>0){for(d=g=h=a.length-1;h>0?g>=0:g<=0;d=h>0?--g:++g)b=a[d],e=!0,c[b.id]?e=!1:b.isAppointmentGroupEvent()&&(f.displayAppointmentEvents?f.displayAppointmentEvents.id===((i=b.calendarEvent)!=null?i.appointment_group_id:void 0)?e=!!b.calendarEvent.reserve_url:e=!b.calendarEvent.reserve_url:b.calendarEvent.reserve_url?b.calendarEvent.child_events_count>0&&!b.calendarEvent.reserved?e=!0:e=!1:e=!0),e||a.splice(d,1),c[b.id]=!0;return a}return a},this.dataSource.getEvents(c.unfudgeDateForProfileTimezone(a),c.unfudgeDateForProfileTimezone(b),this.visibleContextList,function(a){return f.displayAppointmentEvents?f.dataSource.getEventsForAppointmentGroup(f.displayAppointmentEvents,function(b){var c,f,g,h,i;for(f=0,h=a.length;f<h;f++)c=a[f],c.removeClass("current-appointment-group");for(g=0,i=b.length;g<i;g++)c=b[g],c.addClass("current-appointment-group");return d(e(a.concat(b)))}):d(e(a))})},m.prototype.eventRender=function(a,b,d){var e;return a.isAppointmentGroupEvent()&&this.displayAppointmentEvents&&this.displayAppointmentEvents.id===a.calendarEvent.appointment_group_id&&(e="Available",a.calendarEvent.available_slots>0&&(e=""+a.calendarEvent.available_slots+" Available"),a.calendarEvent.available_slots===0&&(e="Filled"),a.calendarEvent.reserved===!0&&(e="Reserved"),c(b).find(".fc-event-title").text(e)),!0},m.prototype.eventAfterRender=function(a,b,c){var d,e;a.eventType==="assignment"&&a.isDueAtMidnight()&&b.find(".fc-event-time").remove(),a.eventType==="assignment"&&c.name==="agendaWeek"&&b.height("").find(".ui-resizable-handle").remove();if(a.eventType==="calendar_event"&&((d=this.options)!=null?d.activateEvent:void 0)&&a.id==="calendar_event_"+((e=this.options)!=null?e.activateEvent:void 0))return this.options.activateEvent=null,this.eventClick(a,{currentTarget:b,pageX:b.offset().left+parseInt(b.width()/2)},c)},m.prototype.eventDrop=function(a,b,c,d,e,f,g,h){return a.eventType==="assignment"&&a.isDueAtMidnight()&&c===0&&a.start.setMinutes(59),a.saveDates(null,e)},m.prototype.eventClick=function(a,b,c){return(new h(a)).show(b)},m.prototype.dayClick=function(a,b,c,d){var e;if(this.displayAppointmentEvents)return;return e=g(null,this.contexts),e.allDay=b,e.date=a,(new i(e)).show()},m.prototype.eventResize=function(a,b,c,d,e,f,g){return a.saveDates(null,d)},m.prototype.updateFragment=function(a){var b,d,e;b=this.dataFromDocumentHash();for(d in a)e=a[d],b[d]=e;return location.replace("#"+c.encodeToHex(JSON.stringify(b)))},m.prototype.viewDisplay=function(a){return this.updateFragment({view_start:c.dateToISO8601UTC(a.start)})},m.prototype.drop=function(a,b,d,e){var f,g;f=c(d.target),g=f.data("calendarEvent");if(g)return g.start=a,g.addClass("event_pending"),this.calendar.fullCalendar("renderEvent",g),g.saveDates(null,function(){return console.log("could not save date on undated event")})},m.prototype.fragmentChange=function(a,b){var d,e,f,g;d=this.dataFromDocumentHash(),f=(g=this.calendar)!=null?g.fullCalendar("getView"):void 0;if(!f||!!c.isEmptyObject(d))return;(d.view_name==="month"||d.view_name==="agendaWeek")&&d.view_name!==f.name&&this.calendar.fullCalendar("changeView",d.view_name);if(d.view_start&&d.view_start!==c.dateToISO8601UTC(f.start)){e=c.fullCalendar.parseISO8601(d.view_start);if(e)return this.calendar.fullCalendar("gotoDate",e)}},m.prototype.reloadClick=function(a){a.preventDefault();if(this.activeAjax===0)return this.dataSource.clearCache(),this.currentView==="scheduler"&&this.scheduler.loadData(),this.calendar.fullCalendar("refetchEvents")},m.prototype.eventDeleting=function(a){return a.addClass("event_pending"),this.calendar.fullCalendar("updateEvent",a)},m.prototype.eventDeleted=function(a){return this.calendar.fullCalendar("removeEvents",a.id)},m.prototype.eventSaving=function(a){if(!a.start)return;return a.addClass("event_pending"),a.isNewEvent()?this.calendar.fullCalendar("renderEvent",a):this.calendar.fullCalendar("updateEvent",a)},m.prototype.eventSaved=function(a){return a.removeClass("event_pending"),this.calendar.fullCalendar("refetchEvents")},m.prototype.eventSaveFailed=function(a){return a.removeClass("event_pending"),a.isNewEvent()?this.calendar.fullCalendar("removeEvents",a.id):this.calendar.fullCalendar("updateEvent",a)},m.prototype.visibleContextListChanged=function(a){return this.visibleContextList=a,this.calendar.fullCalendar("refetchEvents")},m.prototype.ajaxStarted=function(){return this.activeAjax+=1,this.$refresh_calendar_link.addClass("loading")},m.prototype.ajaxEnded=function(){this.activeAjax-=1;if(!this.activeAjax)return this.$refresh_calendar_link.removeClass("loading")},m.prototype.refetchEvents=function(){return this.calendar.fullCalendar("refetchEvents")},m.prototype.gotoDate=function(a){return this.calendar.fullCalendar("gotoDate",a)},m.prototype.loadView=function(a){return this.updateFragment({view_name:a}),a!=="scheduler"?(this.currentView=a,this.calendar.removeClass("scheduler-mode"),this.displayAppointmentEvents=null,this.scheduler.hide(),this.calendar.show(),this.calendar.fullCalendar("refetchEvents"),this.calendar.fullCalendar("changeView",a==="week"?"agendaWeek":"month")):(this.currentView="scheduler",this.calendar.addClass("scheduler-mode"),this.calendar.hide(),this.scheduler.show())},f=c("<div />").appendTo("body"),l=[43,5,205,85,289,63,230,186,115,330],k=function(a,b,c){var e;return e=d(a,b,c),"rgb("+e.join(" ,")+")"},m.prototype.colorizeContexts=function(){var a,b,c,d,e,g,h,i,j,m,n,o,p;return n=[30,96],b=n[0],a=n[1],o=[60,40],m=o[0],j=o[1],p=[70,70],i=p[0],h=p[1],d=function(){var d,f,n,o;n=this.contextCodes,o=[];for(g=d=0,f=n.length;d<f;g=++d)c=n[g],e=l[g%l.length],o.push(".group_"+c+"{           color: "+k(e,m,j)+";           border-color: "+k(e,i,h)+";           background-color: "+k(e,b,a)+";        }");return o}.call(this),f.html("<style>"+d.join("")+"</style>")},m.prototype.dataFromDocumentHash=function(){var a;a={};try{a=c.parseJSON(c.decodeFromHex(location.hash.substring(1)))||{}}catch(b){a={}}return a},m}()})}).call(this)