(function(){var a=function(a,b){return function(){return a.apply(b,arguments)}};define(["jquery","underscore","i18n!EditAppointmentGroupDetails","compiled/calendar/TimeBlockList","jst/calendar/editAppointmentGroup","jst/calendar/genericSelect","jst/calendar/sectionCheckboxes","compiled/calendar/ContextSelector","compiled/fn/preventDefault","jquery.ajaxJSON","jquery.disableWhileLoading","jquery.instructure_forms"],function(b,c,d,e,f,g,h,i,j){var k;return k=function(){function h(c,d,g,h){var k,l,m,n,o,p,q,r,s,t=this;this.apptGroup=d,this.contexts=g,this.closeCB=h,this.toggleContextsMenu=a(this.toggleContextsMenu,this),this.contextsChanged=a(this.contextsChanged,this),this.save=a(this.save,this),this.saveClick=a(this.saveClick,this),this.saveWithoutPublishingClick=a(this.saveWithoutPublishingClick,this),this.currentContextInfo=null,b(c).html(f({title:this.apptGroup.title,contexts:this.contexts,appointment_group:this.apptGroup})),this.contextsHash={},s=this.contexts;for(q=0,r=s.length;q<r;q++)l=s[q],this.contextsHash[l.asset_string]=l;this.form=b(c).find("form"),this.contextSelector=new i(".ag-menu-container",this.apptGroup,this.contexts,this.contextsChanged,this.toggleContextsMenu),this.apptGroup.id?(this.form.attr("action",this.apptGroup.url),this.form.find(".context_id").val(this.apptGroup.context_code).attr("disabled",!0),this.form.find("select.context_id").change(),this.disableGroups(),this.apptGroup.participant_type==="Group"?(this.form.find(".group-signup-checkbox").prop("checked",!0),this.form.find(".group_category").val(this.apptGroup.sub_context_codes[0])):this.form.find(".group-signup-checkbox").prop("checked",!1)):this.form.attr("action","/api/v1/appointment_groups"),this.form.find(".ag_contexts_selector").click(j(this.toggleContextsMenu)),p=function(){var a,b,c,d;c=this.apptGroup.appointmentEvents||[],d=[];for(a=0,b=c.length;a<b;a++)k=c[a],d.push([k.start,k.end,!0]);return d}.call(this),this.timeBlockList=new e(this.form.find(".time-block-list-body"),this.form.find(".splitter"),p),this.form.find('[name="slot_duration"]').change(function(a){if(t.form.find('[name="autosplit_option"]').is(":checked"))return t.timeBlockList.split(a.target.value),t.timeBlockList.render()}),this.form.find('[name="participant_visibility"]').prop("checked",this.apptGroup.participant_visibility==="protected"),this.form.find(".group-signup-checkbox").change(function(a){var b;return b=!!a.target.checked,t.form.find(".per_appointment_groups_label").toggle(b),t.form.find(".per_appointment_users_label").toggle(!b),t.form.find(".group-signup").toggle(b)}),this.form.find(".group-signup-checkbox").change(),this.form.find('[name="per_slot_option"]').change(function(a){var b,c;b=a.target,c=t.form.find('[name="participants_per_appointment"]');if(!b.checked)return c.attr("disabled",!0);c.attr("disabled",!1);if(c.val()==="")return c.val("1")}),this.apptGroup.participants_per_appointment>0?(this.form.find('[name="per_slot_option"]').prop("checked",!0),this.form.find('[name="participants_per_appointment"]').val(this.apptGroup.participants_per_appointment)):this.form.find('[name="participants_per_appointment"]').attr("disabled",!0),o=this.form.find('[name="max_appointments_per_participant"]'),m=this.apptGroup.max_appointments_per_participant||1,o.val(m),n=this.form.find("#max-per-student-option"),n.change(function(){return o.prop("disabled",!n.prop("checked"))}),m>0?n.prop("checked",!0):o.attr("disabled",!0),this.apptGroup.workflow_state==="active"&&this.form.find("#appointment-blocks-active-button").attr("disabled",!0).prop("checked",!0)}return h.name="EditAppointmentGroupDetails",h.prototype.saveWithoutPublishingClick=function(a){return a.preventDefault(),this.save(!1)},h.prototype.saveClick=function(a){return a.preventDefault(),this.save(!0)},h.prototype.save=function(a){var c,e,f,g,h,i,j,k,l,m,n,o,p,q=this;f=this.form.getFormData({object_name:"appointment_group"}),e=this.apptGroup.id===void 0,k={"appointment_group[title]":f.title,"appointment_group[description]":f.description,"appointment_group[location_name]":f.location};if(f.max_appointments_per_participant_option){if(f.max_appointments_per_participant<1)return b('[name="max_appointments_per_participant"]').errorBox(d.t("bad_max_appts","You must allow at least one appointment per participant")),!1;k["appointment_group[max_appointments_per_participant]"]=f.max_appointments_per_participant}else k["appointment_group[max_appointments_per_participant]"]="";k["appointment_group[new_appointments]"]=[];if(!this.timeBlockList.validate())return!1;p=this.timeBlockList.blocks();for(n=0,o=p.length;n<o;n++)l=p[n],k["appointment_group[new_appointments]"].push([b.dateToISO8601UTC(b.unfudgeDateForProfileTimezone(l[0])),b.dateToISO8601UTC(b.unfudgeDateForProfileTimezone(l[1]))]);f.per_slot_option==="1"&&f.participants_per_appointment&&(k["appointment_group[participants_per_appointment]"]=f.participants_per_appointment),a&&this.apptGroup.workflow_state!=="active"&&(k["appointment_group[publish]"]="1"),k["appointment_group[participant_visibility]"]=f.participant_visibility==="1"?"protected":"private",delete f["context_codes[]"],delete f["sections[]"],c=this.contextSelector.selectedContexts();if(c.length===0){b(".ag_contexts_selector").errorBox(d.t("context_required","You need to select a calendar"));return}return k["appointment_group[context_codes]"]=c,e&&(f.use_group_signup==="1"&&f.group_category_id?k["appointment_group[sub_context_codes]"]=[f.group_category_id]:(m=this.contextSelector.selectedSections(),m&&(k["appointment_group[sub_context_codes]"]=m)),k["appointment_group[min_appointments_per_participant]"]=1),j=function(){return q.closeCB(!0)},i=function(){},h=this.apptGroup.id?"PUT":"POST",g=b.ajaxJSON(this.form.attr("action"),h,k,j,i),this.form.disableWhileLoading(g)},h.prototype.contextsChanged=function(a,b){var e,f,g,h,i,j;b.length===0&&a.length===0?this.form.find(".ag_contexts_selector").text(d.t("select_calendars","Select Calendars")):(a.length>0&&(f=a[0],i=this.contextsHash[f].name,a.length>1&&(i+=d.t("and_n_contexts"," and %{n} others",{n:a.length-1})),this.form.find(".ag_contexts_selector").text(i)),b.length>0&&(h=b[0],g=c.chain(this.contexts).pluck("course_sections").flatten().find(function(a){return a.asset_string===h}).value(),i=g.name,b.length>1&&(i+=d.t("and_n_sectionCodes"," and %{n} others",{n:b.length-1})),this.form.find(".ag_contexts_selector").text(i))),e=this.contextsHash[a[0]];if(a.length!==1||b.length!==0||((j=e.group_categories)!=null?j.length:void 0)<=0)return this.disableGroups();this.enableGroups(e);if(this.apptGroup.sub_context_codes.length>0)return this.form.find("[name=group_category_id]").prop("disabled",!0)},h.prototype.disableGroups=function(){return this.form.find(".group-signup-checkbox").attr("disabled",!0),this.form.find("group-signup").hide()},h.prototype.enableGroups=function(a){var b;return this.form.find(".group-signup-checkbox").attr("disabled",!1),b={cssClass:"group_category",name:"group_category_id",collection:a.group_categories},this.form.find(".group_select").html(g(b)),this.form.find("group-signup").show()},h.prototype.toggleContextsMenu=function(a){return b(".ag_contexts_menu").toggleClass("hidden")},h}()})}).call(this)