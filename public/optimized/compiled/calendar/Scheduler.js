(function(){var a=function(a,b){return function(){return a.apply(b,arguments)}},b=[].indexOf||function(a){for(var b=0,c=this.length;b<c;b++)if(b in this&&this[b]===a)return b;return-1};define(["jquery","underscore","i18n!calendar","jst/calendar/appointmentGroupList","jst/calendar/schedulerRightSideAdminSection","compiled/calendar/EditAppointmentGroupDialog","compiled/calendar/MessageParticipantsDialog","jst/calendar/deleteItem","jquery.instructure_date_and_time","jqueryui/dialog","jquery.instructure_misc_plugins","vendor/jquery.ba-tinypubsub","vendor/jquery.spin"],function(c,d,e,f,g,h,i,j){var k;return k=function(){function k(b,e){this.calendar=e,this.messageLinkClick=a(this.messageLinkClick,this),this.deleteLinkClick=a(this.deleteLinkClick,this),this.editLinkClick=a(this.editLinkClick,this),this.showList=a(this.showList,this),this.doneClick=a(this.doneClick,this),this.viewCalendarForGroup=a(this.viewCalendarForGroup,this),this.viewCalendarForGroupId=a(this.viewCalendarForGroupId,this),this.viewCalendarForElement=a(this.viewCalendarForElement,this),this.showEventLinkClick=a(this.showEventLinkClick,this),this.viewCalendarLinkClick=a(this.viewCalendarLinkClick,this),this.redraw=a(this.redraw,this),this.loadData=a(this.loadData,this),this.canManageAGroup=a(this.canManageAGroup,this),this.hide=a(this.hide,this),this.show=a(this.show,this),this.eventDeleted=a(this.eventDeleted,this),this.eventSaved=a(this.eventSaved,this),this.dialogCloseCB=a(this.dialogCloseCB,this),this.createClick=a(this.createClick,this),this.div=c(b),this.contexts=this.calendar.contexts,this.listDiv=this.div.find(".appointment-list"),this.div.delegate(".single_item_done_button","click",this.doneClick),this.div.delegate(".view_calendar_link","click",this.viewCalendarLinkClick),this.listDiv.delegate(".edit_link","click",this.editLinkClick),this.listDiv.delegate(".message_link","click",this.messageLinkClick),this.listDiv.delegate(".delete_link","click",this.deleteLinkClick),this.listDiv.delegate(".show_event_link","click",this.showEventLinkClick),this.canManageAGroup()&&(this.div.addClass("can-manage"),this.rightSideAdminSection=c(g()),this.rightSideAdminSection.find(".create_link").click(this.createClick),this.appointmentGroupContexts=d.filter(this.contexts,function(a){return a.can_create_appointment_groups})),c.subscribe("CommonEvent/eventSaved",this.eventSaved),c.subscribe("CommonEvent/eventDeleted",this.eventDeleted)}return k.name="Scheduler",k.prototype.createClick=function(a){var b;return a.preventDefault(),b={context_codes:[],sub_context_codes:[]},this.createDialog=new h(b,this.appointmentGroupContexts,this.dialogCloseCB),this.createDialog.show()},k.prototype.dialogCloseCB=function(a){if(a)return this.calendar.dataSource.clearCache(),this.loadData()},k.prototype.eventSaved=function(a){if(this.active)return this.calendar.dataSource.clearCache(),this.loadData()},k.prototype.eventDeleted=function(a){if(this.active)return this.calendar.dataSource.clearCache(),this.loadData()},k.prototype.toggleListMode=function(a){var b;return a?(delete this.viewingGroup,this.calendar.updateFragment({appointment_group_id:null}),this.showList(),this.canManageAGroup()?(c("#right-side .rs-section").hide(),this.rightSideAdminSection.appendTo("#right-side")):c("#right-side-wrapper").hide()):(c("#right-side-wrapper").show(),c("#right-side .rs-section").not("#undated-events, #calendar-feed").show(),(b=this.rightSideAdminSection)!=null?b.detach():void 0)},k.prototype.show=function(){return c("#undated-events, #calendar-feed").hide(),this.active=!0,this.div.show(),this.loadData(),this.toggleListMode(!0),c.publish("Calendar/saveVisibleContextListAndClear")},k.prototype.hide=function(){return c("#undated-events, #calendar-feed").show(),this.active=!1,this.div.hide(),this.toggleListMode(!1),this.calendar.displayAppointmentEvents=null,c.publish("Calendar/restoreVisibleContextList")},k.prototype.canManageAGroup=function(){var a,b,c,d;d=this.contexts;for(b=0,c=d.length;b<c;b++){a=d[b];if(a.can_create_appointment_groups)return!0}return!1},k.prototype.loadData=function(){var a=this;if(!this.loadingDeferred||this.loadingDeferred&&!this.loadingDeferred.isResolved())this.loadingDeferred=new c.Deferred;return this.groups={},this.loadingDiv==null&&(this.loadingDiv=c('<div id="scheduler-loading" />').appendTo(this.div).spin()),this.calendar.dataSource.getAppointmentGroups(this.canManageAGroup(),function(b){var c,d,e;for(d=0,e=b.length;d<e;d++)c=b[d],a.groups[c.id]=c;return a.redraw(),a.loadingDeferred.resolve()})},k.prototype.redraw=function(){var a,e,g,h,i,j,k,l,m,n,o,p,q,r,s,t;this.loadingDiv.hide();if(this.groups){h=[],q=this.groups;for(j in q){g=q[j],g.signed_up_times=null;if(g.appointmentEvents){r=g.appointmentEvents;for(k=0,n=r.length;k<n;k++){a=r[k];if(a.object.reserved){s=a.childEvents;for(l=0,o=s.length;l<o;l++){e=s[l];if(!e.object.own_reservation)continue;g.signed_up_times==null&&(g.signed_up_times=[]),g.signed_up_times.push({id:e.id,formatted_time:e.displayTimeString()})}}}}g.signed_up=0;if(g.appointmentEvents){t=g.appointmentEvents;for(m=0,p=t.length;m<p;m++)a=t[m],a.childEvents&&(g.signed_up+=a.childEvents.length)}g.contexts=d.filter(this.contexts,function(a){var c;return c=a.asset_string,b.call(g.context_codes,c)>=0}),g.published=g.workflow_state==="active",h.push(g)}i=f({appointment_groups:h,canManageAGroup:this.canManageAGroup()}),this.listDiv.find(".list-wrapper").html(i),this.viewingGroup&&(this.viewingGroup=this.groups[this.viewingGroup.id],this.viewingGroup?(this.listDiv.find(".appointment-group-item[data-appointment-group-id='"+this.viewingGroup.id+"']").addClass("active"),this.calendar.displayAppointmentEvents=this.viewingGroup):this.toggleListMode(!0))}return c.publish("Calendar/refetchEvents")},k.prototype.viewCalendarLinkClick=function(a){return a.preventDefault(),this.viewCalendarForElement(c(a.target))},k.prototype.showEventLinkClick=function(a){var b,d,e,f,g,h,i,j,k,l;a.preventDefault(),f=this.viewCalendarForElement(c(a.target)),e=c(a.target).data("event-id");if(e){k=f.object.appointmentEvents;for(g=0,i=k.length;g<i;g++){b=k[g],l=b.object.childEvents;for(h=0,j=l.length;h<j;h++){d=l[h];if(d.id!==e)continue;this.calendar.gotoDate(d.start);return}}}},k.prototype.viewCalendarForElement=function(a){var b,c,d,e,f;return d=a.closest(".appointment-group-item"),c=d.data("appointment-group-id"),d.addClass("active"),b=(e=this.groups)!=null?e[c]:void 0,this.viewCalendarForGroup((f=this.groups)!=null?f[c]:void 0),b},k.prototype.viewCalendarForGroupId=function(a){var b=this;return this.loadData(),this.loadingDeferred.done(function(){var c;return b.viewCalendarForGroup((c=b.groups)!=null?c[a]:void 0)})},k.prototype.viewCalendarForGroup=function(a){var b=this;return this.calendar.updateFragment({appointment_group_id:a.id}),this.toggleListMode(!1),this.viewingGroup=a,this.loadingDeferred.done(function(){return b.div.addClass("showing-single"),b.calendar.calendar.show(),b.calendar.calendar.fullCalendar("changeView","agendaWeek"),b.viewingGroup.start_at?b.calendar.gotoDate(c.parseFromISO(b.viewingGroup.start_at).time):b.calendar.gotoDate(new Date),b.calendar.displayAppointmentEvents=b.viewingGroup,c.publish("Calendar/refetchEvents"),b.redraw()})},k.prototype.doneClick=function(a){return a.preventDefault(),this.toggleListMode(!0)},k.prototype.showList=function(){return this.div.removeClass("showing-single"),this.listDiv.find(".appointment-group-item").removeClass("active"),this.calendar.calendar.hide(),this.calendar.displayAppointmentEvents=null},k.prototype.editLinkClick=function(a){var b,d;a.preventDefault(),b=(d=this.groups)!=null?d[c(a.target).closest(".appointment-group-item").data("appointment-group-id")]:void 0;if(!b)return;return this.createDialog=new h(b,this.appointmentGroupContexts,this.dialogCloseCB),this.createDialog.show()},k.prototype.deleteLinkClick=function(a){var b,d,f=this;a.preventDefault(),b=(d=this.groups)!=null?d[c(a.target).closest(".appointment-group-item").data("appointment-group-id")]:void 0;if(!b)return;return c("<div />").confirmDelete({url:b.url,message:c(j({message:e.t("confirm_appointment_group_deletion","Are you sure you want to delete this appointment group?"),details:e.t("appointment_group_deletion_details","Deleting it will also delete any appointments that have been signed up for by students.")})),dialog:{title:e.t("confirm_deletion","Confirm Deletion")},prepareData:function(a){return{cancel_reason:a.find("#cancel_reason").val()}},confirmed:function(){return c(a.target).closest(".appointment-group-item").addClass("event_pending")},success:function(){return f.calendar.dataSource.clearCache(),f.loadData()}})},k.prototype.messageLinkClick=function(a){var b,d;return a.preventDefault(),b=(d=this.groups)!=null?d[c(a.target).closest(".appointment-group-item").data("appointment-group-id")]:void 0,this.messageDialog=new i({group:b,dataSource:this.calendar.dataSource}),this.messageDialog.show()},k}()})}).call(this)