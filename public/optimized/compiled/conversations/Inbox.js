(function(){var a=function(a,b){return function(){return a.apply(b,arguments)}},b=[].indexOf||function(a){for(var b=0,c=this.length;b<c;b++)if(b in this&&this[b]===a)return b;return-1};define(["i18n!conversations","underscore","str/htmlEscape","compiled/conversations/introSlideshow","compiled/conversations/ConversationsPane","compiled/conversations/audienceList","compiled/conversations/contextList","compiled/widget/TokenInput","compiled/str/TextHelper","jquery.ajaxJSON","jquery.instructure_date_and_time","jquery.instructure_forms","jqueryui/dialog","jquery.instructure_misc_helpers","jquery.disableWhileLoading","jquery.rails_flash_notifications","media_comments","vendor/jquery.ba-hashchange","vendor/jquery.elastic","jqueryui/position"],function(c,d,e,f,g,h,i,j,k){return function(){function j(b){this.options=b,this.initializeMenus=a(this.initializeMenus,this),this.render=a(this.render,this),this.currentUser=this.options.USER,this.contexts=this.options.CONTEXTS,this.userCache={},this.userCache[this.currentUser.id]=this.currentUser,$(this.render)}return j.prototype.render=function(){this.$inbox=$("#inbox"),this.minHeight=parseInt(this.$inbox.css("min-height").replace("px","")),this.$conversations=$("#conversations"),this.$messages=$("#messages"),this.$messageList=this.$messages.find("ul.messages"),this.initializeHelp(),this.initializeForms(),this.initializeMenus(),this.initializeMessageActions(),this.initializeConversationActions(),this.initializeTemplates(),this.initializeTokenInputs(),this.initializeConversationsPane(),this.initializeAutoResize(),this.initializeHashChange();if(this.options.SHOW_INTRO)return f()},j.prototype.showMessageForm=function(){var a,b,c,d;return a=this.conversations.active(),b=a==null,this.$form.find("#recipient_info").showIf(b),this.$form.find("#group_conversation_info").hide(),$("#action_compose_message").toggleClass("active",b),b?(this.$form.addClass("new"),this.$form.find("#action_add_recipients").hide(),this.$form.attr({action:"/conversations?"+$.param((c=(d=this.conversations)!=null?d.baseData():void 0)!=null?c:{})})):(this.$form.removeClass("new"),this.$form.find("#action_add_recipients").showIf(!a.get("private")),this.$form.attr({action:a.url("add_message")})),this.resetMessageForm(),this.$form.find("#user_note_info").hide().find("input").attr("checked",!1),this.$form.show().find(":input:visible:first").focus()},j.prototype.resetMessageForm=function(a){var b;return a==null&&(a=!0),this.$form.find(".audience").html((b=this.conversations.active())?this.htmlAudience(b.attributes,{linkToContexts:!0,highlightFilters:!0}):e(c.t("headings.new_message","New Message"))),a&&(this.$form.find("input[name!=authenticity_token], textarea").not(":checkbox").val("").change(),this.$form.find(".attachment:visible").remove(),this.$form.find(".media_comment").hide(),this.$form.find("#action_media_comment").show()),this.resize()},j.prototype.filters=function(){var a;return(a=this.conversations.baseData().filter)!=null?a:[]},j.prototype.htmlAudience=function(a,b){var c,e,f,g;return b==null&&(b={}),e=b.filters=b.highlightFilters?this.filters():[],c=function(){var b,c,g,h;g=a.audience,h=[];for(b=0,c=g.length;b<c;b++)f=g[b],h.push({id:f,name:this.userCache[f].name,activeFilter:d.include(e,"user_"+f)});return h}.call(this),g=h(c,b),c.length&&(g+=" <em>"+this.htmlContextList(a.audience_contexts,b)+"</em>"),g},j.prototype.htmlContextList=function(a,b){var c,e,f,g,h,j,k;return b==null&&(b={}),f=(k=b.filters)!=null?k:[],a=function(){var b,c;b=a.courses,c=[];for(h in b)j=b[h],(e=this.contexts.courses[h])&&c.push(e);return c}.call(this).concat(function(){var b,c;b=a.groups,c=[];for(h in b)j=b[h],(g=this.contexts.groups[h])&&c.push(g);return c}.call(this)),a=function(){var b,e,g;g=[];for(b=0,e=a.length;b<e;b++)c=a[b],c=d.clone(c),c.activeFilter=d.include(f,""+c.type+"_"+c.id),g.push(c);return g}(),i(a,b)},j.prototype.htmlNameForUser=function(a,b){var c,d;return b==null&&(b={courses:a.common_courses,groups:a.common_groups}),e(a.name)+(((c=b.courses)!=null?c.length:void 0)||((d=b.groups)!=null?d.length:void 0)?" <em>"+this.htmlContextList(b)+"</em>":"")},j.prototype.canAddNotesFor=function(a){var c,d,e,f;if(!this.options.NOTES_ENABLED)return!1;if(a.can_add_notes)return!0;e=a.common_courses;for(c in e){d=e[c];if(b.call(d,"StudentEnrollment")>=0&&(this.options.CAN_ADD_NOTES_FOR_ACCOUNT||((f=this.contexts.courses[c])!=null?f.can_add_notes:void 0)))return!0}return!1},j.prototype.loadConversation=function(a,b,c){var d,e,f=this;return this.toggleMessageActions(!1),this.$messageList.removeClass("private").hide().html(""),(typeof $conversation!="undefined"&&$conversation!==null?$conversation.hasClass("private"):void 0)&&this.$messageList.addClass("private"),this.showMessageForm(),d=this.currentHashData(),d.message&&this.$form.find("#body").val(d.message),a==null?(d.user_id&&($("#from_conversation_id").val(d.from_conversation_id),$("#recipients").data("token_input").selector.addByUserId(d.user_id,d.from_conversation_id)),c()):(e=a.url(),this.$messageList.show().disableWhileLoading($.ajaxJSON(e,"GET",{},function(a){var b,d,e,g,h,i,j,k,l;f.conversations.updateItems([a]);if(!f.conversations.isActive(a.id))return;j=a.participants;for(e=0,h=j.length;e<h;e++){d=j[e];if((k=f.userCache[d.id])!=null?!k.avatar_url:!void 0)f.userCache[d.id]=d,d.htmlName=f.htmlNameForUser(d);else continue}a["private"]&&(d=function(){var b,c,e,f;e=a.participants,f=[];for(b=0,c=e.length;b<c;b++)d=e[b],d.id!==this.currentUser.id&&f.push(d);return f}.call(f)[0]&&f.canAddNotesFor(d))&&f.$form.find("#user_note_info").show(),f.resize(),f.$messages.show(),l=a.messages;for(g=0,i=l.length;g<i;g++)b=l[g],f.$messageList.append(f.buildMessage(b));return f.$messageList.show(),c()})))},j.prototype.deselectMessages=function(){return this.$messageList.find("li.selected").removeClass("selected")},j.prototype.addMessage=function(a){return this.toggleMessageActions(!1),this.buildMessage(a).prependTo(this.$messageList).slideDown("fast")},j.prototype.buildMessage=function(a){var b,d,f,g,h,i,j,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z=this;if(a.submission)return this.buildSubmission(a);f=$("#message_blank").clone(!0).attr("id","message_"+a.id),f.data("id",a.id),f.addClass(a.generated?"generated":a.author_id===this.currentUser.id?"self":"other"),f.addClass("forwardable"),n=this.userCache[a.author_id],(j=n!=null?n.avatar_url:void 0)&&f.prepend($("<img />").attr("src",j).addClass("avatar")),n&&n.htmlName==null&&(n.htmlName=this.htmlNameForUser(n)),o=(u=n!=null?n.name:void 0)!=null?u:c.t("unknown_user","Unknown user"),f.find(".audience").html((n!=null?n.htmlName:void 0)||e(o)),f.find("span.date").text($.parseFromISO(a.created_at).datetime_formatted),f.find("p").html(k.formatMessage(a.body)),f.find("a.show_quoted_text_link").click(function(a){var b,c;b=$(a.currentTarget),c=b.parents(".quoted_text_holder").children(".quoted_text");if(c.length)return event.stopPropagation(),event.preventDefault(),c.show(),b.hide()}),g=f.find("a.send_private_message"),l=$.replaceTags(g.attr("href"),{user_id:a.author_id,user_name:encodeURIComponent(o),from_conversation_id:typeof (p=this.conversations).active=="function"?p.active().id:void 0}),g.attr("href",l).click(function(a){return a.stopPropagation()});if((v=a.forwarded_messages)!=null?v.length:void 0){h=$('<ul class="messages"></ul>'),w=a.forwarded_messages;for(q=0,s=w.length;q<s;q++)m=w[q],h.append(this.buildMessage(m));f.append(h)}h=f.find("ul.message_attachments").detach(),d=h.find(".media_object_blank").detach(),b=h.find(".attachment_blank").detach();if(a.media_comment!=null||((x=a.attachments)!=null?x.length:void 0)){f.append(h),a.media_comment!=null&&h.append(this.buildMediaObject(d,a.media_comment));if(a.attachments!=null){y=a.attachments;for(r=0,t=y.length;r<t;r++)i=y[r],h.append(this.buildAttachment(b,i))}}return f},j.prototype.buildMediaObject=function(a,b){var c;return c=a.clone(!0).attr("id","media_comment_"+b.media_id),c.find("span.title").html(e(b.display_name)),c.find("span.media_comment_id").html(e(b.media_id)),c.find(".instructure_inline_media_comment").data("media_comment_type",b.media_type),c},j.prototype.buildAttachment=function(a,b){var c,d,f=this;return c=a.clone(!0).attr("id","attachment_"+b.id),c.data("id",b.id),c.find("span.title").html(e(b.display_name)),d=c.find("a"),d.attr("href",b.url),d.click(function(a){return a.stopPropagation()}),c},j.prototype.buildSubmission=function(a){var b,d,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w=this;i=$("#submission_blank").clone(!0).attr("id",a.id),i.data("id",a.id),a=a.submission,j=i.find("ul"),f=j.find("li.header"),l=$.replaceTags(f.find("a").attr("href"),{course_id:a.assignment.course_id,assignment_id:a.assignment_id,id:a.user_id}),f.find("a").attr("href",l),q=this.userCache[a.user_id],q&&q.htmlName==null&&(q.htmlName=this.htmlNameForUser(q)),r=(t=q!=null?q.name:void 0)!=null?t:c.t("unknown_user","Unknown user"),f.find(".title").html(e(a.assignment.name)),f.find("span.date").text(a.submitted_at?$.parseFromISO(a.submitted_at).datetime_formatted:c.t("not_applicable","N/A")),f.find(".audience").html((q!=null?q.htmlName:void 0)||e(r)),a.score&&a.assignment.points_possible?p=""+a.score+" / "+a.assignment.points_possible:p=(u=a.score)!=null?u:c.t("not_scored","no score"),f.find(".score").html(p),d=j.find(".comment").detach(),n=0,o=4;for(m=s=v=a.submission_comments.length-1;s>=0;m=s+=-1){k=a.submission_comments[m];if(n<10)n++,b=this.buildSubmissionComment(d,k),n>o&&b.hide(),j.append(b);else break}return h=j.find(".more").detach(),n>o&&(g=h.clone(!0),g.find(".hidden").text(n-o),g.attr("title",e(c.t("titles.expand_inline","Show more comments"))),g.click(function(a){var b;return b=$(a.currentTarget),i=b.closest(".submission"),i.find(".more:hidden").show(),b.hide(),i.find(".comment:hidden").slideDown("fast"),w.resize(),!1}),j.append(g)),a.submission_comments.length>n&&(h.find("a").attr("href",l).attr("target","_blank"),h.find(".hidden").text(a.submission_comments.length-n),h.attr("title",e(c.t("titles.view_submission","Open submission in new window."))),a.submission_comments.length>o&&h.hide(),j.append(h)),i},j.prototype.buildSubmissionComment=function(a,b){var d,f,g,h,i;return d=a.clone(!0),g=this.userCache[b.author_id],(f=g!=null?g.avatar_url:void 0)&&d.prepend($("<img />").attr("src",f).addClass("avatar")),g&&g.htmlName==null&&(g.htmlName=this.htmlNameForUser(g)),h=(i=g!=null?g.name:void 0)!=null?i:c.t("unknown_user","Unknown user"),d.find(".audience").html((g!=null?g.htmlName:void 0)||e(h)),d.find("span.date").text($.parseFromISO(b.created_at).datetime_formatted),d.find("p").html(e(b.comment).replace(/\n/g,"<br />")),d},j.prototype.closeMenus=function(){return $("#actions .menus > li, #conversation_actions, #conversations .actions").removeClass("selected"),$("#conversations li.menu_active").removeClass("menu_active")},j.prototype.openMenu=function(a){var b,c;this.closeMenus();if(!a.hasClass("disabled"))return b=a.parent("li, span").addClass("selected").find("div"),c=-(b.parent().position().left+b.parent().outerWidth()/2)+6,c<-(b.outerWidth()/2)&&(c=-(b.outerWidth()/2)),b.css("margin-left",c+"px")},j.prototype.resize=function(a){var b=this;return a==null&&(a=0),this.resizeCb&&clearTimeout(this.resizeCb),this.resizeCb=setTimeout(function(){var a;return delete b.resizeCb,a=$(window).height()-$("#header").outerHeight(!0)-($("#wrapper-container").outerHeight(!0)-$("#wrapper-container").height())-($("#main").outerHeight(!0)-$("#main").height())-$("#breadcrumbs").outerHeight(!0)-$("#footer").outerHeight(!0),a<b.minHeight&&(a=b.minHeight),$(document.body).toggleClass("too_small",a<=b.minHeight),b.$inbox.height(a),b.$messageList.height(a-b.$form.outerHeight(!0)),b.conversations.resize(a)},a)},j.prototype.toggleMessageActions=function(a){return a!=null?(this.$messageList.find("> li").removeClass("selected"),this.$messageList.find("> li :checkbox").attr("checked",!1)):a=!!this.$messageList.find("li.selected").length,$("#action_forward").parent().showIf(a&&this.$messageList.find("li.selected.forwardable").length),a?$("#message_actions").slideDown(100):$("#message_actions").slideUp(100),this.$form[a?"addClass":"removeClass"]("disabled")},j.prototype.updateHashData=function(a){var b,c;b=$.extend(this.currentHashData(),a),c=$.encodeToHex(JSON.stringify(b));if(c!==location.hash.substring(1))return location.hash=c,$(document).triggerHandler("document_fragment_change",c)},j.prototype.initializeHelp=function(){var a=this;return $("#help_crumb").click(function(a){return a.preventDefault(),f()})},j.prototype.initializeForms=function(){var a=this;return $("#create_message_form, #forward_message_form").find("textarea").elastic().keypress(function(a){if(a.which===13&&a.shiftKey)return a.preventDefault(),$(a.target).closest("form").submit(),!1}),this.$form=$("#create_message_form"),this.$addForm=$("#add_recipients_form"),this.$forwardForm=$("#forward_message_form"),this.$form.submit(function(b){var c;return c=!!a.$form.find("#body").val()&&(a.$form.find("#recipient_info").filter(":visible").length===0||a.$form.find(".token_input li").length>0),c||b.stopImmediatePropagation(),c}),this.$form.formSubmit({fileUpload:function(){return a.$form.find(".file_input:visible").length>0},preparedFileUpload:!0,context_code:"user_"+$("#identity .user_id").text(),folder_id:this.options.FOLDER_ID,intent:"message",formDataTarget:"url",handle_files:function(a,b){var c;return b.attachment_ids=function(){var b,d,e;e=[];for(b=0,d=a.length;b<d;b++)c=a[b],e.push(c.attachment.id);return e}(),b},disableWhileLoading:!0,success:function(b){var d;return b.length==null&&(b=[b]),a.conversations.updateItems(b),b.length===1?(d=b[0],a.conversations.isActive(d.id)&&a.buildMessage(d.messages[0]).prependTo(a.$messageList).slideDown("fast"),d.visible&&a.updateHashData({id:d.id}),$.flashMessage(c.t("message_sent","Message Sent"))):$.flashMessage(c.t("messages_sent","Messages Sent")),a.resetMessageForm()},error:function(b){var d,e;if(typeof b.isRejected=="function"?b.isRejected():void 0)return;return d=b[0],(d!=null?d.attribute:void 0)==="body"?a.$form.find("#body").errorBox(c.t("message_blank_error","No message was specified")):(e=(d!=null?d.attribute:void 0)==="recipients"?d.message==="blank"?c.t("recipient_blank_error","No recipients were specified"):c.t("recipient_error","The course or group you have selected has no valid recipients"):c.t("unspecified_error","An unexpected error occurred, please try again"),a.$form.find(".token_input").errorBox(e)),$(".error_box").filter(":visible").css("z-index",10)}}),this.$form.click(function(){return a.toggleMessageActions(!1)}),this.$addForm.submit(function(b){var c;return c=!!a.$addForm.find(".token_input li").length,c||b.stopImmediatePropagation(),c}),this.$addForm.formSubmit({disableWhileLoading:!0,success:function(b){return a.buildMessage(b.messages[0]).prependTo(a.$messageList).slideDown("fast"),a.conversations.updateItems([b]),a.resetMessageForm(),a.$addForm.dialog("close")},error:function(b){return a.$addForm.dialog("close")}}),this.$forwardForm.submit(function(b){var c;return c=!!a.$forwardForm.find("#forward_body").val()&&!!a.$forwardForm.find(".token_input li").length,c||b.stopImmediatePropagation(),c}),this.$forwardForm.formSubmit({disableWhileLoading:!0,success:function(b){var c;return c=b[0],a.conversations.updateItems([c]),a.updateHashData({id:c.id}),a.resetMessageForm(),a.$forwardForm.dialog("close")},error:function(b){return a.$forwardForm.dialog("close")}}),this.$messageList.click(function(b){var c;if(!$(b.target).closest("a.instructure_inline_media_comment").length)return c=$(b.target).closest("#messages > ul > li"),c.hasClass("generated")||(c.toggleClass("selected"),c.find("> :checkbox").attr("checked",c.hasClass("selected"))),a.toggleMessageActions()})},j.prototype.initializeMenus=function(){var a=this;return $(".menus > li > a").click(function(b){return b.preventDefault(b),a.openMenu($(b.currentTarget))}).focus(function(b){return a.openMenu($(b.currentTarget))}),$(document).bind("mousedown",function(b){$(b.target).closest("span.others").find("> span").length||$("span.others > span").hide();if(!$(b.target).closest(".menus > li, #conversation_actions, #conversations .actions").length)return a.closeMenus()}),this.$menuViews=$("#menu_views"),this.$menuViewsList=this.$menuViews.parent(),this.$menuViewsList.find("li a").click(function(b){var c;a.closeMenus();if(c=$(b.target).closest("li").data("scope"))return b.preventDefault(),a.updateHashData({scope:c})}),$("#conversations ul, #create_message_form").delegate(".audience","click",function(a){var b;if((b=$(a.target).closest("span.others").find("> span")).length)return $(a.target).closest("span.others > span").length||($("span.others > span").not(b).hide(),b.toggle(),b.css("left",b.parent().position().left),b.css("top",b.parent().height()+b.parent().position().top)),!1})},j.prototype.setScope=function(a){var b,c;return c=this.$menuViewsList.find("li"),c.removeClass("checked"),b=c.filter("[data-scope="+a+"]"),b.length||(b=c.filter("[data-scope=inbox]")),b.addClass("checked"),this.$menuViews.text(b.text())},j.prototype.initializeMessageActions=function(){var a=this;return $("#message_actions").find("a").click(function(a){return a.preventDefault()}),$("#cancel_bulk_message_action").click(function(){return a.toggleMessageActions(!1)}),$("#action_delete").click(function(b){var d,e,f;e=a.conversations.active();if(e==null)return;d=a.$messageList.find(".selected"),f=d.length>1?c.t("confirm.delete_messages","Are you sure you want to delete your copy of these messages? This action cannot be undone."):c.t("confirm.delete_message","Are you sure you want to delete your copy of this message? This action cannot be undone.");if(confirm(f))return d.fadeOut("fast"),a.conversations.action($(b.currentTarget),{conversationId:e.id,data:{remove:function(){var a,b,c;c=[];for(a=0,b=d.length;a<b;a++)f=d[a],c.push($(f).data("id"));return c}()},success:function(){return a.toggleMessageActions(!1)},error:function(){return d.show()}})}),$("#action_forward").click(function(b){var d;if(a.conversations.active()==null)return;return a.$forwardForm.find("input[name!=authenticity_token], textarea").val("").change(),d=a.$forwardForm.find("ul.messages").first(),d.html(""),d.html(a.$messageList.find("> li.selected.forwardable").clone(!0).removeAttr("id").removeClass("self")),d.find("> li").removeClass("selected odd").find("> :checkbox").attr("checked",!0).attr("name","forwarded_message_ids[]").val(function(){return $(this).closest("li").data("id")}),d.find("> li").last().addClass("last"),a.$forwardForm.css("max-height",$(window).height()-300+"px").dialog("close").dialog({position:"center",height:"auto",width:510,title:c.t("title.forward_messages","Forward Messages"),buttons:[{text:c.t("buttons.send_message","Send"),click:function(){return $(this).submit()}},{text:c.t("#buttons.cancel","Cancel"),click:function(){return $(this).dialog("close")}}],open:function(){return a.$forwardForm.attr({action:"/conversations?"+$.param(a.conversations.baseData())})},close:function(){return $("#forward_recipients").data("token_input").$input.blur()}})})},j.prototype.initializeConversationActions=function(){var a=this;return $("#action_compose_message").click(function(b){return b.preventDefault(),a.updateHashData({id:null})}),$("#action_add_recipients").click(function(b){b.preventDefault();if(a.conversations.active()==null)return;return a.$addForm.attr("action",a.conversations.actionUrlFor($(b.currentTarget))).dialog("close").dialog({width:420,title:c.t("title.add_recipients","Add Recipients"),buttons:[{text:c.t("buttons.add_people","Add People"),click:function(){return a.$addForm.submit()}},{text:c.t("#buttons.cancel","Cancel"),click:function(){return a.$addForm.dialog("close")}}],open:function(){var b;return b=$("#add_recipients").data("token_input"),b.baseExclude=a.conversations.active().get("audience"),a.$addForm.find("input[name!=authenticity_token]").val("").change()},close:function(){return $("#add_recipients").data("token_input").$input.blur()}})})},j.prototype.initializeTemplates=function(){var a,b=this;return a=0,$("#action_add_attachment").click(function(c){var d;return c.preventDefault(),d=$("#attachment_blank").clone(!0),d.attr("id",null),d.find("input[type='file']").attr("name","attachments["+a++ +"]"),$("#attachment_list").append(d),d.slideDown("fast",function(){return b.resize()}),!1}),$("#attachment_blank a.remove_link").click(function(a){var c;return a.preventDefault(),c=$(a.currentTarget).closest(".attachment"),c.slideUp("fast",function(){return b.resize(),c.remove()}),!1}),$("#action_media_comment").click(function(a){return a.preventDefault(),$("#create_message_form .media_comment").mediaComment("create","any",function(a,b){return $("#media_comment_id").val(a),$("#media_comment_type").val(b),$("#create_message_form .media_comment").show(),$("#action_media_comment").hide()})}),$("#create_message_form .media_comment a.remove_link").click(function(a){return a.preventDefault(),$("#media_comment_id").val(""),$("#media_comment_type").val(""),$("#create_message_form .media_comment").hide(),$("#action_media_comment").show()})},j.prototype.buildContextInfo=function(a){var b,c,d;c=a.id.match(/^(course|section)_(\d+)$/),c&&(d=this.contexts[""+c[1]+"s"][c[2]]),b=a.context_name||"",b=b.length<40?b:b.substr(0,40)+"...";if(d!=null?d.term:void 0)b=b?""+b+" - "+d.term:d.term;return b?$("<span />",{"class":"context_info"}).text("("+b+")"):""},j.prototype.initializeTokenInputs=function(){var a,b,d,e,f,g,h,i=this;return a=function(a){return a==null&&(a={}),function(b,d,e,f){var g,h,j,k,l,m;f==null&&(f={}),e.id=""+e.id,e.avatar_url&&(j=$('<img class="avatar" />'),j.attr("src",e.avatar_url),d.append(j)),g=$("<b />"),g.text(e.name),k=$("<span />",{"class":"name"}),f.parent||(h=i.buildContextInfo(e)),k.append(g,h),l=$("<span />",{"class":"details"}),e.common_courses!=null?l.html(i.htmlContextList({courses:e.common_courses,groups:e.common_groups},{hardCutoff:2})):e.type&&e.user_count!=null?l.text(c.t("people_count","person",{count:e.user_count})):e.item_count!=null?e.id.match(/_groups$/)?l.text(c.t("groups_count","group",{count:e.item_count})):e.id.match(/_sections$/)&&l.text(c.t("sections_count","section",{count:e.item_count})):e.subText&&l.text(e.subText),d.append(k,l),d.attr("title",e.name),m=e.name,f.parent&&(e.selectAll&&e.noExpand?m=f.parent.data("text"):e.id.match(/_\d+_/)&&(m=c.beforeLabel(f.parent.data("text"))+" "+m)),d.data("text",m),d.data("id",e.type==="context"||!a.prefixUserIds?e.id:"user_"+e.id),e.rootId=f.ancestors[0],d.data("user_data",e),d.addClass(e.type?e.type:"user"),f.level>0&&b.options.showToggles&&(d.prepend('<a class="toggle"><i></i></a>'),e.item_count||d.addClass("toggleable"));if(e.type==="context"&&!e.noExpand)return d.prepend('<a class="expand"><i></i></a>'),d.addClass("expandable")}},f=c.t("recipient_field_placeholder","Enter a name, course, or group"),e=c.t("no_results","No results found"),b=c.t("enrollments_everyone","Everyone"),g=c.t("select_all","Select All"),$(".recipients").tokenInput({placeholder:f,added:function(a,b,d){var e,f,g;a.id=""+a.id,d&&a.rootId&&b.append("<input type='hidden' name='tags[]' value='"+a.rootId+"'>"),d&&a.type&&(b.addClass(a.type),a.user_count!=null&&(b.addClass("details"),e=$("<span />"),e.text(c.t("people_count","person",{count:a.user_count})),b.append(e)));if(!a.id.match(/^(course|group)_/))return a=$.extend({},a),delete a.avatar_url,f=(g=i.userCache[a.id])!=null?g:{},i.userCache[a.id]=$.extend(f,a)},selector:{messages:{noResults:e},populator:a(),limiter:function(a){return a.level>0?-1:5},showToggles:!0,preparer:function(a,c,d){var e;e=a.context;if(!a.search&&e&&c.length>1){if(e.match(/^(course|section)_\d+$/))return c.unshift({id:""+e+"_all",name:b,user_count:d.data("user_data").user_count,type:"context",avatar_url:d.data("user_data").avatar_url,selectAll:!0});if(e.match(/^((course|section)_\d+_.*|group_\d+)$/)&&!e.match(/^course_\d+_(groups|sections)$/))return c.unshift({id:e,name:g,user_count:d.data("user_data").user_count,type:"context",avatar_url:d.data("user_data").avatar_url,selectAll:!0,noExpand:!0})}},baseData:{synthetic_contexts:1},browser:{data:{per_page:-1,type:"context"}}}}),h=$("#recipients").data("token_input"),h.$fakeInput.css("width","100%"),h.change=function(a){var b,c;return a.length>1||((c=a[0])!=null?c.match(/^(course|group)_/):void 0)?(i.$form.find("#group_conversation_info").is(":visible")||i.$form.find("#group_conversation").attr("checked",!1),i.$form.find("#group_conversation_info").show(),i.$form.find("#user_note_info").hide()):(i.$form.find("#group_conversation").attr("checked",!1),i.$form.find("#group_conversation_info").hide(),i.$form.find("#user_note_info").showIf((b=i.userCache[a[0]])&&i.canAddNotesFor(b))),i.resize()},this.filterNameMap={},$("#context_tags").tokenInput({placeholder:f,added:function(a,b,c){return b.prevAll().remove()},tokenWrapBuffer:80,selector:{messages:{noResults:e},populator:a({prefixUserIds:!0}),limiter:function(a){return 5},preparer:function(a,d,e){var f,g;f=a.context;if(!a.search&&f&&d.length>0&&f.match(/^(course|group)_\d+$/))return d.length>1&&f.match(/^course_/)&&d.unshift({id:""+f+"_all",name:b,user_count:e.data("user_data").user_count,type:"context",avatar_url:e.data("user_data").avatar_url}),g=f.match(/^course/)?c.t("filter_by_course","Fiter by this course"):c.t("filter_by_group","Fiter by this group"),d.unshift({id:f,name:e.data("text"),type:"context",avatar_url:e.data("user_data").avatar_url,subText:g,noExpand:!0})},baseData:{synthetic_contexts:1,types:["course","user","group"],include_inactive:!0},browser:{data:{per_page:-1,types:["context"]}}}}),d=$("#context_tags").data("token_input"),d.change=function(a){var b,c;return b=function(){var a,b,e,f;e=d.tokenPairs(),f=[];for(a=0,b=e.length;a<b;a++)c=e[a],this.filterNameMap[c[0]]=c[1],f.push(c[0]);return f}.call(i),i.updateHashData({filter:b})}},j.prototype.initializeConversationsPane=function(){return this.conversations=new g(this,this.$conversations)},j.prototype.initializeAutoResize=function(){var a=this;return $(window).resize(function(){return a.resize(50)}),this.resize()},j.prototype.currentHashData=function(){var a;try{a=$.parseJSON($.decodeFromHex(location.hash.substring(1)))||{}}catch(b){a={}}return a},j.prototype.initializeHashChange=function(){var a=this;return $(window).bind("hashchange",function(){var b,c,d;c=location.hash,b=a.currentHashData();if(b.filter){b.filter=function(){var a,c,e,f;e=b.filter,f=[];for(a=0,c=e.length;a<c;a++)d=e[a],this.filterNameMap[d]&&f.push(d);return f}.call(a);if(!b.filter.length)return a.updateHashData({filter:null})}return a.setScope(b.scope),a.conversations.updateView(b)}).triggerHandler("hashchange")},j}()})}).call(this)