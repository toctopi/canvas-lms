(function(){function a(a){var b,c,d;if(a&&!a.splice){c=[];for(d=0;!0;d++)if(a[d])c[d]=a[d];else break;return c}return a}var b=tinymce.explode("id,name,width,height,style,align,class,hspace,vspace,bgcolor,type"),c=tinymce.makeMap(b.join(",")),d=tinymce.html.Node,e,f,g=tinymce.util.JSON,h;e=[["Flash","d27cdb6e-ae6d-11cf-96b8-444553540000","application/x-shockwave-flash","http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,40,0"],["ShockWave","166b1bca-3f9c-11cf-8075-444553540000","application/x-director","http://download.macromedia.com/pub/shockwave/cabs/director/sw.cab#version=8,5,1,0"],["WindowsMedia","6bf52a52-394a-11d3-b153-00c04f79faa6,22d6f312-b0f6-11d0-94ab-0080c74c7e95,05589fa1-c356-11ce-bf01-00aa0055595a","application/x-mplayer2","http://activex.microsoft.com/activex/controls/mplayer/en/nsmp2inf.cab#Version=5,1,52,701"],["QuickTime","02bf25d5-8c17-4b23-bc80-d3488abddc6b","video/quicktime","http://www.apple.com/qtactivex/qtplugin.cab#version=6,0,2,0"],["RealMedia","cfcdaa03-8be4-11cf-b84b-0020afbbccfa","audio/x-pn-realaudio-plugin","http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,40,0"],["Java","8ad9c840-044e-11d1-b3e9-00805f499d93","application/x-java-applet","http://java.sun.com/products/plugin/autodl/jinstall-1_5_0-windows-i586.cab#Version=1,5,0,0"],["Silverlight","dfeaf541-f3e1-4c24-acac-99c30715084a","application/x-silverlight-2"],["Iframe"],["Video"],["EmbeddedAudio"],["Audio"]],tinymce.create("tinymce.plugins.MediaPlugin",{init:function(a,c){function d(b){return b&&b.nodeName==="IMG"&&a.dom.hasClass(b,"mceItemMedia")}var h=this,i={},j,k,l,m;h.editor=a,h.url=c,f="";for(j=0;j<e.length;j++){m=e[j][0],l={name:m,clsids:tinymce.explode(e[j][1]||""),mimes:tinymce.explode(e[j][2]||""),codebase:e[j][3]};for(k=0;k<l.clsids.length;k++)i["clsid:"+l.clsids[k]]=l;for(k=0;k<l.mimes.length;k++)i[l.mimes[k]]=l;i["mceItem"+m]=l,i[m.toLowerCase()]=l,f+=(f?"|":"")+m}tinymce.each(a.getParam("media_types","video=mp4,m4v,ogv,webm;silverlight=xap;flash=swf,flv;shockwave=dcr;quicktime=mov,qt,mpg,mpeg;shockwave=dcr;windowsmedia=avi,wmv,wm,asf,asx,wmx,wvx;realmedia=rm,ra,ram;java=jar;audio=mp3,ogg").split(";"),function(a){var b,c,d;a=a.split(/=/),c=tinymce.explode(a[1].toLowerCase());for(b=0;b<c.length;b++)d=i[a[0].toLowerCase()],d&&(i[c[b]]=d)}),f=new RegExp("write("+f+")\\(([^)]+)\\)"),h.lookup=i,a.onPreInit.add(function(){a.schema.addValidElements("object[id|style|width|height|classid|codebase|*],param[name|value],embed[id|style|width|height|type|src|*],video[*],audio[*],source[*]"),a.parser.addNodeFilter("object,embed,video,audio,script,iframe",function(a){var b=a.length;while(b--)h.objectToImg(a[b])}),a.serializer.addNodeFilter("img",function(a,b,c){var d=a.length,e;while(d--)e=a[d],(e.attr("class")||"").indexOf("mceItemMedia")!==-1&&h.imgToObject(e,c)})}),a.onInit.add(function(){a.theme&&a.theme.onResolveName&&a.theme.onResolveName.add(function(b,c){c.name==="img"&&a.dom.hasClass(c.node,"mceItemMedia")&&(c.name="media")}),a&&a.plugins.contextmenu&&a.plugins.contextmenu.onContextMenu.add(function(a,b,c){c.nodeName==="IMG"&&c.className.indexOf("mceItemMedia")!==-1&&b.add({title:"media.edit",icon:"media",cmd:"mceMedia"})})}),a.addCommand("mceMedia",function(){var e,f;f=a.selection.getNode(),d(f)&&(e=a.dom.getAttrib(f,"data-mce-json"),e&&(e=g.parse(e),tinymce.each(b,function(b){var c=a.dom.getAttrib(f,b);c&&(e[b]=c)}),e.type=h.getType(f.className).name.toLowerCase())),e||(e={type:"flash",video:{sources:[]},params:{}}),a.windowManager.open({file:c+"/media.htm",width:430+parseInt(a.getLang("media.delta_width",0)),height:500+parseInt(a.getLang("media.delta_height",0)),inline:1},{plugin_url:c,data:e})}),a.addButton("media",{title:"media.desc",cmd:"mceMedia"}),a.onNodeChange.add(function(a,b,c){b.setActive("media",d(c))})},convertUrl:function(a,b){var c=this,d=c.editor,e=d.settings,f=e.url_converter,g=e.url_converter_scope||c;return a?b?d.documentBaseURI.toAbsolute(a):f.call(g,a,"src","object"):a},getInfo:function(){return{longname:"Media",author:"Moxiecode Systems AB",authorurl:"http://tinymce.moxiecode.com",infourl:"http://wiki.moxiecode.com/index.php/TinyMCE:Plugins/media",version:tinymce.majorVersion+"."+tinymce.minorVersion}},dataToImg:function(b,c){var d=this,e=d.editor,f=e.documentBaseURI,h,i,j,k;b.params.src=d.convertUrl(b.params.src,c),i=b.video.attrs,i&&(i.src=d.convertUrl(i.src,c)),i&&(i.poster=d.convertUrl(i.poster,c)),h=a(b.video.sources);if(h)for(k=0;k<h.length;k++)h[k].src=d.convertUrl(h[k].src,c);return j=d.editor.dom.create("img",{id:b.id,style:b.style,align:b.align,hspace:b.hspace,vspace:b.vspace,src:d.editor.theme.url+"/img/trans.gif","class":"mceItemMedia mceItem"+d.getType(b.type).name,"data-mce-json":g.serialize(b,"'")}),j.width=b.width||(b.type=="audio"?"300":"320"),j.height=b.height||(b.type=="audio"?"32":"240"),j},dataToHtml:function(a,b){return this.editor.serializer.serialize(this.dataToImg(a,b),{forced_root_block:"",force_absolute:b})},htmlToData:function(a){var c,d,e;return e={type:"flash",video:{sources:[]},params:{}},c=this.editor.parser.parse(a),d=c.getAll("img")[0],d&&(e=g.parse(d.attr("data-mce-json")),e.type=this.getType(d.attr("class")).name.toLowerCase(),tinymce.each(b,function(a){var b=d.attr(a);b&&(e[a]=b)})),e},getType:function(a){var b,c,d;c=tinymce.explode(a," ");for(b=0;b<c.length;b++){d=this.lookup[c[b]];if(d)return d}},imgToObject:function(c,e){function f(a,b){var c,d,e,f,g;g=i.getParam("flash_video_player_url",h.convertUrl(h.url+"/moxieplayer.swf")),g&&(c=i.documentBaseURI,p.params.src=g,i.getParam("flash_video_player_absvideourl",!0)&&(a=c.toAbsolute(a||"",!0),b=c.toAbsolute(b||"",!0)),e="",d=i.getParam("flash_video_player_flashvars",{url:"$url",poster:"$poster"}),tinymce.each(d,function(c,d){c=c.replace(/\$url/,a||""),c=c.replace(/\$poster/,b||""),c.length>0&&(e+=(e?"&":"")+d+"="+escape(c))}),e.length&&(p.params.flashvars=e),f=i.getParam("flash_video_player_params",{allowfullscreen:!0,allowscriptaccess:!0}),tinymce.each(f,function(a,b){p.params[b]=""+a}))}var h=this,i=h.editor,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B;p=c.attr("data-mce-json");if(!p)return;p=g.parse(p),u=this.getType(c.attr("class")),A=c.attr("data-mce-style"),A||(A=c.attr("style"),A&&(A=i.dom.serializeStyle(i.dom.parseStyle(A,"img"))));if(u.name==="Iframe"){y=new d("iframe",1),tinymce.each(b,function(a){var b=c.attr(a);a=="class"&&b&&(b=b.replace(/mceItem.+ ?/g,"")),b&&b.length>0&&y.attr(a,b)});for(n in p.params)y.attr(n,p.params[n]);y.attr({style:A,src:p.params.src}),c.replace(y);return}if(this.editor.settings.media_use_script){y=(new d("script",1)).attr("type","text/javascript"),o=new d("#text",3),o.value="write"+u.name+"("+g.serialize(tinymce.extend(p.params,{width:c.attr("width"),height:c.attr("height")}))+");",y.append(o),c.replace(y);return}if(u.name==="Video"&&p.video.sources[0]){j=(new d("video",1)).attr(tinymce.extend({id:c.attr("id"),width:c.attr("width"),height:c.attr("height"),style:A},p.video.attrs)),p.video.attrs&&(z=p.video.attrs.poster),r=p.video.sources=a(p.video.sources);for(v=0;v<r.length;v++)/\.mp4$/.test(r[v].src)&&(x=r[v].src);r[0].type||(j.attr("src",r[0].src),r.splice(0,1));for(v=0;v<r.length;v++)q=(new d("source",1)).attr(r[v]),q.shortEnded=!0,j.append(q);x?(f(x,z),u=h.getType("flash")):p.params.src=""}if(u.name==="Audio"&&p.video.sources[0]){B=(new d("audio",1)).attr(tinymce.extend({id:c.attr("id"),width:c.attr("width"),height:c.attr("height"),style:A},p.video.attrs)),p.video.attrs&&(z=p.video.attrs.poster),r=p.video.sources=a(p.video.sources),r[0].type||(B.attr("src",r[0].src),r.splice(0,1));for(v=0;v<r.length;v++)q=(new d("source",1)).attr(r[v]),q.shortEnded=!0,B.append(q);p.params.src=""}if(u.name==="EmbeddedAudio"){l=new d("embed",1),l.shortEnded=!0,l.attr({id:c.attr("id"),width:c.attr("width"),height:c.attr("height"),style:A,type:c.attr("type")});for(n in p.params)l.attr(n,p.params[n]);tinymce.each(b,function(a){p[a]&&a!="type"&&l.attr(a,p[a])}),p.params.src=""}if(p.params.src){/\.flv$/i.test(p.params.src)&&f(p.params.src,""),e&&e.force_absolute&&(p.params.src=i.documentBaseURI.toAbsolute(p.params.src)),k=(new d("object",1)).attr({id:c.attr("id"),width:c.attr("width"),height:c.attr("height"),style:A}),tinymce.each(b,function(a){var b=p[a];a=="class"&&b&&(b=b.replace(/mceItem.+ ?/g,"")),b&&a!="type"&&k.attr(a,b)});for(n in p.params)t=new d("param",1),t.shortEnded=!0,o=p.params[n],n==="src"&&u.name==="WindowsMedia"&&(n="url"),t.attr({name:n,value:o}),k.append(t);if(this.editor.getParam("media_strict",!0))k.attr({data:p.params.src,type:u.mimes[0]});else{k.attr({classid:"clsid:"+u.clsids[0],codebase:u.codebase}),l=new d("embed",1),l.shortEnded=!0,l.attr({id:c.attr("id"),width:c.attr("width"),height:c.attr("height"),style:A,type:u.mimes[0]});for(n in p.params)l.attr(n,p.params[n]);tinymce.each(b,function(a){p[a]&&a!="type"&&l.attr(a,p[a])}),k.append(l)}p.object_html&&(o=new d("#text",3),o.raw=!0,o.value=p.object_html,k.append(o)),j&&j.append(k)}j&&p.video_html&&(o=new d("#text",3),o.raw=!0,o.value=p.video_html,j.append(o)),B&&p.video_html&&(o=new d("#text",3),o.raw=!0,o.value=p.video_html,B.append(o));var C=j||B||k||l;C?c.replace(C):c.remove()},objectToImg:function(a){function e(a){return(new tinymce.html.Serializer({inner:!0,validate:!1})).serialize(a)}function h(a,b){return B[(a.attr(b)||"").toLowerCase()]}function i(a){var b=a.replace(/^.*\.([^.]+)$/,"$1");return B[b.toLowerCase()||""]}var j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B=this.lookup,C,D,E=this.editor.settings.url_converter,F=this.editor.settings.url_converter_scope,G,H,I,J;if(!a.parent)return;if(a.name==="script"){a.firstChild&&(C=f.exec(a.firstChild.value));if(!C)return;A=C[1],z={video:{},params:g.parse(C[2])},q=z.params.width,r=z.params.height}z=z||{video:{},params:{}},n=new d("img",1),n.attr({src:this.editor.theme.url+"/img/trans.gif"}),o=a.name;if(o==="video"||o=="audio"){l=a,j=a.getAll("object")[0],k=a.getAll("embed")[0],q=l.attr("width"),r=l.attr("height"),p=l.attr("id"),z.video={attrs:{},sources:[]},D=z.video.attrs;for(o in l.attributes.map)D[o]=l.attributes.map[o];x=a.attr("src"),x&&z.video.sources.push({src:E.call(F,x,"src",a.name)}),y=l.getAll("source");for(t=0;t<y.length;t++)x=y[t].remove(),z.video.sources.push({src:E.call(F,x.attr("src"),"src","source"),type:x.attr("type"),media:x.attr("media")});D.poster&&(D.poster=E.call(F,D.poster,"poster",a.name))}a.name==="object"&&(j=a,k=a.getAll("embed")[0]),a.name==="embed"&&(k=a),a.name==="iframe"&&(m=a,A="Iframe");if(j){q=q||j.attr("width"),r=r||j.attr("height"),s=s||j.attr("style"),p=p||j.attr("id"),G=G||j.attr("hspace"),H=H||j.attr("vspace"),I=I||j.attr("align"),J=J||j.attr("bgcolor"),z.name=j.attr("name"),w=j.getAll("param");for(t=0;t<w.length;t++)v=w[t],o=v.remove().attr("name"),c[o]||(z.params[o]=v.attr("value"));z.params.src=z.params.src||j.attr("data")}if(k){q=q||k.attr("width"),r=r||k.attr("height"),s=s||k.attr("style"),p=p||k.attr("id"),G=G||k.attr("hspace"),H=H||k.attr("vspace"),I=I||k.attr("align"),J=J||k.attr("bgcolor");for(o in k.attributes.map)!c[o]&&!z.params[o]&&(z.params[o]=k.attributes.map[o])}if(m){q=m.attr("width"),r=m.attr("height"),s=s||m.attr("style"),p=m.attr("id"),G=m.attr("hspace"),H=m.attr("vspace"),I=m.attr("align"),J=m.attr("bgcolor"),tinymce.each(b,function(a){n.attr(a,m.attr(a))});for(o in m.attributes.map)!c[o]&&!z.params[o]&&(z.params[o]=m.attributes.map[o])}z.params.movie&&(z.params.src=z.params.src||z.params.movie,delete z.params.movie),z.params.src&&(z.params.src=E.call(F,z.params.src,"src","object")),l&&(a.name==="video"?A=B.video.name:a.name==="audio"&&(A=B.audio.name)),j&&!A&&(A=(h(j,"clsid")||h(j,"classid")||h(j,"type")||{}).name),k&&!A&&(A=(h(k,"type")||i(z.params.src)||{}).name),k&&A=="EmbeddedAudio"&&(z.params.type=k.attr("type")),a.replace(n),k&&k.remove(),j&&(u=e(j.remove()),u&&(z.object_html=u)),l&&(u=e(l.remove()),u&&(z.video_html=u)),z.hspace=G,z.vspace=H,z.align=I,z.bgcolor=J,n.attr({id:p,"class":"mceItemMedia mceItem"+(A||"Flash"),style:s,width:q||(a.name=="audio"?"300":"320"),height:r||(a.name=="audio"?"32":"240"),hspace:G,vspace:H,align:I,bgcolor:J,"data-mce-json":g.serialize(z,"'")})}}),tinymce.PluginManager.add("media",tinymce.plugins.MediaPlugin)})()