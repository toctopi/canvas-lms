define(["compiled/editor/stocktiny","jquery","jqueryui/dialog"],function(a,b){a.create("tinymce.plugins.InstructureEquella",{init:function(a,c){a.addCommand("instructureEquella",function(){var c=b("#equella_dialog"),d=b("#equella_endpoint_url").attr("href"),e=b.trim(b("#equella_action").text()||"")||"selectOrAdd",f=b("#equella_callback_url").attr("href"),g=b("#equella_cancel_url").attr("href");if(!d||!f||!g){alert("Equella is not properly configured for this account, please notify your system administrator.");return}var h=Math.max(Math.min(b(window).height()-100,550),100);c.length||(c=b('<div id="equella_dialog" style="padding: 0; overflow-y: hidden;"/>').hide().html("<div class='teaser' style='width: 800px; margin-bottom: 10px; display: none;'></div><iframe style='background: url(/images/ajax-loader-medium-444.gif) no-repeat left top; width: 800px; height: "+h+"px; border: 0;' src='about:blank' borderstyle='0'/>").appendTo("body").dialog({autoOpen:!1,width:"auto",resizable:!0,resizeStart:function(){b(this).find("iframe").each(function(){b('<div class="fix_for_resizing_over_iframe" style="background: #fff;"></div>').css({width:this.offsetWidth+"px",height:this.offsetHeight+"px",position:"absolute",opacity:"0.001",zIndex:1e7}).css(b(this).offset()).appendTo("body")})},resizeStop:function(){b(".fix_for_resizing_over_iframe").remove()},resize:function(){b(this).find("iframe").add(".fix_for_resizing_over_iframe").height(b(this).height()).width(b(this).width())},close:function(){c.find("iframe").attr("src","about:blank")},title:"Embed content from Equella"}).bind("equella_ready",function(d,e){var f=c.data("editor")||a,g=a.selection.getContent();if(g)a.execCommand("mceInsertLink",!1,{title:e.name,href:e.url,"class":"equella_content_link"});else{var h=b("<div><a/></div>");h.find("a").attr("title",e.name).attr("href",e.url).attr("class","equella_content_link").text(e.name),a.execCommand("mceInsertContent",!1,h.html())}b("#equella_dialog").dialog("close")}));var i=b("#equella_teaser").html();c.find(".teaser").hide(),i&&c.find(".teaser").html(i).show();var j=d;j=j+"?method=lms&returnprefix=eq_&action="+e,j=j+"&returnurl="+encodeURIComponent(f),j=j+"&cancelurl="+encodeURIComponent(g),c.data("editor",a),c.dialog("close").dialog("open"),c.find("iframe").attr("src",j)}),a.addButton("instructure_equella",{title:"Insert Equella Links",cmd:"instructureEquella",image:c+"/button.gif"})},getInfo:function(){return{longname:"InstructureEquella",author:"Brian Whitmer",authorurl:"http://www.instructure.com",infourl:"http://www.instructure.com",version:a.majorVersion+"."+a.minorVersion}}}),a.PluginManager.add("instructure_equella",a.plugins.InstructureEquella)})