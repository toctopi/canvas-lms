define(["compiled/editor/stocktiny","i18n!editor","jquery","str/htmlEscape","jquery.dropdownList","jquery.instructure_misc_helpers","jqueryui/dialog","jquery.instructure_misc_plugins"],function(a,b,c,d){var e={embed_from_external_tool:b.t("embed_from_external_tool",'"Embed content from External Tool"'),more_external_tools:INST.htmlEscape(b.t("more_external_tools","More External Tools"))};a.create("tinymce.plugins.InstructureExternalTools",{init:function(a,b){function d(b){var d=Math.max(Math.min(c(window).height()-100,550),100);f||(f=c('<div id="external_tool_button_dialog" style="padding: 0; overflow-y: hidden;"/>').hide().html("<div class='teaser' style='width: 800px; margin-bottom: 10px; display: none;'></div><iframe id='external_tool_button_frame' style='width: 800px; height: "+d+"px; border: 0;' src='/images/ajax-loader-medium-444.gif' borderstyle='0'/>").appendTo("body").dialog({autoOpen:!1,width:"auto",resizable:!0,close:function(){f.find("iframe").attr("src","/images/ajax-loader-medium-444.gif")},title:e.embed_from_external_tool}).bind("dialogresize",function(){c(this).find("iframe").add(".fix_for_resizing_over_iframe").height(c(this).height()).width(c(this).width())}).bind("dialogresizestop",function(){c(".fix_for_resizing_over_iframe").remove()}).bind("dialogresizestart",function(){c(this).find("iframe").each(function(){c('<div class="fix_for_resizing_over_iframe" style="background: #fff;"></div>').css({width:this.offsetWidth+"px",height:this.offsetHeight+"px",position:"absolute",opacity:"0.001",zIndex:1e7}).css(c(this).offset()).appendTo("body")})}).bind("selection",function(b,d){var e=f.data("editor")||a;if(d.embed_type=="basic_lti")if(c("#external_tool_retrieve_url").attr("href")){var g=c.replaceTags(c("#external_tool_retrieve_url").attr("href"),"url",d.url);c("#"+a.id).editorBox("create_link",{url:g,title:d.title,text:d.text})}else console.log("cannot embed basic lti links in this context");else if(d.embed_type=="image"){var h=c("<div/>").append(c("<img/>",{src:d.url,alt:d.alt}).css({width:d.width,height:d.height})).html();c("#"+a.id).editorBox("insert_code",h)}else if(d.embed_type=="link")c("#"+a.id).editorBox("create_link",{url:d.url,title:d.title,text:d.text,target:d.target=="_blank"?"_blank":null});else if(d.embed_type=="iframe"){var h=c("<div/>").append(c("<iframe/>",{src:d.url,title:d.title}).css({width:d.width,height:d.height})).html();c("#"+a.id).editorBox("insert_code",h)}else d.embed_type=="rich_content"?c("#"+a.id).editorBox("insert_code",d.html):d.embed_type=="error"&&d.message?alert(d.message):console.log("unrecognized embed type: "+d.embed_type);c("#external_tool_button_dialog iframe").attr("src","about:blank"),c("#external_tool_button_dialog").dialog("close")})),f.dialog("option","title","Embed content from "+b.name),f.dialog("close").dialog("option","width",b.width||800).dialog("option","height",b.height||d||400).dialog("open"),f.triggerHandler("dialogresize"),f.data("editor",a);var g=c.replaceTags(c("#context_external_tool_resource_selection_url").attr("href"),"id",b.id);f.find("iframe").attr("src",g)}if(!window||!window.INST||!window.INST.editorButtons||!window.INST.editorButtons.length)return;var f=null,g=[];for(var h in INST.editorButtons){var i=INST.editorButtons[h];INST.editorButtons.length>INST.maxVisibleEditorButtons&&h>=INST.maxVisibleEditorButtons-1?g.push(i):function(b){a.addCommand("instructureExternalButton"+b.id,function(){d(b)}),a.addButton("instructure_external_button_"+b.id,{title:b.name,cmd:"instructureExternalButton"+b.id,image:b.icon_url,"class":"instructure_external_tool_button"})}(i)}g.length&&(a.addCommand("instructureExternalButtonClump",function(){var b={};for(var e in g)(function(a){b["<img src='"+g[a].icon_url+"'/>&nbsp;"+g[a].name]=function(){d(g[a])}})(e);c("#"+a.id+"_instructure_external_button_clump").dropdownList({options:b})}),a.addButton("instructure_external_button_clump",{title:e.more_external_tools,cmd:"instructureExternalButtonClump",image:"/images/downtick.png"}))},getInfo:function(){return{longname:"InstructureExternalTools",author:"Brian Whitmer",authorurl:"http://www.instructure.com",infourl:"http://www.instructure.com",version:a.majorVersion+"."+a.minorVersion}}}),a.PluginManager.add("instructure_external_tools",a.plugins.InstructureExternalTools)})