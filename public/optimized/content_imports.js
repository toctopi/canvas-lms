define(["i18n!content_imports","compiled/util/processMigrationItemSelections","jquery","jquery.ajaxJSON","jquery.instructure_date_and_time","jquery.instructure_misc_plugins","jquery.rails_flash_notifications","vendor/date","jqueryui/progressbar"],function(a,b,c){c(function(){c(".date_field").date_field();var d=0,e=function(a,b,e,f){d+=1,setTimeout(function(){var g=f+"["+b+"]";a.find(":checkbox:first").attr("name",g).attr("id",g.replace(/[\[\]]+/g,"_")),e!=null&&a.find("label:first").text(e),a.find("label:first").attr("for",g.replace(/[\[\]]+/g,"_")),a.show(),d-=1,d<=0&&(c("#copy_context_form_loading").hide(),c("#copy_context_form").show())})};c.ajaxJSON(location.href,"GET",{},function(b){if(b.start_timestamp){var d=c.parseFromISO((new Date(parseInt(b.start_timestamp,10))).toISOString()).date_formatted;c("#copy_old_start_date").val(d)}if(b.end_timestamp){var d=c.parseFromISO((new Date(parseInt(b.end_timestamp,10))).toISOString()).date_formatted;c("#copy_old_end_date").val(d)}c("#copy_quizzes_list").showIf(b.assessments&&b.assessments.length>0);if(b.assessments&&b.assessments)for(var f in b.assessments){var g=b.assessments[f],h=c("#copy_quizzes_list .quiz:first").clone(!0);e(h,g.assessment_id||g.migration_id,g.assessment_title||g.quiz_name,"copy[quizzes]"),c("#copy_quizzes_list ul.quizzes_list").append(h)}c("#copy_assignments_list").showIf(b.assignments&&b.assignments.length>0);if(b.assignments)for(var f in b.assignments){var i=b.assignments[f],j=c("#copy_assignments_list .assignment:first").clone(!0);e(j,i.migration_id,i.title,"copy[assignments]"),c("#copy_assignments_list ul").append(j)}c("#copy_announcements_list").showIf(b.announcements&&b.announcements.length>0);if(b.announcements)for(var f in b.announcements){var k=b.announcements[f],l=c("#copy_announcements_list .announcement:first").clone(!0);e(l,k.migration_id,k.title,"copy[announcements]"),c("#copy_announcements_list ul").append(l)}c("#copy_events_list").showIf(b.calendar_events&&b.calendar_events.length>0);if(b.calendar_events)for(var f in b.calendar_events){var m=b.calendar_events[f],n=c("#copy_events_list .event:first").clone(!0);e(n,m.migration_id,m.title,"copy[events]"),c("#copy_events_list ul").append(n)}c("#copy_modules_list").showIf(b.modules&&b.modules.length>0);if(b.modules)for(var f in b.modules){var o=b.modules[f],p=c("#copy_modules_list .module:first").clone(!0);e(p,o.migration_id,o.title,"copy[modules]"),c("#copy_modules_list ul").append(p)}c("#copy_rubrics_list").showIf(b.rubrics&&b.rubrics.length>0);if(b.rubrics)for(var f in b.rubrics){var q=b.rubrics[f],r=c("#copy_rubrics_list .rubric:first").clone(!0);e(r,q.migration_id,q.title,"copy[rubrics]"),c("#copy_rubrics_list ul").append(r)}c("#copy_groups_list").showIf(b.groups&&b.groups.length>0);if(b.groups)for(var f in b.groups){var s=b.groups[f],t=c("#copy_groups_list .group:first").clone(!0);e(t,s.migration_id,s.title,"copy[groups]"),c("#copy_groups_list ul").append(t)}c("#copy_assignment_groups_list").showIf(b.assignment_groups&&b.assignment_groups.length>0);if(b.assignment_groups)for(var f in b.assignment_groups){var u=b.assignment_groups[f],v=c("#copy_assignment_groups_list .assignment_group:first").clone(!0);e(v,u.migration_id,u.title,"copy[assignment_groups]"),c("#copy_assignment_groups_list ul").append(v)}c("#copy_wikis_list").showIf(b.wikis&&b.wikis.length>0);if(b.wikis)for(var f in b.wikis){var w=b.wikis[f],x=c("#copy_wikis_list .wiki:first").clone(!0);e(x,w.migration_id,w.title,"copy[wikis]"),c("#copy_wikis_list ul").append(x)}c("#copy_external_tools_list").showIf(b.external_tools&&b.external_tools.length>0);if(b.external_tools)for(var f in b.external_tools){var y=b.external_tools[f],z=c("#copy_external_tools_list .external_tool:first").clone(!0);e(z,y.migration_id,y.title,"copy[external_tools]"),c("#copy_external_tools_list ul").append(z)}var A=0;c("#copy_topics_list").showIf(b.discussion_topics&&b.discussion_topics.length>0);if(b.discussion_topics)for(var f in b.discussion_topics){var B=b.discussion_topics[f];B.entry_count=0;var C=c("#copy_topics_list .topic:first").clone(!0);e(C,B.migration_id,B.title,"copy[topics]"),e(C.children("div"),B.topic_id,null,"copy[topic_entries]"),c("#copy_topics_list ul").append(C)}var D=0;if(b.course_outline){var E=function(b,d){if(b&&b.migration_id){D++;var f=c("#copy_outline_folders_list .outline_folder:first").clone(!0);d&&(b.title=a.t("titles.home_page","Home Page")),e(f,b.migration_id,b.title,"copy[outline_folders]"),c("#copy_outline_folders_list ul").append(f)}for(var g in b.contents)E(b.contents[g])};E(b.course_outline,!0)}c("#copy_outline_folders_list").showIf(D>0);var F=0;if(b.file_map){var G={},H=[];for(var f in b.file_map){var I=b.file_map[f];if(!I.is_folder){var J=I.path_name.split("/"),K=J.pop();J=J.join("/")||"";if(!G[J]){var L=c("#copy_files_list .folder:first").clone(!0);L.find("ul").empty(),e(L,I.migration_id,J||"/","copy[folders]"),H.push(J),G[J]=L}var M=c("#copy_files_list .file:first").clone(!0);e(M,I.migration_id,K,"copy[files]"),G[J].find("ul").append(M),F++}}H=H.sort();for(var f in H)c("#copy_files_list").append(G[H[f]])}c("#copy_files_list").showIf(F>0),c("#copy_context_form .course_name").text(b.name),c("#copy_everything").prop("checked",!0).change()}),c("#copy_context_form :checkbox").change(function(){c(this).hasClass("copy_all")?c(this).parent().nextAll("ul").find(":checkbox:not(.secondary_checkbox)").prop("checked",c(this).prop("checked")).each(function(){c(this).triggerHandler("change")}):c(this).hasClass("copy_everything")?c("#copy_context_form :checkbox:not(.secondary_checkbox):not(.copy_everything)").prop("checked",c(this).prop("checked")).filter(":not(.copy_all)").each(function(){c(this).triggerHandler("change")}):(c(this).parent().find(":checkbox.secondary_checkbox").prop("checked",c(this).prop("checked")),c(this).prop("checked")||c(this).parents("ul").each(function(){c(this).prev("h2,h3,h4").find(":checkbox").prop("checked",!1)}))}),c(".shift_dates_checkbox").change(function(){c(".shift_dates_settings").showIf(c(this).prop("checked"))}).change(),c(".add_substitution_link").click(function(a){a.preventDefault();var b=c(".substitution_blank").clone(!0).removeClass("substitution_blank");c(".substitutions").append(b.hide());var d=c(".weekday_select_blank").clone(!0).removeClass("weekday_select_blank");b.find(".old_select").empty().append(d.clone(!0)),b.find(".new_select").empty().append(d),b.find(".old_select").children("select").change(),b.slideDown()}),c(".weekday_select").change(function(){if(c(this).parents(".old_select").length>0){var a=c(this).parents(".substitution").find(".new_select").children("select");a.attr("name","copy[day_substitutions]["+c(this).val()+"]")}}),c(".delete_substitution_link").click(function(a){a.preventDefault(),c(this).parents(".substitution").slideUp(function(){c(this).remove()})});var f=c("<iframe id='copy_course_target' name='copy_course_target' src='about:blank'/>");c("body").append(f.hide()),c("#copy_context_form").attr("target","copy_course_target"),c(".copy_progress").progressbar(),c("#copy_context_form").formSubmit({processData:b,beforeSubmit:function(b){setTimeout(function(){c("#copy_context_form").find(":checkbox,:text,select").attr("disabled",!0)},1e3),c("#copy_context_form .submit_button").text(a.t("messages.importing_button","Importing... this could take a while")).attr("disabled",!0),c(".progress_bar_holder").slideDown()},success:function(b){var d="nothing",e=0,f=function(){if(d=="nothing"){e++;var a=(c(".copy_progress").progressbar("option","value")||0)+.25;e<10&&c(".copy_progress").progressbar("option","value",a),setTimeout(f,2e3)}else d="nothing",e=0,setTimeout(f,1e4)},g=function(){var b=c("#copy_context_form").attr("action"),e=null,f=1500;c.ajaxJSON(b,"GET",{},function(b){d="updating";var h=b.content_migration,i=0;h&&(i=Math.max(c(".copy_progress").progressbar("option","value")||0,h.progress),c(".copy_progress").progressbar("option","value",i));if(h&&h.progress>=100)c.flashMessage(a.t("messages.import_complete","Import Complete!  Returning to the Course Page...")),location.href=c(".course_url").attr("href");else if(h&&h.workflow_state=="failed"){var j="ContentMigration:"+c(".content_migration_id:first").text()+":"+h.progress,k=a.t("errors.import_failed",'There was an error during your migration import.  Please notify your system administrator and give them the following code: "%{code}"',{code:j});c.flashError(k),c(".progress_message").text(k)}else i==e?f=Math.max(f+500,3e4):f=1500,e=i,setTimeout(g,1500)},function(){setTimeout(g,3e3)})};return setTimeout(g,2e3),setTimeout(f,1e3),!0}})})})