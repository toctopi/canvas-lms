define(["i18n!edit_rubric","jst/changePointsPossibleToMatchRubricDialog","jquery","underscore","find_outcome","jquery.ajaxJSON","jquery.instructure_forms","jqueryui/dialog","jquery.instructure_misc_helpers","jquery.instructure_misc_plugins","jquery.loadingImg","jquery.templateData","vendor/jquery.ba-tinypubsub","vendor/jquery.scrollTo"],function(a,b,c,d){var e={htmlBody:null,updateCriteria:function(a){a.find(".criterion:not(.blank)").each(function(a){c(this).attr("id","criterion_"+(a+1))})},addCriterion:function(a){var b=a.find(".criterion.blank:first"),c=b.clone(!0);return c.removeClass("blank"),a.find(".summary").before(c.show()),e.updateCriteria(a),e.updateRubricPoints(a),e.sizeRatings(c),c},findOutcomeCriterion:function(a){c("#find_outcome_criterion_dialog").data("current_rubric",a),find_outcome.find(function(a){if(!c("#find_outcome_criterion_dialog").data("current_rubric"))return;var b=c("#find_outcome_criterion_dialog").data("current_rubric"),d=a.find(".learning_outcome_id").text();b.find(".criterion.learning_outcome_"+d).find(".delete_criterion_link").click(),b.find(".add_criterion_link").click();var e=b.find(".criterion:not(.blank):last");e.toggleClass("ignore_criterion_for_scoring",!a.find(".criterion_for_scoring").attr("checked")),e.find(".mastery_points").val(a.find(".mastery_points").text()),e.addClass("learning_outcome_criterion"),e.find(".learning_outcome_id").text(d),e.find(".criterion_points").val(a.find(".rating:not(.blank):first .points").text()).blur();for(var f=0;f<a.find(".rating:not(.blank)").length-2;f++)e.find(".rating:not(.blank):first").addClass("add_column").click();e.find(".rating:not(.blank)").each(function(b){var d=a.find(".rating:not(.blank)").eq(b).getTemplateData({textValues:["description","points"]});c(this).fillTemplateData({data:d})});var g=a.find(".body.description").html(),h=a.find(".mastery_points").text();e.find(".cancel_button").click(),e.find(".long_description").val(g),e.find(".long_description_holder").toggleClass("empty",!g),e.find(".criterion_description_value").text(a.find(".short_description").text()),e.find(".criterion_description").val(a.find(".short_description").text()).focus().select(),e.find(".mastery_points").text(h)},{for_rubric:!0})},hideCriterionAdd:function(a){a.find(".add_right, .add_left, .add_column").removeClass("add_left add_right add_column")},updateRubricPoints:function(a){var b=0;a.find(".criterion:not(.blank):not(.ignore_criterion_for_scoring) .criterion_points").each(function(){var a=parseFloat(c(this).val(),10);isNaN(a)||(b+=a)}),b=f(b,2),a.find(".rubric_total").text(b)},updateCriterionPoints:function(a,b){e.hideEditRating();var d=c.makeArray(a.find(".rating")).reverse(),g=-1,h=parseFloat(a.find(".criterion_points").val());isNaN(h)?h=5:h=f(h,2),a.find(".rating:first .points").text(h),c.each(d,function(a,b){var d=c(b),e=d.getTemplateData({textValues:["points"]});e.points<g&&(e.points=g),e.points=f(e.points,2),d.fillTemplateData({data:e}),g=parseFloat(e.points)}),b&&g>h&&(h=g),a.find(".criterion_points").val(h),a.find(".display_criterion_points").text(h);if(!a.data("criterion_points")||a.data("criterion_points")!=h){if(!a.data("criterion_points")){var i=parseFloat(a.find(".rating:first .points").text());a.data("criterion_points",i)}var j=parseFloat(a.data("criterion_points")),k=h;if(j!==k){var l=a.find(".rating");c(l[0]).find(".points").text(h);var m=h;for(var n=1;n<l.length-1;n++){var i=parseFloat(c(l[n]).find(".points").text()),o=Math.round(i/j*k);if(isNaN(i)||i==0&&m>0)o=m-Math.round(m/(l.length-n));o>=m&&(o=m-1),o=Math.max(0,o),m=o,c(l[n]).find(".points").text(o)}}a.data("criterion_points",h)}e.updateRubricPoints(a.parents(".rubric"))},editRating:function(a){if(!a.parents(".rubric").hasClass("editing"))return;e.hideEditRating(!0),e.hideCriterionAdd(a.parents(".rubric"));var b=Math.max(40,a.find(".rating").height()),d=a.getTemplateData({textValues:["description","points"]}),f=c("#edit_rating");f.fillFormData(d),a.find(".container").hide(),a.append(f.show()),f.find(":input:first").focus().select(),a.addClass("editing"),e.sizeRatings(a.parents(".criterion"))},hideEditRating:function(a){var b=c("#edit_rating");b.filter(":visible").length>0&&a&&b.find("form").submit();var d=b.parents(".rating");d.removeClass("editing"),b.appendTo(c("body")).hide(),d.find(".container").show(),e.sizeRatings(d.parents(".criterion")),e.hideCriterionAdd(d.parents(".rubric"))},editCriterion:function(a){if(!a.parents(".rubric").hasClass("editing"))return;e.hideEditCriterion(!0);var b=a.find(".criterion_description"),d=Math.max(40,b.find(".description").height()),f=b.getTemplateData({textValues:["description"]}),g=c("#edit_criterion");g.fillFormData(f),b.find(".container").hide().after(g.show()),g.find(":input:first").focus().select(),e.sizeRatings(a)},hideEditCriterion:function(a){var b=c("#edit_criterion");b.filter(":visible").length>0&&a&&b.find("form").submit();var d=b.parents(".criterion");b.appendTo("body").hide(),d.find(".criterion_description").find(".container").show(),e.sizeRatings(d)},originalSizeRatings:function(){var a=c(".rubric:not(.rubric_summary) .criterion:visible");if(a.length){var b=c.windowScrollTop();a.each(function(){var a=c(this),b=a.find(".ratings:visible");if(b.length){var d=b.find(".rating .container").css("height",""),e=Math.max(b.height(),a.find(".criterion_description .container").height());d.css("height",e-10+"px")}}),e.htmlBody.scrollTop(b)}},rubricData:function(a){a=a.filter(":first"),a.hasClass("editing")||(a=a.next(".editing")),a.find(".criterion_points").each(function(){var a=c(this).val();c(this).parents(".criterion").find(".display_criterion_points").text(a)});var b=a.getFormData();a.find("thead .title").text(b.title);var b=a.getTemplateData({textValues:["title","description","rubric_total","rubric_association_id"]}),d={};d["rubric[title]"]=b.title,d["rubric[points_possible]"]=b.rubric_total,d["rubric_association[use_for_grading]"]=a.find(".grading_rubric_checkbox").attr("checked")?"1":"0",d["rubric_association[hide_score_total]"]="0",d["rubric_association[use_for_grading]"]=="0"&&(d["rubric_association[hide_score_total]"]=a.find(".totalling_rubric_checkbox").attr("checked")?"1":"0"),d["rubric[free_form_criterion_comments]"]=a.find(".rubric_custom_rating").attr("checked")?"1":"0",d["rubric_association[id]"]=b.rubric_association_id,d.rubric_association_id=b.rubric_association_id;var e=0;return a.find(".criterion:not(.blank)").each(function(){var a=c(this);a.hasClass("learning_outcome_criterion")||a.find("span.mastery_points").text(parseFloat(a.find("input.mastery_points").val(),10)||"0");var b=a.getTemplateData({textValues:["description","display_criterion_points","learning_outcome_id","mastery_points","long_description","criterion_id"]});b.long_description=a.find("textarea.long_description").val(),b.mastery_points=a.find("span.mastery_points").text();var f="rubric[criteria]["+e+"]";d[f+"[description]"]=b.description,d[f+"[points]"]=b.display_criterion_points,d[f+"[learning_outcome_id]"]=b.learning_outcome_id,d[f+"[long_description]"]=b.long_description,d[f+"[id]"]=b.criterion_id,a.hasClass("ignore_criterion_for_scoring")&&(d[f+"[ignore_for_scoring]"]="1"),b.learning_outcome_id&&(d[f+"[mastery_points]"]=b.mastery_points);var g=0;a.find(".rating").each(function(){var a=c(this),b=a.getTemplateData({textValues:["description","points","rating_id"]}),e=f+"[ratings]["+g+"]";d[e+"[description]"]=b.description,d[e+"[points]"]=b.points,d[e+"[id]"]=b.rating_id,g++}),e++}),d.title=d["rubric[title]"],d.points_possible=d["rubric[points_possible]"],d.rubric_id=a.attr("id").substring(7),d=c.extend(d,c("#rubrics #rubric_parameters").getFormData()),d},addRubric:function(){var a=c("#default_rubric").clone(!0).attr("id","rubric_new").addClass("editing");a.find("#edit_rubric").remove();var b=c("#edit_rubric").clone(!0).show().removeAttr("id").addClass("edit_rubric"),d=b.find("#edit_rubric_form");a.append(b),d.attr("method","POST").attr("action",c("#add_rubric_url").attr("href"));var e=parseFloat(c("#full_assignment .points_possible,#rubrics.rubric_dialog .assignment_points_possible").filter(":first").text());return d.find(".rubric_grading").showIf(e||c("#full_assignment").length>0),a},editRubric:function(a,b){var d=a.clone(!0).addClass("editing");d.find("#edit_rubric").remove();var f=d.getTemplateData({textValues:["use_for_grading","free_form_criterion_comments","hide_score_total"]});a.hide().after(d.show());var g=c("#edit_rubric").clone(!0).show().removeAttr("id").addClass("edit_rubric"),h=g.find("#edit_rubric_form");return d.append(g),d.find(":text:first").focus().select(),h.find(".grading_rubric_checkbox").attr("checked",f.use_for_grading=="true").triggerHandler("change"),h.find(".rubric_custom_rating").attr("checked",f.free_form_criterion_comments=="true").triggerHandler("change"),h.find(".totalling_rubric_checkbox").attr("checked",f.hide_score_total=="true").triggerHandler("change"),h.find(".save_button").text(d.attr("id")=="rubric_new"?"Create Rubric":"Update Rubric"),h.attr("method","PUT").attr("action",b),e.sizeRatings(),d},hideEditRubric:function(a,b){a=a.filter(":first"),a.hasClass("editing")||(a=a.next(".editing")),a.removeClass("editing"),c("#edit_criterion").hide().appendTo("body"),a.find(".edit_rubric").remove(),b?(a.attr("id")!="rubric_new"?a.prev(".rubric").show():c(".add_rubric_link").show(),a.remove()):a.find(".rubric_title .links").show()},updateRubric:function(a,b){a.find(".criterion:not(.blank)").remove();var d=a.find(".rating:first").clone(!0).removeAttr("id");a.fillTemplateData({data:b,id:"rubric_"+b.id,hrefValues:["id","rubric_association_id"],avoid:".criterion"}),a.fillFormData(b);var e=c.replaceTags(a.find(".edit_rubric_url").attr("href"),"rubric_id",b.id);a.find(".edit_rubric_link").attr("href",e);var e=c.replaceTags(a.find(".delete_rubric_url").attr("href"),"association_id",b.rubric_association_id);a.find(".delete_rubric_link").attr("href",e),a.find(".edit_rubric_link").showIf(b.permissions.update_association),a.find(".find_rubric_link").showIf(b.permissions.update_association&&!c("#rubrics").hasClass("raw_listing")),a.find(".delete_rubric_link").showIf(b.permissions.delete_association),a.find(".criterion:not(.blank) .ratings").empty();for(var f in b.criteria){var g=b.criteria[f];g.display_criterion_points=g.points,g.criterion_id=g.id;var h=a.find(".criterion.blank:first").clone(!0).show().removeAttr("id");h.removeClass("blank"),h.fillTemplateData({data:g}),h.find(".long_description_holder").toggleClass("empty",!g.long_description),h.find(".ratings").empty(),h.toggleClass("learning_outcome_criterion",!!g.learning_outcome_id),h.toggleClass("ignore_criterion_for_scoring",!!g.ignore_for_scoring);for(var i in g.ratings){var j=g.ratings[i];j.rating_id=j.id;var k=d.clone(!0);k.toggleClass("edge_rating",i===0||i===g.ratings.length-1),k.fillTemplateData({data:j}),h.find(".ratings").append(k)}a.find(".summary").before(h),h.find(".criterion_points").val(g.points).blur()}a.find(".criterion:not(.blank)").find(".ratings").showIf(!b.free_form_criterion_comments).end().find(".custom_ratings").showIf(b.free_form_criterion_comments)}};e.sizeRatings=d.debounce(e.originalSizeRatings,10);var f=function(a,b){return b=Math.pow(10,b||0).toFixed(b<0?-b:0),Math.round(a*b)/b};e.init=function(){var d=!0,f=c("#rubric_dialog"),g=c("#rubric_long_description_dialog");e.htmlBody=c("html,body"),c("#rubrics").delegate(".long_description_link","click",function(b){b.preventDefault();var d=c(this).parents(".rubric").hasClass("editing"),e=c(this).parents(".criterion"),f=c(this).parents(".criterion").hasClass("learning_outcome_criterion"),h=e.getTemplateData({textValues:["long_description","description"]});h.long_description=e.find("textarea.long_description").val(),g.data("current_criterion",e).fillTemplateData({data:h,htmlValues:f?["long_description"]:[]}).fillFormData(h).find(".editing").showIf(d&&!e.hasClass("learning_outcome_criterion")).end().find(".displaying").showIf(!d||e.hasClass("learning_outcome_criterion")).end().dialog("close").dialog({autoOpen:!1,title:a.t("titles.criterion_long_description","Criterion Long Description"),width:400}).dialog("open").find("textarea:visible:first").focus().select()}).delegate(".find_rubric_link","click",function(b){b.preventDefault(),f.dialog("close").dialog({autoOpen:!0,width:800,height:380,resizable:!0,title:a.t("titles.find_existing_rubric","Find Existing Rubric")}).dialog("open");if(!f.hasClass("loaded")){f.find(".loading_message").text(a.t("messages.loading_rubric_groups","Loading rubric groups..."));var d=f.find(".grading_rubrics_url").attr("href");c.ajaxJSON(d,"GET",{},function(a){for(var b in a){var c=a[b],d=f.find(".rubrics_dialog_context_select.blank:first").clone(!0).removeClass("blank");d.fillTemplateData({data:{name:c.name,context_code:c.context_code,rubrics:c.rubrics+" rubrics"}}),f.find(".rubrics_dialog_contexts_select").append(d.show())}var e={};a.length==0?f.find(".loading_message").text("No rubrics found"):f.find(".loading_message").remove(),f.find(".rubrics_dialog_rubrics_holder").slideDown(),f.find(".rubrics_dialog_contexts_select .rubrics_dialog_context_select:visible:first").click(),f.addClass("loaded")},function(b){f.find(".loading_message").text(a.t("errors.load_rubrics_failed","Loading rubrics failed, please try again"))})}}).delegate(".edit_rubric_link","click",function(b){var d=c(this);return(!d.hasClass("copy_edit")||confirm(a.t("prompts.read_only_rubric","You can't edit this rubric, either because you don't have permission or it's being used in more than one place. Any changes you make will result in a new rubric based on the old rubric.  Continue anyway?")))&&e.editRubric(d.parents(".rubric"),d.attr("href")),!1}),c(".rubric .delete_rubric_link").bind("click",function(b,d){b.preventDefault();var e=a.t("prompts.confirm_delete","Are you sure you want to delete this rubric?");d&&d.confirmationMessage&&(e=d.confirmationMessage),c(this).parents(".rubric").confirmDelete({url:c(this).attr("href"),message:e,success:function(){c(this).fadeOut(function(){c(".add_rubric_link").show(),d&&c.isFunction(d)&&d()})}})}),g.find(".save_button").click(function(){var a=g.find("textarea.long_description").val(),b=g.data("current_criterion");b&&(b.fillTemplateData({data:{long_description:a}}),b.find("textarea.long_description").val(a),b.find(".long_description_holder").toggleClass("empty",!a)),g.dialog("close")}),g.find(".cancel_button").click(function(){g.dialog("close")}),c(".add_rubric_link").click(function(a){a.preventDefault();if(c("#rubric_new").length>0)return;if(d&&c("#rubrics .rubric:visible").length>0)return;var b=e.addRubric();c("#rubrics").append(b.show()),b.find(":text:first").focus().select(),d&&c(".add_rubric_link").hide()}),c("#rubric_dialog").delegate(".rubrics_dialog_context_select","click",function(b){b.preventDefault(),c(".rubrics_dialog_contexts_select .selected_side_tab").removeClass("selected_side_tab");var d=c(this);d.addClass("selected_side_tab");var e=d.getTemplateData({textValues:["context_code"]}).context_code;if(d.hasClass("loaded"))f.find(".rubrics_loading_message").hide(),f.find(".rubrics_dialog_rubrics,.rubrics_dialog_rubrics_select").show(),f.find(".rubrics_dialog_rubrics_select .rubrics_dialog_rubric_select").hide(),f.find(".rubrics_dialog_rubrics_select .rubrics_dialog_rubric_select."+e).show(),f.find(".rubrics_dialog_rubrics_select .rubrics_dialog_rubric_select:visible:first").click();else{f.find(".rubrics_loading_message").text(a.t("messages.loading_rubrics","Loading rubrics...")).show(),f.find(".rubrics_dialog_rubrics,.rubrics_dialog_rubrics_select").hide();var g=f.find(".grading_rubrics_url").attr("href")+"?context_code="+e;c.ajaxJSON(g,"GET",{},function(a){d.addClass("loaded"),f.find(".rubrics_loading_message").hide(),f.find(".rubrics_dialog_rubrics,.rubrics_dialog_rubrics_select").show();for(var b in a){var c=a[b].rubric_association,g=c.rubric,h=f.find(".rubrics_dialog_rubric_select.blank:first").clone(!0);h.addClass(c.context_code),g.criterion_count=g.data.length,h.fillTemplateData({data:g}).removeClass("blank"),f.find(".rubrics_dialog_rubrics_select").append(h.show());var i=f.find(".rubrics_dialog_rubric.blank:first").clone(!0);i.removeClass("blank"),i.find(".criterion.blank").hide(),g.rubric_total=g.points_possible,i.fillTemplateData({data:g,id:"rubric_dialog_"+g.id});for(var b in g.data){var j=g.data[b];j.criterion_points=j.points,j.criterion_points_possible=j.points,j.criterion_description=j.description;var k=j.ratings;delete j.ratings;var l=i.find(".criterion.blank:first").clone().removeClass("blank");l.fillTemplateData({data:j}),l.find(".rating_holder").addClass("blank");for(var m in k){var n=k[m],o=l.find(".rating_holder.blank:first").clone().removeClass("blank");n.rating=n.description,o.fillTemplateData({data:n}),l.find(".ratings").append(o.show())}l.find(".rating_holder.blank").remove(),i.find(".rubric.rubric_summary tr.summary").before(l.show())}f.find(".rubrics_dialog_rubrics").append(i)}f.find(".rubrics_dialog_rubrics_select .rubrics_dialog_rubric_select").hide(),f.find(".rubrics_dialog_rubrics_select .rubrics_dialog_rubric_select."+e).show(),f.find(".rubrics_dialog_rubrics_select .rubrics_dialog_rubric_select:visible:first").click()},function(a){f.find(".rubrics_loading_message").text("Loading rubrics failed, please try again")})}}).delegate(".rubrics_dialog_rubric_select","click",function(a){a.preventDefault();var b=c(this);b.find("a").focus();var d=b.getTemplateData({textValues:["id"]}).id;c(".rubric_dialog .rubrics_dialog_rubric_select").removeClass("selected_side_tab"),b.addClass("selected_side_tab"),c(".rubric_dialog .rubrics_dialog_rubric").hide(),c(".rubric_dialog #rubric_dialog_"+d).show()}).delegate(".select_rubric_link","click",function(a){a.preventDefault();var b={},d=f.getTemplateData({textValues:["rubric_association_type","rubric_association_id","rubric_association_purpose"]});b["rubric_association[association_type]"]=d.rubric_association_type,b["rubric_association[association_id]"]=d.rubric_association_id,b["rubric_association[rubric_id]"]=c(this).parents(".rubrics_dialog_rubric").getTemplateData({textValues:["id"]}).id,b["rubric_association[purpose]"]=d.rubric_association_purpose,f.loadingImage();var g=f.find(".select_rubric_url").attr("href");c.ajaxJSON(g,"POST",b,function(a){f.loadingImage("remove");var b=c("#rubrics .rubric:visible:first");b.length===0&&(b=e.addRubric());var d=a.rubric;d.rubric_association_id=a.rubric_association.id,d.permissions=d.permissions||{},a.rubric_association.permissions&&(d.permissions.update_association=a.rubric_association.permissions.update,d.permissions.delete_association=a.rubric_association.permissions["delete"]),e.updateRubric(b,d),e.hideEditRubric(b,!1),f.dialog("close")},function(){f.loadingImage("remove")})}),f.find(".cancel_find_rubric_link").click(function(a){a.preventDefault(),f.dialog("close")}),f.find(".rubric_brief").find(".expand_data_link,.collapse_data_link").click(function(a){a.preventDefault(),c(this).parents(".rubric_brief").find(".expand_data_link,.collapse_data_link").toggle().end().find(".details").slideToggle()});var h=!1,i=!1;c("#edit_rubric_form").formSubmit({processData:function(a){var d=c(this).parents(".rubric");if(!d.find(".criterion:not(.blank)").length)return!1;var a=e.rubricData(d);if(a["rubric_association[use_for_grading]"]=="1"){var f=parseFloat(c("#full_assignment .points_possible").text()),g=parseFloat(a.points_possible);if(f&&g!=f&&!h){var j=c(b({assignmentPoints:f,rubricPoints:g})),k=function(a){h=!0,i=a===!0,j.remove(),c("#edit_rubric_form").submit()};return j.dialog({buttons:{Change:k,"Leave different":function(){k(!0)}},width:320,resizable:!1,close:j.remove}),!1}}return a.skip_updating_points_possible=i,i=!1,h=!1,a},beforeSubmit:function(a){var b=c(this).parents(".rubric");return b.find("thead .title").text(a["rubric[title]"]),b.find(".rubric_total").text(a.points_possible),b.removeClass("editing"),b.attr("id")=="rubric_new"?b.attr("id","rubric_adding"):b.prev(".rubric").remove(),c(this).parents("tr").hide(),b.loadingImage(),b},success:function(a,b){var d=a.rubric;b.loadingImage("remove"),d.rubric_association_id=a.rubric_association.id,d.permissions=d.permissions||{},a.rubric_association.permissions&&(d.permissions.update_association=a.rubric_association.permissions.update,d.permissions.delete_association=a.rubric_association.permissions["delete"]),e.updateRubric(b,d),a.rubric_association&&a.rubric_association.use_for_grading&&!a.rubric_association.skip_updating_points_possible&&(c("#full_assignment .points_possible").text(d.points_possible),c("#full_assignment input.points_possible").val(d.points_possible)),b.find(".rubric_title .links:not(.locked)").show()}}),c("#edit_rubric_form .cancel_button").click(function(){e.hideEditRubric(c(this).parents(".rubric"),!0)}),c("#rubrics").delegate(".add_criterion_link","click",function(a){var b=e.addCriterion(c(this).parents(".rubric"));return e.editCriterion(b),!1}).delegate(".find_outcome_link","click",function(a){return e.findOutcomeCriterion(c(this).parents(".rubric")),!1}).delegate(".criterion_description_value","click",function(a){return e.editCriterion(c(this).parents(".criterion")),!1}).delegate(".edit_criterion_link","click",function(a){return e.editCriterion(c(this).parents(".criterion")),!1}).delegate(".delete_criterion_link","click",function(a){var b=c(this).parents(".criterion");return b.fadeOut(function(){var a=b.parents(".rubric");b.remove(),e.updateCriteria(a),e.updateRubricPoints(a)}),!1}).delegate(".rating_description_value,.edit_rating_link","click",function(a){return e.editRating(c(this).parents(".rating")),!1}).bind("mouseover",function(a){$target=c(a.target),$target.closest(".ratings").length||e.hideCriterionAdd($target.parents(".rubric"))}).delegate(".rating","mousemove",function(a){var b=c(this),d=b.parents(".rubric");if(d.find(".rating.editing").length>0||b.parents(".criterion").hasClass("learning_outcome_criterion"))return e.hideCriterionAdd(d),!1;var f=10;if(!c.data(this,"hover_offset")){c.data(this,"hover_offset",b.offset()),c.data(this,"hover_width",b.outerWidth());var g=c.data(this,"points",parseFloat(b.find(".points").text())),h=c.data(this,"prev_points",parseFloat(b.prev(".rating").find(".points").text())),i=c.data(this,"next_points",parseFloat(b.next(".rating").find(".points").text()));c.data(this,"prev_diff",Math.abs(g-h)),c.data(this,"next_diff",Math.abs(g-i))}var j=c.data(this,"hover_offset"),k=c.data(this,"hover_width"),l=b.parents(".ratings"),m=a.pageX,n=a.pageY,o=!1;m<=j.left+k/2&&(o=!0);var p=l.data("hover_rating"),q=l.data("hover_left_side");if(!p||b[0]!=p[0]||o!=q){e.hideCriterionAdd(d);var r,s;o&&(r=b.prev(".rating"))&&r.length?(b.addClass("add_left"),r.addClass("add_right"),b[m>j.left+f?"removeClass":"addClass"]("add_column")):!o&&(s=b.next(".rating"))&&s.length&&(b.addClass("add_right"),s.addClass("add_left"),b[m<j.left+k-f?"removeClass":"addClass"]("add_column"))}else p&&(o?m<=j.left+f&&c.data(this,"prev_diff")>1?b.addClass("add_column"):b.removeClass("add_column"):m>=j.left+k-f&&c.data(this,"next_diff")>1?b.addClass("add_column"):b.removeClass("add_column"));return!1}).delegate(".rating","mouseout",function(a){c(this).data("hover_offset",null).data("hover_width",null)}).delegate(".delete_rating_link","click",function(a){a.preventDefault(),e.hideCriterionAdd(c(this).parents(".rubric")),c(this).parents(".rating").fadeOut(function(){var a=c(this).parents(".criterion");c(this).remove(),e.sizeRatings(a)})}).delegate(".add_column","click",function(a){var b=c(this),d=b.parents(".rubric");if(d.hasClass("editing")){var f=b.clone(!0).removeClass("edge_rating"),g=parseFloat(b.find(".points").text()),h=b.parents(".criterion"),i=h.find(".criterion_points"),j=parseFloat(i.val(),10)||5,k={description:"Rating Description"},l=b.hasClass("add_left");if(b.hasClass("add_left")){var m=parseFloat(b.prev(".rating").find(".points").text());k.points=Math.round((g+m)/2);if(k.points==g||k.points==m)k.points=g}else{var n=parseFloat(b.next(".rating").find(".points").text());k.points=Math.round((g+n)/2);if(k.points==g||k.points==n)k.points=n}f.fillTemplateData({data:k}),l?b.before(f):b.after(f),e.hideCriterionAdd(d),e.updateCriterionPoints(h),e.sizeRatings(h)}return!1}),c(".criterion_points").keydown(function(a){a.keyCode==13&&(e.updateCriterionPoints(c(this).parents(".criterion")),c(this).blur())}).blur(function(a){e.updateCriterionPoints(c(this).parents(".criterion"))}),c("#edit_criterion").delegate(".cancel_button","click",function(a){e.hideEditCriterion()}),c("#edit_criterion_form").submit(function(a){a.preventDefault(),a.stopPropagation();var b=c(this).parents("#edit_criterion").getFormData();b.criterion_description_value=b.description,delete b.description,c(this).parents(".criterion").fillTemplateData({data:b}),e.hideEditCriterion()}),c("#edit_rating").delegate(".cancel_button","click",function(a){e.hideEditRating()}),c("#edit_rating_form").submit(function(a){a.preventDefault(),a.stopPropagation();var b=c(this).parents("#edit_rating").getFormData();b.points=parseFloat(b.points),isNaN(b.points)&&(b.points=parseFloat(c(this).parents(".criterion").find(".criterion_points").val()),isNaN(b.points)&&(b.points=5));var d=c(this).parents(".rating");d.fillTemplateData({data:b}),d.prev(".rating").length===0&&c(this).parents(".criterion").find(".criterion_points").val(b.points),e.updateCriterionPoints(c(this).parents(".criterion"),!0)}),c("#edit_rubric_form .rubric_custom_rating").change(function(){c(this).parents(".rubric").find("tr.criterion").find(".ratings").showIf(!c(this).attr("checked")).end().find(".custom_ratings").showIf(c(this).attr("checked"))}).triggerHandler("change"),c("#edit_rubric_form #totalling_rubric").change(function(){c(this).parents(".rubric").find(".total_points_holder").showIf(!c(this).attr("checked"))}),c("#edit_rubric_form .grading_rubric_checkbox").change(function(){c(this).parents(".rubric").find(".totalling_rubric").css("visibility",c(this).attr("checked")?"hidden":"visible"),c(this).parents(".rubric").find(".totalling_rubric_checkbox").attr("checked",!1)}).triggerHandler("change"),c("#criterion_blank").find(".criterion_points").val("5"),c("#default_rubric").find(".criterion").length<=1&&e.addCriterion(c("#default_rubric")),setInterval(e.sizeRatings,1e4),c.publish("edit_rubric/initted")},c(function(){e.init()})})