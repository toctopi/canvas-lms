define(["i18n!instructure","jquery","str/htmlEscape","jquery.keycodes","vendor/date","jqueryui/datepicker","jqueryui/sortable","jqueryui/widget"],function(a,b,c){b.parseDateTime=function(a,c){var a=b.datepicker.parseDate("mm/dd/yy",a);if(c){var d=c.split(":"),e=parseInt(d[0],10);e==12&&(e=0),c.match(/pm/i)&&(e+=12);var f=0;d[1]&&(f=d[1].replace(/(am|pm)/gi,"")),a.setHours(e),a.setMinutes(f)}else a.setHours(0),a.setMinutes(0);return a.date=a,a},b.formatDateTime=function(a,b){var c="",d="";a&&(a.date=a.date||a),b.object_name&&(c+=b.object_name+"[",d="]"+d),b.property_name&&(c+=b.property_name);var e={};return a&&!isNaN(a.date.getFullYear())?(e[c+"(1i)"+d]=a.getFullYear(),e[c+"(2i)"+d]=a.getMonth()+1,e[c+"(3i)"+d]=a.getDate(),e[c+"(4i)"+d]=a.getHours(),e[c+"(5i)"+d]=a.getMinutes()):(e[c+"(1i)"+d]="",e[c+"(2i)"+d]="",e[c+"(3i)"+d]="",e[c+"(4i)"+d]="",e[c+"(5i)"+d]=""),e},b.parseFromISO=function(a,c){var d=parseInt(b("#time_zone_offset").text(),10)/-60,e=new Date;c=c||"event";try{var f={};if(!a)return b.parseFromISO.defaults;var g=a.substring(0,4),h=a.substring(5,7),i=a.substring(8,10),j=parseInt(a.substring(19),10)||0;f.date=new Date(g,h-1,i),f.date.getTimezoneOffset()!=e.getTimezoneOffset()&&(d-=(f.date.getTimezoneOffset()-e.getTimezoneOffset())/60);var k=d-j;f.date_sortable=a.substring(0,10),f.date_string=h+"/"+i+"/"+g,f.date_formatted=b.dateString(f.date);var l=a.substring(11,13),m=a.substring(14,16),n=a.substring(17,19),o=parseInt(l,10)*1e3*3600;k&&!isNaN(k)&&(o+=k*1e3*3600);var p=parseInt(m,10)*1e3*60,q=parseInt(n,10)*1e3,r=o+p+q||0,s=Date.UTC(g,h-1,i)||0;f.time_timestamp=r/1e3,f.date_timestamp=s/1e3;var t=f.date.getTimezoneOffset()*6e4,u=new Date(s+r+t),v="am";o=u.getHours(),o>12?(o-=12,v="pm"):o==12?v="pm":o===0&&(o=12);var w=o,x=":";u.getMinutes()<10&&(x+="0"),x+=u.getMinutes(),u.getMinutes()!==0&&(w+=x);var y=c=="due_date"?"by":"at",z=" "+y+" "+w+v;f.show_time=!0;var A=u.getHours();return A<10&&(A="0"+A),f.time_sortable=A+x,w+=v,f.time_formatted=w,f.time_string=o+x+v,f.time=u,f.datetime=u,f.date_formatted=b.dateString(f.datetime),f.datetime_formatted=f.date_formatted+z,f.timestamp=(r+s)/1e3,f.minute_timestamp=f.timestamp-f.timestamp%60,f}catch(B){return b.parseFromISO.defaults}},b.fudgeDateForProfileTimezone=function(a,c){var d=new Date,e=parseInt(b("#time_zone_offset").text(),10)*-1;a.getTimezoneOffset()!=d.getTimezoneOffset()&&(e-=a.getTimezoneOffset()-d.getTimezoneOffset());var f=e+a.getTimezoneOffset();if(f==0)return a;time=a.getTime(),time+=f*60*1e3*(c===!0?-1:1);var g=new Date;return g.setTime(time),g},b.unfudgeDateForProfileTimezone=function(a){return b.fudgeDateForProfileTimezone(a,!0)},b.parseFromDateUTC=function(a,c){return b.parseFromISO(b.dateToISO8601UTC(a),c)},b.parseFromISO.ref_date=new Date,b.parseFromISO.offset=b.parseFromISO.ref_date.getTimezoneOffset()*6e4,b.parseFromISO.defaults={date:new Date(b.parseFromISO.offset),date_sortable:"0000-00-00",date_string:"",date_formatted:"",time_timestamp:0,date_timestamp:0,timestamp:0,time:new Date(b.parseFromISO.offset),time_formatted:"",time_string:""},b.dateToISO8601UTC=function(a){var b=function(a){return a<10?"0"+a:a};return a.getUTCFullYear()+"-"+b(a.getUTCMonth()+1)+"-"+b(a.getUTCDate())+"T"+b(a.getUTCHours())+":"+b(a.getUTCMinutes())+":"+b(a.getUTCSeconds())+"Z"},b.dateToISO8601=function(a){var b=function(a){a<10?"0"+a:a};return a.getFullYear()+"-"+b(a.getMonth()+1)+"-"+b(a.getDate())+"T"+b(a.getHours())+":"+b(a.getMinutes())+":"+b(a.getSeconds())+"Z"};var d=new Date;b.thisYear=function(a){return a&&a.getFullYear()==d.getFullYear()},b.dateString=function(a){return a&&a.toString(b.thisYear(a)?"MMM d":"MMM d, yyyy")||""},b.timeString=function(a){return a&&a.toString("h:mmtt").toLowerCase()||""},b.friendlyDatetime=function(c,d){var e=Date.today();return Date.equals(c.clone().clearTime(),e)?a.l("#time.formats.tiny",c):b.friendlyDate(c,d)},b.friendlyDate=function(b,c){c==null&&(c="past");var d=Date.today(),e=b.clone().clearTime();return Date.equals(e,d)?a.t("#date.days.today","Today"):Date.equals(e,d.add(-1).days())?a.t("#date.days.yesterday","Yesterday"):Date.equals(e,d.add(1).days())?a.t("#date.days.tomorrow","Tomorrow"):c=="past"&&e<d&&e>=d.add(-6).days()?a.l("#date.formats.weekday",e):c=="future"&&e<d.add(7).days()&&e>=d?a.l("#date.formats.weekday",e):a.l("#date.formats.medium",e)},b.fn.parseFromISO=b.parseFromISO,b.datepicker.oldParseDate=b.datepicker.parseDate,b.datepicker.parseDate=function(a,c,d){return Date.parse((c||"").toString().replace(/ (at|by)/,""))||b.datepicker.oldParseDate(a,c,d)},b.datepicker._generateDatepickerHTML=b.datepicker._generateHTML,b.datepicker._generateHTML=function(d){var e=b.datepicker._generateDatepickerHTML(d);if(d.settings.timePicker){var f=d.input.data("time-hour")||"";f=f.replace(/'/g,"");var g=d.input.data("time-minute")||"";g=g.replace(/'/g,"");var h=d.input.data("time-ampm")||"",i=h=="am"?"selected":"",j=h=="pm"?"selected":"";e+="<div class='datepicker-time'><label for='ui-datepicker-time-hour'>"+c(a.beforeLabel("datepicker.time","Time"))+"</label> <input id='ui-datepicker-time-hour' type='text' value='"+f+"' title='hr' class='ui-datepicker-time-hour' style='width: 20px;'/>:<input type='text' value='"+g+"' title='min' class='ui-datepicker-time-minute' style='width: 20px;'/> <select class='ui-datepicker-time-ampm' title='"+c(a.t("datepicker.titles.am_pm","am/pm"))+"'><option value=''>&nbsp;</option><option value='am' "+i+">"+c(a.t("#time.am","am"))+"</option><option value='pm' "+j+">"+c(a.t("#time.pm","pm"))+"</option></select>&nbsp;&nbsp;&nbsp;<button type='button' class='button small-button ui-datepicker-ok'>"+c(a.t("#buttons.done","Done"))+"</button></div>"}return e},b.fn.realDatepicker=b.fn.datepicker;var e=b.datepicker._selectDay;b.datepicker._selectDay=function(a,c,d,f){var g=b(a);if(b(f).hasClass(this._unselectableClass)||this._isDisabledDatepicker(g[0]))return;var h=this._getInst(g[0]);if(h.settings.timePicker&&!b.datepicker.okClicked&&!h._keyEvent){var i=h.inline;h.inline=!0,b.data(g,"datepicker",h),e.call(this,a,c,d,f),h.inline=i,b.data(g,"datepicker",h)}else e.call(this,a,c,d,f)},b.fn.datepicker=function(a){return a=b.extend({},a),a.prevOnSelect=a.onSelect,a.onSelect=function(c,d){a.prevOnSelect&&a.prevOnSelect.call(this,c,d);var e=d.dpDiv,f=e.find(".ui-datepicker-time-hour").val()||b(this).data("time-hour"),g=e.find(".ui-datepicker-time-minute").val()||b(this).data("time-minute"),h=e.find(".ui-datepicker-time-ampm").val()||b(this).data("time-ampm");if(f){g=g||"00",h=h||"pm";var i=f+":"+g+" "+h;c+=" "+i}d.input.val(c).change()},b.fn.datepicker.timepicker_initialized||(b(document).delegate(".ui-datepicker-ok","click",function(a){var c=b.datepicker._curInst,d=c,e=b("td."+b.datepicker._dayOverClass+", td."+b.datepicker._currentClass,d.dpDiv);e[0]?(b.datepicker.okClicked=!0,b.datepicker._selectDay(c.input[0],d.selectedMonth,d.selectedYear,e[0]),b.datepicker.okClicked=!1):b.datepicker._hideDatepicker(null,b.datepicker._get(d,"duration"))}),b(document).delegate(".ui-datepicker-time-hour","change keypress focus blur",function(a){var c=b.datepicker._curInst;if(c){var d=b(this).val();c.input.data("time-hour",d)}}).delegate(".ui-datepicker-time-minute","change keypress focus blur",function(a){var c=b.datepicker._curInst;if(c){var d=b(this).val();c.input.data("time-minute",d)}}).delegate(".ui-datepicker-time-ampm","change keypress focus blur",function(a){var c=b.datepicker._curInst;if(c){var d=b(this).val();c.input.data("time-ampm",d)}}),b(document).delegate(".ui-datepicker-time-hour,.ui-datepicker-time-minute,.ui-datepicker-time-ampm","mousedown",function(a){b(this).focus()}),b(document).delegate(".ui-datepicker-time-hour,.ui-datepicker-time-minute,.ui-datepicker-time-ampm","change keypress focus blur",function(a){if(a.keyCode&&a.keyCode==13){var c=b.datepicker._curInst,d=c,e=b("td."+b.datepicker._dayOverClass+", td."+b.datepicker._currentClass,d.dpDiv);e[0]?(b.datepicker.okClicked=!0,b.datepicker._selectDay(c.input[0],d.selectedMonth,d.selectedYear,e[0]),b.datepicker.okClicked=!1):b.datepicker._hideDatepicker(null,b.datepicker._get(d,"duration"))}else a.keyCode&&a.keyCode==27&&b.datepicker._hideDatepicker(null,"")}),b.fn.datepicker.timepicker_initialized=!0),this.realDatepicker(a),b(document).data("last_datepicker",this),this},b.fn.date_field=function(a){return a=b.extend({},a),a.dateOnly=!0,this.datetime_field(a),this},b.fn.time_field=function(a){return a=b.extend({},a),a.timeOnly=!0,this.datetime_field(a),this},b.fn.datetime_field=function(c){return c=b.extend({},c),this.each(function(){var d=b(this);if(d.hasClass("datetime_field_enabled"))return;d.addClass("datetime_field_enabled"),c.timeOnly||d.datepicker({timePicker:!c.dateOnly,constrainInput:!1,dateFormat:"M d, yy",showOn:"button",buttonImage:"/images/datepicker.gif?1234",buttonImageOnly:!0});var e=b(this);d.next(".ui-datepicker-trigger").length>0&&(e=d.next());var f=b(document.createElement("div")).addClass("datetime_suggest");e.after(f),f=e.next(),d.bind("change focus blur keyup",function(){var d=b(this).val();c.timeOnly&&d&&parseInt(d,10)==d&&(d<8?d+="pm":d+="am");var e=Date.parse((d||"").toString().replace(/ (at|by)/,"")),f=a.t("errors.not_a_date","That's not a date!"),g=f;b(this).val()||(g=""),e&&(b(this).data("date",e),!c.timeOnly&&!c.dateOnly&&(e.getHours()||e.getMinutes()||c.alwaysShowTime)?(g=e.toString("ddd MMM d, yyyy h:mmtt"),b(this).data("time-hour",e.toString("h")).data("time-minute",e.toString("mm")).data("time-ampm",e.toString("tt").toLowerCase())):c.timeOnly?g=e.toString("h:mmtt").toLowerCase():g=e.toString("ddd MMM d, yyyy"));var h=b(this).parent().children(".datetime_suggest");h&&(h.toggleClass("invalid_datetime",g==f),h.text(g))}).triggerHandler("change")}),this},b.datetime={},b.datetime.shortFormat="MMM d, yyyy",b.datetime.defaultFormat="MMM d, yyyy h:mmtt",b.datetime.sortableFormat="yyyy-MM-ddTHH:mm:ss",b.datetime.clean=function(a){var c=Date.parse((a||"").toString("yyyy-MM-ddTHH:mm:ss").replace(/ (at|by)/,""))||a,d="";return c&&(c.getHours()||c.getMinutes()?d=c.toString(b.datetime.defaultFormat):d=c.toString(b.datetime.shortFormat)),d},b.datetime.process=function(a){var c=a;typeof a=="string"&&(c=Date.parse((a||"").toString().replace(/ (at|by)/,"")));var d="";return c&&(d=c.toString(b.datetime.sortableFormat)),d},b.fn.timepicker=function(){var a=b("#time_picker");return a.length===0&&(a=b._initializeTimepicker()),this.each(function(){b(this).focus(function(){var a=b(this).offset(),c=b(this).outerHeight(),d=b(this).outerWidth(),e=b("#time_picker");e.css({left:-1e3,height:"auto",width:"auto"}).show();var f=e.offset(),g=e.outerHeight(),h=e.outerWidth();e.css({top:a.top+c,left:a.left}).end(),b("#time_picker .time_slot").removeClass("ui-state-highlight").removeClass("ui-state-active"),e.data("attached_to",b(this)[0]);var i=b(window).height(),j=b(window).width(),k=b.windowScrollTop();a.top+c-k+g>i&&e.css({top:a.top-g}),a.left+h>j&&e.css({left:a.left+d-h}),b("#time_picker").hide().slideDown()}).blur(function(){b("#time_picker").data("attached_to")==b(this)[0]&&(b("#time_picker").data("attached_to",null),b("#time_picker").hide().find(".time_slot.ui-state-highlight").removeClass("ui-state-highlight"))}).keycodes("esc return",function(a){b(this).triggerHandler("blur")}).keycodes("ctrl+up ctrl+right ctrl+left ctrl+down",function(a){if(b("#time_picker").data("attached_to")!=b(this)[0])return;a.preventDefault();var c=b("#time_picker .time_slot.ui-state-highlight:first"),d=b(b("#time_picker").data("attached_to")).val(),e=12,f="00",g="pm",h;d&&d.length>=7&&(e=d.substring(0,2),f=d.substring(3,5),g=d.substring(5,7));if(c.length===0){h=parseInt(d,10)-1,isNaN(h)&&(h=0),b("#time_picker .time_slot").eq(h).triggerHandler("mouseover");return}if(a.keyString=="ctrl+up"){var i=c.parent(".widget_group");h=i.children(".time_slot").index(c),i.hasClass("ampm_group")?h=f/15:i.hasClass("minute_group")&&(h=parseInt(e,10)-1),i.prev(".widget_group").find(".time_slot").eq(h).triggerHandler("mouseover")}else if(a.keyString=="ctrl+right")c.next(".time_slot").triggerHandler("mouseover");else if(a.keyString=="ctrl+left")c.prev(".time_slot").triggerHandler("mouseover");else if(a.keyString=="ctrl+down"){i=c.parent(".widget_group"),h=i.children(".time_slot").index(c);var j=i.next(".widget_group").find(".time_slot");h=Math.min(h,j.length-1),i.hasClass("hour_group")?h=f/15:i.hasClass("minute_group")&&(h=g=="am"?0:1),j.eq(h).triggerHandler("mouseover")}})}),this},b._initializeTimepicker=function(){var d=b(document.createElement("div"));d.attr("id","time_picker").css({position:"absolute",display:"none"});var e="<div class='widget_group hour_group'>";return e+="<div class='ui-widget ui-state-default time_slot'>01</div>",e+="<div class='ui-widget ui-state-default time_slot'>02</div>",e+="<div class='ui-widget ui-state-default time_slot'>03</div>",e+="<div class='ui-widget ui-state-default time_slot'>04</div>",e+="<div class='ui-widget ui-state-default time_slot'>05</div>",e+="<div class='ui-widget ui-state-default time_slot'>06</div>",e+="<div class='ui-widget ui-state-default time_slot'>07</div>",e+="<div class='ui-widget ui-state-default time_slot'>08</div>",e+="<div class='ui-widget ui-state-default time_slot'>09</div>",e+="<div class='ui-widget ui-state-default time_slot'>10</div>",e+="<div class='ui-widget ui-state-default time_slot'>11</div>",e+="<div class='ui-widget ui-state-default time_slot'>12</div>",e+="<div class='clear'></div>",e+="</div>",e+="<div class='widget_group minute_group'>",e+="<div class='ui-widget ui-state-default time_slot'>00</div>",e+="<div class='ui-widget ui-state-default time_slot'>15</div>",e+="<div class='ui-widget ui-state-default time_slot'>30</div>",e+="<div class='ui-widget ui-state-default time_slot'>45</div>",e+="<div class='clear'></div>",e+="</div>",e+="<div class='widget_group ampm_group'>",e+="<div class='ui-widget ui-state-default time_slot'>"+c(a.t("#time.am","am"))+"</div>",e+="<div class='ui-widget ui-state-default time_slot'>"+c(a.t("#time.pm","pm"))+"</div>",e+="<div class='clear'></div>",e+="</div>",d.html(e),b("body").append(d),d.find(".time_slot").mouseover(function(){d.find(".time_slot.ui-state-highlight").removeClass("ui-state-highlight"),b(this).addClass("ui-state-highlight");var a=b(d.data("attached_to")||"none"),c=a.val(),e=12,f="00",g="pm";c&&c.length>=7&&(e=c.substring(0,2),f=c.substring(3,5),g=c.substring(5,7));var h=b(this).text();h>0&&h<=12?e=h:h=="am"||h=="pm"?g=h:f=h,a.val(e+":"+f+g)}).mouseout(function(){b(this).removeClass("ui-state-highlight")}).mousedown(function(a){a.preventDefault(),b(this).triggerHandler("mouseover"),b(this).removeClass("ui-state-highlight").addClass("ui-state-active")}).mouseup(function(){b(this).removeClass("ui-state-active")}).click(function(a){a.preventDefault(),b(this).triggerHandler("mouseover"),d.data("attached_to")&&b(d.data("attached_to")).focus(),d.stop().hide().data("attached_to",null)}),d}})