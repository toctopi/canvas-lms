define(["INST","i18n!select_content_dialog","jquery","jquery.ajaxJSON","jquery.instructure_forms","jqueryui/dialog","jquery.instructure_misc_helpers","jquery.instructure_misc_plugins","jquery.keycodes","jquery.loadingImg","jquery.templateData"],function(a,b,c){c(document).ready(function(){var d=null,e=c("#select_context_content_dialog");attachAddAssignment(c("#assignments_select .module_item_select")),a=a||{},a.selectContentDialog=function(a){var f=a.for_modules,g=a.select_button_text||b.t("buttons.add_item","Add Item"),h=a.holder_name||"module",i=a.dialog_title||b.t("titles.add_item_to_module","Add Item to Module"),j=f;e.data("submitted_function",a.submit),e.find(".context_module_content").showIf(f),e.find(".holder_name").text(h),e.find(".add_item_button").text(g),e.find(".select_item_name").showIf(!a.no_name_input);if(j&&!d){var k=c("#content_tag_services").empty();c.getUserServices("BookmarkService",function(a){for(var d in a){service=a[d].user_service,$service=c("<a href='#' class='bookmark_service no-hover'/>"),$service.addClass(service.service),$service.data("service",service),$service.attr("title",b.t("titles.find_links_using_service","Find links using %{service}",{service:service.service}));var e=c("<img/>");e.attr("src","/images/"+service.service+"_small_icon.png"),$service.append(e),$service.click(function(a){a.preventDefault(),c.findLinkForService(c(this).data("service").service,function(a){c("#content_tag_create_url").val(a.url),c("#content_tag_create_title").val(a.title)})}),k.append($service),k.append("&nbsp;&nbsp;")}})}c("#select_context_content_dialog #external_urls_select :text").val(""),c("#select_context_content_dialog #context_module_sub_headers_select :text").val(""),c("#add_module_item_select").change(),c("#select_context_content_dialog .module_item_select").change(),c("#select_context_content_dialog").dialog("close").dialog({autoOpen:!0,title:i,width:400}).dialog("open"),c("#select_context_content_dialog").dialog("option","title",i)},c("#select_context_content_dialog .cancel_button").click(function(){c("#select_context_content_dialog").dialog("close")}),c("#select_context_content_dialog .item_title").keycodes("return",function(){c(this).parents(".module_item_option").find(".add_item_button").click()}),c("#select_context_content_dialog .add_item_button").click(function(){var a=function(a){c("#select_context_content_dialog").dialog("close");var b=e.data("submitted_function");b&&c.isFunction(b)&&b(a)},d=c("#add_module_item_select").val();if(d=="external_url"){var f={"item[type]":c("#add_module_item_select").val(),"item[id]":c("#select_context_content_dialog .module_item_option:visible:first .module_item_select").val(),"item[indent]":c("#content_tag_indent").val()};f["item[url]"]=c("#content_tag_create_url").val(),f["item[title]"]=c("#content_tag_create_title").val(),a(f)}else if(d=="context_external_tool"){var f={"item[type]":c("#add_module_item_select").val(),"item[id]":c("#context_external_tools_select .tools .tool.selected").data("id"),"item[new_tab]":c("#external_tool_create_new_tab").attr("checked")?"1":"0","item[indent]":c("#content_tag_indent").val()};f["item[url]"]=c("#external_tool_create_url").val(),f["item[title]"]=c("#external_tool_create_title").val(),a(f)}else if(d=="context_module_sub_header"){var f={"item[type]":c("#add_module_item_select").val(),"item[id]":c("#select_context_content_dialog .module_item_option:visible:first .module_item_select").val(),"item[indent]":c("#content_tag_indent").val()};f["item[title]"]=c("#sub_header_title").val(),a(f)}else{var g=c("#select_context_content_dialog .module_item_option:visible:first .module_item_select option:selected");g.each(function(){var e=c(this),f={"item[type]":d,"item[id]":e.val(),"item[title]":e.text(),"item[indent]":c("#content_tag_indent").val()};if(f["item[id]"]=="new"){c("#select_context_content_dialog").loadingImage();var g=c("#select_context_content_dialog .module_item_option:visible:first .new .add_item_url").attr("href"),h=c("#select_context_content_dialog .module_item_option:visible:first").getFormData(),i=function(b){c("#select_context_content_dialog").loadingImage("remove");var d=b[f["item[type]"]];f["item[id]"]=d.id,f["item[title]"]=c("#select_context_content_dialog .module_item_option:visible:first .item_title").val(),f["item[title]"]=f["item[title]"]||d.display_name;var e=c(document.createElement("option"));e.val(d.id).text(f["item[title]"]),c("#"+f["item[type]"]+"s_select").find(".module_item_select option:last").before(e),a(f)};f["item[type]"]=="attachment"?c.ajaxJSONFiles(g,"POST",h,c("#module_attachment_uploaded_data"),function(a){i(a)},function(a){c("#select_context_content_dialog").loadingImage("remove"),c("#select_context_content_dialog").errorBox(b.t("errors.failed_to_create_item","Failed to Create new Item"))}):c.ajaxJSON(g,"POST",h,function(a){i(a)},function(a){c("#select_context_content_dialog").loadingImage("remove"),c("#select_context_content_dialog").errorBox(b.t("errors.failed_to_create_item","Failed to Create new Item"))})}else a(f)})}}),c("#context_external_tools_select .tools").delegate(".tool","click",function(){var a=c(this);if(c(this).hasClass("selected")&&!c(this).hasClass("resource_selection")){c(this).removeClass("selected");return}a.parents(".tools").find(".tool.selected").removeClass("selected"),a.addClass("selected");if(a.hasClass("resource_selection")){var d=a.data("tool"),e=Math.max(Math.min(c(window).height()-100,550),100),f=d.resource_selection_settings.selection_width,g=d.resource_selection_settings.selection_height,h=c("#resource_selection_dialog");h.length==0&&(h=c("<div/>",{id:"resource_selection_dialog",style:"padding: 0; overflow-y: hidden;"}),h.append(c("<iframe/>",{id:"resource_selection_iframe",style:"width: 800px; height: "+e+"px; border: 0;",src:"/images/ajax-loader-medium-444.gif",borderstyle:"0"})),c("body").append(h.hide()),h.dialog({autoOpen:!1,width:"auto",resizable:!0,close:function(){h.find("iframe").attr("src","/images/ajax-loader-medium-444.gif")},title:b.t("link_from_external_tool","Link Resource from External Tool")}).bind("dialogresize",function(){c(this).find("iframe").add(".fix_for_resizing_over_iframe").height(c(this).height()).width(c(this).width())}).bind("dialogresizestop",function(){c(".fix_for_resizing_over_iframe").remove()}).bind("dialogresizestart",function(){c(this).find("iframe").each(function(){c('<div class="fix_for_resizing_over_iframe" style="background: #fff;"></div>').css({width:this.offsetWidth+"px",height:this.offsetHeight+"px",position:"absolute",opacity:"0.001",zIndex:1e7}).css(c(this).offset()).appendTo("body")})}).bind("selection",function(a,e){e.embed_type=="basic_lti"&&e.url?(c("#external_tool_create_url").val(e.url),c("#external_tool_create_title").val(e.text||d.name),c("#context_external_tools_select .domain_message").hide()):(alert(b.t("invalid_lti_resource_selection","There was a problem retrieving a valid link from the external tool")),c("#external_tool_create_url").val(""),c("#external_tool_create_title").val("")),c("#resource_selection_dialog iframe").attr("src","about:blank"),c("#resource_selection_dialog").dialog("close")})),h.dialog("close").dialog("option","width",f||800).dialog("option","height",g||e||400).dialog("open"),h.triggerHandler("dialogresize");var i=c.replaceTags(c("#select_content_resource_selection_url").attr("href"),"id",d.id);h.find("iframe").attr("src",i)}else c("#external_tool_create_url").val(a.data("url")||""),c("#context_external_tools_select .domain_message").showIf(a.data("domain")).find(".domain").text(a.data("domain")),c("#external_tool_create_title").val(a.data("name"))});var f=c("#context_external_tools_select .tools .tool:first").detach();c("#add_module_item_select").change(function(){c("#select_context_content_dialog .module_item_option").hide(),c("#"+c(this).val()+"s_select").show().find(".module_item_select").change();if(c(this).val()=="context_external_tool"){var a=c("#context_external_tools_select");if(!a.hasClass("loaded")){a.find(".message").text("Loading...");var d=c("#select_context_content_dialog .external_tools_url").attr("href");c.ajaxJSON(d,"GET",{},function(b){a.find(".message").remove(),a.addClass("loaded"),a.find(".tools").empty();for(var c in b){var d=b[c];if(d.url||d.domain||d.resource_selection_settings){var e=f.clone(!0);e.toggleClass("resource_selection",!!d.resource_selection_settings),e.fillTemplateData({data:d,dataValues:["id","url","domain","name"]}),e.data("tool",d),a.find(".tools").append(e.show())}}},function(c){a.find(".message").text(b.t("errors.loading_failed","Loading Failed"))})}}}),c("#select_context_content_dialog .module_item_select").change(function(){c(this).val()=="new"?c(this).parents(".module_item_option").find(".new").show().focus().select():c(this).parents(".module_item_option").find(".new").hide()})})})