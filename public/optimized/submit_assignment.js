define(["i18n!assignments","jquery","jquery.rails_flash_notifications","jquery.ajaxJSON","jquery.inst_tree","jquery.instructure_forms","jqueryui/dialog","jquery.instructure_misc_plugins","jquery.templateData","media_comments","tinymce.editor_box","vendor/jquery.scrollTo","jqueryui/tabs"],function(a,b){window.submissionAttachmentIndex=-1,b(document).ready(function(){function c(){b("#submit_online_upload_form .remove_attachment_link").showIf(b("#submit_online_upload_form .submission_attachment:not(#submission_attachment_blank)").length>1)}function d(){b("#submit_online_upload_form button[type=submit]").attr("disabled",!!b(".bad_ext_msg:visible").length)}var e=!1,f=b(".submit_assignment_form");f.delegate("#submission_comment","focus",function(a){var c=b(this);c.val().trim()===""&&c.css("height","72px")}).delegate("#submission_comment","blur",function(a){var c=b(this);c.val().trim()===""&&c.css("height","16px")}),f.submit(function(c){var d=b(this).find(".turnitin_pledge");if(d.length>0&&!d.attr("checked"))return alert(a.t("messages.agree_to_pledge","You must agree to the submission pledge before you can submit this assignment.")),c.preventDefault(),c.stopPropagation(),!1;var f=!b(this).is("#submit_online_text_entry_form")||b(this).validateForm({object_name:"submission",required:["body"]});if(!f)return!1;b(this).find("button[type='submit']").text(a.t("messages.submitting","Submitting...")),b(this).find("button").attr("disabled",!0);if(b(this).attr("id")=="submit_online_upload_form"){c.preventDefault()&&c.stopPropagation();var g=b(this).find("input[type=file]:visible").filter(function(){return b(this).val()!==""}),h=b(this).find("#submission_attachment_ids").val();if(g.length===0&&h==="")return b.flashError(a.t("#errors.no_attached_file","You must attach at least one file to this assignment")),b(this).find("button[type=submit]").text(a.t("#button.submit_assignment","Submit Assignment")).prop("disabled",!1),!1;b.ajaxJSONPreparedFiles.call(this,{handle_files:function(a,b){var c=(b["submission[attachment_ids]"]||"").split(",");for(var d in a)c.push(a[d].attachment.id);return b["submission[attachment_ids]"]=c.join(","),b},context_code:b("#submit_assignment").data("context_code"),asset_string:b("#submit_assignment").data("asset_string"),intent:"submit",file_elements:g,formData:b(this).getFormData(),formDataTarget:"url",url:b(this).attr("action"),success:function(a){e=!0,window.location=window.location.href.replace(window.location.hash,"")},error:function(c){b(this).find("button[type='submit']").text(a.t("messages.submit_failed","Submit Failed, please try again")),b(this).find("button").attr("disabled",!1)}})}else e=!0}),window.onbeforeunload=function(){if(b("#submit_assignment:visible").length>0&&!e)return a.t("messages.not_submitted_yet",'You haven\'t finished submitting your assignment.  You still need to click "Submit" to finish turning it in.  Do you want to leave this page anyway?')},b(document).fragmentChange(function(a,c){c&&c.indexOf("#submit")==0&&(b(".submit_assignment_link").triggerHandler("click",!0),c=="#submit_google_doc"&&b("#submit_assignment_tabs").tabs("select","#submit_google_doc_form"))}),b(".submit_assignment_link").click(function(c,d){c.preventDefault();var e=b(this).hasClass("late"),f=new Date;if(e&&!d){var g;b(".resubmit_link").length>0?g=confirm(a.t("messages.now_overdue","This assignment is now overdue.  Any new submissions will be marked as late.  Continue anyway?")):g=confirm(a.t("messages.overdue","This assignment is overdue.  Do you still want to submit it?"));if(!g)return}hideFullAssignmentForm(),b("#submit_assignment").show(),b(".submit_assignment_link").hide(),b("html,body").scrollTo(b("#submit_assignment")),b("#submit_online_text_entry_form textarea:first").editorBox()}),b("#switch_text_entry_submission_views").click(function(a){a.preventDefault(),b("#submit_online_text_entry_form textarea:first").editorBox("toggle")}),b(".submit_assignment_form .cancel_button").click(function(){b("#submit_assignment").hide(),b(".submit_assignment_link").show()}),b("#submit_assignment_tabs").tabs(),b("#uploaded_files > ul").instTree({autoclose:!1,multi:!0,dragdrop:!1,onClick:function(a,c){b("#submission_attachment_ids").val("");var d=[];b("#uploaded_files .file.active-leaf").each(function(){var a=b(this).getTemplateData({textValues:["id"]}).id;d.push(a)}),b("#submission_attachment_ids").val(d.join(","))}}),b(".toggle_uploaded_files_link").click(function(a){a.preventDefault(),b("#uploaded_files").slideToggle()}),b(".add_another_file_link").click(function(a){a.preventDefault(),b("#submission_attachment_blank").clone(!0).removeAttr("id").show().insertBefore(this).find("input").attr("name","attachments["+ ++submissionAttachmentIndex+"][uploaded_data]"),c()}).click(),b(".remove_attachment_link").click(function(a){a.preventDefault(),b(this).parents(".submission_attachment").remove(),d(),c()}),b(".submission_attachment input[type=file]").live("change",function(){if(ENV.SUBMIT_ASSIGNMENT.ALLOWED_EXTENSIONS.length<1||b(this).val()=="")return;var a=b(this).val().split(".").pop().toLowerCase();b(this).parent().find(".bad_ext_msg").showIf(b.inArray(a,ENV.SUBMIT_ASSIGNMENT.ALLOWED_EXTENSIONS)<0),d()})}),b(document).ready(function(){b("#google_docs_tree").instTree({autoclose:!1,multi:!1,dragdrop:!1}),b("#google_docs_tree li.file").click(function(a){if(b(a.target).closest(".popout").length>0)return;a.preventDefault(),a.stopPropagation(),b("#google_docs_tree li.file.active").removeClass("active"),b(this).addClass("active"),b("#submit_google_doc_form").find("input[name='google_doc[document_id]']").val(b(this).attr("id").substring(9))}),b("#google_docs_tree li.folder").click(function(a){b(a.target).closest(".sign").length==0&&b(a.target).closest(".file,.folder").hasClass("folder")&&b(this).find(".sign").click()})}),b("#submit_google_doc_form").submit(function(){b("#uploading_google_doc_message").dialog("close").dialog({autoOpen:!1,title:a.t("titles.uploading","Uploading Submission"),modal:!0,overlay:{backgroundColor:"#000",opacity:.7}}).dialog("open")}),b(document).ready(function(){b("#submit_media_recording_form .submit_button").attr("disabled",!0).text(a.t("messages.record_before_submitting","Record Before Submitting")),b("#media_media_recording_submission_holder .record_media_comment_link").click(function(c){c.preventDefault(),b("#media_media_recording_submission").mediaComment("create","any",function(c,d){b("#submit_media_recording_form .submit_button").attr("disabled",!1).text(a.t("buttons.submit_assignment","Submit Assignment")),b("#submit_media_recording_form .media_comment_id").val(c),b("#submit_media_recording_form .media_comment_type").val(d),b("#media_media_recording_submission_holder").children().hide(),b("#media_media_recording_ready").show(),b("#media_media_recording_thumbnail").attr("id","media_comment_"+c)})})})})