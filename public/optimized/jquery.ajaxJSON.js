define(["jquery","jquery.instructure_forms"],function(a){a.originalGetJSON=a.getJSON,a.getJSON=function(b,c,d){var e=a.originalGetJSON(b,c,d);return a.ajaxJSON.storeRequest(e,b,"GET",c),e};var b=function(a,b){if(!a[b])throw b+" option is required"};a.ajaxJSONPreparedFiles=function(c){b(c,"context_code");var d=[],e=this,f=c.files||c.file_elements||[];for(var g=0;g<f.length;g++){var h=f[g];h.name=(h.value||h.name).split(/(\/|\\)/).pop(),d.push(h)}var i=[],j=function(){var b=c.formDataTarget=="url"?c.formData:{};if(c.handle_files){var d=i;c.single_file&&(d=i[0]),b=c.handle_files.call(this,d,b)}c.url&&c.success&&b!==!1&&a.ajaxJSON(c.url,c.method,b,c.success,c.error)},k=function(b,d){a.ajaxJSON(c.uploadDataUrl||"/files/pending","POST",b,function(b){try{if(b&&b.upload_url){var f=b.upload_params,g=a(d).attr("name");a(d).attr("name",b.file_param),a.ajaxJSONFiles(b.upload_url,"POST",f,a(d),function(b){i.push(b),a(d).attr("name",g),l.call(e)},function(b){a(d).attr("name",g),(c.upload_error||c.error).call(e,b)},{onlyGivenParameters:b.remote_url})}else(c.upload_error||c.error).call(e,b)}catch(h){var j=h}},function(){return(c.upload_error||c.error).apply(this,arguments)})},l=function(){var b=d.shift();b?k.call(e,a.extend({"attachment[folder_id]":c.folder_id,"attachment[intent]":c.intent,"attachment[asset_string]":c.asset_string,"attachment[filename]":b.name,"attachment[context_code]":c.context_code},c.formDataTarget=="uploadDataUrl"?c.formData:{}),b):j.call(e)};l.call(e)},a.ajaxJSONFiles=function(b,c,d,e,f,g,h){var i=a(document.createElement("form"));i.attr("action",b).attr("method",c),d.authenticity_token||(d.authenticity_token=a("#ajax_authenticity_token").text());var j={};e.each(function(){j[a(this).attr("name")]=!0});for(var k in d)if(!j[k]){var l=a(document.createElement("input"));l.attr("type","hidden").attr("name",k).attr("value",d[k]),i.append(l)}e.each(function(){var b=a(this).clone(!0);a(this).after(b),i.append(a(this)),a(this).removeAttr("id")}),a("body").append(i.hide()),i.formSubmit({fileUpload:!0,success:f,onlyGivenParameters:h?h.onlyGivenParameters:!1,error:g}),function(){i.submit()}.call(i)},a.ajaxJSON=function(b,c,d,e,f,g){d=d||{};if(!b&&f){f(null,null,"URL required for requests",null);return}b=b||".",c!="GET"&&(d._method=c,c="POST",d.authenticity_token||(d.authenticity_token=a("#ajax_authenticity_token").text())),a("#page_view_id").length>0&&!d.page_view_id&&(!g||!g.skipPageViewLog)&&(d.page_view_id=a("#page_view_id").text());var h=function(b,c,d){var e=b;if(b.responseText){var h=b.responseText.replace(/(<([^>]+)>)/ig,"");e={message:h};try{e=a.parseJSON(b.responseText)}catch(i){}}g&&g.skipDefaultError&&a.ajaxJSON.ignoredXHRs.push(b),f&&a.isFunction(f)?f(e,b,c,d):a.ajaxJSON.unhandledXHRs.push(b)},i={url:b,dataType:"json",type:c,success:function(b){b=b||{};var c=null;j&&j.getResponseHeader&&(c=j.getResponseHeader("X-Canvas-Page-View-Id"))&&setTimeout(function(){a(document).triggerHandler("page_view_id_received",c)},50),!b.length&&b.errors?(h(b.errors,null,""),!g||!g.skipDefaultError?a.fn.defaultAjaxError.func.call(a.fn.defaultAjaxError.object,null,b,"0",b.errors):a.ajaxJSON.ignoredXHRs.push(j)):e&&a.isFunction(e)&&e(b,j)},error:function(){h.apply(this,arguments)},data:d};g&&g.timeout&&(i.timeout=g.timeout);var j=a.ajax(i);return a.ajaxJSON.storeRequest(j,b,c,d),j},a.ajaxJSON.unhandledXHRs=[],a.ajaxJSON.ignoredXHRs=[],a.ajaxJSON.passedRequests=[],a.ajaxJSON.storeRequest=function(b,c,d,e){a.ajaxJSON.passedRequests.push({xhr:b,url:c,submit_type:d,data:e})},a.ajaxJSON.findRequest=function(b){var c=a.ajaxJSON.passedRequests;for(var d in c)if(c[d]&&c[d].xhr==b)return c[d];return null}})