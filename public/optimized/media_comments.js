define(["i18n!media_comments","jquery","str/htmlEscape","jquery.ajaxJSON","jqueryui/dialog","jquery.instructure_misc_helpers","jquery.instructure_misc_plugins","jqueryui/progressbar","jqueryui/tabs"],function(a,b,c){(function(b,d){var e=null;try{e=swfobject.getFlashPlayerVersion().major+"."+swfobject.getFlashPlayerVersion().minor,e=" (you have "+e+" installed)"}catch(f){}var g="<div>"+c(a.t("messages.flash_required","This video requires Flash version 9 or higher (you have %{version} installed).",{version:e}))+"<br/><a target='_blank' href='http://get.adobe.com/flashplayer/'>"+c(a.t("links.upgrade_flash","Click here to upgrade"))+"</a></div>";b.fn.mediaComment=function(c,e,f,h,i){var j=e,k=f,l=h;if(!d.kalturaSettings){console.log("Kaltura has not been enabled for this account");return}if(c=="create"){k=e;var m=f,n=h,o=i;b("#media_recorder_container").removeAttr("id").addClass("old_recorder_container"),this.attr("id","media_recorder_container").removeClass("old_recorder_container"),b(document).unbind("media_comment_created");var p=this;b(document).bind("media_comment_created",function(a,b){m.call(p,b.id,b.mediaType)}),b.mediaComment.init(k,{modal:!1,close:function(){n&&b.isFunction(n)&&n.call(p)},defaultTitle:o})}else if(c=="show_inline"){var q=b("<span/>");k!="video"&&k!="audio"&&(b(this).hasClass("audio_playback")?k="audio":k="video"),q.attr("id","media_comment_holder_"+Math.round(Math.random()*1e4));var r=b(this);b(this).parent(".instructure_file_link_holder").length>0&&(r=b(this).parent(".instructure_file_link_holder"));var s=function(a){r.append(q);var b=r.width(),c={},d={allowScriptAccess:"always",allowNetworking:"all",allowFullScreen:!0,bgcolor:"#000000",wmode:"opaque"},e="/media_objects/"+a+"/redirect",b=Math.min(r.closest("div,p,table").width()||550,550),f=b/550*448;k=="audio"&&(f=125,b=Math.min(b,350)),swfobject.embedSWF(e,q.attr("id"),b.toString(),f.toString(),"9.0.0",!1,c,d)};if(j=="maybe"){var t=l.replace(/\/download.*/,"");r.text("Loading..."),b.ajaxJSON(t,"GET",{},function(b){b.attachment&&b.attachment.media_entry_id&&b.attachment.media_entry_id!="maybe"?(r.text(""),s(b.attachment.media_entry_id)):r.text(a.t("messages.file_failed_to_load","This media file failed to load"))},function(){r.text(a.t("messages.file_failed_to_load","This media file failed to load"))})}else s(j)}else if(c=="show"){var u={},v={allowScriptAccess:"always",allowNetworking:"all",allowFullScreen:!0,bgcolor:"#000000",wmode:"opaque"},w="/media_objects/"+j+"/redirect",x=b("#media_comment_player_dialog");x.length||(x=b("<div id='media_comment_player_dialog'/>").appendTo("body")),x.dialog({title:a.t("titles.play_comment","Play Media Comment"),width:575,height:493,modal:!0,draggable:!1}).empty().css({padding:0,overflow:"hidden"}).append(b('<div id="media_comment_play" />').html(g)),swfobject.embedSWF(w,"media_comment_play","100%","100%","9.0.0",!1,u,v)}return this};var h=[],i=!1,j=function(){if(!h.length)return;i=!0;var a=Math.min(h.length,30),b;for(var c=0;c<a;c++)(b=h.shift())&&b.elem.createMediaCommentThumbnail(b);h.length>0?setTimeout(j,500):i=!1};b.fn.mediaCommentThumbnail=function(a,c){return b(this).each(function(){h.push({size:a,elem:b(this),keepOriginalText:c})}),i||(i=!0,setTimeout(j,500)),this},b.fn.createMediaCommentThumbnail=function(c){if(!d.kalturaSettings){console.log("Kaltura has not been enabled for this account");return}var e=c.size||"normal",f=c.only_show_icon,g=c.keepOriginalText,h=b.fn.mediaCommentThumbnail.sizes[e]||b.fn.mediaCommentThumbnail.sizes.normal;return this.each(function(){var c=b.trim(b(this).find(".media_comment_id:first").text());!c&&b(this).attr("id")&&b(this).attr("id").match(/^media_comment_/)&&(c=b(this).attr("id").substring(14)),c=c||b.trim(b(this).parent().find(".media_comment_id:first").text());if(c){var i="http://"+d.kalturaSettings.resource_domain;location.protocol==="https:"&&(i="https://"+(d.kalturaSettings.secure_resource_domain||d.kalturaSettings.domain)),i=i+"/p/"+d.kalturaSettings.partner_id+"/thumbnail/entry_id/",i+=c,i=i+"/width/"+h.width+"/height/"+h.height+"/bgcolor/000000/type/2/vid_sec/5";var j=b("<img/>");j.addClass("media_comment_thumbnail"),j.addClass("media_comment_thumbnail-"+e),f?j.attr("src","/images/media_comment.png"):(j.attr("src","/images/blank.png"),b(this).addClass("no-hover").addClass("no-underline"),j.hover(function(){j.attr("src","/images/play_overlay.png")},function(){j.attr("src","/images/blank.png")})),j.css("backgroundImage","url("+i+")"),j.attr("title",a.t("titles.click_to_view","Click to View"));var k=b(this);if(!g)b(this).empty();else{var k=b(this).clone().empty().removeClass("instructure_file_link");b(this).parent(".instructure_file_link_holder").length>0?b(this).parent(".instructure_file_link_holder").append(k):b(this).after(k)}k.addClass("instructure_inline_media_comment"),k.append(j).css({backgroundImage:"",padding:0}),b(this).append("<span class='media_comment_id' style='display: none;'>"+c+"</span>")}}),this},b.fn.mediaCommentThumbnail.sizes={normal:{width:140,height:100},small:{width:70,height:50}},b.mediaComment=function(a,c,d){var e=b("<div/>");b("body").append(e.hide()),b.fn.mediaComment.apply(e,arguments)},b.mediaComment.partnerData=function(a){return a=a||{},a.context_code=b.mediaComment.contextCode(),a.root_account_id=parseInt(b("#domain_root_account_id").text(),10)||0,JSON.stringify(a)},b.mediaComment.contextCode=function(){var a="";try{a=b.trim(b("#current_context_code").text())||b.trim("user_"+b("#identity .user_id").text())}catch(c){}return a};var k={};b.mediaComment.entryAdded=function(a,c,d,e){if(!a||k[a])return;k[a]=!0;var f={mediaType:c,entryId:a,title:d,userTitle:e},g=b.mediaComment.contextCode();if(f.mediaType==1||f.mediaType==2||f.mediaType==5||!0){var h="video";f.mediaType==2?h="image":f.mediaType==5&&(h="audio"),g&&b.ajaxJSON("/media_objects","POST",{id:f.entryId,type:h,context_code:g,title:f.title,user_entered_title:f.userTitle},function(a){b(document).triggerHandler("media_object_created",a)},function(a){}),b(document).triggerHandler("media_comment_created",{id:f.entryId,mediaType:h})}},b.mediaComment.audio_delegate={readyHandler:function(){b("#audio_upload")[0].setMediaType("audio")},selectHandler:function(){b.mediaComment.upload_delegate.selectHandler("audio")},singleUploadCompleteHandler:function(a){b.mediaComment.upload_delegate.singleUploadCompleteHandler("audio",a)},allUploadsCompleteHandler:function(){b.mediaComment.upload_delegate.allUploadsCompleteHandler("audio")},entriesAddedHandler:function(a){b.mediaComment.upload_delegate.entriesAddedHandler("audio",a)},progressHandler:function(a){b.mediaComment.upload_delegate.progressHandler("audio",a[0],a[1],a[2])},uploadErrorHandler:function(){b.mediaComment.upload_delegate.uploadErrorHandler("audio")}},b.mediaComment.video_delegate={readyHandler:function(){b("#video_upload")[0].setMediaType("video")},selectHandler:function(){b.mediaComment.upload_delegate.selectHandler("video")},singleUploadCompleteHandler:function(a){b.mediaComment.upload_delegate.singleUploadCompleteHandler("video",a)},allUploadsCompleteHandler:function(){b.mediaComment.upload_delegate.allUploadsCompleteHandler("video")},entriesAddedHandler:function(a){b.mediaComment.upload_delegate.entriesAddedHandler("video",a)},progressHandler:function(a){b.mediaComment.upload_delegate.progressHandler("video",a[0],a[1],a[2])},uploadErrorHandler:function(){b.mediaComment.upload_delegate.uploadErrorHandler("video")}},b.mediaComment.upload_delegate={currentType:"audio",submit:function(){var c=b.mediaComment.upload_delegate.currentType,d=b("#"+c+"_upload")[0].getFiles();d.length>1&&b("#"+c+"_upload")[0].removeFiles(0,d.length-2),d=b("#"+c+"_upload")[0].getFiles();if(d.length==0)return;b("#media_upload_progress").css("visibility","visible").progressbar({value:1}),b("#media_upload_submit").attr("disabled",!0).text(a.t("messages.submitting","Submitting Media File...")),b("#"+c+"_upload")[0].upload()},selectHandler:function(c){b.mediaComment.upload_delegate.currentType=c;var e=b("#"+c+"_upload")[0].getFiles();e.length>1&&b("#"+c+"_upload")[0].removeFiles(0,e.length-2);var f=b("#"+c+"_upload")[0].getFiles()[0];b("#media_upload_settings .icon").attr("src","/images/file-"+c+".png"),b("#media_upload_submit").show(),b("#media_upload_submit").attr("disabled",f?!1:!0),b("#media_upload_settings").css("visibility",f?"visible":"hidden"),b("#media_upload_title").val(f.title),b("#media_upload_display_title").text(f.title),b("#media_upload_file_size").text(b.fileSize(f.bytesTotal)),b("#media_upload_feedback_text").html(""),b("#media_upload_feedback").css("visibility","hidden");if(f.bytesTotal>d.kalturaSettings.max_file_size_bytes){b("#media_upload_feedback_text").html(a.t("errors.file_too_large","*This file is too large.* The maximum size is %{size}MB.",{size:d.kalturaSettings.max_file_size_bytes/1048576,wrapper:"<b>$1</b>"})),b("#media_upload_feedback").css("visibility","visible"),b("#media_upload_submit").hide();return}b("#media_upload_submit").click()},singleUploadCompleteHandler:function(a,c){b("#media_upload_progress").progressbar("option","value",100)},allUploadsCompleteHandler:function(a){b("#media_upload_progress").progressbar("option","value",100),b("#"+a+"_upload")[0].addEntries()},entriesAddedHandler:function(c,d){b("#media_upload_progress").progressbar("option","value",100);var e=d[0];b("#media_upload_submit").text(a.t("messages.submitted","Submitted Media File!")),setTimeout(function(){b("#media_comment_dialog").dialog("close")},1500),c=="audio"?e.entryType=5:c=="video"&&(e.entryType=1),b.mediaComment.entryAdded(e.entryId,e.entryType,e.title)},progressHandler:function(a,c,d,e){var f=100*c/d;b("#media_upload_progress").progressbar("option","value",f)},uploadErrorHandler:function(c){var d=b("#"+c+"_upload")[0].getError();b("#media_upload_errors").text(a.t("errors.upload_failed","Upload failed with error:")+" "+d),b("#media_upload_progress").hide()}};var l=!1,m=null;b.mediaComment.init=function(c,e){m=m||new Date,c=c||"any",e=e||{};var f=b.trim(b("#identity .user_name").text()||"");f&&(f=f+": "+(new Date).toString("ddd MMM d, yyyy"));var g=e.defaultTitle||f||a.t("titles.media_contribution","Media Contribution"),h=function(){b("#video_record_title,#audio_record_title").val(g),j.dialog({title:a.t("titles.record_upload_media_comment","Record/Upload Media Comment"),width:560,height:460,modal:!1}),j.dialog("option","close",function(){b("#audio_record").before("<div id='audio_record'/>").remove(),b("#video_record").before("<div id='video_record'/>").remove(),e&&e.close&&b.isFunction(e.close)&&e.close.call(j)}),b("#audio_record").before("<div id='audio_record'/>").remove(),b("#video_record").before("<div id='video_record'/>").remove();var f=j.data("ks");c=="video"?(b("#video_record_option").click(),b("#media_record_option_holder").hide(),b("#audio_upload_holder").hide(),b("#video_upload_holder").show()):c=="audio"?(b("#audio_record_option").click(),b("#media_record_option_holder").hide(),b("#audio_upload_holder").show(),b("#video_upload_holder").hide()):(b("#video_record_option").click(),b("#audio_upload_holder").show(),b("#video_upload_holder").show()),b(document).triggerHandler("reset_media_comment_forms");var h=b.trim(b("#identity .user_name").text())+" "+(new Date).toISOString();setTimeout(function(){var c={host:location.protocol+"//"+d.kalturaSettings.domain,rtmpHost:"rtmp://"+(d.kalturaSettings.rtmp_domain||d.kalturaSettings.domain),kshowId:"-1",pid:d.kalturaSettings.partner_id,subpid:d.kalturaSettings.subpartner_id,uid:j.data("uid")||"ANONYMOUS",ks:f,themeUrl:"/media_record/skin.swf",localeUrl:"/media_record/locale.xml",thumbOffset:"1",licenseType:"CC-0.1",showUi:"true",useCamera:"0",maxFileSize:d.kalturaSettings.max_file_size_bytes/1048576,maxUploads:1,partnerData:b.mediaComment.partnerData(),partner_data:b.mediaComment.partnerData(),entryName:h},e={align:"middle",quality:"high",bgcolor:"#ffffff",name:"KRecordAudio",allowScriptAccess:"sameDomain",type:"application/x-shockwave-flash",pluginspage:"http://www.adobe.com/go/getflashplayer",wmode:"opaque"};b("#audio_record").text(a.t("messages.flash_required_record_audio","Flash required for recording audio.")),swfobject.embedSWF("/media_record/KRecord.swf","audio_record","400","300","9.0.0",!1,c,e);var e=b.extend({},e,{name:"KRecordVideo"}),c=b.extend({},c,{useCamera:"1"});b("#video_record").html("Flash required for recording video."),swfobject.embedSWF("/media_record/KRecord.swf","video_record","400","300","9.0.0",!1,c,e)},d.browser.ie?500:10);var i={host:location.protocol+"//"+d.kalturaSettings.domain,partnerId:d.kalturaSettings.partner_id,subPId:d.kalturaSettings.subpartner_id,uid:j.data("uid")||"ANONYMOUS",entryId:"-1",ks:f,thumbOffset:"1",licenseType:"CC-0.1",maxFileSize:d.kalturaSettings.max_file_size_bytes/1048576,maxUploads:1,uiConfId:d.kalturaSettings.upload_ui_conf,jsDelegate:"$.mediaComment.audio_delegate"},k={align:"middle",quality:"high",bgcolor:"#ffffff",name:"KUpload",allowScriptAccess:"always",type:"application/x-shockwave-flash",pluginspage:"http://www.adobe.com/go/getflashplayer",wmode:"transparent"};b("#audio_upload").text(a.t("messages.flash_required_upload_audio","Flash required for uploading audio."));var m="180",n="50";swfobject.embedSWF("//"+d.kalturaSettings.domain+"/kupload/ui_conf_id/"+d.kalturaSettings.upload_ui_conf,"audio_upload",m,n,"9.0.0",!1,i,k),i=b.extend({},i,{jsDelegate:"$.mediaComment.video_delegate"}),b("#video_upload").text(a.t("messages.flash_required_upload_video","Flash required for uploading video."));var m="180",n="50";swfobject.embedSWF("//"+d.kalturaSettings.domain+"/kupload/ui_conf_id/"+d.kalturaSettings.upload_ui_conf,"video_upload",m,n,"9.0.0",!1,i,k);var o,p,q,r,s,t,u,v,w,x,y,z=!1;l=!0,setInterval(function(){l&&(o=b("#audio_record_holder"),p=b("#audio_record"),q=b("#audio_record_meter"),r=0,s=0,u=b("#video_record_holder"),v=b("#video_record"),w=b("#video_record_meter"),x=0,y=0,l=!1),r++,x++;var a=null,c=null;p&&p[0]&&p[0].getMicophoneActivityLevel&&p.parent().length?a=p[0].getMicophoneActivityLevel():p=b("#audio_record"),v&&v[0]&&v[0].getMicophoneActivityLevel&&v.parent().length?c=v[0].getMicophoneActivityLevel():v=b("#video_record");if(a!=null){a=Math.max(a,s),a>-1&&!o.hasClass("with_volume")&&(q.css("display","none"),b("#audio_record_holder").addClass("with_volume").animate({width:420},function(){q.css("display","")}));if(r>4){s=0,r=0;var d=(a-a%10)/10;q.attr("class","volume_meter band_"+d)}else s=a}if(c!=null){c=Math.max(c,y),c>-1&&!u.hasClass("with_volume")&&(w.css("display","none"),b("#video_record_holder").addClass("with_volume").animate({width:420},function(){w.css("display","")}));if(x>4){y=0,x=0;var d=(c-c%10)/10;w.attr("class","volume_meter band_"+d)}else y=c}},20)},i=new Date;i-m>3e5&&b("#media_comment_dialog").dialog("close").remove(),m=i;var j=b("#media_comment_dialog");if(j.length==0){var k=b("<div/>").attr("id","media_comment_dialog");k.text(a.t("messages.loading","Loading...")),k.dialog({title:a.t("titles.record_upload_media_comment","Record/Upload Media Comment"),resizable:!1,width:470,height:300,modal:!1}),b.ajaxJSON("/api/v1/services/kaltura_session","POST",{},function(a){k.data("ks",a.ks),k.data("uid",a.uid)},function(b){b.logged_in==0?k.data("ks-error",a.t("errors.must_be_logged_in","You must be logged in to record media.")):k.data("ks-error",a.t("errors.load_failed","Media Comment Application failed to load.  Please try again."))}),b.get("/partials/_media_comments.html",function(a){var c=function(){k.data("ks")?(k.html(a),k.find("#media_record_tabs").tabs({select:function(){b(document).triggerHandler("reset_media_comment_forms")}}),h()):k.data("ks-error")?k.html(k.data("ks-error")):setTimeout(c,500)};c(),j=b("#media_comment_dialog")}),j=k}else h()},b(document).ready(function(){b(document).bind("reset_media_comment_forms",function(){b("#audio_record_holder_message,#video_record_holder_message").removeClass("saving").find(".recorder_message").html("Saving Recording...<img src='/images/media-saving.gif'/>"),b("#audio_record_holder").stop(!0,!0).clearQueue().css("width","").removeClass("with_volume"),b("#video_record_holder").stop(!0,!0).clearQueue().css("width","").removeClass("with_volume"),b("#media_upload_submit").text(a.t("buttons.submit","Submit Media File")).attr("disabled",!0),b("#media_upload_settings").css("visibility","hidden"),b("#media_upload_progress").css("visibility","hidden").progressbar().progressbar("option","value",1),b("#media_upload_title").val("");var c=b("#audio_upload")[0]&&b("#audio_upload")[0].getFiles&&b("#audio_upload")[0].getFiles();c&&b("#audio_upload")[0].removeFiles&&c.length>0&&b("#audio_upload")[0].removeFiles(0,c.length-1),c=b("#video_upload")[0]&&b("#video_upload")[0].getFiles&&b("#video_upload")[0].getFiles(),c&&b("#video_upload")[0].removeFiles&&c.length>0&&b("#video_upload")[0].removeFiles(0,c.length-1)}),b("#media_upload_submit").live("click",function(a){b.mediaComment.upload_delegate.submit()}),b("#video_record_option,#audio_record_option").live("click",function(a){a.preventDefault(),b("#video_record_option,#audio_record_option").removeClass("selected_option"),b(this).addClass("selected_option"),b("#audio_record_holder").stop(!0,!0).clearQueue().css("width","").removeClass("with_volume"),b("#video_record_holder").stop(!0,!0).clearQueue().css("width","").removeClass("with_volume"),b(this).attr("id")=="audio_record_option"?(b("#video_record_holder_holder").hide(),b("#audio_record_holder_holder").show()):(b("#video_record_holder_holder").show(),b("#audio_record_holder_holder").hide())})}),b(document).bind("media_recording_error",function(){b("#audio_record_holder_message,#video_record_holder_message").find(".recorder_message").html(c(a.t("errors.save_failed","Saving appears to have failed.  Please close this popup to try again."))+"<div style='font-size: 0.8em; margin-top: 20px;'>"+c(a.t("errors.persistent_problem","If this problem keeps happening, you may want to try recording your media locally and then uploading the saved file instead."))+"</div>")})})(b,INST),window.mediaCommentCallback=function(a){var c=b.trim(b("#current_context_code").text())||b.trim("user_"+b("#identity .user_id").text());for(var d in a){var e=a[d];if(e.mediaType==1||e.mediaType==2||e.mediaType==5||!0){var f="video";e.mediaType==2?f="image":e.mediaType==5&&(f="audio"),c&&b.ajaxJSON("/media_objects","POST",{id:e.entryId,type:f,context_code:c,title:e.name},function(a){b(document).triggerHandler("media_object_created",a)},function(a){}),b(document).triggerHandler("media_comment_created",{id:e.entryId,mediaType:f})}}b("#media_comment_create_dialog").empty().dialog("close")},window.beforeAddEntry=function(){var a=Math.random();b.mediaComment.lastAddAttemptId=a,setTimeout(function(){b.mediaComment.lastAddAttemptId==a&&b(document).triggerHandler("media_recording_error")},3e4),b("#audio_record_holder_message,#video_record_holder_message").addClass("saving")},window.addEntryFail=function(){b(document).triggerHandler("media_recording_error")},window.addEntryFailed=function(){b(document).triggerHandler("media_recording_error")},window.addEntryComplete=function(c){b.mediaComment.lastAddAttemptId=null,b("#audio_record_holder_message,#video_record_holder_message").removeClass("saving");try{var d=null;b.isArray(c)||(c=[c]);for(var e=0;e<c.length;e++){var f=c[e];b("#media_record_tabs").tabs("option","selected")==0?d=b("#video_record_title,#audio_record_title").filter(":visible:first").val():b("#media_record_tabs").tabs("option","selected")!=1,f.entryType==1&&b("#audio_record_option").hasClass("selected_option")&&(f.entryType=5),b.mediaComment.entryAdded(f.entryId,f.entryType,f.entryName,d),b("#media_comment_dialog").dialog("close")}}catch(g){console.log(g),alert(a.t("errors.save_failed_try_again","Entry failed to save.  Please try again."))}}})