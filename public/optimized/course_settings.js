define(["i18n!course_settings","jquery","jquery.ajaxJSON","jquery.instructure_date_and_time","jquery.instructure_forms","jqueryui/dialog","jquery.instructure_misc_helpers","jquery.instructure_misc_plugins","jquery.keycodes","jquery.loadingImg","jquery.rails_flash_notifications","jquery.templateData","link_enrollment","vendor/jquery.ba-tinypubsub","vendor/jquery.scrollTo","jqueryui/autocomplete","jqueryui/sortable","jqueryui/tabs"],function(a,b){var c={status:null,checkup:function(){b.ajaxJSON(b("#publish_to_sis_form").attr("action"),"GET",{},function(a){if(!a.hasOwnProperty("sis_publish_overall_status"))return;c.status=a.sis_publish_overall_status,c.update(a.hasOwnProperty("sis_publish_statuses")?a.sis_publish_statuses:{})})},update:function(d,e){var f=b("#publish_grades_link"),g=b("#publish_grades_error");c.status=="published"?(g.hide(),f.html(a.t("links.republish","Republish grades to SIS")),f.removeClass("disabled")):c.status=="publishing"||c.status=="pending"?(g.hide(),f.html(a.t("links.publishing","Publishing grades to SIS...")),e||setTimeout(c.checkup,5e3),f.addClass("disabled")):c.status=="unpublished"?(g.hide(),f.html(a.t("links.publish","Publish grades to SIS")),f.removeClass("disabled")):(g.show(),f.html(a.t("links.republish","Republish grades to SIS")),f.removeClass("disabled")),$messages=b("#publish_grades_messages"),$messages.empty(),b.each(d,function(a,c){var d=b("<span/>");d.text(a);var e=b("<li/>");e.append(d),e.append(" - <b>"+c.length+"</b>"),$messages.append(e)})},publish:function(){if(c.status=="publishing"||c.status=="pending"||c.status==null)return;if(c.status=="published"){if(!confirm(a.t("confirm.re_publish_grades","Are you sure you want to republish these grades to the student information system?")))return}else if(!confirm(a.t("confirm.publish_grades","Are you sure you want to publish these grades to the student information system? You should only do this if all your grades have been finalized.")))return;var d=b("#publish_to_sis_form");c.status="publishing",c.update({},!0);var e={published:1,publishing:1,pending:1},f=function(d,e,f,g){c.status="unknown",b.flashError(a.t("errors.publish_grades","Something went wrong when trying to publish grades to the student information system. Please try again later.")),c.update({})};b.ajaxJSON(d.attr("action"),"POST",d.getFormData(),function(b){if(!b.hasOwnProperty("sis_publish_overall_status")||!e.hasOwnProperty(b.sis_publish_overall_status)){f(null,null,a.t("errors.invalid_sis_status","Invalid SIS publish status"),null);return}c.status=b.sis_publish_overall_status,c.update(b.hasOwnProperty("sis_publish_statuses")?b.sis_publish_statuses:{})},f)}};b(document).ready(function(){var d=b("#add_section_form"),e=b("#edit_section_form"),f=b("#course_form"),g=b(".hashtag_form"),h=b("#course_hashtag"),i=b("#enroll_users_form"),j=b("#enrollment_dialog");b("#course_details_tabs").tabs({cookie:{}}).show(),d.formSubmit({required:["course_section[name]"],beforeSubmit:function(b){d.find("button").attr("disabled",!0).text(a.t("buttons.adding_section","Adding Section..."))},success:function(c){var e=c.course_section,f=b(".section_blank:first").clone(!0).attr("class","section"),g=b("<option/>");d.find("button").attr("disabled",!1).text(a.t("buttons.add_section","Add Section")),f.fillTemplateData({data:e,hrefValues:["id"]}),b("#course_section_id_holder").show(),g.val(e.id).text(e.name).addClass("option_for_section_"+e.id),b("#sections .section_blank").before(f),f.slideDown(),b("#course_section_name").val()},error:function(b){d.formErrors(b).find("button").attr("disabled",!1).text(a.t("errors.section","Add Section Failed, Please Try Again"))}}),b(".cant_delete_section_link").click(function(a){return alert(b(this).attr("title")),!1}),e.formSubmit({beforeSubmit:function(a){e.hide();var b=e.parents(".section");return b.find(".name").text(a["course_section[name]"]).show(),b.loadingImage({image_size:"small"}),b},success:function(a,c){var d=a.course_section;c.loadingImage("remove"),b(".option_for_section_"+d.id).text(d.name)},error:function(a,b){b.loadingImage("remove").find(".edit_section_link").click(),e.formErrors(a)}}).find(":text").bind("blur",function(){e.submit()}).keycodes("return esc",function(a){a.keyString=="return"?e.submit():(b(this).parents(".section").find(".name").show(),b("body").append(e.hide()))}),b(".edit_section_link").click(function(){var a=b(this),c=a.parents(".section"),d=c.getTemplateData({textValues:["name"]});return e.fillFormData(d,{object_name:"course_section"}),c.find(".name").hide().after(e.show()),e.attr("action",a.attr("href")),e.find(":text:first").focus().select(),!1}),b(".delete_section_link").click(function(){return b(this).parents(".section").confirmDelete({url:b(this).attr("href"),message:a.t("confirm.delete_section","Are you sure you want to delete this section?"),success:function(a){b(this).slideUp(function(){b(this).remove()})}}),!1}),b("#nav_form").submit(function(){function a(a){var c=b(a).attr("id");if(c){var d=c.replace(/^nav_edit_tab_id_/,"");if(d.length>0)return d.match(/context/)||(d=parseInt(d,10)),d}return null}tab_id_regex=/(\d+)$/;var c=[];return b("#nav_enabled_list li").each(function(){var b=a(this);b!==null&&c.push({id:b})}),b("#nav_disabled_list li").each(function(){var b=a(this);b!==null&&c.push({id:b,hidden:!0})}),b("#tabs_json").val(JSON.stringify(c)),!0}),b(".edit_nav_link").click(function(a){a.preventDefault(),b("#nav_form").dialog("close").dialog({modal:!0,resizable:!1,width:400}).dialog("open")}),b("#nav_enabled_list, #nav_disabled_list").sortable({items:"li.enabled",connectWith:".connectedSortable",axis:"y"}).disableSelection(),b(".hashtag_dialog_link").click(function(c){c.preventDefault(),b("#hashtag_dialog").dialog("close").dialog({autoOpen:!1,title:a.t("titles.hashtag_help","What's a Hashtag?"),width:500}).dialog("open")}),b(".close_dialog_button").click(function(){b("#hashtag_dialog").dialog("close")}),b("#course_hashtag").bind("blur change keyup",function(){var a=b(this).val()||"";a=a.replace(/(\s)+/g,"_").replace(/#/,""),b("#hashtag_options").showIf(a&&a!==""),b(this).val(a)}),b(document).fragmentChange(function(a,c){function d(a){b("#tab-users-link").click(),b(".add_users_link:visible").click(),b("#enroll_users_form select[name='enrollment_type']").val(a)}c=="#add_students"?d("StudentEnrollment"):c=="#add_tas"?d("TaEnrollment"):c=="#add_teacher"&&d("TeacherEnrollment")}),b(".edit_course_link").click(function(a){a.preventDefault(),b("#course_form").addClass("editing").find(":text:first").focus().select(),b("#course_account_id_lookup").autocomplete({source:b("#course_account_id_url").attr("href"),select:function(a,c){b("#course_account_id").val(c.item.id)}}),g.showIf(h.text().length>0),h.triggerHandler("blur")}),b(".move_course_link").click(function(c){c.preventDefault(),b("#move_course_dialog").dialog("close").dialog({autoOpen:!1,title:a.t("titles.move_course","Move Course"),width:500}).dialog("open")}),b("#move_course_dialog").delegate(".cancel_button","click",function(){b("#move_course_dialog").dialog("close")}),f.find(".grading_standard_checkbox").change(function(){f.find(".grading_standard_link").showIf(b(this).attr("checked"))}).change(),f.formSubmit({processData:function(a){return a["course[hashtag]"]=(a["course[hashtag]"]||"").replace(/\s/g,"_").replace(/#/g,""),a["course[start_at]"]&&(a["course[start_at]"]+=" 12:00am"),a["course[conclude_at]"]&&(a["course[conclude_at]"]+=" 11:55pm"),a},beforeSubmit:function(a){b(this).loadingImage().removeClass("editing"),b(this).find(".readable_license,.account_name,.term_name,.grading_scheme_set").text("..."),b(this).find(".storage_quota_mb").text(a["course[storage_quota_mb]"]),b(".course_form_more_options").hide()},success:function(c){var d=c.course;d.start_at=b.parseFromISO(d.start_at).datetime_formatted,d.conclude_at=b.parseFromISO(d.conclude_at).datetime_formatted,d.is_public=d.is_public?a.t("public_course","Public"):a.t("private_course","Private"),d.indexed=d.indexed?a.t("indexed_course","Included in public course index"):"",d.grading_scheme_set=d.grading_standard_title||(d.grading_standard_id?a.t("grading_standard_set","Currently Set"):a.t("grading_standard_unset","Not Set")),d.restrict_dates=d.restrict_enrollments_to_course_dates?a.t("course_dates_enforced","Users can only participate in the course between these dates"):a.t("course_dates_unenforced","These dates will not affect course availability"),d.locale=b("#course_locale option[value='"+(d.locale||"")+"']").text();if(d.locale!=f.find(".locale").text()){location.reload();return}b(this).loadingImage("remove"),b("#course_form .public_options").showIf(d.is_public),b("#course_form .self_enrollment_message").css("display",d.self_enrollment?"":"none"),b("#course_form").fillTemplateData({data:d}),d.self_enrollment_code&&b("#course_form .self_enrollment_message b").each(function(){b(this).text(b.replaceTags(b(this).text(),"self_enrollment_code",d.self_enrollment_code))}),b(".hashtag_form").showIf(b("#course_hashtag").text().length>0)},error:function(a){b(this).loadingImage("remove"),b(".edit_course_link").click(),b(this).formErrors(a)}}).find(".cancel_button").click(function(){f.removeClass("editing"),g.showIf(h.text().length>0),b(".course_form_more_options").hide()}).end().find(":text:not(.date_entry)").keycodes("esc",function(){f.find(".cancel_button:first").click()}),i.hide(),b(".add_users_link").click(function(a){b(this).hide(),a.preventDefault(),i.show(),b("html,body").scrollTo(i),i.find("textarea").focus().select()}),b(".associated_user_link").click(function(a){a.preventDefault();var c=b(this).parents(".user"),d=b(this).parents(".enrollment_link"),e=c.getTemplateData({textValues:["name"]}),f=d.getTemplateData({textValues:["enrollment_id","associated_user_id"]});link_enrollment.choose(e.name,f.enrollment_id,f.associated_user_id,function(a){if(a){var c=b(".observer_enrollments .user_"+a.user_id),d=c.find(".enrollment_link.enrollment_"+a.id);d.find(".associated_user.associated").showIf(a.associated_user_id),d.fillTemplateData({data:a}),d.find(".associated_user.unassociated").showIf(!a.associated_user_id)}})}),b(".course_info").attr("title",a.t("titles.click_to_edit","Click to Edit")).click(function(a){if(a.target.nodeName=="INPUT")return;b(".edit_course_link:first").click();var c=b(this).parents("td").find(".course_form");c.length&&c.focus().select()}),b(".course_form_more_options_link").click(function(a){a.preventDefault(),b(".course_form_more_options").slideToggle()}),b(".user_list").delegate(".user","mouseover",function(c){var d=b(this),e=d.attr("title"),f=a.t("details.re_send_invitation","This user has not yet accepted their invitation.  Click to re-send invitation.");e!=f&&d.data("real_title",e),d.hasClass("pending")?d.attr("title",f).css("cursor","pointer"):d.attr("title",b(this).data("real_title")||a.t("defaults.user_name","User")).css("cursor","")}),j.find(".cancel_button").click(function(){j.dialog("close")}),b(".user_list").delegate(".user_information_link","click",function(c){var d=b(this),e=d.closest(".user"),f=e.hasClass("pending"),g=e.getTemplateData({textValues:["name","invitation_sent_at"]}),h=e.parents(".teacher_enrollments,.ta_enrollments").length>0;return g.re_send_invitation_link=a.t("links.re_send_invitation","Re-Send Invitation"),j.data("user",e).find(".re_send_invitation_link").attr("href",e.find(".re_send_confirmation_url").attr("href")).end().find(".student_enrollment_re_send").showIf(f&&!h).end().find(".admin_enrollment_re_send").showIf(f&&h).end().find(".accepted_enrollment_re_send").showIf(!f).end().find(".invitation_sent_at").showIf(f).end().fillTemplateData({data:g}).dialog("close").dialog({autoOpen:!1,title:a.t("titles.enrollment_details","Enrollment Details")}).dialog("open"),!1}),b(".user_list .edit_section_link").click(function(a){a.preventDefault();var c=b(this),d=c.parents(".user"),e=d.find(".sections");e.find(".section_name").toggle(),e.find(".enrollment_course_section_form").toggle()}),b(".user_list .enrollment_course_section_form .course_section_id").change(function(c){var d=b(this),e=d.parents(".sections"),f=d.parent("form"),g=f.prev(".section_name");b.ajaxJSON(f.attr("action"),"POST",f.getFormData(),function(a){g.html(d.find('option[value="'+d.val()+'"]').html()),e.find(".section_name").toggle(),e.find(".enrollment_course_section_form").toggle()},function(c){c&&c.enrollment&&d.val(c.enrollment.course_section_id),b.flashError(a.t("errors.move_user","Something went wrong moving the user to the new section. Please try again later."))})}),j.find(".re_send_invitation_link").click(function(c){c.preventDefault();var d=b(this);d.text(a.t("links.re_sending_invitation","Re-Sending Invitation..."));var e=d.attr("href");b.ajaxJSON(e,"POST",{},function(b){j.fillTemplateData({data:{invitation_sent_at:a.t("invitation_sent_now","Just Now")}}),d.text(a.t("invitation_sent","Invitation Sent!"));var c=j.data("user");c&&c.fillTemplateData({data:{invitation_sent_at:a.t("invitation_sent_now","Just Now")}})},function(b){d.text(a.t("errors.invitation","Invitation Failed.  Please try again."))})}),b(".date_entry").date_field(),b().data("current_default_wiki_editing_roles",b("#course_default_wiki_editing_roles").val()),b("#course_default_wiki_editing_roles").change(function(){var a=b(this);b(".changed_default_wiki_editing_roles").showIf(a.val()!=b().data("current_default_wiki_editing_roles")),b(".default_wiki_editing_roles_change").text(a.find(":selected").text())}),b(".re_send_invitations_link").click(function(c){c.preventDefault();var d=b(this),e=a.t("links.re_send_all","Re-Send All Unaccepted Invitations");d.text(a.t("buttons.re_sending_all","Re-Sending Unaccepted Invitations...")).attr("disabled",!0),b.ajaxJSON(d.attr("href"),"POST",{},function(c){d.text(a.t("buttons.re_sent_all","Re-Sent All Unaccepted Invitations!")).attr("disabled",!1),b(".user_list .user.pending").each(function(){var c=b(this);c.fillTemplateData({data:{invitation_sent_at:a.t("invitation_sent_now","Just Now")}})}),setTimeout(function(){d.text(e)},2500)},function(){d.text(a.t("errors.re_send_all","Send Failed, Please Try Again")).attr("disabled",!1)})}),b("#enrollment_type").change(function(){b(".teacherless_invite_message").showIf(b(this).find(":selected").hasClass("teacherless_invite"))}),b(".is_public_checkbox").change(function(){b(".public_options").showIf(b(this).attr("checked"))}).change(),b(".self_enrollment_checkbox").change(function(){b(".open_enrollment_holder").showIf(b(this).attr("checked"))}).change(),b("#publish_grades_link").click(function(a){a.preventDefault(),c.publish()}),typeof sisPublishEnabled!="undefined"&&sisPublishEnabled&&c.checkup(),b(".reset_course_content_button").click(function(c){c.preventDefault(),b("#reset_course_content_dialog").dialog("close").dialog({autoOpen:!1,title:a.t("titles.reset_course_content_dialog_help","Reset Course Content"),width:500}).dialog("open")}),b("#reset_course_content_dialog .cancel_button").click(function(){b("#reset_course_content_dialog").dialog("close")}),b.scrollSidebar()})})