define(["vendor/slickgrid-googlecode/slick.globaleditorlock","jquery","jqueryui/sortable","jqueryui/resizable","vendor/jquery.getScrollbarWidth"],function(a,b){return function c(c,d,e,f){function g(){f=b.extend({},S,f),c.empty().attr("tabIndex",0).attr("hideFocus",!0).css("overflow","hidden").css("outline",0).css("position","relative").addClass(W),Y=b("<div class='grid-header' style='overflow:hidden;position:relative;' />").appendTo(c),Z=b("<div style='width:10000px' />").appendTo(Y),$=b("<div tabIndex='0' hideFocus style='width:100%;overflow:scroll;outline:0;position:relative;outline:0px;'>").appendTo(c),_=b("<div class='grid-canvas' tabIndex='0' hideFocus />").appendTo($),$.height(c.innerHeight()-Y.outerHeight());for(var a=0;a<e.length;a++){var d=e[a];bq[d.id]=a,d.width||(d.width=f.defaultColumnWidth),d.formatter||(d.formatter=p);var g=b("<div class='h c"+a+"' cell="+a+" id='"+d.id+"' />").html(d.name).width(d.width).appendTo(Z);d.rerenderOnResize&&g.append(" <img src='images/help.png' align='absmiddle' title='This column has an adaptive formatter.  Resize to a smaller size to see alternative data representation.'>")}Z.find(".h").each(function(){var a=parseInt(b(this).attr("cell")),c=e[a];if(c.resizable===!1)return;b(this).resizable({handles:"e",minWidth:c.minWidth?c.minWidth:null,maxWidth:c.maxWidth?c.maxWidth:null,stop:function(a,c){var d=b(this).attr("id"),f=bq[d];e[f].width=b(this).width(),b("body").append("<style class='slick-style'> ."+W+" .grid-canvas .c"+f+"{width: "+e[f].width+"px;} </style>"),y(),e[f].rerenderOnResize&&t(),B()}})}),f.enableColumnReorder&&Z.sortable({axis:"x",cancel:".ui-resizable-handle",update:function(a,b){console.time("column reorder");var c=Z.sortable("toArray"),d={};for(var f=0;f<e.length;f++)d[e[f].id]=e[f];for(var f=0;f<c.length;f++)bq[c[f]]=f,e[f]=d[c[f]];t(),i(),h(),B(),X.onColumnsReordered&&X.onColumnsReordered(),a.stopPropagation(),console.timeEnd("column reorder")}}),Z.bind("click",function(a){if(!b(a.target).hasClass(".h"))return;var c=b(a.target).attr("id");X.onColumnHeaderClick&&X.onColumnHeaderClick(e[bq[c]])}),h(),y(),B(),f.manualScrolling||$.bind("scroll",C),_.bind("keydown",D),_.bind("click",E),_.bind("dblclick",F),b.browser.msie&&($[0].onselectstart=function(){if(event.srcElement.tagName!="INPUT"&&event.srcElement.tagName!="TEXTAREA")return!1})}function h(){for(var a=0;a<e.length;a++)b("body").append("<style class='slick-style'> ."+W+" .grid-canvas .c"+a+" { width:"+e[a].width+"px } </style>")}function i(){b("body").find("style.slick_style").remove()}function j(){bf&&R(),Z.sortable("destroy"),Z.find(".h").resizable("destroy"),i(),c.empty().removeClass(W)}function k(a,b,c){Z.find(".h[id="+a+"]").removeClass(c).addClass(b)}function l(a){return bq[a]}function m(){return bo.concat()}function n(c){if(a.isEditing()&&!a.hasLock(X))throw"Grid : setSelectedRows : cannot set selected rows when somebody else has an edit lock";var d={};for(var e=0;e<c.length;e++)d[c[e]]=!0;for(var e=0;e<bo.length;e++){var f=bo[e];bg[f]&&!d[f]&&b(bg[f]).removeClass("selected")}for(var e=0;e<c.length;e++){var f=c[e];bg[f]&&!bp[f]&&b(bg[f]).addClass("selected")}bo=c.concat(),bp=d}function o(a){if(bf&&!Q())return;H(null),f.enableAddRow!=a.enableAddRow&&u(d.length),f=b.extend(f,a),B()}function p(a,b,c,d,e){return c==null||c==undefined?"":c}function q(a,b){var c=d[b],f=b<d.length&&!c,g="r"+(f?" loading":"")+(bp[b]?" selected":"");a.push("<div class='"+g+"' row='"+b+"' style='top:"+T*b+"px'>");for(var h=0,i=e.length;h<i;h++){var j=e[h],k;!j.active||!c.active,a.push("<div "+(j.unselectable?"":"hideFocus tabIndex=0 ")+"class='c c"+h+(j.cssClass?" "+j.cssClass:"")+(j.active&&c.active?" active-col-and-row":"")+"' cell="+h+">"),c&&b<d.length&&a.push(j.formatter(b,h,c[j.field],j,c)),a.push("</div>")}a.push("</div>")}function r(a){var b=[];return q(b,a),b.join("")}function s(a,b){console.time("cleanupRows");var c=bh,d=_[0];for(var e in bg)(e<a||e>b)&&e!=bc&&(d.removeChild(bg[e]),delete bg[e],bh--,bu++);console.log("removed "+(c-bh)+" rows"),console.timeEnd("cleanupRows")}function t(){console.log("removeAllRows"),_[0].innerHTML="",bg={},bu+=bh,bh=0}function u(a){var b=bg[a];if(!b)return;if(bf&&bc==a)throw"Grid : removeRow : Cannot remove a row that is currently in edit mode";bm=0,b.parentNode.removeChild(b),b=null,delete bg[a],bh--,bu++}function v(a){console.time("removeRows");if(!a||!a.length)return;bm=0;var b=[];for(var c=0,d=a.length;c<d;c++){if(bf&&bc==c)throw"Grid : removeRow : Cannot remove a row that is currently in edit mode";var e=bg[a[c]];if(!e)continue;b.push(a[c])}if(bh>10&&b.length==bh)_[0].innerHTML="",bg={},bu+=bh,bh=0;else for(var c=0,f=b.length;c<f;c++){var e=bg[b[c]];e.parentNode.removeChild(e),delete bg[b[c]],bh--,bu++}console.timeEnd("removeRows")}function w(a,c){if(!bg[a])return;var f=b(bg[a]).find(".c[cell="+c+"]");if(f.length===0)return;var g=e[c],h=d[a];bf&&bc==a&&bd==c?bf.setValue(h[g.field]):f[0].innerHTML=h?g.formatter(a,c,h[g.field],g,h):""}function x(a){if(!bg[a])return;b(bg[a]).find(".c").each(function(b){var c=e[b];a==bc&&b==bd&&bf?bf.setValue(d[bc][c.field]):d[a]?this.innerHTML=c.formatter(a,b,d[a][c.field],c,d[a]):this.innerHTML=""})}function y(){bb=$.innerWidth(),ba=$.innerHeight(),V=bi=Math.ceil(ba/T),U=Math.max(U,bi+2*V);var a=0;for(var c=0;c<e.length;c++)a+=e[c].width+5;_.width(a);var g=_[0],h=f.enableAddRow?d.length:d.length-1;for(var c in bg)c>=h&&(g.removeChild(bg[c]),delete bg[c],bh--,bu++);var i=Math.max(T*(d.length+bi-2),ba-b.getScrollbarWidth());$.scrollTop()>i-$.height()+b.getScrollbarWidth()&&$.scrollTop(i-$.height()+b.getScrollbarWidth()),_.height(i)}function z(){return{top:Math.floor(bk/T),bottom:Math.floor((bk+ba)/T)}}function A(a,b){console.time("renderRows");var c=_[0],d=bh,e=[],f=[],g=new Date;for(var h=a;h<=b;h++){if(bg[h])continue;bh++,f.push(h),q(e,h),bt++}var i=document.createElement("div");i.innerHTML=e.join("");for(var h=0,j=i.childNodes.length;h<j;h++)bg[f[h]]=c.appendChild(i.firstChild);bh-d>5&&(bn=(new Date-g)/(bh-d)),console.log("rendered "+(bh-d)+" rows"),console.timeEnd("renderRows")}function B(){var a=z(),b=Math.max(0,a.top-(bm<0?V:5)),c=Math.min(f.enableAddRow?d.length:d.length-1,a.bottom+(bm>0?V:5));bh>10&&Math.abs(bj-bk)>T*U?t():s(b,c),A(b,c),bj=bk,bs=null}function C(){bk=$[0].scrollTop;var a=Math.abs(bj-bk),b=$[0].scrollLeft;b!=bl&&(Y[0].scrollLeft=bl=b);if(a<5*T)return;bj==bk?bm=0:bj<bk?bm=1:bm=-1,bs&&window.clearTimeout(bs),a<bi*T?B():bs=window.setTimeout(B,50),X.onViewportChanged&&X.onViewportChanged()}function D(b){switch(b.which){case 27:a.isEditing()&&a.hasLock(X)&&R(X),be&&be.focus();break;case 9:b.shiftKey?O(0,-1,!0):O(0,1,!0);break;case 37:O(0,-1);break;case 39:O(0,1);break;case 38:O(-1,0);break;case 40:case 13:O(1,0);break;default:if(X.onKeyDown&&d[bc]&&!bf&&X.onKeyDown(b,bc,bd))return b.stopPropagation(),b.preventDefault(),!1;return}return b.stopPropagation(),b.preventDefault(),!1}function E(a){var c=b(a.target).closest(".c");if(c.length===0)return;if(be==c[0]&&bf!=null)return;var g=parseInt(c.parent().attr("row")),h=parseInt(c.attr("cell")),i=null;if(d[g]&&X.onClick&&(!bf||(i=Q()))&&X.onClick(a,g,h))return a.stopPropagation(),a.preventDefault(),!1;f.enableCellNavigation&&!e[h].unselectable&&(i==1||i==null&&Q())&&I(c[0])}function F(a){var c=b(a.target).closest(".c");if(c.length===0)return;if(be==c[0]&&bf!=null)return;f.editOnDoubleClick&&M()}function G(a,b){var c=Math.floor(b/T),d=0,f=0;for(var g=0;g<e.length&&f<b;g++)f+=e[g].width,d++;return{row:c,cell:d-1}}function H(a,c){be!=null&&(L(),b(be).removeClass("selected")),be=a,be!=null?(bc=parseInt(b(be).parent().attr("row")),bd=parseInt(b(be).attr("cell")),b(be).addClass("selected"),N(),f.editable&&!f.editOnDoubleClick&&(d[bc]||bc==d.length)&&(window.clearTimeout(br),c?br=window.setTimeout(M,100):M())):(bc=null,bd=null)}function I(a,b){H(a,b),a?n([bc]):n([]),X.onSelectedRowsChanged&&X.onSelectedRowsChanged()}function J(){if(document.selection&&document.selection.empty)document.selection.empty();else if(window.getSelection){var a=window.getSelection();a&&a.removeAllRanges&&a.removeAllRanges()}}function K(a,b){return a<d.length&&!d[a]?!1:e[b].cannotTriggerInsert&&a>=d.length?!1:e[b].editor?!0:!1}function L(){if(!bf)return;bf.destroy(),b(be).removeClass("editable invalid"),d[bc]&&(be.innerHTML=e[bd].formatter(bc,bd,d[bc][e[bd].field],e[bd],d[bc])),bf=null,b.browser.msie&&J(),a.leaveEditMode(X)}function M(){if(!be)return;if(!f.editable)throw"Grid : makeSelectedCellEditable : should never get called when options.editable is false";window.clearTimeout(br);if(!K(bc,bd))return;a.enterEditMode(X),b(be).addClass("editable");var c=null;d[bc]&&(c=d[bc][e[bd].field]),be.innerHTML="",bf=new e[bd].editor(b(be),e[bd],c,d[bc])}function N(){if(!be)return;var a=$[0].scrollTop;(bc+2)*T>a+ba?($[0].scrollTop=bc*T,C()):bc*T<a&&($[0].scrollTop=(bc+2)*T-ba,C())}function O(c,d,e){if(!be)return;if(!f.enableCellNavigation)return;if(!a.commitCurrentEdit())return;var g=bg[bc+c],h=g?b(g).find(".c[cell="+(bd+d)+"][tabIndex=0]"):null;e&&c==0&&!(g&&h&&h.length)&&(!h||!h.length)&&(d>0?(g=bg[bc+c+1],h=g?b(g).find(".c[cell][tabIndex=0]:first"):null):(g=bg[bc+c-1],h=g?b(g).find(".c[cell][tabIndex=0]:last"):null)),g&&h&&h.length?(I(h[0],f.asyncEditorLoading),bf||be.focus()):be.focus()}function P(c,g){if(c>d.length||c<0||g>=e.length||g<0)return;if(!f.enableCellNavigation||e[g].unselectable)return;if(!a.commitCurrentEdit())return;bg[c]||A(c,c);var g=b(bg[c]).find(".c[cell="+g+"][tabIndex=0]")[0];I(g),bf||be.focus()}function Q(){if(bf){if(bf.isValueChanged()){var a=bf.validate();if(a.valid){var c=bf.getValue();return bc<d.length?e[bd].setValueHandler?e[bd].setValueHandler(c,e[bd],d[bc]):d[bc][e[bd].field]=c:X.onAddNewRow&&X.onAddNewRow(e[bd],c),L(),!0}return b(be).addClass("invalid"),b(be).stop(!0,!0).effect("highlight",{color:"red"},300),X.onValidationError&&X.onValidationError(be,a,bc,bd,e[bd]),bf.focus(),!1}L()}return!0}function R(){L()}var S={enableAddRow:!0,manualScrolling:!1,editable:!0,editOnDoubleClick:!1,enableCellNavigation:!0,defaultColumnWidth:80,enableColumnReorder:!0,asyncEditorLoading:!0},T=24,U=50,V=5,W="slickgrid_"+Math.round(1e6*Math.random()),X=this,Y,Z,$,_,ba,bb,bc,bd,be=null,bf=null,bg={},bh=0,bi,bj=0,bk=0,bl=0,bm=1,bn=10,bo=[],bp={},bq={},br=null,bs=null,bt=0,bu=0,bv=document.createDocumentFragment(),bw=!1;this.debug=function(){var a="";a+="\ncounter_rows_rendered:  "+bt,a+="\ncounter_rows_removed:  "+bu,a+="\nrenderedRows:  "+bh,a+="\nnumVisibleRows:  "+bi,a+="\nCAPACITY:  "+U,a+="\nBUFFER:  "+V,a+="\navgRowRenderTime:  "+bn,alert(a)},this.benchmark_render_200=function(){t(),A(0,200),s()},this.stressTest=function(){console.time("benchmark-stress"),A(0,500),s(),console.timeEnd("benchmark-stress"),window.setTimeout(X.stressTest,50)},this.benchmarkFn=function(a){var b=new Date,c=new Array(arguments);c.splice(0,1),X[a].call(this,c),alert("Grid : benchmarkFn : "+a+" : "+(new Date-b)+"ms")},g(),b.extend(this,{onColumnHeaderClick:null,onClick:null,onKeyDown:null,onAddNewRow:null,onValidationError:null,onViewportChanged:null,onSelectedRowsChanged:null,onColumnsReordered:null,destroy:j,getColumnIndex:l,updateCell:w,updateRow:x,removeRow:u,removeRows:v,removeAllRows:t,render:B,getViewport:z,resizeCanvas:y,scroll:scroll,getCellFromPoint:G,gotoCell:P,editCurrentCell:M,getSelectedRows:m,setSelectedRows:n,setColumnHeaderCssClass:k,commitCurrentEdit:Q,cancelCurrentEdit:R})}})