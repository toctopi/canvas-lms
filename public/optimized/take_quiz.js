define(["i18n!quizzes.take_quiz","jquery","quiz_timing","compiled/behaviors/autoBlurActiveInput","jquery.ajaxJSON","jquery.instructure_date_and_time","jquery.instructure_forms","jqueryui/dialog","jquery.instructure_misc_helpers","jquery.rails_flash_notifications","compiled/tinymce","tinymce.editor_box","vendor/jquery.scrollTo","compiled/behaviors/quiz_selectmenu"],function(a,b,c,d){var e=null,f=function(){var d=0,e=b(".started_at"),g=b(".end_at"),h=e.text(),i=g.text(),j=i&&new Date(i),k=b(".countdown_seconds"),l=b(".time_running,.time_remaining"),m=b("#last_saved_indicator");return{referenceDate:null,countDown:null,isDeadline:!0,fiveMinuteDeadline:!1,oneMinuteDeadline:!1,submitting:!1,dialogged:!1,contentBoxCounter:0,lastSubmissionUpdate:new Date,currentlyBackingUp:!1,started_at:e,end_at:g,time_limit:parseInt(b(".time_limit").text(),10)||null,updateSubmission:function(c){if(f.submitting&&!c)return;var d=new Date;if(d-f.lastSubmissionUpdate<1e3)return;if(f.currentlyBackingUp)return;f.currentlyBackingUp=!0,f.lastSubmissionUpdate=new Date;var e=b("#submit_quiz_form").getFormData();b(".question_holder .question.marked").each(function(){e[b(this).attr("id")+"_marked"]="1"}),m.text(a.t("saving","Saving...")),b.ajaxJSON(b(".backup_quiz_submission_url").attr("href"),"PUT",e,function(d){m.text(a.t("saved_at","Saved at %{t}",{t:b.friendlyDatetime(new Date)})),f.currentlyBackingUp=!1,c&&setTimeout(function(){f.updateSubmission(!0)},3e4);if(d&&d.end_at){var e=Date.parse(d.end_at),g=Date.parse(f.end_at.text()),h=e.getTime(),k=g.getTime();f.referenceDate=null,h!==k&&(h>k?b.flashMessage(a.t("notices.extra_time","You have been given extra time on this attempt")):b.flashMessage(a.t("notices.less_time","Your time for this quiz has been reduced.")),f.end_at.text(d.end_at),i=d.end_at,j=new Date(d.end_at))}},function(){var d=b("#identity .user_id").text()||"none";f.currentlyBackingUp=!1,b.ajaxJSON(location.protocol+"//"+location.host+"/simple_response.json?user_id="+d+"&rnd="+Math.round(Math.random()*9999999),"GET",{},function(){},function(){ajaxErrorFlash(a.t("errors.connection_lost","Connection to %{host} was lost.  Please make sure you're connected to the Internet before continuing.",{host:location.host}),request)},{skipDefaultError:!0}),c&&setTimeout(function(){f.updateSubmission(!0)},3e4)},{timeout:5e3})},updateTime:function(){var e=new Date,g=f.time_limit?i:null;d=(d+1)%120;if(d==0&&!g&&!f.twelveHourDeadline){f.referenceDate=null;var l=j;!f.time_limit&&l-e<432e5&&(g=i)}f.referenceDate||b.extend(f,c.setReferenceDate(h,g,e));if(f.countDown){var m=f.countDown.getTime()-e.getTime()-f.clientServerDiff;m<=0&&(m=0);var n=new Date(m);k.text(n.getUTCSeconds()),m<=0&&!f.submitting&&(f.submitting=!0,b("#submit_quiz_form").submit())}var m=f.referenceDate.getTime()-e.getTime()-f.clientServerDiff;f.isDeadline&&(m<1e3&&(m=0),m<1e3&&!f.dialogged?(f.dialogged=!0,f.countDown=new Date(e.getTime()+1e4),b("#times_up_dialog").show().dialog({title:a.t("titles.times_up","Time's Up!"),width:"auto",height:"auto",modal:!0,overlay:{backgroundColor:"#000",opacity:.7},close:function(){f.submitting||(f.submitting=!0,b("#submit_quiz_form").submit())}})):m>3e4&&m<6e4&&!f.oneMinuteDeadline?(f.oneMinuteDeadline=!0,b.flashMessage(a.t("notices.one_minute_left","One Minute Left"))):m>25e4&&m<3e5&&!f.fiveMinuteDeadline?(f.fiveMinuteDeadline=!0,b.flashMessage(a.t("notices.five_minutes_left","Five Minutes Left"))):m>18e5&&m<177e4&&!f.thirtyMinuteDeadline?(f.thirtyMinuteDeadline=!0,b.flashMessage(a.t("notices.thirty_minutes_left","Thirty Minutes Left"))):m>432e5&&m<4317e4&&!f.twelveHourDeadline&&(f.twelveHourDeadline=!0,b.flashMessage(a.t("notices.twelve_hours_left","Twelve Hours Left")))),f.updateTimeString(m)},updateTimeString:function(b){var c=new Date(Math.abs(b)),d=c.getUTCFullYear()-1970,e=c.getUTCMonth(),f=c.getUTCDate()-1,g=c.getUTCHours(),h=c.getUTCMinutes(),i=c.getUTCSeconds(),j=[];d&&j.push(a.t("years_count","Year",{count:d})),e&&j.push(a.t("months_count","Month",{count:e})),f&&j.push(a.t("days_count","Day",{count:f})),g&&j.push(a.t("hours_count","Hour",{count:g})),j.push(a.t("minutes_count","Minute",{count:h})),j.push(a.t("seconds_count","Second",{count:i})),l.text(j.join(", "))}}}();b(document).mousedown(function(a){e=b(a.target).parents(".answer")[0]}).keydown(function(){e=null}),b(function(){b.scrollSidebar(),d(),b("#preview_mode_link").length==0&&(window.onbeforeunload=function(){f.updateSubmission();if(!f.submitting&&!f.alreadyAcceptedNavigatingAway)return a.t("confirms.unfinished_quiz","You're about to leave the quiz unfinished.  Continue anyway?")},b(document).delegate("a","click",function(c){if(b(this).closest(".ui-dialog,.mceToolbar,.ui-selectmenu").length>0)return;if(!c.isDefaultPrevented()){var d=b(this).attr("href")||"",e=location.href;e.indexOf("#")&&(e=e.substring(0,e.indexOf("#")));if(d.indexOf("#")==0||d.indexOf(e+"#")==0)return;var g=confirm(a.t("confirms.navigate_away","You're about to navigate away from this page.  Continue anyway?"));g?f.alreadyAcceptedNavigatingAway=!0:c.preventDefault()}}));var c=b("#questions");b("#question_list").delegate(".jump_to_question_link","click",function(a){a.preventDefault();var c=b(b(this).attr("href"));b("html,body").scrollTo(c.parent()),c.find(":input:first").focus().select()}).find(".list_question").bind({mouseenter:function(c){var d=b(this),e=d.data(),f=a.t("titles.not_answered","Haven't Answered yet");d.hasClass("marked")?f=a.t("titles.come_back_later","You marked this question to come back to later"):d.hasClass("answered")&&(f=a.t("titles.answered","Answered")),d.attr("title",f),e.relatedQuestion||(e.relatedQuestion=b("#"+d.attr("id").substring(5))),e.relatedQuestion.addClass("related")},mouseleave:function(a){var c=b(this).data("relatedQuestion");c&&c.removeClass("related")}}),c.find(".group_top,.answer_select").bind({mouseenter:function(a){b(this).addClass("hover")},mouseleave:function(a){b(this).removeClass("hover")}}),c.delegate(":checkbox,:radio,label","change mouseup",function(a){var c=b(this).parents(".answer");e==c[0]&&(c.find(":checkbox,:radio").blur(),f.updateSubmission())}).delegate(":text,textarea,select","change",function(a,c){var d=b(this);if(d.hasClass("numerical_question_input")){var e=parseFloat(d.val());d.val(isNaN(e)?"":e.toFixed(4))}c!==!1&&f.updateSubmission()}).delegate(".numerical_question_input",{keyup:function(c){var d=b(this).val();d===""||!isNaN(parseFloat(d))?b(this).triggerHandler("focus"):b(this).errorBox(a.t("errors.only_numerical_values","only numerical values are accepted"))}}).delegate(".flag_question","click",function(){var a=b(this).parents(".question");a.toggleClass("marked"),b("#list_"+a.attr("id")).toggleClass("marked")}).delegate(".question_input","change",function(a,c,d){var e=b(this),f=this.tagName.toUpperCase(),g=e.parents(".question").attr("id"),h="";if(f=="A")return;if(d){if(d[g])return;d[g]=!0}if(f=="TEXTAREA")h=e.editorBox("get_code");else if(e.attr("type")=="text")h=e.val();else if(f=="SELECT"){var i=e.parents(".question").find("select.question_input");h=!i.filter(function(){return!b(this).val()}).length}else e.parents(".question").find(".question_input").each(function(){if(b(this).attr("checked")||b(this).attr("selected"))h=!0});b("#list_"+g)[h?"addClass":"removeClass"]("answered")}).find(".question_input").trigger("change",[!1,{}]),setInterval(function(){b("textarea.question_input").each(function(){b(this).triggerHandler("change",!1)})},2500),b(".hide_time_link").click(function(c){c.preventDefault(),b(".time_running").css("visibility")!="hidden"?(b(".time_running").css("visibility","hidden"),b(this).text(a.t("show_time_link","Show"))):(b(".time_running").css("visibility","visible"),b(this).text(a.t("hide_time_link","Hide")))}),setTimeout(function(){b("#question_list .list_question").each(function(){var a=b(this);a.find(".jump_to_question_link").text()=="Spacer"&&a.remove()})},1e3),b("#submit_quiz_form input[type=text]").keypress(function(a){if(a.keyCode==13)return!1}),b("#submit_quiz_form").submit(function(c){b(".question_holder textarea.question_input").each(function(){b(this).change()}),unanswered=b("#question_list .list_question:not(.answered)").length;if(unanswered&&!f.submitting){var d=confirm(a.t("confirms.unanswered_questions",{one:"You have 1 unanswered question (see the right sidebar for details).  Submit anyway?",other:"You have %{count} unanswered questions (see the right sidebar for details).  Submit anyway?"},{count:unanswered}));if(!d)return c.preventDefault(),c.stopPropagation(),!1}f.submitting=!0}),b(".submit_quiz_button").click(function(a){a.preventDefault(),b("#times_up_dialog").dialog("close")}),setTimeout(function(){b(".question_holder textarea.question_input").each(function(){b(this).attr("id","question_input_"+f.contentBoxCounter++),b(this).editorBox()})},2e3),setInterval(f.updateTime,400);var g=b("#identity .user_id").text()||"none";setInterval(function(){b.ajaxJSON(location.protocol+"//"+location.host+"/simple_response.json?user_id="+g+"&rnd="+Math.round(Math.random()*9999999),"GET",{},function(){},function(){ajaxErrorFlash(a.t("errors.connection_lost","Connection to %{host} was lost.  Please make sure you're connected to the Internet before continuing.",{host:location.host}),request)},{skipDefaultError:!0})},3e4),setTimeout(function(){f.updateSubmission(!0)},15e3)})})