define(["INST","i18n!full_assignment","jquery","wikiSidebar","str/htmlEscape","jquery.instructure_date_and_time","jquery.instructure_forms","jqueryui/dialog","jquery.instructure_misc_helpers","jquery.instructure_misc_plugins","jquery.keycodes","jquery.loadingImg","jquery.templateData","compiled/tinymce","tinymce.editor_box","vendor/date","vendor/jquery.scrollTo"],function(a,b,c,d,e){hideFullAssignmentForm=function(a){var b=c("#full_assignment"),e=c("#edit_assignment_form");e.hide(),d&&(d.hide(),c("#sidebar_content").show()),b.find(".description").show(),b.find(".edit_full_assignment_link").show()},c(function(){function f(a){c("#"+a).editorBox("focus")||setTimeout(function(){f(a)},500)}function g(){var a=c("#full_assignment"),b=c("#edit_assignment_form");if(b.css("display")==="none"){var e=a.getTemplateData({textValues:["title","due_date_string","due_time_string","points_possible","points_type"]});e.description=="No Content"&&(e.description=""),e.due_date=e.due_date_string,e.due_time=e.due_time_string;var g=Date.parse(c.trim(e.due_date+" "+e.due_time));e.due_at=g&&c.dateString(g)+" at "+c.timeString(g),b.find("select[name='points_type']").change(),b.fillFormData(e,{object_name:"assignment"}),a.find(".description, .edit_full_assignment_link").hide(),b.show(),ENV.HIDE_DESCRIPTION||(b.find("textarea:first").editorBox(),d&&(d.attachToEditor(b.find("textarea:first")),d.show(),c("#sidebar_content").hide())),b.find(".more_options_link").show(),b.find(".more_assignment_values").hide(),ENV.HIDE_DESCRIPTION||setTimeout(function(){f(b.find("textarea:first").attr("id"))},500),b.parents(".ui-dialog").length||c("html,body").scrollTo(b),setTimeout(function(){b.find(".assignment_type").change()},500)}}function h(){var a=i.find("#assignment_peer_reviews"),b=i.find(".assignment_type").val()==="discussion_topic"&&i.find("#assignment_group_assignment").prop("checked");b&&a.prop("checked",!1).change(),a.prop("disabled",b)}d&&d.init();var i=c("#edit_assignment_form");i.find(".more_options_link").click(function(a){c(this).focus(),a.preventDefault(),i.find(".more_options_link").hide(),i.find(".more_assignment_values").show(),i.find(".assignment_type").change()}),c(".edit_full_assignment_link").click(function(a){a.preventDefault(),g()}),i.find(".time_field").timepicker(),i.find(".date_field").datetime_field(),i.find(".assignment_type").change(function(a){var b=c(this).val();i.find(".assignment_content").showIf(b=="assignment"||b=="discussion_topic"||b=="external_tool"),i.find(".submission_content").showIf(b=="assignment"),i.find(".quiz_content").showIf(b=="quiz"),i.find(".discussion_topic_content").showIf(b=="discussion_topic"),i.find(".external_tool_content").showIf(b=="external_tool"),i.find(".not_graded_content").showIf(b=="not_graded"),i.find(".more_assignment_values.assignment_content").showIf((b=="assignment"||b=="discussion_topic")&&!i.find(".more_options_link:visible").length),b=="external_tool"&&c("#assignment_external_tool_tag_attributes_url").val()==""&&c("#edit_external_tool_url").click(),h()}).triggerHandler("change"),i.find(".points_possible").change(function(a){var b=parseFloat(c(this).val());if(isNaN(b)||!isFinite(b)){c(this).val("");return}var d=c("#edit_assignment_form"),e=d.getFormData({object_name:"assignment"}),f=c(this).data("old_value"),g={};g.points_possible=b;if(!e.mastery_score||f&&e.mastery_score==Math.round(f*.75*10)/10){var h=Math.round(b*.75*10)/10;g.mastery_score=h}if(!e.max_score||e.max_score==f)g.max_score=b;e.min_score||(g.min_score=0),d.fillFormData(g,{object_name:"assignment",call_change:!1}),c(this).data("old_value",b)}).change(),c(".more_grading_options_link").click(function(){var a=c(this).hasClass("hide_options");return c(this).toggleClass("hide_options").text(a?b.t("links.more_grading_options","more grading options"):b.t("links.hide_grading_options","hide grading options")),c(".more_grading_options").showIf(!a),!1}),c(".switch_full_assignment_view").click(function(){return i.find("textarea:first").editorBox("toggle"),!1}),i.find(".submission_type_option").change(function(){i.find(".online_submission_types").showIf(c(this).val()=="online")}).change(),i.formSubmit({required:["title"],object_name:"assignment",property_validations:{unlock_at:function(a,c){var d=Date.parse(c.unlock_at),e=Date.parse(c.due_at);if(d&&e&&d>e)return b.t("messages.unlock_before_due","The assignment should be unlocked before it's due")},lock_at:function(a,c){var d=Date.parse(c.lock_at),e=Date.parse(c.due_at);if(d&&e&&d<e)return b.t("messages.lock_after_due","The assignment shouldn't be locked again until after the due date")},"=submission_type":function(a,c){if(a=="online"&&c.assignment_type=="assignment"&&!c.online_upload&&!c.online_text_entry&&!c.online_url&&!c.media_recording)return b.t("messages.need_online_submission_type","Please choose at least one type of online submission")},"external_tool_tag_attributes[url]":function(a,c){if(c.assignment_type=="external_tool"&&(a.length<3||a.indexOf(" ")>=0))return b.t("messages.need_url","Please specify a valid URL")}},onFormError:function(a){var d=[];c.each(a,function(a,b){b.object.is(":visible")||d.push(e(b.message))}),d.length&&c(this).find("a.more_options_link").errorBox(e(b.t("messages.hidden_errors","There were errors on one or more advanced options")))},processData:function(a){var b;return c(this).find(".more_grading_options").css("display")=="none"&&(delete a["assignment[min_score]"],delete a["assignment[max_score]"],delete a["assignment[mastery_score]"],delete a.never_drop),c("#assignment_group_assignment").prop("checked")||(a["assignment[group_category_id]"]=""),c.each(["unlock_at","lock_at","due_at"],function(c,d){if(d=="due_at"||a["assignment["+d+"]"])b=Date.parse(a["assignment["+d+"]"]),b&&(a["assignment["+d+"]"]=b.toString("yyyy-MM-ddTHH:mm:ss"))}),c.extend(a,{"assignment[submission_types]":a.submission_type,due_date:c.dateString(b),description:c(this).find("textarea:first").editorBox("get_code"),"assignment[description]":a.description}),a.submission_type=="online"&&(a["assignment[submission_types]"]=c.map(["online_upload","online_text_entry","online_url","media_recording"],function(b){return a[b]&&b}).join(",")||"none"),a.assignment_type=="quiz"&&(a["assignment[submission_types]"]="online_quiz"),a.assignment_type=="not_graded"&&(a["assignment[submission_types]"]="not_graded"),a.assignment_type=="discussion_topic"&&(a["assignment[submission_types]"]="discussion_topic"),a.assignment_type=="external_tool"&&(a["assignment[submission_types]"]="external_tool"),a},beforeSubmit:function(a){return hideFullAssignmentForm(),c("#full_assignment").fillTemplateData({data:c.extend(c(this).getFormData({object_name:"assignment"}),{description:c(this).find("textarea:first").editorBox("get_code"),due_date_string:a.due_date,due_time_string:a.due_time}),except:["description"]}).loadingImage()},success:function(a,b){var d=a.assignment,e=c.parseFromISO(d.due_at,"due_date"),b=c("#full_assignment");c.extend(d,{due_date:e.date_formatted,due_time:e.time_formatted,timestamp:e.timestamp,due_date_string:e.date_string,due_time_string:e.time_string,lock_at:c.parseFromISO(d.lock_at).datetime_formatted,unlock_at:c.parseFromISO(d.unlock_at).datetime_formatted}),b.find(".quiz_content").showIf(d.submission_types=="online_quiz"&&d.quiz),b.find(".discussion_topic_content").showIf(d.submission_types=="discussion_topic"&&d.discussion_topic),c("#turnitin_enabled").showIf(d.turnitin_enabled),c(".readable_submission_types").text(d.readable_submission_types||"").showIf(d.readable_submission_types),d.quiz&&c.extend(d,{quiz_id:d.quiz.id,quiz_title:d.quiz.title}),d.discussion_topic&&c.extend(d,{discussion_topic_id:d.discussion_topic.id,discussion_topic_title:d.discussion_topic.title}),c(this).find("textarea:first").editorBox("set_code",d.description),c(this).fillFormData(d,{object_name:"assignment"}),b.fillTemplateData({data:d,htmlValues:["description"]}),c("#full_assignment_holder").find(".points_text").showIf(d.points_possible||d.points_possible===0),b.find(".assignment_quiz_link").attr("href",c.replaceTags(b.find(".assignment_quiz_url").attr("href"),"quiz_id",d.quiz_id)),b.find(".assignment_topic_link").attr("href",c.replaceTags(b.find(".assignment_topic_url").attr("href"),"discussion_topic_id",d.discussion_topic_id)),b.loadingImage("remove"),c(this).triggerHandler("assignment_updated",a),c("#full_assignment_holder .redirect_on_finish_url").ifExists(function(){var a=c(this).attr("href");a.indexOf("#")>0&&(a=a.substr(0,a.indexOf("#"))),window.location.href=a+"#assignment_"+d.id})},error:function(a,b){g(),b.loadingImage("remove"),i.formErrors(a)}}),i.find(".cancel_button").click(function(){hideFullAssignmentForm(!0)}),i.find("select.grading_type").change(function(a){i.find(".edit_letter_grades_link").showIf(c(this).val()=="letter_grade")}),i.find("#auto_peer_reviews,#manual_peer_reviews").change(function(){i.find(".auto_peer_reviews").showIf(c("#auto_peer_reviews").attr("checked"))}).change(),c(".rubric .long_description_link").click(function(a){a.preventDefault();if(!c(this).parents(".rubric").hasClass("editing")){var d=c(this).parents(".criterion").getTemplateData({textValues:["long_description","description"]}),e=c(this).parents(".criterion").hasClass("learning_outcome_criterion"),f=c("#rubric_long_description_dialog");f.fillTemplateData({data:d,htmlValues:e?["long_description"]:[]}),f.find(".editing").hide(),f.find(".displaying").show(),f.dialog("close").dialog({autoOpen:!1,title:b.t("titles.criterion_long_description","Criterion Long Description"),width:400}).dialog("open")}}),c("#edit_external_tool_url, #assignment_external_tool_tag_attributes_url").click(function(d){d.preventDefault(),a.selectContentDialog({select_button_text:b.t("buttons.select_url","Select"),no_name_input:!0,submit:function(a){c("#assignment_external_tool_tag_attributes_url").val(a["item[url]"]),c("#assignment_external_tool_tag_attributes_new_tab").val(a["item[new_tab]"])}}),c("#external_tool_create_url").val(c("#assignment_external_tool_tag_attributes_url").val())}),i.find(":input").keycodes("esc",function(a){a.preventDefault(),c(this).parents("form").find(".cancel_button").click()});var j=i.find("#assignment_assignment_group_id");attachAddAssignmentGroup(j);if(editIfNoContent){var k=c.trim(c("#full_assignment").find(".description").text());(!k||k==""||k=="No Content")&&setTimeout(g,500)}c("#assignment_group_assignment").change(function(){c("#assignment_group_category").showIf(c(this).attr("checked")),c(this).attr("checked")||c("#assignment_group_category").val(""),h()}).change(),c("#assignment_turnitin_enabled").change(function(){c("#assignment_turnitin_settings").showIf(c(this).attr("checked"))}).change(),c("#assignment_peer_reviews").change(function(){c("#assignment_peer_reviews_options").showIf(c(this).attr("checked")),c(this).attr("checked")||c("#assignment_peer_reviews_options :text").val("")}).change(),c.scrollSidebar(),c("#assignment_group_category_select").change(function(){var a=c(this);c(this).val()=="new"&&addGroupCategory&&addGroupCategory(function(b){var d=b[0].group_category,e=c(document.createElement("option"));e.text(d.name).val(d.id),a.find("option:last").before(e),a.val(d.id)})}),c("#assignment_online_upload").change(function(){c("#restrict_file_extensions_options").showIf(c(this).attr("checked"))}).change(),c("#assignment_restrict_file_extensions").change(function(){var a=c("#allowed_extensions_options");c(this).attr("checked")?a.show():(a.hide(),c("#assignment_allowed_extensions").val(""))}).change(),setTimeout(function(){if(location.hash=="#add_rubric")c(".add_rubric_link:visible:first").click();else if(location.hash=="#edit_rubric"){var a=c(".edit_rubric_link:visible:first");c("html,body").scrollTo(a.closest(".rubric")),a.click()}else c("#full_assignment_holder").hasClass("editing")&&(c(".edit_full_assignment_link:first").click(),c("#full_assignment_holder .more_options_link:first").click())},500)})})