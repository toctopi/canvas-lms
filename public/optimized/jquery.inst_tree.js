define(["jquery","jqueryui/draggable","jqueryui/droppable"],function(a){a.fn.instTree=function(b){return a(this).each(function(){var c=!1,d=a(this),e=this,f=null;e.options={autoclose:!0,overrideEvents:!1,multi:!0,dragdrop:!0,onClick:!1,onDblClick:!1,onExpand:!1,onCollapse:!1,onAddNode:!1,onEditNode:!1,onDeleteNode:!1,onDrag:!1,onDrop:!1},e.opts=a.extend({},e.options,b),a.fn.instTree.InitInstTree=function(b){d=a(b);var f='<li class="separator"></li>';d.find("li:not(.separator)").filter(function(){return!a(this).prev("li.separator").get(0)&&!a(this).parents("ul.non-instTree").get(0)}).each(function(){a(this).before(f)}),d.find("li > span").not(".sign").not(".clr").addClass("text").attr("unselectable","on"),d.find("li:not(.separator)").filter(function(){return!a(this).parents("ul.non-instTree").get(0)}).filter(":has(ul)").addClass("node").end().filter(":not(.node)").addClass("leaf"),e.IeSetStyles(),e.Clean(),e.AddSigns(),c||e.BindEvents(b),e.opts.dragdrop&&(e.CancelDragDrop(b),e.InitDragDrop(b))},e.InitDragDrop=function(b){d=a(b),d.find("span.text").draggable({cursor:a.browser.msie?"default":"move",distance:3,helper:function(){return a('<div id="instTree-drag"><span>'+a(this).text()+"</span></div>")},appendTo:d}),d.find("li.separator").droppable({accept:"span.text",hoverClass:"dd-hover"}),d.find("span.text").bind("dragstart",function(b,c){d=a(this).parents("ul.instTree:first");var f=a(this).parent("li"),g=a("div#instTree-drag");a.browser.msie&&d.find("li.separator").removeClass("dd-hover"),a.browser.opera&&g.css("margin-top","10px"),f.is(".leaf")?(g.addClass("leaf"),a.browser.msie&&g.css("background","#C3E1FF url("+e.opts.imgFolder+"leaf-drag.gif) left 3px no-repeat")):f.is(".node")&&g.addClass("node"),f.prev("li.separator").addClass("alt").end().addClass("alt"),typeof e.opts.onDrag=="function"&&e.opts.onDrag(b,f)}),d.find("li.separator").bind("dropover",function(b,c){f=a(this)}),d.find("li.separator").bind("dropout",function(a,b){f=null}),d.find("span.text").bind("dragstop",function(c,g){var h=!0;if(f){var i=d.find("li.alt:not(.separator):eq(0)"),j=f.parents("li.node:eq(0)");i.is(".node")&&j.is(".fixedLevel")&&(h=!1)}f&&h?(f.before(d.find("li.alt").remove().removeClass("alt")),f=null,typeof e.opts.onDrop=="function"&&e.opts.onDrop(c,i),a.fn.instTree.InitInstTree(b)):d.find("li.alt").removeClass("alt")})},e.CancelDragDrop=function(b){d=a(b),d.find("span.text").draggable("destroy"),d.find("li.separator").droppable("destroy"),d.find("li.separator").unbind(),d.find("span.text").unbind()},a.fn.instTree.AddNode=function(b,c){d=a(b);var f=d.find("span.active").get(0);if(f){var g=a(f).parents("li:first"),h=a(f).parents("li.node:first");if(!h.is(".fixedLevel")||c!="node"){var i=c=="leaf"?"":' class="node"',j='<li class="separator"></li>',k="<li"+i+'><span class="text">&nbsp;</span><input type="text" value="New item" /></li>',l=j+k,m=!1,n,o,p;g.is(".leaf")?(g.after(l),n=g.nextAll("li:not(.separator):first"),p=g.parent(),m=!0):g.is(".node")&&(o=g.children("ul").get(0),o?(a(o).append(l),n=a(o).children("li:not(.separator):last")):(g.append("<ul>"+l+"</ul>"),o=g.children("ul").get(0),n=a(o).children("li:not(.separator):last")),e.ExpandNode(b,g),p=g,m=!0),m&&(a(f).removeClass("active"),p.find("input:text").focus().select().blur(function(){e.SaveInput(b,a(this))})),a.fn.instTree.InitInstTree(b),typeof e.opts.onAddNode=="function"&&e.opts.onAddNode(n)}}},a.fn.instTree.EditNode=function(b){d=a(b);var c=d.find("span.active").get(0);if(c){var f=a(c).parents("li:first");a(c).replaceWith('<span class="text">&nbsp;</span><input type="text" value="'+a(c).text()+'" />'),f.find("input:text").focus().select().blur(function(){e.SaveInput(b,a(this))}),typeof e.opts.onEditNode=="function"&&e.opts.onEditNode(f)}},a.fn.instTree.DeleteNode=function(b){d=a(b);var c=d.find("span.active").get(0);if(c){var f=a(c).parents("li:first"),g=f.parents("li.node:first");f.prev("li.separator").remove().end().remove(),a.fn.instTree.InitInstTree(b),typeof e.opts.onDeleteNode=="function"&&e.opts.onDeleteNode(f,g)}},e.SaveInput=function(b,c){c.prev("span.text").remove();var d=a.trim(c.get(0).value)!==""?c.get(0).value:"_____";c.replaceWith('<span class="active text">'+d+"</span>"),a.fn.instTree.InitInstTree(b)},e.IeSetStyles=function(){a.browser.msie&&(d.find("li.node:not(.open) > ul").hide(),d.find("li.node.open > ul").css("margin-bottom","1px"))},e.Clean=function(){d.find("li:not(.separator)").each(function(){a(this).removeClass("last"),(!a(this).next("li").length||a(this).find("ul").length)&&a(this).addClass("last")})},e.AddSigns=function(){d.find("li.node").each(function(){a(this).hasClass("open")?a(this).find("span.sign").remove().end().append('<span class="sign minus"></span>'):a(this).find("span.sign").remove().end().append('<span class="sign plus"></span>')})},e.BindEvents=function(b){d.click(function(c){var d=a(this).closest(".instTree"),f=a(c.target),g;f.is("span.sign")?(g=f.parents("li:eq(0)"),e.ToggleNode(b,g)):f.is("span.text")&&(g=f.closest("li"),typeof e.opts.onClick=="function"?(e.opts.overrideEvents||((!e.opts.multi||!c.ctrlKey)&&d.find(".active").removeClass("active").end().find(".active-leaf").removeClass("active-leaf").end().find(".active-node").removeClass("active-node"),f.addClass("active"),g.hasClass("leaf")?g.addClass("active-leaf"):g.addClass("active-node")),e.opts.onClick.call(g,c,g)):((!e.opts.multi||!c.ctrlKey)&&d.find(".active").removeClass("active").end().find(".active-leaf").removeClass("active-leaf").end().find(".active-node").removeClass("active-node"),f.addClass("active"),g.hasClass("leaf")?g.addClass("active-leaf"):g.addClass("active-node")))}),d.dblclick(function(c){var d=a(c.target);if(d.is("span.text")){var f=d.parents("li:eq(0)");typeof e.opts.onDblClick=="function"?(!e.opts.overrideEvents&&f.is(".node")&&e.ToggleNode(b,f),e.opts.onDblClick.call(f,c,f)):f.is(".node")&&e.ToggleNode(b,f)}}),c=!0},e.ToggleNode=function(a,b){b.hasClass("open")?e.CollapseNode(b):e.ExpandNode(a,b),e.Clean()},e.ExpandNode=function(b,c){c.addClass("open"),e.opts.autoclose&&c.siblings(".open").each(function(){e.CollapseNode(a(this))}),a.browser.msie&&(c.children("ul").show().css({"margin-bottom":"1px",visibility:"visible"}),c.children("ul").find("li.node:not(.open) > ul").each(function(){a(this).css("visibility","hidden")}));var d=c.find("span.sign:last");d.removeClass("plus").addClass("minus"),e.opts.multi&&a.fn.instTree.InitInstTree(b),typeof e.opts.onExpand=="function"&&e.opts.onExpand(c)},e.CollapseNode=function(b){b.removeClass("open"),a.browser.msie&&b.children("ul").hide();var c=b.find("span.sign:last");c.removeClass("minus").addClass("plus"),typeof e.opts.onCollapse=="function"&&e.opts.onCollapse(b)},a(this).is("ul")&&(d=a(this),d.addClass("instTree"),a.fn.instTree.InitInstTree(e))})}})