define(["i18n!content_tags","jquery","jquery.instructure_forms","jqueryui/dialog","jquery.instructure_misc_helpers","jquery.instructure_misc_plugins","jquery.loadingImg","jquery.templateData","vendor/jquery.scrollTo","jqueryui/accordion"],function(a,b){function c(a,c){var d=null;a.find(".tag_list .tag_name").each(function(){var a=b(this).find(".name").text();a==c.tag?d=b(this):c.tag>a&&(d=b("#tag_name_blank").clone(!0).removeAttr("id"),d.find(".name").text(c.tag),b(this).before(d));if(d)return!1});if(d==null){var d=b("#tag_name_blank").clone(!0).removeAttr("id");d.find(".name").text(c.tag),a.find(".tag_list").append(d)}return d}var d={currentHover:null,hoverCount:-1,checkForHover:function(){if(d.hoverCount>=0){if(d.currentHover==null){d.hoverCount=-1;return}d.hoverCount++,d.hoverCount>4&&d.currentHover.click()}}};b(document).ready(function(){b("#tags .tag_name").click(function(a){b("#tags .tag_name.selected").removeClass("selected"),b(this).parents(".tag_list").scrollTo(b(this)),b(this).addClass("selected"),a.preventDefault();var c=b(this).getTemplateData({textValues:["name"]}).name.toLowerCase().replace(/\s/g,"_");b("#pages_for_tags").find(".page").hide();var d=b("#pages_for_tags").find(".page.tag_named_"+c),e=b(this).parents(".context_tags").attr("id");e!="tags_for_all"&&(d=d.filter("."+e.replace(/^tags_for/,"page_for")));var f={};d.each(function(){f[b(this).find(".title").attr("href")+"::"+b(this).find(".title").text()]=!0,b(this).show()})}),b("#tags").accordion({header:".header",fillSpace:!0,alwaysOpen:!0}).bind("accordionchange",function(a,c){b("#pages_for_tags .page").hide(),b(c.newContent).filter(":first").click()}),b("#tags_for_all .tag_list .tag_name:first").click(),b(".content_tags_description_link").click(function(a){a.preventDefault(),b("#content_tags_details_dialog").dialog({title:"What Are Content Tags?"})}),b(".page").click(function(a){if(b(this).hasClass("selected"))return;if(b(a.target).closest("a").length>0)return;a.preventDefault(),b("#pages_for_tags .page.selected").removeClass("selected").find(".comments").slideUp(),b(this).addClass("selected").find(".comments").slideDown()}),b(".page").hover(function(){d.currentHover=b(this),d.hoverCount=0},function(){d.currentHover&&d.currentHover[0]==b(this)[0]&&(d.currentHover=null,d.hoverCount=-1)}),setInterval(d.checkForHover,200),b(".page .delete_page_link").click(function(c){c.preventDefault(),b(this).parents(".page").confirmDelete({message:a.t("prompts.delete_tag","Are you sure you want to delete this tag?"),url:b(this).attr("href"),success:function(){b(this).slideUp(function(){b(this).remove()})}})}),b(".add_external_tag_link").click(function(c){c.preventDefault(),b("#external_tag_dialog").dialog({title:a.t("titles.tag_external_web_page","Tag External Web Page"),width:400,open:function(){var c={url:"http://",title:a.t("defaults.page_title","Page Title"),comments:a.t("defaults.comments","Comments")};b(this).fillFormData(c,{object_name:"tag"}),b(this).find(":text:visible:first").focus().select()}}).dialog("open")}),b("#add_external_tag_form").formSubmit({beforeSubmit:function(a){b(this).loadingImage()},success:function(a){b(this).loadingImage("remove"),b("#external_tag_dialog").dialog("close");for(var c in a){var d=a[c];b(document).triggerHandler("tag_added",d)}}}),b(document).bind("tag_added",function(a,d){var e=b("#tags_for_"+d.context_type.toLowerCase()+"_"+d.context_id),f=c(e,d),g=c(b("#tags_for_all"),d),h=b("#page_blank").clone(!0).removeAttr("id");h.find(".title").attr("href",d.url).text(d.title),h.find(".comments").text(d.comments),h.find(".delete_page_link").attr("href",b.replaceTags(h.find(".delete_page_link").attr("href"),"id",d.id)),h.addClass("page_for_"+d.context_type.toLowerCase()+"_"+d.context_id).addClass("tag_named_"+d.tag.toLowerCase().replace(/ /g,"_")),b("#pages_for_tags").prepend(h),b("#content_tags_description").hide(),b("#content_tags_table").show(),b("#personal_tags_message").hide(),f.filter(":visible").click(),g.filter(":visible").click(),b(window).triggerHandler("resize")}),b(document).fragmentChange(function(a,c){c=c||"";var d=c.substring(1);b(".ui-accordion-content-active").find(".tag_name."+d).click()}),b(window).resize(function(){var a=b(window).height(),c=b("#tags").offset().top,d=Math.max(a-c,200)-10;b("#tags,#pages_for_tags").height(d);if(b.browser.msie&&navigator.appVersion.match("MSIE 6.0"))return;b("#tags").accordion("resize")}).triggerHandler("resize")})})